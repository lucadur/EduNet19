"use strict";let adminToRemove=null;async function waitForAdminManager(){console.log("‚è≥ [Manage Admins] Attendo AdminManager...");let n=0;const e=100;for(;!window.adminManager&&n<e;)await new Promise(n=>setTimeout(n,100)),n++;if(!window.adminManager)throw console.error("‚ùå [Manage Admins] AdminManager non disponibile dopo",100*e,"ms"),new Error("AdminManager non disponibile");console.log("‚úÖ [Manage Admins] AdminManager disponibile, attendo inizializzazione...");const i=await window.adminManager.waitForInit();if(!i)throw console.error("‚ùå [Manage Admins] AdminManager non inizializzato correttamente"),new Error("AdminManager non inizializzato");console.log("‚úÖ [Manage Admins] AdminManager inizializzato"),console.log("üìã [Manage Admins] AdminManager.currentInstitute:",window.adminManager.currentInstitute)}async function initializePage(){console.log("üöÄ [Manage Admins] Inizializzazione pagina...");const n=window.adminManager;if(!n.currentInstitute)return console.error("‚ùå [Manage Admins] currentInstitute non disponibile"),alert("Devi essere un amministratore di un istituto per accedere a questa pagina"),void(window.location.href=window.AppConfig.getPageUrl("homepage.html"));console.log("‚úÖ [Manage Admins] currentInstitute:",n.currentInstitute),console.log("üîê [Manage Admins] Verifico permessi...");const e=await n.canManageAdmins();if(console.log("üìã [Manage Admins] canManageAdmins:",e),!e)return console.error("‚ùå [Manage Admins] Permessi insufficienti"),alert("Non hai i permessi per gestire i collaboratori"),void(window.location.href=window.AppConfig.getPageUrl("homepage.html"));console.log("‚úÖ [Manage Admins] Permessi OK, carico dati..."),await refreshData(),console.log("‚úÖ [Manage Admins] Pagina inizializzata")}async function refreshData(){const n=window.adminManager;await n.loadAdmins(),await n.loadPendingInvites(),updateStats(),renderAdminList(),renderPendingInvites(),updateInviteButton()}function updateStats(){const n=window.adminManager,e=n.admins.length,i=n.pendingInvites.length,t=n.maxAdmins-e;document.getElementById("active-admins-count").textContent=e,document.getElementById("pending-invites-count").textContent=i,document.getElementById("available-slots").textContent=t}function renderAdminList(){const n=window.adminManager,e=document.getElementById("admin-list");if(!e)return;if(0===n.admins.length)return void(e.innerHTML='\n      <div class="empty-state">\n        <i class="fas fa-users"></i>\n        <div class="empty-title">Nessun collaboratore</div>\n        <p class="empty-text">Inizia invitando il primo collaboratore</p>\n      </div>\n    ');const i=window.eduNetAuth.getCurrentUser().id;e.innerHTML=n.admins.map(e=>{const t=e.user_id===i,o="owner"!==e.role&&n.isOwner()&&!t;return`\n      <div class="admin-card" data-admin-id="${e.id}">\n        <div class="admin-avatar">\n          ${e.avatar_url?`<img src="${e.avatar_url}" alt="${e.first_name||"Admin"}">`:`<div class="avatar-placeholder">${getInitials(e.first_name,e.last_name)}</div>`}\n        </div>\n        <div class="admin-info">\n          <div class="admin-name">\n            ${e.first_name||"Admin"} ${e.last_name||""}\n            ${t?'<span style="color: #667eea; font-size: 0.85rem;">(Tu)</span>':""}\n          </div>\n          <div class="admin-email">${e.email}</div>\n          <div class="admin-role">\n            <span class="role-badge role-${e.role}">${getRoleLabel(e.role)}</span>\n            ${e.invited_at?`<span class="admin-date">Aggiunto ${formatDate(e.invited_at)}</span>`:""}\n          </div>\n        </div>\n        <div class="admin-actions">\n          ${o?`\n            <button \n              class="btn-icon btn-danger" \n              onclick="showRemoveAdminModal('${e.id}', '${e.first_name} ${e.last_name}')"\n              title="Rimuovi collaboratore"\n            >\n              <i class="fas fa-user-minus"></i>\n            </button>\n          `:""}\n        </div>\n      </div>\n    `}).join("")}function renderPendingInvites(){const n=window.adminManager,e=document.getElementById("pending-invites");e&&(0!==n.pendingInvites.length?e.innerHTML=n.pendingInvites.map(n=>`\n    <div class="invite-card" data-invite-id="${n.id}">\n      <div class="invite-icon">\n        <i class="fas fa-envelope"></i>\n      </div>\n      <div class="invite-info">\n        <div class="invite-email">${n.email}</div>\n        <div class="invite-meta">\n          <span class="badge badge-${n.role}">${getRoleLabel(n.role)}</span>\n          <span class="invite-date">\n            <i class="fas fa-clock"></i>\n            Inviato ${formatDate(n.created_at)}\n          </span>\n          <span class="invite-date">\n            <i class="fas fa-hourglass-end"></i>\n            Scade ${formatDate(n.expires_at)}\n          </span>\n        </div>\n      </div>\n      <div class="invite-actions">\n        <button \n          class="btn-icon btn-secondary" \n          onclick="copyInviteLink('${n.token}')"\n          title="Copia link invito"\n        >\n          <i class="fas fa-link"></i>\n        </button>\n        <button \n          class="btn-icon btn-danger" \n          onclick="cancelInvite('${n.id}')"\n          title="Cancella invito"\n        >\n          <i class="fas fa-times"></i>\n        </button>\n      </div>\n    </div>\n  `).join(""):e.innerHTML='\n      <div class="empty-state">\n        <i class="fas fa-envelope"></i>\n        <div class="empty-title">Nessun invito in sospeso</div>\n        <p class="empty-text">Gli inviti inviati appariranno qui</p>\n      </div>\n    ')}function updateInviteButton(){const n=window.adminManager,e=document.getElementById("add-admin-btn");e&&(n.canAddMoreAdmins()?(e.disabled=!1,e.innerHTML='<i class="fas fa-user-plus"></i><span>Invita Collaboratore</span>',e.style.opacity="1",e.style.cursor="pointer"):(e.disabled=!0,e.innerHTML='<i class="fas fa-user-plus"></i><span>Limite Raggiunto</span>',e.style.opacity="0.5",e.style.cursor="not-allowed"))}function setupEventListeners(){const n=document.getElementById("invite-form");n&&n.addEventListener("submit",handleInviteSubmit);const e=document.getElementById("invite-modal");e&&e.addEventListener("click",n=>{n.target===e&&closeInviteModal()});const i=document.getElementById("confirm-remove-modal");i&&i.addEventListener("click",n=>{n.target===i&&closeConfirmRemoveModal()}),document.addEventListener("keydown",n=>{"Escape"===n.key&&(closeInviteModal(),closeConfirmRemoveModal())});const t=document.getElementById("confirm-remove-btn");t&&t.addEventListener("click",handleRemoveAdmin)}function showInviteModal(){const n=window.adminManager;if(!n.canAddMoreAdmins())return void showNotification("Hai raggiunto il limite massimo di 3 collaboratori","warning");const e=document.getElementById("invite-modal");e&&(e.classList.add("active"),setTimeout(()=>{document.getElementById("invite-email")?.focus()},100))}function closeInviteModal(){const n=document.getElementById("invite-modal");if(n){n.classList.remove("active");const e=document.getElementById("invite-form");e&&e.reset()}}function showRemoveAdminModal(n,e){adminToRemove=n;const i=document.getElementById("confirm-remove-modal"),t=document.getElementById("remove-admin-name");i&&t&&(t.textContent=e,i.classList.add("active"))}function closeConfirmRemoveModal(){adminToRemove=null;const n=document.getElementById("confirm-remove-modal");n&&n.classList.remove("active")}async function handleInviteSubmit(n){n.preventDefault();const e=window.adminManager,i=document.getElementById("send-invite-btn"),t=document.getElementById("invite-email").value.trim(),o=document.getElementById("invite-role").value;i.disabled=!0,i.innerHTML='<i class="fas fa-spinner fa-spin"></i> Invio...';try{await e.inviteAdmin(t,o),showNotification("Invito inviato con successo!","success"),closeInviteModal(),await refreshData()}catch(n){console.error("Errore invio invito:",n),showNotification(n.message||"Errore nell'invio dell'invito","error")}finally{i.disabled=!1,i.innerHTML='<i class="fas fa-paper-plane"></i> Invia Invito'}}async function handleRemoveAdmin(){if(!adminToRemove)return;const n=document.getElementById("confirm-remove-btn"),e=window.adminManager;n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin"></i> Rimozione...';try{await e.removeAdmin(adminToRemove),showNotification("Collaboratore rimosso con successo","success"),closeConfirmRemoveModal(),await refreshData()}catch(n){console.error("Errore rimozione admin:",n),showNotification(n.message||"Errore nella rimozione del collaboratore","error")}finally{n.disabled=!1,n.innerHTML='<i class="fas fa-trash"></i> Rimuovi Collaboratore'}}async function copyInviteLink(n){const e=window.location.origin,i=`${e}${window.AppConfig.getBasePath()}accept-invite.html?token=${n}`;try{await navigator.clipboard.writeText(i),showNotification("Link invito copiato negli appunti!","success")}catch(n){console.error("Errore copia link:",n),showNotification("Errore nella copia del link","error")}}async function cancelInvite(n){if(!confirm("Sei sicuro di voler cancellare questo invito?"))return;const e=window.adminManager;try{await e.cancelInvite(n),showNotification("Invito cancellato","success"),await refreshData()}catch(n){console.error("Errore cancellazione invito:",n),showNotification(n.message||"Errore nella cancellazione dell'invito","error")}}function getInitials(n,e){const i=(n||"").charAt(0).toUpperCase(),t=(e||"").charAt(0).toUpperCase();return i+t||"A"}function getRoleLabel(n){const e={owner:"Proprietario",admin:"Admin",editor:"Editor"};return e[n]||n}function formatDate(n){if(!n)return"";const e=new Date(n),i=new Date,t=i-e,o=Math.floor(t/864e5);return 0===o?"oggi":1===o?"ieri":o<7?`${o} giorni fa`:e.toLocaleDateString("it-IT",{day:"numeric",month:"short",year:"numeric"})}function showNotification(n,e="info"){const i=document.createElement("div");i.className=`notification notification-${e}`,i.innerHTML=`\n    <div class="notification-content">\n      <i class="fas fa-${getNotificationIcon(e)}"></i>\n      <span>${n}</span>\n    </div>\n    <button class="notification-close" onclick="this.parentElement.remove()">\n      <i class="fas fa-times"></i>\n    </button>\n  `,document.body.appendChild(i),setTimeout(()=>i.classList.add("show"),10),setTimeout(()=>{i.classList.remove("show"),setTimeout(()=>i.remove(),300)},5e3)}function getNotificationIcon(n){const e={success:"check-circle",error:"times-circle",warning:"exclamation-triangle",info:"info-circle"};return e[n]||"info-circle"}function hideLoadingScreen(){const n=document.getElementById("loading-screen");n&&(n.style.opacity="0",setTimeout(()=>{n.style.display="none"},300))}document.addEventListener("DOMContentLoaded",async()=>{console.log("üîß [Manage Admins] DOMContentLoaded");try{console.log("‚è≥ [Manage Admins] Attendo auth system...");let n=0;for(;!window.eduNetAuth&&n<100;)await new Promise(n=>setTimeout(n,100)),n++;if(!window.eduNetAuth)return console.error("‚ùå [Manage Admins] Auth system non disponibile"),void(window.location.href=window.AppConfig.getPageUrl("index.html"));for(console.log("‚úÖ [Manage Admins] Auth system disponibile"),n=0;!window.eduNetAuth.isAuthenticated()&&n<100;)await new Promise(n=>setTimeout(n,100)),n++;if(!window.eduNetAuth.isAuthenticated())return console.log("‚ùå [Manage Admins] Utente non autenticato, redirect a login"),void(window.location.href=window.AppConfig.getPageUrl("index.html"));for(console.log("‚úÖ [Manage Admins] Utente autenticato"),n=0;!window.eduNetAuth.getUserProfile()&&n<100;)await new Promise(n=>setTimeout(n,100)),n++;const e=window.eduNetAuth.getUserProfile();if(console.log("üìã [Manage Admins] Profilo utente:",e),!e)return console.error("‚ùå [Manage Admins] Profilo non disponibile"),alert("Errore nel caricamento del profilo"),void(window.location.href=window.AppConfig.getPageUrl("homepage.html"));if("istituto"!==e.user_type)return console.log("‚ùå [Manage Admins] Utente non √® un istituto"),alert("Solo gli istituti possono accedere a questa pagina"),void(window.location.href=window.AppConfig.getPageUrl("homepage.html"));console.log("‚úÖ [Manage Admins] Utente √® un istituto, procedo..."),await waitForAdminManager(),await initializePage(),setupEventListeners(),hideLoadingScreen(),console.log("üéâ [Manage Admins] Pagina inizializzata con successo")}catch(n){console.error("‚ùå [Manage Admins] Errore inizializzazione:",n),alert("Errore nel caricamento della pagina: "+n.message),window.location.href=window.AppConfig.getPageUrl("homepage.html")}}),window.showInviteModal=showInviteModal,window.closeInviteModal=closeInviteModal,window.showRemoveAdminModal=showRemoveAdminModal,window.closeConfirmRemoveModal=closeConfirmRemoveModal,window.copyInviteLink=copyInviteLink,window.cancelInvite=cancelInvite;