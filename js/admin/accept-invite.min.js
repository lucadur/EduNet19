"use strict";let inviteToken=null,inviteData=null;async function waitForAdminManager(){let e=0;const t=50;for(;!window.adminManager&&e<t;)await new Promise(e=>setTimeout(e,100)),e++;if(!window.adminManager)throw new Error("AdminManager non disponibile")}async function verifyInvite(){try{const{data:e,error:t}=await window.eduNetAuth.supabase.from("institute_admin_invites").select("\n        *,\n        school_institutes (\n          id,\n          institute_name,\n          institute_type,\n          logo_url\n        )\n      ").eq("token",inviteToken).eq("accepted",!1).gt("expires_at",(new Date).toISOString()).single();if(t||!e)throw new Error("Invito non trovato o scaduto");const n=window.eduNetAuth.getCurrentUser();if(e.email.toLowerCase()!==n.email.toLowerCase())throw new Error("Questo invito Ã¨ destinato a un altro indirizzo email");inviteData=e,showValidInvite()}catch(e){console.error("Errore verifica invito:",e),showInvalidInvite(e.message)}}function showValidInvite(){document.getElementById("loading-state").style.display="none";const e=document.getElementById("valid-invite-state");e.style.display="block";const t=inviteData.school_institutes;document.getElementById("institute-name").textContent=t.institute_name,document.getElementById("institute-type").textContent=t.institute_type||"Istituto Scolastico";const n=document.getElementById("institute-avatar");if(t.logo_url)n.innerHTML=`<img src="${t.logo_url}" alt="${t.institute_name}">`;else{const e=getInstituteInitials(t.institute_name);n.innerHTML=e}const i=document.getElementById("invite-role");i.textContent=getRoleLabel(inviteData.role),i.className=`role-badge role-${inviteData.role}`}function showInvalidInvite(e){document.getElementById("loading-state").style.display="none";const t=document.getElementById("invalid-invite-state");t.style.display="block",document.getElementById("error-message").textContent=e}async function acceptInvite(){const e=document.getElementById("accept-btn");e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Accettazione...';try{await window.adminManager.acceptInvite(inviteToken),showSuccess()}catch(t){console.error("Errore accettazione invito:",t),alert(t.message||"Errore nell'accettazione dell'invito"),e.disabled=!1,e.innerHTML='<i class="fas fa-check"></i> Accetta Invito'}}function declineInvite(){confirm("Sei sicuro di voler rifiutare questo invito?")&&(window.location.href=window.AppConfig.getPageUrl("homepage.html"))}function showSuccess(){document.getElementById("valid-invite-state").style.display="none",document.getElementById("success-state").style.display="block"}function getInstituteInitials(e){if(!e)return"?";const t=e.split(" ");return t.length>=2?(t[0][0]+t[1][0]).toUpperCase():e.substring(0,2).toUpperCase()}function getRoleLabel(e){const t={owner:"Proprietario",admin:"Amministratore",editor:"Editor"};return t[e]||e}document.addEventListener("DOMContentLoaded",async()=>{const e=new URLSearchParams(window.location.search);if(inviteToken=e.get("token"),inviteToken){if(!window.eduNetAuth||!window.eduNetAuth.isAuthenticated())return sessionStorage.setItem("pendingInviteToken",inviteToken),void(window.location.href=window.AppConfig.getPageUrl(`index.html?redirect=accept-invite&token=${inviteToken}`));await waitForAdminManager(),await verifyInvite()}else showInvalidInvite("Nessun token di invito fornito")}),window.acceptInvite=acceptInvite,window.declineInvite=declineInvite;