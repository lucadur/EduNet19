class ModerationCenter{constructor(){this.supabase=null,this.currentUser=null,this.adminRole=null,this.permissions={},this.currentSection="overview",this.syncInterval=null,this.filters={reportStatus:"pending",reportCategory:"all",reportPriority:"all",gdprStatus:"pending",gdprType:"all",appealStatus:"pending",parentalStatus:"pending"},this.init()}async init(){this.showLoadingScreen();try{await this.waitForSupabase()}catch(e){return console.error("[ModerationCenter] Failed to initialize Supabase:",e),this.hideLoadingScreen(),void this.showError("Errore di connessione al database. Ricarica la pagina.")}const e=await this.checkAuth();if("login_shown"!==e){if(!e)return this.hideLoadingScreen(),void this.showAccessDenied();this.hideLoadingScreen(),this.setupEventListeners(),this.setupTheme(),this.applyPermissions(),this.loadSection("overview"),this.loadStats(),this.startSilentSync()}}startSilentSync(){this.syncInterval=setInterval(()=>{this.silentRefresh()},3e4)}stopSilentSync(){this.syncInterval&&(clearInterval(this.syncInterval),this.syncInterval=null)}async silentRefresh(){try{switch(await this.loadStats(),this.currentSection){case"overview":await this.loadRecentActivity();break;case"reports":await this.loadReports();break;case"appeals":await this.loadAppeals();break;case"gdpr":await this.loadGdprRequests();break;case"parental":await this.loadParentalConsents();break;case"actions":await this.loadActions()}console.log("[ModerationCenter] Silent sync completed")}catch(e){console.error("[ModerationCenter] Silent sync error:",e)}}showError(e){document.body.innerHTML=`\n            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #0f172a; color: white; text-align: center; padding: 2rem;">\n                <div style="width: 80px; height: 80px; background: #f59e0b; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem;">\n                    <svg width="40" height="40" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>\n                    </svg>\n                </div>\n                <h1 style="font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem;">Errore</h1>\n                <p style="color: #94a3b8; margin-bottom: 2rem; max-width: 400px;">${e}</p>\n                <button onclick="location.reload()" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: 500; cursor: pointer;">\n                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>\n                    </svg>\n                    Ricarica pagina\n                </button>\n            </div>\n        `}showLoadingScreen(){const e=document.createElement("div");e.id="authLoadingOverlay",e.innerHTML='\n            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #0f172a; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999;">\n                <div style="width: 50px; height: 50px; border: 4px solid #1e3a5f; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;"></div>\n                <p style="color: #94a3b8; margin-top: 1rem;">Verifica autorizzazioni...</p>\n                <style>@keyframes spin { to { transform: rotate(360deg); } }</style>\n            </div>\n        ',document.body.appendChild(e)}hideLoadingScreen(){const e=document.getElementById("authLoadingOverlay");e&&e.remove()}showAccessDenied(){document.body.innerHTML='\n            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #0f172a; color: white; text-align: center; padding: 2rem;">\n                <div style="width: 80px; height: 80px; background: #dc2626; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem;">\n                    <svg width="40" height="40" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>\n                    </svg>\n                </div>\n                <h1 style="font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem;">Accesso Negato</h1>\n                <p style="color: #94a3b8; margin-bottom: 2rem; max-width: 400px;">\n                    Non hai i permessi necessari per accedere al Centro Moderazione. \n                    Questa area è riservata agli amministratori e moderatori della piattaforma.\n                </p>\n                <a href="../../homepage.html" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; background: #3b82f6; color: white; text-decoration: none; border-radius: 8px; font-weight: 500;">\n                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>\n                    </svg>\n                    Torna alla Home\n                </a>\n            </div>\n        '}showAdminLogin(){document.body.innerHTML='\n            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background: #0f172a; color: white; padding: 2rem;">\n                <div style="width: 100%; max-width: 400px; background: #1e293b; border-radius: 16px; padding: 2rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">\n                    <div style="text-align: center; margin-bottom: 2rem;">\n                        <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">\n                            <svg width="32" height="32" fill="none" stroke="white" viewBox="0 0 24 24">\n                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>\n                            </svg>\n                        </div>\n                        <h1 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">Centro Moderazione</h1>\n                        <p style="color: #94a3b8; font-size: 0.9rem;">Accedi con le tue credenziali admin</p>\n                    </div>\n                    \n                    <form id="adminLoginForm" style="display: flex; flex-direction: column; gap: 1rem;">\n                        <div>\n                            <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; color: #e2e8f0;">Email</label>\n                            <input type="email" id="adminEmail" required \n                                style="width: 100%; padding: 0.75rem 1rem; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: white; font-size: 1rem; outline: none; transition: border-color 0.2s;"\n                                placeholder="admin@example.com"\n                                onfocus="this.style.borderColor=\'#3b82f6\'" \n                                onblur="this.style.borderColor=\'#334155\'">\n                        </div>\n                        \n                        <div>\n                            <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; color: #e2e8f0;">Password</label>\n                            <input type="password" id="adminPassword" required \n                                style="width: 100%; padding: 0.75rem 1rem; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: white; font-size: 1rem; outline: none; transition: border-color 0.2s;"\n                                placeholder="••••••••"\n                                onfocus="this.style.borderColor=\'#3b82f6\'" \n                                onblur="this.style.borderColor=\'#334155\'">\n                        </div>\n                        \n                        <div id="adminLoginError" style="display: none; padding: 0.75rem; background: rgba(220, 38, 38, 0.2); border: 1px solid #dc2626; border-radius: 8px; color: #fca5a5; font-size: 0.875rem;"></div>\n                        \n                        <button type="submit" id="adminLoginBtn"\n                            style="width: 100%; padding: 0.875rem; background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; border-radius: 8px; color: white; font-size: 1rem; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; margin-top: 0.5rem;"\n                            onmouseover="this.style.transform=\'translateY(-1px)\'; this.style.boxShadow=\'0 4px 12px rgba(59, 130, 246, 0.4)\'"\n                            onmouseout="this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'none\'">\n                            <span id="loginBtnText">Accedi</span>\n                            <span id="loginBtnSpinner" style="display: none;">\n                                <svg style="animation: spin 1s linear infinite; width: 20px; height: 20px; display: inline-block; vertical-align: middle;" fill="none" viewBox="0 0 24 24">\n                                    <circle style="opacity: 0.25;" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>\n                                    <path style="opacity: 0.75;" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>\n                                </svg>\n                            </span>\n                        </button>\n                    </form>\n                    \n                    <p style="text-align: center; margin-top: 1.5rem; color: #64748b; font-size: 0.8rem;">\n                        Area riservata al personale autorizzato\n                    </p>\n                </div>\n                <style>@keyframes spin { to { transform: rotate(360deg); } }</style>\n            </div>\n        ',document.getElementById("adminLoginForm").addEventListener("submit",e=>this.handleAdminLogin(e))}async handleAdminLogin(e){e.preventDefault();const t=document.getElementById("adminEmail").value,n=document.getElementById("adminPassword").value,a=document.getElementById("adminLoginError"),s=document.getElementById("loginBtnText"),i=document.getElementById("loginBtnSpinner"),o=document.getElementById("adminLoginBtn");s.style.display="none",i.style.display="inline-block",o.disabled=!0,a.style.display="none";try{const{data:e,error:a}=await this.supabase.auth.signInWithPassword({email:t,password:n});if(a)throw a;const{data:s,error:i}=await this.supabase.from("admin_users").select("*").eq("user_id",e.user.id).single();if(i||!s)throw await this.supabase.auth.signOut(),new Error("Account non autorizzato per il Centro Moderazione");window.location.reload()}catch(e){console.error("Admin login error:",e),a.textContent=e.message||"Credenziali non valide",a.style.display="block",s.style.display="inline",i.style.display="none",o.disabled=!1}}async waitForSupabase(){return new Promise((e,t)=>{let n=0;const a=50,s=async()=>{if(n++,console.log(`[ModerationCenter] Waiting for Supabase... attempt ${n}`),n>a)return console.error("[ModerationCenter] Timeout waiting for Supabase client"),void t(new Error("Timeout waiting for Supabase"));if(window.supabaseClientManager)try{if(this.supabase=await window.supabaseClientManager.getClient(),this.supabase)return console.log("[ModerationCenter] Supabase client ready"),void e();console.warn("[ModerationCenter] getClient() returned null")}catch(e){console.error("[ModerationCenter] Error getting Supabase client:",e)}else console.warn("[ModerationCenter] supabaseClientManager not found yet");setTimeout(s,100)};s()})}async checkAuth(){try{if(!this.supabase)return console.error("[ModerationCenter] Supabase client not initialized"),!1;const{data:{user:e},error:t}=await this.supabase.auth.getUser();if(console.log("[ModerationCenter] Auth check - user:",e?.id,e?.email,"error:",t?.message),!e)return console.log("[ModerationCenter] No user logged in, showing admin login..."),this.hideLoadingScreen(),this.showAdminLogin(),"login_shown";this.currentUser=e,console.log("[ModerationCenter] Checking admin_users for user_id:",e.id);const{data:n,error:a}=await this.supabase.from("admin_users").select("*").eq("user_id",e.id).single();return console.log("[ModerationCenter] Admin query result:",n,"error:",a?.message,a?.code),a||!n?(console.warn("[ModerationCenter] User is not an admin:",a?.message),!1):(this.adminRole=n.role,this.permissions=n.permissions||{},console.log("Admin authenticated:",this.adminRole,this.permissions),!0)}catch(e){return console.error("Auth check error:",e),!1}}applyPermissions(){const e=document.querySelector('[data-section="gdpr"]'),t=(document.querySelector('[data-section="parental"]'),document.querySelector('[data-section="users"]')),n=document.getElementById("adminManagementSection");this.permissions.can_manage_gdpr||"super_admin"===this.adminRole||e?.parentElement?.removeChild(e),"super_admin"!==this.adminRole&&"admin"!==this.adminRole&&t?.parentElement?.removeChild(t),"super_admin"===this.adminRole&&n&&(n.style.display="block");const a=document.querySelector(".mod-nav-title");if(a){const e={super_admin:"Super Admin",admin:"Amministratore",moderator:"Moderatore"};a.innerHTML=`\n                <i class="fas fa-shield-alt"></i>\n                Centro Moderazione\n                <span style="font-size: 0.75rem; background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 4px; margin-left: 0.5rem;">\n                    ${e[this.adminRole]||this.adminRole}\n                </span>\n            `}}setupEventListeners(){const e=document.getElementById("mobileMenuToggle"),t=document.querySelector(".mod-sidebar"),n=document.getElementById("mobileOverlay");e?.addEventListener("click",()=>{t?.classList.toggle("open"),n?.classList.toggle("active");const a=e.querySelector("i");t?.classList.contains("open")?a.className="fas fa-times":a.className="fas fa-bars"}),n?.addEventListener("click",()=>{t?.classList.remove("open"),n?.classList.remove("active");const a=e?.querySelector("i");a&&(a.className="fas fa-bars")}),document.querySelectorAll(".mod-nav-item").forEach(a=>{a.addEventListener("click",s=>{s.preventDefault();const i=a.dataset.section;this.loadSection(i),t?.classList.remove("open"),n?.classList.remove("active");const o=e?.querySelector("i");o&&(o.className="fas fa-bars")})}),document.getElementById("reportStatusFilter")?.addEventListener("change",e=>{this.filters.reportStatus=e.target.value,this.loadReports()}),document.getElementById("reportCategoryFilter")?.addEventListener("change",e=>{this.filters.reportCategory=e.target.value,this.loadReports()}),document.getElementById("reportPriorityFilter")?.addEventListener("change",e=>{this.filters.reportPriority=e.target.value,this.loadReports()}),document.getElementById("gdprStatusFilter")?.addEventListener("change",e=>{this.filters.gdprStatus=e.target.value,this.loadGdprRequests()}),document.getElementById("gdprTypeFilter")?.addEventListener("change",e=>{this.filters.gdprType=e.target.value,this.loadGdprRequests()}),document.getElementById("appealStatusFilter")?.addEventListener("change",e=>{this.filters.appealStatus=e.target.value,this.loadAppeals()}),document.getElementById("parentalStatusFilter")?.addEventListener("change",e=>{this.filters.parentalStatus=e.target.value,this.loadParentalConsents()}),document.getElementById("contentTypeFilter")?.addEventListener("change",()=>{this.loadContent()}),document.getElementById("contentStatusFilter")?.addEventListener("change",()=>{this.loadContent()});const a=document.getElementById("userSearchInput");let s;a?.addEventListener("input",e=>{clearTimeout(s),s=setTimeout(()=>{this.searchUsers(e.target.value)},300)}),document.querySelectorAll(".mod-modal-backdrop, .mod-modal-close").forEach(e=>{e.addEventListener("click",()=>this.closeModals())}),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.closeModals()})}setupTheme(){let e="dark";try{const t=localStorage.getItem("edunet_settings");if(t){const n=JSON.parse(t);e=n.theme||"dark"}}catch(e){}("dark"===e||"auto"===e&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add("dark-theme");const t=document.querySelector("#themeToggle i");t&&(t.className=document.body.classList.contains("dark-theme")?"fas fa-sun":"fas fa-moon"),document.getElementById("themeToggle")?.addEventListener("click",()=>{document.body.classList.toggle("dark-theme");const e=document.body.classList.contains("dark-theme");try{const t=localStorage.getItem("edunet_settings"),n=t?JSON.parse(t):{};n.theme=e?"dark":"light",localStorage.setItem("edunet_settings",JSON.stringify(n))}catch(e){}const t=document.querySelector("#themeToggle i");t&&(t.className=e?"fas fa-sun":"fas fa-moon")})}loadSection(e){switch(document.querySelectorAll(".mod-nav-item").forEach(t=>{t.classList.toggle("active",t.dataset.section===e)}),document.querySelectorAll(".mod-section").forEach(t=>{t.classList.toggle("active",t.id===e)}),this.currentSection=e,e){case"overview":this.loadOverview();break;case"reports":this.loadReports();break;case"users":break;case"content":this.loadContent();break;case"actions":this.loadActions();break;case"appeals":this.loadAppeals();break;case"gdpr":this.loadGdprRequests();break;case"parental":this.loadParentalConsents();break;case"admins":this.loadAdmins()}}async loadStats(){try{const{count:e}=await this.supabase.from("content_reports").select("*",{count:"exact",head:!0}).eq("status","pending"),{count:t}=await this.supabase.from("content_reports").select("*",{count:"exact",head:!0}).eq("status","pending").eq("priority","high"),n=(new Date).toISOString().split("T")[0],{count:a}=await this.supabase.from("content_reports").select("*",{count:"exact",head:!0}).eq("status","resolved").gte("resolved_at",n),{count:s}=await this.supabase.from("moderation_actions").select("*",{count:"exact",head:!0}).in("action_type",["suspension_24h","suspension_7d","suspension_30d","ban"]).gt("suspension_until",(new Date).toISOString()),{count:i}=await this.supabase.from("moderation_actions").select("*",{count:"exact",head:!0}).eq("appeal_status","pending"),{count:o}=await this.supabase.from("gdpr_requests").select("*",{count:"exact",head:!0}).eq("status","pending");document.getElementById("statPendingReports").textContent=e||0,document.getElementById("statHighPriority").textContent=t||0,document.getElementById("statResolvedToday").textContent=a||0,document.getElementById("statSuspendedUsers").textContent=s||0,document.getElementById("pendingReportsBadge").textContent=e||0,document.getElementById("pendingAppealsBadge").textContent=i||0,document.getElementById("pendingGdprBadge").textContent=o||0}catch(e){console.error("Error loading stats:",e)}}async loadOverview(){await this.loadStats(),await this.loadRecentActivity()}async loadRecentActivity(){const e=document.getElementById("recentActivityList");try{const{data:t}=await this.supabase.from("content_reports").select("*").order("created_at",{ascending:!1}).limit(5),{data:n}=await this.supabase.from("moderation_actions").select("*").order("created_at",{ascending:!1}).limit(5),a=[...(t||[]).map(e=>({...e,type:"report"})),...(n||[]).map(e=>({...e,type:"action"}))].sort((e,t)=>new Date(t.created_at)-new Date(e.created_at)).slice(0,10);if(0===a.length)return void(e.innerHTML='<p class="mod-empty-state">Nessuna attività recente</p>');e.innerHTML=a.map(e=>this.renderActivityItem(e)).join("")}catch(t){console.error("Error loading activity:",t),e.innerHTML='<p class="mod-empty-state">Errore nel caricamento</p>'}}renderActivityItem(e){const t="report"===e.type,n=t?"report":"warning"===e.action_type?"action":"resolved",a=t?"fa-flag":"fa-gavel",s=t?`Nuova segnalazione: <strong>${this.getCategoryLabel(e.category||e.report_reason)}</strong>`:`Azione: <strong>${this.getActionLabel(e.action_type)}</strong>`;return`\n            <div class="mod-activity-item">\n                <div class="mod-activity-icon ${n}">\n                    <i class="fas ${a}"></i>\n                </div>\n                <div class="mod-activity-content">\n                    <p class="mod-activity-text">${s}</p>\n                    <span class="mod-activity-time">${this.formatTimeAgo(e.created_at)}</span>\n                </div>\n            </div>\n        `}async loadReports(){const e=document.getElementById("reportsList");e.innerHTML='<div class="mod-loading"><i class="fas fa-spinner fa-spin"></i> Caricamento...</div>';try{let t=this.supabase.from("content_reports").select("*").order("created_at",{ascending:!1});"all"!==this.filters.reportStatus&&(t=t.eq("status",this.filters.reportStatus)),"all"!==this.filters.reportCategory&&(t=t.or(`category.eq.${this.filters.reportCategory},report_reason.eq.${this.filters.reportCategory}`)),"all"!==this.filters.reportPriority&&(t=t.eq("priority",this.filters.reportPriority));const{data:n,error:a}=await t.limit(50);if(a)throw a;if(!n||0===n.length)return void(e.innerHTML='<p class="mod-empty-state">Nessuna segnalazione trovata</p>');e.innerHTML=n.map(e=>this.renderReportCard(e)).join(""),this.attachReportActions()}catch(t){console.error("Error loading reports:",t),e.innerHTML='<p class="mod-empty-state">Errore nel caricamento</p>'}}renderReportCard(e){const t=e.category||e.report_reason||"other",n=e.priority||"normal",a="post"===e.reported_content_type?"Post":"comment"===e.reported_content_type?"Commento":e.reported_content_type||"N/A",s={high:"#dc2626",normal:"#f59e0b",low:"#10b981"};return`\n            <div class="mod-report-card" data-report-id="${e.id}" style="border-left: 4px solid ${s[n]||"#6b7280"};">\n                <div class="mod-report-header">\n                    <div class="mod-report-meta">\n                        <span class="mod-report-id" style="font-family: monospace;">#${e.id.substring(0,8)}</span>\n                        <span class="mod-priority-badge ${n}" style="background: ${s[n]}15; color: ${s[n]};">\n                            <i class="fas ${"high"===n?"fa-exclamation-triangle":"low"===n?"fa-arrow-down":"fa-minus"}"></i>\n                            ${this.getPriorityLabel(n)}\n                        </span>\n                        <span class="mod-category-badge">\n                            <i class="${this.getCategoryIcon(t)}"></i>\n                            ${this.getCategoryLabel(t)}\n                        </span>\n                        <span style="background: #e0e7ff; color: #3730a3; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">\n                            <i class="fas ${"post"===e.reported_content_type?"fa-file-alt":"fa-comment"}"></i>\n                            ${a}\n                        </span>\n                    </div>\n                    <span class="mod-status-badge ${e.status}">${this.getStatusLabel(e.status)}</span>\n                </div>\n                <div class="mod-report-body">\n                    ${e.report_description?`\n                        <div class="mod-report-content" style="background: #fef3c7; border-left: 3px solid #f59e0b; padding: 0.75rem; border-radius: 0 8px 8px 0; margin-bottom: 1rem;">\n                            <h4 style="font-size: 0.85rem; color: #92400e; margin-bottom: 0.25rem;">\n                                <i class="fas fa-quote-left"></i> Descrizione segnalazione\n                            </h4>\n                            <p style="color: #78350f; margin: 0;">${this.escapeHtml(e.report_description)}</p>\n                        </div>\n                    `:""}\n                    <div class="mod-report-info">\n                        <div class="mod-info-item">\n                            <span class="mod-info-label">Data segnalazione</span>\n                            <span class="mod-info-value">${this.formatDate(e.created_at)}</span>\n                        </div>\n                        <div class="mod-info-item">\n                            <span class="mod-info-label">ID Contenuto</span>\n                            <span class="mod-info-value" style="font-family: monospace; font-size: 0.8rem;">${e.reported_content_id?.substring(0,12)||"N/A"}...</span>\n                        </div>\n                        ${e.reviewed_at?`\n                            <div class="mod-info-item">\n                                <span class="mod-info-label">Preso in carico</span>\n                                <span class="mod-info-value">${this.formatDate(e.reviewed_at)}</span>\n                            </div>\n                        `:""}\n                        ${e.resolved_at?`\n                            <div class="mod-info-item">\n                                <span class="mod-info-label">Risolto il</span>\n                                <span class="mod-info-value">${this.formatDate(e.resolved_at)}</span>\n                            </div>\n                        `:""}\n                    </div>\n                    <div class="mod-report-actions">\n                        <button class="mod-btn mod-btn-primary" data-action="preview" data-report-id="${e.id}">\n                            <i class="fas fa-eye"></i> Visualizza Contenuto\n                        </button>\n                        ${"pending"===e.status?`\n                            <button class="mod-btn mod-btn-outline" data-action="review" data-report-id="${e.id}" style="color: #3b82f6; border-color: #3b82f6;">\n                                <i class="fas fa-hand-paper"></i> Prendi in carico\n                            </button>\n                        `:""}\n                        ${"pending"===e.status||"reviewing"===e.status?`\n                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #e2e8f0; width: 100%;">\n                                <span style="font-size: 0.75rem; color: #6b7280; width: 100%; margin-bottom: 0.25rem;">Azioni sul contenuto:</span>\n                                <button class="mod-btn mod-btn-warning" data-action="shadowban" data-report-id="${e.id}">\n                                    <i class="fas fa-eye-slash"></i> Shadowban\n                                </button>\n                                <button class="mod-btn mod-btn-danger" data-action="delete-content" data-report-id="${e.id}">\n                                    <i class="fas fa-trash"></i> Elimina\n                                </button>\n                                <button class="mod-btn mod-btn-success" data-action="dismiss" data-report-id="${e.id}">\n                                    <i class="fas fa-check"></i> Respingi\n                                </button>\n                            </div>\n                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #e2e8f0; width: 100%;">\n                                <span style="font-size: 0.75rem; color: #6b7280; width: 100%; margin-bottom: 0.25rem;">Azioni sull'utente:</span>\n                                <button class="mod-btn mod-btn-outline" data-action="warn-user" data-report-id="${e.id}" title="Invia avviso all'utente">\n                                    <i class="fas fa-exclamation-circle"></i> Avviso\n                                </button>\n                                <button class="mod-btn mod-btn-outline" data-action="suspend-user" data-report-id="${e.id}" title="Sospendi utente" style="color: #f59e0b; border-color: #f59e0b;">\n                                    <i class="fas fa-user-clock"></i> Sospendi\n                                </button>\n                                <button class="mod-btn mod-btn-outline" data-action="ban-user" data-report-id="${e.id}" title="Banna utente" style="color: #dc2626; border-color: #dc2626;">\n                                    <i class="fas fa-user-slash"></i> Ban\n                                </button>\n                            </div>\n                        `:""}\n                        ${e.moderator_notes?`\n                            <div style="width: 100%; margin-top: 0.5rem; padding: 0.5rem; background: #f1f5f9; border-radius: 6px; font-size: 0.8rem;">\n                                <strong>Note moderatore:</strong> ${this.escapeHtml(e.moderator_notes)}\n                            </div>\n                        `:""}\n                    </div>\n                </div>\n            </div>\n        `}attachReportActions(){document.querySelectorAll(".mod-report-actions button").forEach(e=>{e.addEventListener("click",t=>{const n=e.dataset.action,a=e.dataset.reportId;this.handleReportAction(n,a)})})}async handleReportAction(e,t){const n=await this.getReport(t);if(n)switch(e){case"preview":await this.showContentPreview(n);break;case"review":await this.takeReportInReview(t);break;case"shadowban":this.showActionModal("shadowban",n);break;case"delete-content":this.showActionModal("delete",n);break;case"dismiss":this.showActionModal("dismiss",n);break;case"warn-user":this.showActionModal("warn",n);break;case"suspend-user":this.showActionModal("suspend",n);break;case"ban-user":this.showActionModal("ban",n)}}async getReport(e){const{data:t}=await this.supabase.from("content_reports").select("*").eq("id",e).single();return t}async takeReportInReview(e){try{await this.supabase.from("content_reports").update({status:"reviewing",reviewed_by:this.currentUser.id,reviewed_at:(new Date).toISOString()}).eq("id",e),this.showNotification('Segnalazione presa in carico - ora visibile in "In revisione"',"success"),this.filters.reportStatus="reviewing";const t=document.getElementById("reportStatusFilter");t&&(t.value="reviewing"),this.loadReports(),this.loadStats()}catch(e){console.error("Error:",e),this.showNotification("Errore","error")}}showActionModal(e,t){const n=document.getElementById("actionModal"),a=document.getElementById("actionModalTitle"),s=document.getElementById("actionModalBody"),i=document.getElementById("actionModalFooter"),o={shadowban:"Shadowban Contenuto",delete:"Elimina Contenuto",dismiss:"Respingi Segnalazione",warn:"Invia Avviso",suspend:"Sospendi Utente",ban:"Banna Utente"};a.textContent=o[e]||"Azione",s.innerHTML=`\n            <div class="mod-form-group">\n                <label class="mod-form-label">Motivo dell'azione</label>\n                <textarea id="actionReason" class="mod-form-textarea" placeholder="Inserisci il motivo..." required></textarea>\n            </div>\n            ${"suspend"===e?'\n                <div class="mod-form-group">\n                    <label class="mod-form-label">Durata sospensione</label>\n                    <select id="suspensionDuration" class="mod-select" style="width: 100%;">\n                        <option value="24h">24 ore</option>\n                        <option value="7d">7 giorni</option>\n                        <option value="30d">30 giorni</option>\n                    </select>\n                </div>\n            ':""}\n            ${"dismiss"===e?'\n                <p style="color: #64748b; font-size: 0.9rem;">\n                    La segnalazione verrà chiusa come "non valida". Il contenuto rimarrà visibile.\n                </p>\n            ':""}\n        `;const r="dismiss"===e?"mod-btn-success":"mod-btn-danger",d="dismiss"===e?"Respingi":"Conferma";i.innerHTML=`\n            <button class="mod-btn mod-btn-outline" onclick="moderationCenter.closeModals()">Annulla</button>\n            <button class="mod-btn ${r}" id="confirmActionBtn">\n                <i class="fas fa-check"></i> ${d}\n            </button>\n        `,document.getElementById("confirmActionBtn").addEventListener("click",()=>{this.executeAction(e,t)}),n.classList.add("active")}async executeAction(e,t){const n=document.getElementById("actionReason")?.value;if(n)try{switch(e){case"shadowban":await this.shadowbanContent(t,n);break;case"delete":await this.deleteContent(t,n);break;case"dismiss":await this.dismissReport(t,n);break;case"warn":await this.warnUser(t,n);break;case"suspend":const e=document.getElementById("suspensionDuration")?.value||"24h";await this.suspendUser(t,n,e);break;case"ban":await this.banUser(t,n)}this.closeModals(),this.loadReports(),this.loadStats()}catch(e){console.error("Error executing action:",e),this.showNotification("Errore nell'esecuzione","error")}else this.showNotification("Inserisci un motivo","warning")}async shadowbanContent(e,t){const n=e.reported_content_type,a=e.reported_content_id,s=(new Date).toISOString();"post"===n?await this.supabase.from("institute_posts").update({shadowbanned:!0,shadowbanned_at:s,shadowbanned_reason:t,published:!1}).eq("id",a):"comment"===n&&await this.supabase.from("post_comments").update({hidden:!0,shadowbanned_at:s,shadowbanned_reason:t}).eq("id",a),await this.logModerationAction(e.reported_user_id,"content_shadowban",t,e.id,n,a),await this.supabase.from("content_reports").update({status:"resolved",resolved_at:(new Date).toISOString(),moderator_notes:`Shadowban: ${t}`}).eq("id",e.id),this.showNotification("Contenuto shadowbannato","success")}async deleteContent(e,t){const n=e.reported_content_type,a=e.reported_content_id;"post"===n?await this.supabase.from("institute_posts").delete().eq("id",a):"comment"===n&&await this.supabase.from("post_comments").delete().eq("id",a),await this.logModerationAction(e.reported_user_id,"content_deleted",t,e.id,n,a),await this.supabase.from("content_reports").update({status:"resolved",resolved_at:(new Date).toISOString(),moderator_notes:`Eliminato: ${t}`}).eq("id",e.id),this.showNotification("Contenuto eliminato","success")}async dismissReport(e,t){await this.supabase.from("content_reports").update({status:"dismissed",resolved_at:(new Date).toISOString(),moderator_notes:t}).eq("id",e.id),this.showNotification("Segnalazione respinta","success")}async warnUser(e,t){await this.logModerationAction(e.reported_user_id,"warning",t,e.id),await this.supabase.from("content_reports").update({status:"resolved",resolved_at:(new Date).toISOString(),moderator_notes:`Avviso inviato: ${t}`}).eq("id",e.id),this.showNotification("Avviso inviato all'utente","success")}async suspendUser(e,t,n){if(!this.permissions.can_ban&&"super_admin"!==this.adminRole&&"admin"!==this.adminRole)return void this.showNotification("Non hai i permessi per sospendere utenti","error");const a={"24h":864e5,"7d":6048e5,"30d":2592e6},s=new Date(Date.now()+a[n]).toISOString(),i=`suspension_${n}`;await this.logModerationAction(e.reported_user_id,i,t,e.id,null,null,s),await this.supabase.from("private_users").update({account_status:"suspended"}).eq("id",e.reported_user_id),await this.supabase.from("content_reports").update({status:"resolved",resolved_at:(new Date).toISOString(),moderator_notes:`Sospeso ${n}: ${t}`}).eq("id",e.id),this.showNotification(`Utente sospeso per ${n}`,"success")}async banUser(e,t){this.permissions.can_ban||"super_admin"===this.adminRole?(await this.logModerationAction(e.reported_user_id,"ban",t,e.id),await this.supabase.from("private_users").update({account_status:"banned"}).eq("id",e.reported_user_id),await this.supabase.from("content_reports").update({status:"resolved",resolved_at:(new Date).toISOString(),moderator_notes:`Bannato: ${t}`}).eq("id",e.id),this.showNotification("Utente bannato permanentemente","success")):this.showNotification("Non hai i permessi per bannare utenti","error")}async logModerationAction(e,t,n,a=null,s=null,i=null,o=null){await this.supabase.from("moderation_actions").insert({user_id:e,moderator_id:this.currentUser.id,action_type:t,reason:n,report_id:a,content_type:s,content_id:i,suspension_until:o,user_notified:!1})}async showContentPreview(e){const t=document.getElementById("contentPreviewModal"),n=document.getElementById("contentPreviewBody");n.innerHTML='<div class="mod-loading"><i class="fas fa-spinner fa-spin"></i> Caricamento...</div>',t.classList.add("active");try{let t=null,a=null;const s=e.reported_content_type,i=e.reported_content_id;if("post"===s){const{data:e}=await this.supabase.from("institute_posts").select("*").eq("id",i).single();if(t=e,t?.author_id){const{data:e}=await this.supabase.from("school_institutes").select("name, logo_url, city, province").eq("id",t.author_id).single();a=e}}else if("comment"===s){const{data:e}=await this.supabase.from("post_comments").select("*").eq("id",i).single();if(t=e,t?.user_id){const{data:e}=await this.supabase.from("private_users").select("first_name, last_name, avatar_url").eq("id",t.user_id).single();a=e}}if(!t)return void(n.innerHTML='\n                    <div style="text-align: center; padding: 2rem;">\n                        <i class="fas fa-trash-alt" style="font-size: 3rem; color: #dc2626; margin-bottom: 1rem;"></i>\n                        <p class="mod-empty-state">Contenuto non trovato o già eliminato</p>\n                    </div>\n                ');let o=[];if(t.images)try{o="string"==typeof t.images?JSON.parse(t.images):t.images}catch(e){o=[]}t.image_url&&!o.includes(t.image_url)&&o.unshift(t.image_url);const r="post"===s?`\n                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; padding: 0.75rem; background: #f1f5f9; border-radius: 8px;">\n                        <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6, #8b5cf6); display: flex; align-items: center; justify-content: center; overflow: hidden;">\n                            ${a?.logo_url?`<img src="${a.logo_url}" style="width: 100%; height: 100%; object-fit: cover;">`:'<i class="fas fa-school" style="color: white;"></i>'}\n                        </div>\n                        <div>\n                            <div style="font-weight: 600; color: #1f2937;">${a?.name||"Istituto"}</div>\n                            ${a?.city?`<div style="font-size: 0.8rem; color: #6b7280;">${a.city}${a.province?`, ${a.province}`:""}</div>`:""}\n                        </div>\n                    </div>\n                `:`\n                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; padding: 0.75rem; background: #f1f5f9; border-radius: 8px;">\n                        <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center; overflow: hidden;">\n                            ${a?.avatar_url?`<img src="${a.avatar_url}" style="width: 100%; height: 100%; object-fit: cover;">`:'<i class="fas fa-user" style="color: white;"></i>'}\n                        </div>\n                        <div>\n                            <div style="font-weight: 600; color: #1f2937;">${a?`${a.first_name||""} ${a.last_name||""}`.trim():"Utente"}</div>\n                            <div style="font-size: 0.8rem; color: #6b7280;">Commento</div>\n                        </div>\n                    </div>\n                `,d=o.length>0?`\n                <div style="margin-top: 1rem;">\n                    <h4 style="font-size: 0.9rem; color: #6b7280; margin-bottom: 0.5rem;">\n                        <i class="fas fa-images"></i> Immagini (${o.length})\n                    </h4>\n                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.5rem;">\n                        ${o.map((e,t)=>`\n                            <div style="position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden; cursor: pointer;" onclick="window.open('${e}', '_blank')">\n                                <img src="${e}" style="width: 100%; height: 100%; object-fit: cover;" alt="Immagine ${t+1}">\n                                <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.7)); padding: 0.5rem; color: white; font-size: 0.75rem;">\n                                    <i class="fas fa-expand"></i> Clicca per ingrandire\n                                </div>\n                            </div>\n                        `).join("")}\n                    </div>\n                </div>\n            `:"",l=`\n                <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">\n                    <h4 style="color: #92400e; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">\n                        <i class="fas fa-flag"></i> Dettagli Segnalazione\n                    </h4>\n                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 0.85rem;">\n                        <div><strong>Motivo:</strong> ${this.getCategoryLabel(e.category||e.report_reason)}</div>\n                        <div><strong>Priorità:</strong> ${this.getPriorityLabel(e.priority||"normal")}</div>\n                        <div><strong>Segnalato il:</strong> ${this.formatDate(e.created_at)}</div>\n                        <div><strong>Stato:</strong> ${this.getStatusLabel(e.status)}</div>\n                    </div>\n                    ${e.report_description?`\n                        <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #fcd34d;">\n                            <strong>Descrizione:</strong>\n                            <p style="margin: 0.25rem 0 0; color: #78350f;">${this.escapeHtml(e.report_description)}</p>\n                        </div>\n                    `:""}\n                </div>\n            `;n.innerHTML=`\n                <div class="mod-preview-content">\n                    ${l}\n                    \n                    <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem;">\n                        ${r}\n                        \n                        ${t.title?`\n                            <h3 style="font-size: 1.25rem; font-weight: 600; color: #1f2937; margin-bottom: 0.75rem;">\n                                ${this.escapeHtml(t.title)}\n                            </h3>\n                        `:""}\n                        \n                        ${t.post_type?`\n                            <span style="display: inline-block; background: #e0e7ff; color: #3730a3; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; margin-bottom: 0.75rem;">\n                                ${t.post_type}\n                            </span>\n                        `:""}\n                        \n                        <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; white-space: pre-wrap; line-height: 1.6; color: #374151;">\n                            ${this.escapeHtml(t.content)}\n                        </div>\n                        \n                        ${d}\n                        \n                        ${t.tags?`\n                            <div style="margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">\n                                ${("string"==typeof t.tags?t.tags.split(","):t.tags).map(e=>`\n                                    <span style="background: #f1f5f9; color: #475569; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">\n                                        #${e.trim()}\n                                    </span>\n                                `).join("")}\n                            </div>\n                        `:""}\n                    </div>\n                    \n                    <div class="mod-report-info" style="margin-bottom: 1rem;">\n                        <div class="mod-info-item">\n                            <span class="mod-info-label">Tipo contenuto</span>\n                            <span class="mod-info-value">${"post"===s?"Post":"Commento"}</span>\n                        </div>\n                        <div class="mod-info-item">\n                            <span class="mod-info-label">ID Contenuto</span>\n                            <span class="mod-info-value" style="font-family: monospace; font-size: 0.8rem;">${i}</span>\n                        </div>\n                        <div class="mod-info-item">\n                            <span class="mod-info-label">Creato il</span>\n                            <span class="mod-info-value">${this.formatDate(t.created_at)}</span>\n                        </div>\n                        ${void 0!==t.likes_count?`\n                            <div class="mod-info-item">\n                                <span class="mod-info-label">Like</span>\n                                <span class="mod-info-value">${t.likes_count||0}</span>\n                            </div>\n                        `:""}\n                        ${void 0!==t.comments_count?`\n                            <div class="mod-info-item">\n                                <span class="mod-info-label">Commenti</span>\n                                <span class="mod-info-value">${t.comments_count||0}</span>\n                            </div>\n                        `:""}\n                    </div>\n                </div>\n                \n                <div class="mod-report-actions" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">\n                    <button class="mod-btn mod-btn-outline" onclick="moderationCenter.closeModals()">\n                        <i class="fas fa-times"></i> Chiudi\n                    </button>\n                    <button class="mod-btn mod-btn-warning" onclick="moderationCenter.closeModals(); moderationCenter.handleReportAction('shadowban', '${e.id}')">\n                        <i class="fas fa-eye-slash"></i> Shadowban\n                    </button>\n                    <button class="mod-btn mod-btn-danger" onclick="moderationCenter.closeModals(); moderationCenter.handleReportAction('delete-content', '${e.id}')">\n                        <i class="fas fa-trash"></i> Elimina Contenuto\n                    </button>\n                    <button class="mod-btn mod-btn-success" onclick="moderationCenter.closeModals(); moderationCenter.handleReportAction('dismiss', '${e.id}')">\n                        <i class="fas fa-check"></i> Respingi Segnalazione\n                    </button>\n                </div>\n            `}catch(e){console.error("Error loading preview:",e),n.innerHTML='<p class="mod-empty-state">Errore nel caricamento</p>'}}async loadGdprRequests(){const e=document.getElementById("gdprList");e.innerHTML='<div class="mod-loading"><i class="fas fa-spinner fa-spin"></i> Caricamento...</div>';try{let t=this.supabase.from("gdpr_requests").select("*").order("created_at",{ascending:!1});"all"!==this.filters.gdprStatus&&(t=t.eq("status",this.filters.gdprStatus)),"all"!==this.filters.gdprType&&(t=t.eq("request_type",this.filters.gdprType));const{data:n,error:a}=await t.limit(50);if(a)throw a;if(!n||0===n.length)return void(e.innerHTML='<p class="mod-empty-state">Nessuna richiesta GDPR</p>');e.innerHTML=n.map(e=>this.renderGdprCard(e)).join("")}catch(t){console.error("Error loading GDPR requests:",t),e.innerHTML='<p class="mod-empty-state">Errore nel caricamento</p>'}}renderGdprCard(e){const t={access:"Accesso dati",rectification:"Rettifica",erasure:"Cancellazione",portability:"Portabilità",objection:"Opposizione",restriction:"Limitazione"};return`\n            <div class="mod-report-card">\n                <div class="mod-report-header">\n                    <div class="mod-report-meta">\n                        <span class="mod-report-id">#${e.id.substring(0,8)}</span>\n                        <span class="mod-category-badge">\n                            <i class="fas fa-user-shield"></i>\n                            ${t[e.request_type]||e.request_type}\n                        </span>\n                    </div>\n                    <span class="mod-status-badge ${e.status}">${this.getStatusLabel(e.status)}</span>\n                </div>\n                <div class="mod-report-body">\n                    <div class="mod-report-info">\n                        <div class="mod-info-item">\n                            <span class="mod-info-label">Email</span>\n                            <span class="mod-info-value">${e.user_email}</span>\n                        </div>\n                        <div class="mod-info-item">\n                            <span class="mod-info-label">Data richiesta</span>\n                            <span class="mod-info-value">${this.formatDate(e.created_at)}</span>\n                        </div>\n                        <div class="mod-info-item">\n                            <span class="mod-info-label">Scadenza</span>\n                            <span class="mod-info-value">${e.deadline_at?this.formatDate(e.deadline_at):"30 giorni"}</span>\n                        </div>\n                    </div>\n                    ${e.request_details?`\n                        <div class="mod-report-content">\n                            <h4>Dettagli</h4>\n                            <p>${this.escapeHtml(e.request_details)}</p>\n                        </div>\n                    `:""}\n                    <div class="mod-report-actions">\n                        ${"pending"===e.status?`\n                            <button class="mod-btn mod-btn-primary" onclick="moderationCenter.processGdprRequest('${e.id}')">\n                                <i class="fas fa-play"></i> Elabora\n                            </button>\n                        `:""}\n                        ${"processing"===e.status?`\n                            <button class="mod-btn mod-btn-success" onclick="moderationCenter.completeGdprRequest('${e.id}')">\n                                <i class="fas fa-check"></i> Completa\n                            </button>\n                        `:""}\n                    </div>\n                </div>\n            </div>\n        `}async processGdprRequest(e){await this.supabase.from("gdpr_requests").update({status:"processing",acknowledged_at:(new Date).toISOString()}).eq("id",e),this.showNotification("Richiesta presa in carico","success"),this.loadGdprRequests(),this.loadStats()}async completeGdprRequest(e){await this.supabase.from("gdpr_requests").update({status:"completed",completed_at:(new Date).toISOString()}).eq("id",e),this.showNotification("Richiesta completata","success"),this.loadGdprRequests(),this.loadStats()}async loadParentalConsents(){const e=document.getElementById("parentalList");e.innerHTML='<div class="mod-loading"><i class="fas fa-spinner fa-spin"></i> Caricamento...</div>';try{let t=this.supabase.from("parental_consents").select("*").order("created_at",{ascending:!1});const n=(new Date).toISOString();"pending"===this.filters.parentalStatus?t=t.eq("status","pending").gt("token_expires_at",n):"approved"===this.filters.parentalStatus?t=t.eq("status","approved"):"denied"===this.filters.parentalStatus?t=t.eq("status","denied"):"expired"===this.filters.parentalStatus&&(t=t.or(`status.eq.expired,and(status.eq.pending,token_expires_at.lt.${n})`));const{data:a,error:s}=await t.limit(50);if(s)throw s;if(!a||0===a.length)return void(e.innerHTML='<p class="mod-empty-state">Nessun consenso parentale trovato</p>');const i=this.calculateParentalStats(a);e.innerHTML=`\n                <div class="mod-parental-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">\n                    <div class="mod-stat-mini" style="background: rgba(251, 191, 36, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">\n                        <div style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;">${i.pending}</div>\n                        <div style="font-size: 0.8rem; color: #92400e;">In Attesa</div>\n                    </div>\n                    <div class="mod-stat-mini" style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">\n                        <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">${i.approved}</div>\n                        <div style="font-size: 0.8rem; color: #065f46;">Approvati</div>\n                    </div>\n                    <div class="mod-stat-mini" style="background: rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">\n                        <div style="font-size: 1.5rem; font-weight: 700; color: #ef4444;">${i.denied}</div>\n                        <div style="font-size: 0.8rem; color: #991b1b;">Rifiutati</div>\n                    </div>\n                    <div class="mod-stat-mini" style="background: rgba(107, 114, 128, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">\n                        <div style="font-size: 1.5rem; font-weight: 700; color: #6b7280;">${i.expired}</div>\n                        <div style="font-size: 0.8rem; color: #374151;">Scaduti</div>\n                    </div>\n                </div>\n                ${a.map(e=>this.renderParentalCard(e)).join("")}\n            `}catch(t){console.error("Error loading parental consents:",t),e.innerHTML='<p class="mod-empty-state">Errore nel caricamento</p>'}}calculateParentalStats(e){const t=new Date;return e.reduce((e,n)=>{const a=new Date(n.token_expires_at)<t,s=n.status||(n.confirmed_at?"approved":a?"expired":"pending");return e[s]=(e[s]||0)+1,e},{pending:0,approved:0,denied:0,expired:0})}renderParentalCard(e){const t=new Date,n=new Date(e.token_expires_at)<t,a=e.status||(e.confirmed_at?"approved":n?"expired":"pending"),s={pending:{label:"In Attesa",class:"pending",icon:"clock"},approved:{label:"Approvato",class:"resolved",icon:"check-circle"},denied:{label:"Rifiutato",class:"dismissed",icon:"times-circle"},expired:{label:"Scaduto",class:"expired",icon:"hourglass-end"},cancelled:{label:"Annullato",class:"dismissed",icon:"ban"}},i=s[a]||s.pending;let o=null;if(e.minor_birth_date){const n=new Date(e.minor_birth_date);o=t.getFullYear()-n.getFullYear();const a=t.getMonth()-n.getMonth();(a<0||0===a&&t.getDate()<n.getDate())&&o--}const r=e.status_history||[],d=r.length>0?`\n            <div class="mod-status-history" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">\n                <h5 style="font-size: 0.85rem; color: #9ca3af; margin-bottom: 0.5rem;">\n                    <i class="fas fa-history"></i> Storico Stati\n                </h5>\n                <div style="font-size: 0.8rem; color: #6b7280;">\n                    ${r.map(e=>`\n                        <div style="padding: 0.25rem 0; display: flex; justify-content: space-between;">\n                            <span>${e.from_status||"nuovo"} → ${e.to_status}</span>\n                            <span>${this.formatDate(e.changed_at)}</span>\n                        </div>\n                    `).join("")}\n                </div>\n            </div>\n        `:"";return`\n            <div class="mod-report-card" style="margin-bottom: 1rem;">\n                <div class="mod-report-header">\n                    <div class="mod-report-meta">\n                        <span class="mod-report-id">#${e.id.substring(0,8)}</span>\n                        <span class="mod-category-badge">\n                            <i class="fas fa-child"></i>\n                            Consenso Parentale\n                        </span>\n                        ${o?`<span class="mod-age-badge" style="background: rgba(59, 130, 246, 0.2); color: #3b82f6; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">${o} anni</span>`:""}\n                    </div>\n                    <span class="mod-status-badge ${i.class}">\n                        <i class="fas fa-${i.icon}"></i> ${i.label}\n                    </span>\n                </div>\n                <div class="mod-report-body">\n                    \x3c!-- Info Minore --\x3e\n                    <div class="mod-section-title" style="font-size: 0.9rem; font-weight: 600; color: #e5e7eb; margin-bottom: 0.75rem;">\n                        <i class="fas fa-user"></i> Dati Minore\n                    </div>\n                    <div class="mod-report-info" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">\n                        <div class="mod-info-item">\n                            <span class="mod-info-label">Nome</span>\n                            <span class="mod-info-value">${e.minor_first_name||"N/A"} ${e.minor_last_name||""}</span>\n                        </div>\n                        <div class="mod-info-item">\n                            <span class="mod-info-label">Email</span>\n                            <span class="mod-info-value">${e.minor_email||"N/A"}</span>\n                        </div>\n                        <div class="mod-info-item">\n                            <span class="mod-info-label">Data Nascita</span>\n                            <span class="mod-info-value">${e.minor_birth_date?this.formatDate(e.minor_birth_date):"N/A"}</span>\n                        </div>\n                        <div class="mod-info-item">\n                            <span class="mod-info-label">Codice Fiscale</span>\n                            <span class="mod-info-value" style="font-family: monospace;">${e.minor_codice_fiscale||"N/A"}</span>\n                        </div>\n                    </div>\n                    \n                    \x3c!-- Info Genitore --\x3e\n                    <div class="mod-section-title" style="font-size: 0.9rem; font-weight: 600; color: #e5e7eb; margin: 1rem 0 0.75rem;">\n                        <i class="fas fa-user-shield"></i> Dati Genitore/Tutore\n                    </div>\n                    <div class="mod-report-info" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">\n                        <div class="mod-info-item">\n                            <span class="mod-info-label">Nome</span>\n                            <span class="mod-info-value">${e.parent_name||"N/A"}</span>\n                        </div>\n                        <div class="mod-info-item">\n                            <span class="mod-info-label">Email</span>\n                            <span class="mod-info-value">${e.parent_email}</span>\n                        </div>\n                    </div>\n                    \n                    \x3c!-- Date --\x3e\n                    <div class="mod-section-title" style="font-size: 0.9rem; font-weight: 600; color: #e5e7eb; margin: 1rem 0 0.75rem;">\n                        <i class="fas fa-calendar"></i> Timeline\n                    </div>\n                    <div class="mod-report-info" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">\n                        <div class="mod-info-item">\n                            <span class="mod-info-label">Richiesto il</span>\n                            <span class="mod-info-value">${this.formatDate(e.created_at)}</span>\n                        </div>\n                        <div class="mod-info-item">\n                            <span class="mod-info-label">Scadenza Token</span>\n                            <span class="mod-info-value ${n?"text-danger":""}">${this.formatDate(e.token_expires_at)}</span>\n                        </div>\n                        ${e.confirmed_at?`\n                            <div class="mod-info-item">\n                                <span class="mod-info-label">Approvato il</span>\n                                <span class="mod-info-value" style="color: #10b981;">${this.formatDate(e.confirmed_at)}</span>\n                            </div>\n                        `:""}\n                        ${e.denied_at?`\n                            <div class="mod-info-item">\n                                <span class="mod-info-label">Rifiutato il</span>\n                                <span class="mod-info-value" style="color: #ef4444;">${this.formatDate(e.denied_at)}</span>\n                            </div>\n                        `:""}\n                        ${e.reminder_count>0?`\n                            <div class="mod-info-item">\n                                <span class="mod-info-label">Promemoria inviati</span>\n                                <span class="mod-info-value">${e.reminder_count}</span>\n                            </div>\n                        `:""}\n                    </div>\n                    \n                    ${e.denial_reason?`\n                        <div class="mod-denial-reason" style="margin-top: 1rem; padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 3px solid #ef4444;">\n                            <strong style="color: #fca5a5;">Motivo rifiuto:</strong>\n                            <p style="margin: 0.5rem 0 0; color: #fecaca;">${this.escapeHtml(e.denial_reason)}</p>\n                        </div>\n                    `:""}\n                    \n                    ${d}\n                    \n                    \x3c!-- Azioni --\x3e\n                    ${"pending"!==a||n?"":`\n                        <div class="mod-report-actions" style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">\n                            <button class="mod-btn mod-btn-outline" onclick="moderationCenter.resendParentalEmail('${e.id}')">\n                                <i class="fas fa-envelope"></i> Reinvia Email\n                            </button>\n                            <button class="mod-btn mod-btn-success" onclick="moderationCenter.approveParentalConsent('${e.id}')">\n                                <i class="fas fa-check"></i> Approva Manualmente\n                            </button>\n                            <button class="mod-btn mod-btn-danger" onclick="moderationCenter.denyParentalConsent('${e.id}')">\n                                <i class="fas fa-times"></i> Rifiuta\n                            </button>\n                        </div>\n                    `}\n                </div>\n            </div>\n        `}async resendParentalEmail(e){try{const{data:t,error:n}=await this.supabase.from("parental_consents").select("*").eq("id",e).single();if(n||!t)return void this.showNotification("Consenso non trovato","error");const a=await fetch(`${window.SUPABASE_URL}/functions/v1/send-parental-consent-email`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${window.SUPABASE_ANON_KEY}`},body:JSON.stringify({minorUserId:t.minor_user_id,parentEmail:t.parent_email,parentName:t.parent_name,minorFirstName:t.minor_first_name,minorLastName:t.minor_last_name,minorEmail:t.minor_email,minorBirthDate:t.minor_birth_date,minorCodiceFiscale:t.minor_codice_fiscale})});a.ok?(await this.supabase.from("parental_consents").update({reminder_sent_at:(new Date).toISOString(),reminder_count:(t.reminder_count||0)+1}).eq("id",e),this.showNotification("Email reinviata con successo","success"),this.loadParentalConsents()):this.showNotification("Errore nell'invio dell'email","error")}catch(e){console.error("Error resending email:",e),this.showNotification("Errore nell'invio dell'email","error")}}async approveParentalConsent(e){if(confirm("Sei sicuro di voler approvare manualmente questo consenso? L'account del minore verrà attivato."))try{const{data:t,error:n}=await this.supabase.from("parental_consents").update({status:"approved",confirmed_at:(new Date).toISOString()}).eq("id",e).select().single();if(n)throw n;t.minor_user_id&&await this.supabase.from("private_users").update({parental_consent_verified:!0,account_status:"active"}).eq("id",t.minor_user_id),this.showNotification("Consenso approvato e account attivato","success"),this.loadParentalConsents()}catch(e){console.error("Error approving consent:",e),this.showNotification("Errore nell'approvazione","error")}}async denyParentalConsent(e){const t=prompt("Inserisci il motivo del rifiuto (opzionale):");if(confirm("Sei sicuro di voler rifiutare questo consenso? L'account del minore non sarà attivato."))try{const{data:n,error:a}=await this.supabase.from("parental_consents").update({status:"denied",denied_at:(new Date).toISOString(),denial_reason:t||null}).eq("id",e).select().single();if(a)throw a;n.minor_user_id&&await this.supabase.from("private_users").update({account_status:"parental_consent_denied"}).eq("id",n.minor_user_id),this.showNotification("Consenso rifiutato","info"),this.loadParentalConsents()}catch(e){console.error("Error denying consent:",e),this.showNotification("Errore nel rifiuto","error")}}async loadAppeals(){const e=document.getElementById("appealsList");e.innerHTML='<div class="mod-loading"><i class="fas fa-spinner fa-spin"></i> Caricamento...</div>';try{let t=this.supabase.from("moderation_actions").select("*").not("appeal_text","is",null).order("appeal_submitted_at",{ascending:!1,nullsFirst:!1});"all"!==this.filters.appealStatus&&(t=t.eq("appeal_status",this.filters.appealStatus));const{data:n,error:a}=await t.limit(50);if(a)throw a;if(!n||0===n.length)return void(e.innerHTML='<p class="mod-empty-state">Nessun appello trovato</p>');e.innerHTML=n.map(e=>this.renderAppealCard(e)).join("")}catch(t){console.error("Error loading appeals:",t),e.innerHTML='<p class="mod-empty-state">Errore nel caricamento</p>'}}renderAppealCard(e){return`\n            <div class="mod-report-card">\n                <div class="mod-report-header">\n                    <div class="mod-report-meta">\n                        <span class="mod-report-id">#${e.id.substring(0,8)}</span>\n                        <span class="mod-category-badge">\n                            <i class="fas fa-gavel"></i>\n                            ${this.getActionLabel(e.action_type)}\n                        </span>\n                    </div>\n                    <span class="mod-status-badge ${e.appeal_status}">${this.getAppealStatusLabel(e.appeal_status)}</span>\n                </div>\n                <div class="mod-report-body">\n                    <div class="mod-report-content">\n                        <h4>Motivo originale</h4>\n                        <p>${this.escapeHtml(e.reason)}</p>\n                    </div>\n                    ${e.appeal_text?`\n                        <div class="mod-report-content">\n                            <h4>Testo appello</h4>\n                            <p>${this.escapeHtml(e.appeal_text)}</p>\n                        </div>\n                    `:""}\n                    <div class="mod-report-info">\n                        <div class="mod-info-item">\n                            <span class="mod-info-label">Data azione</span>\n                            <span class="mod-info-value">${this.formatDate(e.created_at)}</span>\n                        </div>\n                        <div class="mod-info-item">\n                            <span class="mod-info-label">Data appello</span>\n                            <span class="mod-info-value">${e.appeal_submitted_at?this.formatDate(e.appeal_submitted_at):"N/A"}</span>\n                        </div>\n                    </div>\n                    ${"pending"===e.appeal_status?`\n                        <div class="mod-report-actions">\n                            <button class="mod-btn mod-btn-success" onclick="moderationCenter.resolveAppeal('${e.id}', 'approved')">\n                                <i class="fas fa-check"></i> Approva\n                            </button>\n                            <button class="mod-btn mod-btn-danger" onclick="moderationCenter.resolveAppeal('${e.id}', 'rejected')">\n                                <i class="fas fa-times"></i> Respingi\n                            </button>\n                        </div>\n                    `:""}\n                </div>\n            </div>\n        `}async resolveAppeal(e,t){try{const{data:n}=await this.supabase.from("moderation_actions").select("*").eq("id",e).single();if(!n)return void this.showNotification("Azione non trovata","error");await this.supabase.from("moderation_actions").update({appeal_status:t,appeal_resolved_at:(new Date).toISOString(),appeal_response:"approved"===t?"Il tuo ricorso è stato accettato. L'azione è stata annullata.":"Il tuo ricorso è stato esaminato ma non è stato accolto.",user_notified:!1}).eq("id",e),"approved"===t&&("content_shadowban"===n.action_type&&n.content_id&&("post"===n.content_type?await this.supabase.from("institute_posts").update({shadowbanned:!1,shadowbanned_at:null,shadowbanned_reason:null,published:!0}).eq("id",n.content_id):"comment"===n.content_type&&await this.supabase.from("post_comments").update({hidden:!1,shadowbanned_at:null,shadowbanned_reason:null}).eq("id",n.content_id)),["suspension_24h","suspension_7d","suspension_30d","ban"].includes(n.action_type)&&await this.supabase.from("private_users").update({account_status:"active"}).eq("id",n.user_id)),this.showNotification("Appello "+("approved"===t?"approvato":"respinto"),"success"),this.loadAppeals(),this.loadStats()}catch(e){console.error("Error resolving appeal:",e),this.showNotification("Errore","error")}}async loadActions(){const e=document.getElementById("actionsList");e.innerHTML='<div class="mod-loading"><i class="fas fa-spinner fa-spin"></i> Caricamento...</div>';try{const{data:t,error:n}=await this.supabase.from("moderation_actions").select("*").order("created_at",{ascending:!1}).limit(100);if(n)throw n;if(!t||0===t.length)return void(e.innerHTML='<p class="mod-empty-state">Nessuna azione registrata</p>');e.innerHTML=t.map(e=>`\n                <div class="mod-report-card" style="margin-bottom: 0.75rem;">\n                    <div class="mod-report-header">\n                        <div class="mod-report-meta">\n                            <span class="mod-report-id">#${e.id.substring(0,8)}</span>\n                            <span class="mod-category-badge" style="background: ${this.getActionColor(e.action_type)}20; color: ${this.getActionColor(e.action_type)};">\n                                <i class="fas ${this.getActionIcon(e.action_type)}"></i>\n                                ${this.getActionLabel(e.action_type)}\n                            </span>\n                            ${e.content_type?`<span class="mod-category-badge"><i class="fas ${"post"===e.content_type?"fa-newspaper":"fa-comment"}"></i> ${e.content_type}</span>`:""}\n                        </div>\n                        <span class="mod-activity-time">${this.formatDate(e.created_at)}</span>\n                    </div>\n                    <div class="mod-report-body" style="padding: 0.75rem 1rem;">\n                        <p style="margin: 0; color: #475569;">${this.escapeHtml(e.reason||"Nessun motivo specificato")}</p>\n                        <div class="mod-report-info" style="margin-top: 0.75rem;">\n                            ${e.user_id?`\n                                <div class="mod-info-item">\n                                    <span class="mod-info-label">Utente</span>\n                                    <span class="mod-info-value">${e.user_id.substring(0,8)}...</span>\n                                </div>\n                            `:""}\n                            ${e.appeal_status&&"none"!==e.appeal_status?`\n                                <div class="mod-info-item">\n                                    <span class="mod-info-label">Appello</span>\n                                    <span class="mod-info-value mod-status-badge ${e.appeal_status}">${this.getAppealStatusLabel(e.appeal_status)}</span>\n                                </div>\n                            `:""}\n                            ${e.suspension_until?`\n                                <div class="mod-info-item">\n                                    <span class="mod-info-label">Scadenza</span>\n                                    <span class="mod-info-value">${this.formatDate(e.suspension_until)}</span>\n                                </div>\n                            `:""}\n                        </div>\n                    </div>\n                </div>\n            `).join("")}catch(t){console.error("Error loading actions:",t),e.innerHTML='<p class="mod-empty-state">Errore nel caricamento</p>'}}async loadContent(){const e=document.getElementById("contentList");e.innerHTML='<div class="mod-loading"><i class="fas fa-spinner fa-spin"></i> Caricamento...</div>';const t=document.getElementById("contentTypeFilter")?.value||"posts",n=document.getElementById("contentStatusFilter")?.value||"shadowbanned";try{let a=[];if("posts"===t){let e=this.supabase.from("institute_posts").select("*").order("created_at",{ascending:!1}).limit(50);"shadowbanned"===n?e=e.eq("shadowbanned",!0):"visible"===n&&(e=e.or("shadowbanned.is.null,shadowbanned.eq.false"));const{data:t,error:s}=await e;if(s)throw s;const i=t||[];if(i.length>0){const e=[...new Set(i.map(e=>e.institute_id).filter(Boolean))];if(e.length>0){const{data:t}=await this.supabase.from("school_institutes").select("id, institute_name, logo_url").in("id",e),n={};(t||[]).forEach(e=>n[e.id]={name:e.institute_name,logo_url:e.logo_url}),a=i.map(e=>({...e,type:"post",school_institutes:n[e.institute_id]||null}))}else a=i.map(e=>({...e,type:"post",school_institutes:null}))}}else if("comments"===t){let e=this.supabase.from("post_comments").select("*").order("created_at",{ascending:!1}).limit(50);"shadowbanned"===n?e=e.eq("hidden",!0):"visible"===n&&(e=e.or("hidden.is.null,hidden.eq.false"));const{data:t,error:s}=await e;if(s)throw s;const i=t||[];if(i.length>0){const e=[...new Set(i.map(e=>e.user_id).filter(Boolean))],{data:t}=await this.supabase.from("private_users").select("id, first_name, last_name").in("id",e),n={};(t||[]).forEach(e=>n[e.id]=e),a=i.map(e=>({...e,type:"comment",private_users:n[e.user_id]||null}))}}if(0===a.length){const a={shadowbanned:"shadowbannati",visible:"visibili",all:""};return void(e.innerHTML=`<p class="mod-empty-state">Nessun ${"posts"===t?"post":"commento"} ${a[n]} trovato</p>`)}const s=a.map(e=>e.id),{data:i}=await this.supabase.from("moderation_actions").select("*").in("content_id",s).order("created_at",{ascending:!1}),o={};(i||[]).forEach(e=>{o[e.content_id]||(o[e.content_id]=[]),o[e.content_id].push(e)}),e.innerHTML=a.map(e=>this.renderContentCard(e,o[e.id]||[])).join(""),this.attachContentActions()}catch(t){console.error("Error loading content:",t),e.innerHTML='<p class="mod-empty-state">Errore nel caricamento</p>'}}renderContentCard(e,t){const n="post"===e.type,a=n?!0===e.shadowbanned:!0===e.hidden,s=n?e.school_institutes?.name||"Istituto sconosciuto":e.private_users?`${e.private_users.first_name} ${e.private_users.last_name}`:e.school_institutes?.name||"Utente";return`\n            <div class="mod-report-card" data-content-id="${e.id}" data-content-type="${e.type}">\n                <div class="mod-report-header">\n                    <div class="mod-report-meta">\n                        <span class="mod-report-id">#${e.id.substring(0,8)}</span>\n                        <span class="mod-category-badge">\n                            <i class="fas ${n?"fa-newspaper":"fa-comment"}"></i>\n                            ${n?"Post":"Commento"}\n                        </span>\n                        ${a?'<span class="mod-priority-badge high"><i class="fas fa-eye-slash"></i> Shadowban</span>':'<span class="mod-priority-badge low"><i class="fas fa-eye"></i> Visibile</span>'}\n                    </div>\n                    <span class="mod-status-badge ${a?"pending":"resolved"}">${a?"Nascosto":"Pubblico"}</span>\n                </div>\n                <div class="mod-report-body">\n                    <div class="mod-report-content">\n                        <h4>Autore: ${this.escapeHtml(s)}</h4>\n                        ${n&&e.title?`<p><strong>${this.escapeHtml(e.title)}</strong></p>`:""}\n                        <p style="background: #f8fafc; padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem; max-height: 150px; overflow-y: auto;">\n                            ${this.escapeHtml(e.content?.substring(0,500)||"Nessun contenuto")}${e.content?.length>500?"...":""}\n                        </p>\n                    </div>\n                    <div class="mod-report-info">\n                        <div class="mod-info-item">\n                            <span class="mod-info-label">Creato</span>\n                            <span class="mod-info-value">${this.formatDate(e.created_at)}</span>\n                        </div>\n                        ${n?`\n                            <div class="mod-info-item">\n                                <span class="mod-info-label">Likes</span>\n                                <span class="mod-info-value">${e.likes_count||0}</span>\n                            </div>\n                        `:""}\n                        ${a&&e.shadowbanned_at?`\n                            <div class="mod-info-item">\n                                <span class="mod-info-label">Shadowban</span>\n                                <span class="mod-info-value">${this.formatDate(e.shadowbanned_at)}</span>\n                            </div>\n                        `:""}\n                    </div>\n                    ${a&&e.shadowbanned_reason?`\n                        <div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 6px;">\n                            <strong style="color: #ef4444; font-size: 0.8rem;"><i class="fas fa-ban"></i> Motivo shadowban:</strong>\n                            <p style="margin: 0.25rem 0 0; color: #64748b; font-size: 0.875rem;">${this.escapeHtml(e.shadowbanned_reason)}</p>\n                        </div>\n                    `:""}\n                    \n                    ${t.length>0?`\n                        <div class="mod-content-history" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">\n                            <h4 style="font-size: 0.875rem; color: #64748b; margin-bottom: 0.5rem;">\n                                <i class="fas fa-history"></i> Storico Moderazione (${t.length})\n                            </h4>\n                            <div style="max-height: 150px; overflow-y: auto;">\n                                ${t.map(e=>`\n                                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f1f5f9; border-radius: 4px; margin-bottom: 0.25rem; font-size: 0.8rem;">\n                                        <i class="fas ${this.getActionIcon(e.action_type)}" style="color: ${this.getActionColor(e.action_type)};"></i>\n                                        <span style="flex: 1;">${this.getActionLabel(e.action_type)}</span>\n                                        <span style="color: #94a3b8;">${this.formatTimeAgo(e.created_at)}</span>\n                                    </div>\n                                `).join("")}\n                            </div>\n                        </div>\n                    `:""}\n                    \n                    <div class="mod-report-actions" style="margin-top: 1rem;">\n                        ${a?`\n                            <button class="mod-btn mod-btn-success" data-action="restore" data-id="${e.id}" data-type="${e.type}">\n                                <i class="fas fa-undo"></i> Ripristina\n                            </button>\n                            <button class="mod-btn mod-btn-danger" data-action="delete-permanent" data-id="${e.id}" data-type="${e.type}">\n                                <i class="fas fa-trash"></i> Elimina Definitivamente\n                            </button>\n                        `:`\n                            <button class="mod-btn mod-btn-warning" data-action="shadowban" data-id="${e.id}" data-type="${e.type}">\n                                <i class="fas fa-eye-slash"></i> Shadowban\n                            </button>\n                        `}\n                    </div>\n                </div>\n            </div>\n        `}attachContentActions(){document.querySelectorAll(".mod-content-list button[data-action]").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.action,n=e.dataset.id,a=e.dataset.type;this.handleContentAction(t,n,a)})})}async handleContentAction(e,t,n){try{"restore"===e?await this.restoreContent(t,n):"shadowban"===e?await this.shadowbanContentDirect(t,n):"delete-permanent"===e&&confirm("Sei sicuro di voler eliminare definitivamente questo contenuto? Questa azione non può essere annullata.")&&await this.deleteContentPermanent(t,n)}catch(e){console.error("Content action error:",e),this.showNotification("Errore nell'esecuzione","error")}}async restoreContent(e,t){"post"===t?await this.supabase.from("institute_posts").update({shadowbanned:!1,shadowbanned_at:null,shadowbanned_reason:null,published:!0}).eq("id",e):await this.supabase.from("post_comments").update({hidden:!1,shadowbanned_at:null,shadowbanned_reason:null}).eq("id",e),await this.supabase.from("moderation_actions").insert({moderator_id:this.currentUser.id,action_type:"content_restored",reason:"Contenuto ripristinato manualmente",content_type:t,content_id:e}),this.showNotification("Contenuto ripristinato","success"),this.loadContent(),this.loadStats()}async shadowbanContentDirect(e,t){const n=prompt("Motivo dello shadowban:");if(!n)return;const a=(new Date).toISOString();"post"===t?await this.supabase.from("institute_posts").update({shadowbanned:!0,shadowbanned_at:a,shadowbanned_reason:n,published:!1}).eq("id",e):await this.supabase.from("post_comments").update({hidden:!0,shadowbanned_at:a,shadowbanned_reason:n}).eq("id",e);let s=null;if("comment"===t){const{data:t}=await this.supabase.from("post_comments").select("user_id").eq("id",e).single();s=t?.user_id}await this.supabase.from("moderation_actions").insert({user_id:s,moderator_id:this.currentUser.id,action_type:"content_shadowban",reason:n,content_type:t,content_id:e,user_notified:!1}),this.showNotification("Contenuto shadowbannato","success"),this.loadContent(),this.loadStats()}async deleteContentPermanent(e,t){"post"===t?await this.supabase.from("institute_posts").delete().eq("id",e):await this.supabase.from("post_comments").delete().eq("id",e),await this.supabase.from("moderation_actions").insert({moderator_id:this.currentUser.id,action_type:"content_deleted_permanent",reason:"Eliminazione definitiva",content_type:t,content_id:e}),this.showNotification("Contenuto eliminato definitivamente","success"),this.loadContent()}getActionIcon(e){const t={content_deleted:"fa-trash",content_shadowban:"fa-eye-slash",content_restored:"fa-undo",content_deleted_permanent:"fa-trash-alt",warning:"fa-exclamation-triangle",suspension_24h:"fa-clock",suspension_7d:"fa-calendar-week",suspension_30d:"fa-calendar-alt",ban:"fa-ban"};return t[e]||"fa-gavel"}getActionColor(e){const t={content_deleted:"#ef4444",content_shadowban:"#f59e0b",content_restored:"#22c55e",content_deleted_permanent:"#991b1b",warning:"#f59e0b",suspension_24h:"#ef4444",suspension_7d:"#ef4444",suspension_30d:"#dc2626",ban:"#991b1b"};return t[e]||"#64748b"}async searchUsers(e){const t=document.getElementById("usersList");if(!e||e.length<3)t.innerHTML='<p class="mod-empty-state">Inserisci almeno 3 caratteri per cercare</p>';else{t.innerHTML='<div class="mod-loading"><i class="fas fa-spinner fa-spin"></i> Ricerca...</div>';try{const{data:n,error:a}=await this.supabase.from("private_users").select("*").or(`first_name.ilike.%${e}%,last_name.ilike.%${e}%`).limit(20);if(a)throw a;if(!n||0===n.length)return void(t.innerHTML='<p class="mod-empty-state">Nessun utente trovato</p>');t.innerHTML=n.map(e=>`\n                <div class="mod-report-card">\n                    <div class="mod-report-header">\n                        <div class="mod-report-meta">\n                            <span class="mod-report-id">${e.first_name} ${e.last_name}</span>\n                            ${e.is_minor?'<span class="mod-category-badge"><i class="fas fa-child"></i> Minore</span>':""}\n                        </div>\n                        <span class="mod-status-badge ${"active"===e.account_status?"resolved":"pending"}">${e.account_status||"active"}</span>\n                    </div>\n                    <div class="mod-report-body">\n                        <div class="mod-report-info">\n                            <div class="mod-info-item">\n                                <span class="mod-info-label">ID</span>\n                                <span class="mod-info-value">${e.id.substring(0,8)}</span>\n                            </div>\n                            <div class="mod-info-item">\n                                <span class="mod-info-label">Registrato</span>\n                                <span class="mod-info-value">${this.formatDate(e.created_at)}</span>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `).join("")}catch(e){console.error("Error searching users:",e),t.innerHTML='<p class="mod-empty-state">Errore nella ricerca</p>'}}}closeModals(){document.querySelectorAll(".mod-modal").forEach(e=>{e.classList.remove("active")})}showNotification(e,t="info"){const n=document.createElement("div");n.className=`mod-notification mod-notification-${t}`,n.innerHTML=`\n            <i class="fas ${"success"===t?"fa-check-circle":"error"===t?"fa-exclamation-circle":"fa-info-circle"}"></i>\n            <span>${e}</span>\n        `,n.style.cssText=`\n            position: fixed;\n            top: 80px;\n            right: 20px;\n            padding: 1rem 1.5rem;\n            background: ${"success"===t?"#10b981":"error"===t?"#ef4444":"warning"===t?"#f59e0b":"#3b82f6"};\n            color: white;\n            border-radius: 8px;\n            display: flex;\n            align-items: center;\n            gap: 0.75rem;\n            box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n            z-index: 3000;\n            animation: slideIn 0.3s ease;\n        `,document.body.appendChild(n),setTimeout(()=>{n.style.animation="slideOut 0.3s ease",setTimeout(()=>n.remove(),300)},3e3)}getCategoryLabel(e){const t={cyberbullying:"Cyberbullismo",inappropriate:"Contenuto inappropriato",spam:"Spam",privacy:"Violazione privacy",harassment:"Molestie",misinformation:"Informazioni false",other:"Altro",user_report:"Segnalazione utente"};return t[e]||e}getCategoryIcon(e){const t={cyberbullying:"fas fa-user-slash",inappropriate:"fas fa-ban",spam:"fas fa-ad",privacy:"fas fa-user-secret",harassment:"fas fa-angry",misinformation:"fas fa-exclamation-triangle",other:"fas fa-flag"};return t[e]||"fas fa-flag"}getPriorityLabel(e){const t={high:"Alta",normal:"Normale",low:"Bassa"};return t[e]||e}getStatusLabel(e){const t={pending:"In attesa",reviewing:"In revisione",resolved:"Risolto",dismissed:"Respinto",processing:"In elaborazione",completed:"Completato",acknowledged:"Preso in carico"};return t[e]||e}getActionLabel(e){const t={warning:"Avviso",content_removal:"Rimozione contenuto",content_deleted:"Contenuto eliminato",content_shadowban:"Shadowban",content_restored:"Contenuto ripristinato",content_deleted_permanent:"Eliminazione definitiva",suspension_24h:"Sospensione 24h",suspension_7d:"Sospensione 7 giorni",suspension_30d:"Sospensione 30 giorni",ban:"Ban permanente"};return t[e]||e}getAppealStatusLabel(e){const t={none:"Nessuno",pending:"In attesa",approved:"Approvato",rejected:"Respinto"};return t[e]||e}formatDate(e){return e?new Date(e).toLocaleDateString("it-IT",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}):"N/A"}formatTimeAgo(e){const t=new Date(e),n=new Date,a=Math.floor((n-t)/1e3);return a<60?"Ora":a<3600?`${Math.floor(a/60)} min fa`:a<86400?`${Math.floor(a/3600)} ore fa`:a<604800?`${Math.floor(a/86400)} giorni fa`:this.formatDate(e)}escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}async loadAdmins(){const e=document.getElementById("adminsList");if(e){e.innerHTML='<div class="mod-loading"><i class="fas fa-spinner fa-spin"></i> Caricamento...</div>';try{const{data:t,error:n}=await this.supabase.from("admin_users").select("*").order("created_at",{ascending:!1});if(n)throw n;if(!t||0===t.length)return void(e.innerHTML='<p class="mod-empty-state">Nessun amministratore configurato</p>');const a=await Promise.all(t.map(async e=>{const{data:t}=await this.supabase.from("private_users").select("first_name, last_name, avatar_url").eq("id",e.user_id).single(),{data:n}=await this.supabase.from("school_institutes").select("email, name").eq("id",e.user_id).single();return{...e,userDetails:t||null,instituteDetails:n||null}}));e.innerHTML=a.map(e=>this.renderAdminCard(e)).join("")}catch(t){console.error("Error loading admins:",t),e.innerHTML='<p class="mod-empty-state">Errore nel caricamento</p>'}}}renderAdminCard(e){const t={super_admin:"Super Admin",admin:"Amministratore",moderator:"Moderatore"},n={super_admin:"#dc2626",admin:"#2563eb",moderator:"#059669"},a={super_admin:"fa-crown",admin:"fa-user-shield",moderator:"fa-user-check"},s=e.user_id===this.currentUser?.id,i=e.userDetails,o=e.instituteDetails,r=i?`${i.first_name||""} ${i.last_name||""}`.trim():o?.name||"Utente",d=i?.avatar_url,l=o?.email||"",c=r.split(" ").map(e=>e[0]).join("").substring(0,2).toUpperCase()||"AD";return`\n            <div class="mod-report-card" style="border-left: 4px solid ${n[e.role]};">\n                <div class="mod-report-header">\n                    <div class="mod-report-meta" style="display: flex; align-items: center; gap: 1rem;">\n                        <div style="width: 48px; height: 48px; border-radius: 50%; background: ${d?"transparent":`linear-gradient(135deg, ${n[e.role]}, ${n[e.role]}99)`}; display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;">\n                            ${d?`<img src="${d}" style="width: 100%; height: 100%; object-fit: cover;" alt="${r}">`:`<span style="color: white; font-weight: 600; font-size: 1rem;">${c}</span>`}\n                        </div>\n                        <div>\n                            <div style="font-weight: 600; font-size: 1rem; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">\n                                ${r}\n                                ${s?'<span style="font-size: 0.7rem; background: #3b82f6; color: white; padding: 2px 6px; border-radius: 4px;">Tu</span>':""}\n                            </div>\n                            ${l?`<div style="font-size: 0.85rem; color: #6b7280;">${l}</div>`:""}\n                        </div>\n                    </div>\n                    <span class="mod-status-badge" style="background: ${n[e.role]}15; color: ${n[e.role]}; display: flex; align-items: center; gap: 0.5rem;">\n                        <i class="fas ${a[e.role]}"></i>\n                        ${t[e.role]||e.role}\n                    </span>\n                </div>\n                <div class="mod-report-body">\n                    <div class="mod-report-info">\n                        <div class="mod-info-item">\n                            <span class="mod-info-label">User ID</span>\n                            <span class="mod-info-value" style="font-family: monospace; font-size: 0.8rem;">${e.user_id}</span>\n                        </div>\n                        <div class="mod-info-item">\n                            <span class="mod-info-label">Aggiunto il</span>\n                            <span class="mod-info-value">${this.formatDate(e.created_at)}</span>\n                        </div>\n                        <div class="mod-info-item">\n                            <span class="mod-info-label">Permessi</span>\n                            <span class="mod-info-value">\n                                ${e.permissions?.can_ban?'<i class="fas fa-ban" title="Può bannare" style="color: #dc2626; margin-right: 4px;"></i>':""}\n                                ${e.permissions?.can_delete_content?'<i class="fas fa-trash" title="Può eliminare contenuti" style="color: #f59e0b; margin-right: 4px;"></i>':""}\n                                ${e.permissions?.can_manage_gdpr?'<i class="fas fa-user-shield" title="Gestione GDPR" style="color: #3b82f6; margin-right: 4px;"></i>':""}\n                                ${e.permissions?.can_manage_admins?'<i class="fas fa-users-cog" title="Gestione Admin" style="color: #8b5cf6; margin-right: 4px;"></i>':""}\n                            </span>\n                        </div>\n                    </div>\n                    ${s?"":`\n                        <div class="mod-report-actions">\n                            <select class="mod-select" id="roleSelect-${e.id}" style="margin-right: 0.5rem;">\n                                <option value="moderator" ${"moderator"===e.role?"selected":""}>Moderatore</option>\n                                <option value="admin" ${"admin"===e.role?"selected":""}>Amministratore</option>\n                                <option value="super_admin" ${"super_admin"===e.role?"selected":""}>Super Admin</option>\n                            </select>\n                            <button class="mod-btn mod-btn-primary" onclick="moderationCenter.updateAdminRole('${e.id}')">\n                                <i class="fas fa-save"></i> Salva\n                            </button>\n                            <button class="mod-btn mod-btn-danger" onclick="moderationCenter.removeAdmin('${e.id}')">\n                                <i class="fas fa-trash"></i> Rimuovi\n                            </button>\n                        </div>\n                    `}\n                </div>\n            </div>\n        `}async addAdmin(){const e=document.getElementById("newAdminEmail"),t=document.getElementById("newAdminRole"),n=e?.value?.trim(),a=t?.value;if(n)try{const{data:t,error:s}=await this.supabase.from("auth.users").select("id").eq("email",n).single();let i=t?.id;if(!i){const{data:e}=await this.supabase.rpc("get_user_id_by_email",{user_email:n});i=e}if(!i)return void this.showNotification("Utente non trovato con questa email","error");const{error:o}=await this.supabase.from("admin_users").insert({user_id:i,role:a,created_by:this.currentUser.id,permissions:this.getDefaultPermissions(a)});if(o){if("23505"!==o.code)throw o;return void this.showNotification("Questo utente è già un amministratore","warning")}this.showNotification("Amministratore aggiunto con successo","success"),e.value="",this.loadAdmins()}catch(e){console.error("Error adding admin:",e),this.showNotification("Errore nell'aggiunta dell'amministratore","error")}else this.showNotification("Inserisci un'email valida","warning")}getDefaultPermissions(e){const t={super_admin:{can_view_reports:!0,can_moderate:!0,can_ban:!0,can_manage_admins:!0,can_delete_content:!0,can_manage_gdpr:!0},admin:{can_view_reports:!0,can_moderate:!0,can_ban:!0,can_manage_admins:!1,can_delete_content:!0,can_manage_gdpr:!0},moderator:{can_view_reports:!0,can_moderate:!0,can_ban:!1,can_manage_admins:!1,can_delete_content:!0,can_manage_gdpr:!1}};return t[e]||t.moderator}async updateAdminRole(e){const t=document.getElementById(`roleSelect-${e}`),n=t?.value;if(n)try{const{error:t}=await this.supabase.from("admin_users").update({role:n,permissions:this.getDefaultPermissions(n),updated_at:(new Date).toISOString()}).eq("id",e);if(t)throw t;this.showNotification("Ruolo aggiornato","success"),this.loadAdmins()}catch(e){console.error("Error updating admin:",e),this.showNotification("Errore nell'aggiornamento","error")}}async removeAdmin(e){if(confirm("Sei sicuro di voler rimuovere questo amministratore?"))try{const{error:t}=await this.supabase.from("admin_users").delete().eq("id",e);if(t)throw t;this.showNotification("Amministratore rimosso","success"),this.loadAdmins()}catch(e){console.error("Error removing admin:",e),this.showNotification("Errore nella rimozione","error")}}}const style=document.createElement("style");style.textContent="\n    @keyframes slideIn {\n        from { transform: translateX(100%); opacity: 0; }\n        to { transform: translateX(0); opacity: 1; }\n    }\n    @keyframes slideOut {\n        from { transform: translateX(0); opacity: 1; }\n        to { transform: translateX(100%); opacity: 0; }\n    }\n",document.head.appendChild(style);const moderationCenter=new ModerationCenter;