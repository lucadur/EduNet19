"use strict";class AdminManager{constructor(){this.supabase=null,this.currentUser=null,this.currentInstitute=null,this.admins=[],this.pendingInvites=[],this.maxAdmins=3,this.initialized=!1,this.initPromise=this.init()}async init(){console.log("üöÄ [AdminManager] Inizializzazione...");let i=0;for(;!window.eduNetAuth&&i<100;)await new Promise(i=>setTimeout(i,100)),i++;if(window.eduNetAuth){for(this.supabase=window.eduNetAuth.supabase,console.log("‚úÖ [AdminManager] Supabase disponibile"),i=0;!window.eduNetAuth.isAuthenticated()&&i<100;)await new Promise(i=>setTimeout(i,100)),i++;this.currentUser=window.eduNetAuth.getCurrentUser(),this.currentUser?(console.log("‚úÖ [AdminManager] Utente autenticato:",this.currentUser.email),await this.loadCurrentInstitute(),this.initialized=!0,console.log("‚úÖ [AdminManager] Inizializzato completamente")):console.warn("‚ö†Ô∏è [AdminManager] Utente non autenticato")}else console.error("‚ùå [AdminManager] eduNetAuth non disponibile")}async waitForInit(){return await this.initPromise,this.initialized}async loadCurrentInstitute(){console.log("üîç [AdminManager] Caricamento istituto per utente:",this.currentUser.id);try{const{data:i,error:t}=await this.supabase.rpc("get_admin_institute",{p_user_id:this.currentUser.id});if(t)throw console.error("‚ùå [AdminManager] Errore RPC get_admin_institute:",t),t;this.currentInstitute=i,console.log("üìã [AdminManager] Istituto caricato:",this.currentInstitute),this.currentInstitute?(await this.loadAdmins(),await this.loadPendingInvites()):console.warn("‚ö†Ô∏è [AdminManager] Nessun istituto trovato per questo utente")}catch(i){console.error("‚ùå [AdminManager] Errore caricamento istituto:",i)}}async loadAdmins(){if(this.currentInstitute)try{const{data:i,error:t}=await this.supabase.from("institute_admins_view").select("*").eq("institute_id",this.currentInstitute).eq("status","active").order("created_at",{ascending:!0});if(t)throw t;this.admins=i||[],console.log(`üìã Caricati ${this.admins.length} admin`)}catch(i){console.error("Errore caricamento admin:",i),this.admins=[]}}async loadPendingInvites(){if(this.currentInstitute)try{const{data:i,error:t}=await this.supabase.from("institute_admin_invites").select("*").eq("institute_id",this.currentInstitute).eq("accepted",!1).gt("expires_at",(new Date).toISOString()).order("created_at",{ascending:!1});if(t)throw t;this.pendingInvites=i||[],console.log(`üì® Caricati ${this.pendingInvites.length} inviti in sospeso`)}catch(i){console.error("Errore caricamento inviti:",i),this.pendingInvites=[]}}async canManageAdmins(){if(!this.currentInstitute)return!1;try{const{data:i,error:t}=await this.supabase.rpc("can_manage_admins",{p_user_id:this.currentUser.id,p_institute_id:this.currentInstitute});if(t)throw t;return!0===i}catch(i){return console.error("Errore verifica permessi:",i),!1}}canAddMoreAdmins(){return this.admins.length<this.maxAdmins}async inviteAdmin(i,t="admin"){if(!this.currentInstitute)throw new Error("Nessun istituto associato");if(!this.canAddMoreAdmins())throw new Error("Limite massimo di 3 amministratori raggiunto");if(!this.validateEmail(i))throw new Error("Email non valida");if(this.admins.some(t=>t.email&&t.email.toLowerCase()===i.toLowerCase()))throw new Error("Questo utente √® gi√† amministratore");if(this.pendingInvites.some(t=>t.email&&t.email.toLowerCase()===i.toLowerCase()))throw new Error("Invito gi√† inviato a questa email");try{const{data:n,error:e}=await this.supabase.rpc("invite_institute_admin",{p_institute_id:this.currentInstitute,p_email:i.toLowerCase(),p_role:t});if(e)throw e;return await this.loadPendingInvites(),console.log("‚úÖ Invito inviato con successo"),n}catch(i){throw console.error("Errore invio invito:",i),i}}async acceptInvite(i){try{const{data:t,error:n}=await this.supabase.rpc("accept_admin_invite",{p_token:i,p_user_id:this.currentUser.id});if(n)throw n;return console.log("‚úÖ Invito accettato con successo"),await this.loadCurrentInstitute(),!0}catch(i){throw console.error("Errore accettazione invito:",i),i}}async removeAdmin(i){if(!await this.canManageAdmins())throw new Error("Non hai i permessi per rimuovere amministratori");try{const{data:t,error:n}=await this.supabase.rpc("remove_institute_admin",{p_admin_id:i,p_removed_by:this.currentUser.id});if(n)throw n;return await this.loadAdmins(),console.log("‚úÖ Admin rimosso con successo"),!0}catch(i){throw console.error("Errore rimozione admin:",i),i}}async cancelInvite(i){if(!await this.canManageAdmins())throw new Error("Non hai i permessi per cancellare inviti");try{const{error:t}=await this.supabase.from("institute_admin_invites").delete().eq("id",i);if(t)throw t;return await this.loadPendingInvites(),console.log("‚úÖ Invito cancellato"),!0}catch(i){throw console.error("Errore cancellazione invito:",i),i}}async updateAdminPermissions(i,t){if(!await this.canManageAdmins())throw new Error("Non hai i permessi per modificare gli amministratori");try{const{error:n}=await this.supabase.from("institute_admins").update({permissions:t}).eq("id",i);if(n)throw n;return await this.loadAdmins(),console.log("‚úÖ Permessi aggiornati"),!0}catch(i){throw console.error("Errore aggiornamento permessi:",i),i}}getCurrentAdminRole(){const i=this.admins.find(i=>i.user_id===this.currentUser.id);return i?.role||null}getCurrentAdminPermissions(){const i=this.admins.find(i=>i.user_id===this.currentUser.id);return i?.permissions||{}}isOwner(){return"owner"===this.getCurrentAdminRole()}validateEmail(i){const t=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;return t.test(i)}generateInviteLink(i){const t=window.location.origin;return`${t}/accept-invite.html?token=${i}`}renderAdminList(i){const t=document.getElementById(i);t&&(0!==this.admins.length?t.innerHTML=this.admins.map(i=>`\n      <div class="admin-card" data-admin-id="${i.id}">\n        <div class="admin-avatar">\n          ${i.avatar_url?`<img src="${i.avatar_url}" alt="${i.first_name} ${i.last_name}">`:`<div class="avatar-placeholder">${this.getInitials(i.first_name,i.last_name)}</div>`}\n        </div>\n        <div class="admin-info">\n          <div class="admin-name">${i.first_name} ${i.last_name}</div>\n          <div class="admin-email">${i.email}</div>\n          <div class="admin-role">\n            <span class="role-badge role-${i.role}">${this.getRoleLabel(i.role)}</span>\n          </div>\n        </div>\n        <div class="admin-actions">\n          ${"owner"!==i.role&&this.isOwner()?`\n            <button class="btn-icon btn-danger" onclick="adminManager.confirmRemoveAdmin('${i.id}')">\n              <i class="fas fa-trash"></i>\n            </button>\n          `:""}\n        </div>\n      </div>\n    `).join(""):t.innerHTML='\n        <div class="empty-state">\n          <i class="fas fa-users"></i>\n          <p>Nessun amministratore</p>\n        </div>\n      ')}renderPendingInvites(i){const t=document.getElementById(i);t&&(0!==this.pendingInvites.length?t.innerHTML=this.pendingInvites.map(i=>`\n      <div class="invite-card" data-invite-id="${i.id}">\n        <div class="invite-info">\n          <div class="invite-email">${i.email}</div>\n          <div class="invite-meta">\n            <span class="role-badge role-${i.role}">${this.getRoleLabel(i.role)}</span>\n            <span class="invite-date">Inviato ${this.formatDate(i.created_at)}</span>\n            <span class="invite-expires">Scade ${this.formatDate(i.expires_at)}</span>\n          </div>\n        </div>\n        <div class="invite-actions">\n          <button class="btn-icon btn-secondary" onclick="adminManager.copyInviteLink('${i.token}')">\n            <i class="fas fa-link"></i>\n          </button>\n          <button class="btn-icon btn-danger" onclick="adminManager.confirmCancelInvite('${i.id}')">\n            <i class="fas fa-times"></i>\n          </button>\n        </div>\n      </div>\n    `).join(""):t.innerHTML='\n        <div class="empty-state">\n          <i class="fas fa-envelope"></i>\n          <p>Nessun invito in sospeso</p>\n        </div>\n      ')}async confirmRemoveAdmin(i){const t=this.admins.find(t=>t.id===i);if(t&&confirm(`Sei sicuro di voler rimuovere ${t.first_name} ${t.last_name} come amministratore?`))try{await this.removeAdmin(i),this.showNotification("Amministratore rimosso con successo","success"),this.renderAdminList("admin-list")}catch(i){this.showNotification(i.message,"error")}}async confirmCancelInvite(i){if(confirm("Sei sicuro di voler cancellare questo invito?"))try{await this.cancelInvite(i),this.showNotification("Invito cancellato","success"),this.renderPendingInvites("pending-invites")}catch(i){this.showNotification(i.message,"error")}}async copyInviteLink(i){const t=this.generateInviteLink(i);try{await navigator.clipboard.writeText(t),this.showNotification("Link copiato negli appunti","success")}catch(i){const n=document.createElement("textarea");n.value=t,document.body.appendChild(n),n.select(),document.execCommand("copy"),document.body.removeChild(n),this.showNotification("Link copiato negli appunti","success")}}getInitials(i,t){return`${i?.[0]||""}${t?.[0]||""}`.toUpperCase()}getRoleLabel(i){const t={owner:"Proprietario",admin:"Amministratore",editor:"Editor"};return t[i]||i}formatDate(i){const t=new Date(i),n=new Date,e=n-t,a=Math.floor(e/864e5);return 0===a?"oggi":1===a?"ieri":a<7?`${a} giorni fa`:t.toLocaleDateString("it-IT")}showNotification(i,t="info"){window.eduNetHomepage&&window.eduNetHomepage.showNotification?window.eduNetHomepage.showNotification(i,t):alert(i)}}"undefined"!=typeof window&&(window.AdminManager=AdminManager,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.adminManager=new AdminManager}):window.adminManager=new AdminManager);