class TwoFactorAuth{constructor(){this.supabase=null,this.init()}async init(){window.supabaseClientManager&&(this.supabase=await window.supabaseClientManager.getClient())}async generateSecret(){try{const{data:{user:e}}=await this.supabase.auth.getUser();if(!e)throw new Error("Utente non autenticato");const{data:r,error:t}=await this.supabase.rpc("generate_2fa_secret",{p_user_id:e.id});if(t)throw console.error("Errore RPC generate_2fa_secret:",t),t;return{secret:r.secret,qrCodeUrl:r.qr_code_url,backupCodes:r.backup_codes}}catch(e){throw console.error("Errore generazione secret 2FA:",e),e}}async verifyCode(e){try{const{data:{user:r}}=await this.supabase.auth.getUser();if(!r)throw new Error("Utente non autenticato");const{data:t,error:a}=await this.supabase.rpc("verify_2fa_code",{p_user_id:r.id,p_code:e});if(a)throw a;return t}catch(e){throw console.error("Errore verifica codice 2FA:",e),e}}async enable2FA(e){try{const{data:{user:r}}=await this.supabase.auth.getUser();if(!r)throw new Error("Utente non autenticato");const t=await this.verifyCode(e);if(!t)throw new Error("Codice di verifica non valido");const{error:a}=await this.supabase.from("user_2fa").update({is_enabled:!0}).eq("user_id",r.id);if(a)throw a;return!0}catch(e){throw console.error("Errore attivazione 2FA:",e),e}}async disable2FA(e){try{const{data:{user:r}}=await this.supabase.auth.getUser();if(!r)throw new Error("Utente non autenticato");const{error:t}=await this.supabase.auth.signInWithPassword({email:r.email,password:e});if(t)throw new Error("Password errata");const{error:a}=await this.supabase.from("user_2fa").update({is_enabled:!1}).eq("user_id",r.id);if(a)throw a;return!0}catch(e){throw console.error("Errore disattivazione 2FA:",e),e}}async is2FAEnabled(){try{const{data:{user:e}}=await this.supabase.auth.getUser();if(!e)return!1;const{data:r,error:t}=await this.supabase.from("user_2fa").select("is_enabled").eq("user_id",e.id).maybeSingle();if(t)throw t;return r?.is_enabled||!1}catch(e){return console.error("Errore verifica stato 2FA:",e),!1}}async verifyBackupCode(e){try{const{data:{user:r}}=await this.supabase.auth.getUser();if(!r)throw new Error("Utente non autenticato");const{data:t,error:a}=await this.supabase.rpc("verify_backup_code",{p_user_id:r.id,p_code:e});if(a)throw a;return t}catch(e){throw console.error("Errore verifica backup code:",e),e}}generateQRCodeImage(e){return new Promise((r,t)=>{const a=new Image;a.onload=()=>r(a),a.onerror=t,a.src=e})}formatSecret(e){return e.match(/.{1,4}/g).join(" ")}downloadBackupCodes(e){const r=`EduNet19 - Codici di Backup 2FA\n    \n⚠️ IMPORTANTE: Conserva questi codici in un luogo sicuro!\n\nOgni codice può essere utilizzato una sola volta per accedere al tuo account se non hai accesso all'app di autenticazione.\n\nCodici di Backup:\n${e.map((e,r)=>`${r+1}. ${e}`).join("\n")}\n\nData generazione: ${(new Date).toLocaleString("it-IT")}\n`,t=new Blob([r],{type:"text/plain"}),a=URL.createObjectURL(t),o=document.createElement("a");o.href=a,o.download=`edunet19-backup-codes-${Date.now()}.txt`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a)}}window.twoFactorAuth=new TwoFactorAuth;