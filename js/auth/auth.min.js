class EduNetAuth{constructor(){this.supabase=null,this.currentUser=null,this.userProfile=null,this.isInitialized=!1,this.init()}initialize(){return this.init()}async init(){try{if(this.supabase=await window.supabaseClientManager.getClient(),!this.supabase)return void console.warn("‚ö†Ô∏è Client Supabase non disponibile");this.supabase.auth.onAuthStateChange((e,t)=>{this.handleAuthStateChange(e,t)});const{data:{session:e}}=await this.supabase.auth.getSession();e&&(this.currentUser=e.user,await this.loadUserProfile(e.user)),this.isInitialized=!0,console.log("‚úÖ Supabase inizializzato correttamente")}catch(e){console.error("‚ùå Errore inizializzazione Supabase:",e),this.showNotification("Errore di connessione al servizio","error")}}async handleAuthStateChange(e,t){if(console.log("Auth state changed:",e,t),"SIGNED_IN"!==e&&"INITIAL_SESSION"!==e||!t?.user)"SIGNED_OUT"===e&&(this.currentUser=null,this.userProfile=null,this.isLoadingProfile=!1,sessionStorage.removeItem("edunet_login_notification_shown"),this.showNotification("Disconnessione effettuata","info"),window.location.pathname.includes("homepage.html")&&setTimeout(()=>{window.location.href=window.AppConfig.getPageUrl("index.html")},1e3));else{if(this.currentUser?.id===t.user.id&&this.userProfile)return void console.log("‚úÖ Profilo gi√† caricato per questo utente, skip");if(this.isLoadingProfile)return void console.log("‚è≥ Caricamento profilo gi√† in corso, skip");this.isLoadingProfile=!0,this.currentUser=t.user,"SIGNED_IN"===e&&await this.handlePendingProfile(t.user);try{if(console.log("üîÑ [handleAuthStateChange] Chiamo loadUserProfile per:",t.user.id),await this.loadUserProfile(t.user),await this.syncUserPreferences(t.user.id),console.log("‚úÖ [handleAuthStateChange] loadUserProfile completata, userProfile:",!!this.userProfile),!this.userProfile)return console.error("‚ùå [handleAuthStateChange] Profilo utente non caricato, logout in corso"),await this.supabase.auth.signOut(),this.showNotification("Errore nel caricamento del profilo. Riprova ad accedere.","error"),void(this.isLoadingProfile=!1)}catch(e){return console.error("‚ùå [handleAuthStateChange] Errore nel caricamento del profilo:",e),await this.supabase.auth.signOut(),this.showNotification("Errore nel caricamento del profilo. Riprova ad accedere.","error"),void(this.isLoadingProfile=!1)}if(this.isLoadingProfile=!1,"SIGNED_IN"===e){const e=sessionStorage.getItem("edunet_login_notification_shown");e||(this.showNotification("Accesso effettuato con successo!","success"),sessionStorage.setItem("edunet_login_notification_shown","true"));const t=window.AppConfig&&"function"==typeof window.AppConfig.getBasePath?window.AppConfig.getBasePath():"/",i=window.location.pathname.endsWith("/")?window.location.pathname:`${window.location.pathname}/`,o=window.location.pathname.includes("index.html")||i===t;o&&setTimeout(()=>{window.location.href=window.AppConfig.getPageUrl("homepage.html")},1e3)}this.closeAllModals()}}async handlePendingProfile(e){try{const t=localStorage.getItem("pendingProfile");if(t){const i=JSON.parse(t);if(i.userId===e.id){console.log("üìù Creazione profilo pendente per utente:",e.id,"tipo:",i.userType);const{data:t}=await this.supabase.from("user_profiles").select("id, user_type").eq("id",e.id).single();if(t){if(console.log("üìã Profilo utente gi√† esistente, tipo attuale:",t.user_type),t.user_type!==i.userType){console.log("üîÑ Aggiornamento user_type da",t.user_type,"a",i.userType);const{error:o}=await this.supabase.from("user_profiles").update({user_type:i.userType}).eq("id",e.id);o?console.error("‚ùå Errore aggiornamento user_type:",o):console.log("‚úÖ user_type aggiornato con successo")}}else await this.createUserProfile(e,i.userType);if("istituto"===i.userType&&i.instituteData){const{data:t}=await this.supabase.from("school_institutes").select("id").eq("id",e.id).single();if(t)console.log("Dati istituto gi√† esistenti, skip creazione");else{const{error:t}=await this.supabase.from("school_institutes").insert([{id:e.id,...i.instituteData}]);t&&console.error("Errore creazione dati istituto pendenti:",t)}}else if("privato"===i.userType&&i.privateData){const{data:t}=await this.supabase.from("private_users").select("id").eq("id",e.id).single();if(t)console.log("Dati utente privato gi√† esistenti, skip creazione");else{const{error:t}=await this.supabase.from("private_users").insert([{id:e.id,...i.privateData}]);t&&console.error("Errore creazione dati utente privato pendenti:",t)}}localStorage.removeItem("pendingProfile"),console.log("Profilo pendente gestito con successo")}}}catch(e){console.error("Errore nella gestione del profilo pendente:",e),localStorage.removeItem("pendingProfile")}}async registerInstitute(e){try{if(window.rateLimiter&&!window.rateLimiter.checkAndNotify("register",e.email))return{success:!1,error:"Troppi tentativi di registrazione. Riprova tra qualche minuto."};if(this.showLoading("Registrazione in corso..."),console.log("üìã Dati form ricevuti:",e),console.log("üìã Campi obbligatori:",{instituteName:e.instituteName,instituteType:e.instituteType,email:e.email,password:e.password?"***":void 0,instituteCodeMiur:e.instituteCodeMiur||e.instituteCode,registrantName:e.registrantName,registrantRole:e.registrantRole}),!(e.instituteName&&e.instituteType&&e.email&&e.password))throw console.error("‚ùå Validazione fallita. Campi mancanti:",{instituteName:!e.instituteName,instituteType:!e.instituteType,email:!e.email,password:!e.password}),new Error("Tutti i campi obbligatori devono essere compilati");if(!e.registrantName||!e.registrantRole)throw new Error("Inserisci il tuo nome e ruolo nell'istituto");if(e.password!==e.confirmPassword)throw new Error("Le password non coincidono");if(e.password.length<8)throw new Error("La password deve essere di almeno 8 caratteri");const t=e.instituteCodeMiur||e.instituteCode||null,i=e.instituteEmailMiur||null,o=e.email,r="pending_verification",a=t?{codice_meccanografico:t,institute_name:e.instituteName,institute_type:e.instituteType,email:i,address:e.instituteAddress||null,city:e.instituteCity||null,province:e.instituteProvince||null,website:e.instituteWebsite||null,verified_from_miur:!0,registration_date:(new Date).toISOString()}:null;console.log("üìã Codice Meccanografico MIUR:",t),console.log("üìã Email Account (login):",o),console.log("üìã Email MIUR (verifica):",i),console.log("üìã Registrante:",e.registrantName,"-",e.registrantRole);const{data:s,error:n}=await this.supabase.auth.signUp({email:o,password:e.password,options:{data:{user_type:"istituto",institute_name:e.instituteName,institute_type:e.instituteType,institute_code:t,registrant_name:e.registrantName,registrant_role:e.registrantRole}}});if(n)throw n;if(s.user){const n={institute_name:e.instituteName,institute_type:e.instituteType,institute_code:t,email:i||o,email_miur:i,email_account:o,address:e.instituteAddress||null,city:e.instituteCity||null,province:e.instituteProvince||null,website:e.instituteWebsite||null,phone:e.institutePhone||null,miur_data:a,verification_status:r,registrant_name:e.registrantName,registrant_role:e.registrantRole,verified:!1};if(localStorage.setItem("pendingProfile",JSON.stringify({userId:s.user.id,userType:"istituto",instituteData:n})),s.user.email_confirmed_at)try{console.log("üìù Creazione profilo istituto...");const{data:t,error:o}=await this.supabase.from("school_institutes").insert([{id:s.user.id,...n}]).select().single();if(o)throw console.error("‚ùå Errore creazione istituto:",o),o;console.log("‚úÖ Istituto creato:",t);const{data:r,error:a}=await this.supabase.rpc("create_institute_owner",{p_institute_id:s.user.id,p_user_id:s.user.id});a?console.error("‚ùå Errore creazione owner:",a):console.log("‚úÖ Owner creato con successo"),await this.sendAdminInvites(s.user.id,e),i&&await this.sendInstituteVerificationEmail(s.user.id,n),localStorage.removeItem("pendingProfile")}catch(e){console.error("‚ùå Errore creazione profilo:",e),console.warn("‚ö†Ô∏è Profilo verr√† creato al primo login")}else localStorage.setItem("pendingProfile",JSON.stringify({userId:s.user.id,userType:"istituto",instituteData:n}));let l="Registrazione completata! Controlla la tua email per confermare l'account.";return i&&(l="Registrazione completata! Controlla la tua email per confermare l'account. Invieremo anche una richiesta di verifica all'email ufficiale dell'istituto."),this.showNotification(l,"success"),{success:!0,user:s.user}}}catch(e){return console.error("Errore registrazione istituto:",e),window.eduNetErrorHandler?window.eduNetErrorHandler.handle(e,"Institute Registration"):this.showNotification(e.message||"Errore durante la registrazione","error"),{success:!1,error:e.message}}finally{this.hideLoading()}}async registerPrivateUser(e){try{if(window.rateLimiter&&!window.rateLimiter.checkAndNotify("register",e.email))return{success:!1,error:"Troppi tentativi di registrazione. Riprova tra qualche minuto."};if(this.showLoading("Registrazione in corso..."),!(e.firstName&&e.lastName&&e.email&&e.password))throw new Error("Tutti i campi obbligatori devono essere compilati");if(e.password!==e.confirmPassword)throw new Error("Le password non coincidono");if(e.password.length<8)throw new Error("La password deve essere di almeno 8 caratteri");if(!e.birthDate)throw new Error("La data di nascita √® obbligatoria");if(!e.codiceFiscale)throw new Error("Il Codice Fiscale √® obbligatorio per verificare la tua identit√†");const t=e.codiceFiscale.toUpperCase().trim();if(!window.codiceFiscaleValidator)throw console.error("Codice Fiscale validator not loaded"),new Error("Errore di sistema: validatore CF non disponibile. Ricarica la pagina.");const i=window.codiceFiscaleValidator.validateForRegistration(t,e.firstName,e.lastName,e.birthDate);if(console.log("üìã Validazione CF:",i),!i.canRegister){const e=i.errors.length>0?i.errors.join(". "):"Codice Fiscale non valido";throw new Error(e)}const o=i.age;console.log(`üìã Et√† estratta dal CF: ${o} anni, categoria: ${i.ageCategory}`);const r=o<18,a=i.requiresParentalConsent||!1,s=i.requiresMinorDeclaration||!1;if(a){if(!e.parentEmail||!e.parentName)throw new Error("Per utenti tra 14 e 16 anni √® richiesto il consenso parentale. Inserisci i dati del genitore/tutore.");const t=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!t.test(e.parentEmail))throw new Error("Inserisci un'email valida per il genitore/tutore");if(e.parentEmail.toLowerCase()===e.email.toLowerCase())throw new Error("L'email del genitore deve essere diversa dalla tua email")}if(s&&!e.minorConsent)throw new Error("Devi dichiarare di avere il consenso dei tuoi genitori per procedere");const{data:n,error:l}=await this.supabase.auth.signUp({email:e.email,password:e.password,options:{data:{user_type:"privato",first_name:e.firstName,last_name:e.lastName,birth_date:e.birthDate,codice_fiscale:t,is_minor:r}}});if(l)throw l;if(n.user){const i={id:n.user.id,first_name:e.firstName,last_name:e.lastName,birth_date:e.birthDate,codice_fiscale:t,codice_fiscale_verified:!0,codice_fiscale_verified_at:(new Date).toISOString(),privacy_level:r?"privato":"pubblico",is_minor:r,parental_consent_required:a,parental_consent_verified:!1,account_status:a?"pending_parental_consent":"active"};if(n.user.email_confirmed_at)try{await this.createUserProfile(n.user,"privato");const{error:o}=await this.supabase.from("private_users").insert([i]);o&&console.error("Errore creazione dati utente privato:",o),a&&await this.sendParentalConsentEmail(n.user.id,e.parentEmail,e.parentName,e.firstName,e.lastName,e.email,e.birthDate,t)}catch(o){console.warn("Profilo utente verr√† creato al primo login:",o),localStorage.setItem("pendingProfile",JSON.stringify({userId:n.user.id,userType:"privato",privateData:i,parentalConsent:a?{parentEmail:e.parentEmail,parentName:e.parentName,minorFirstName:e.firstName,minorLastName:e.lastName,minorEmail:e.email,minorBirthDate:e.birthDate,minorCodiceFiscale:t}:null}))}else localStorage.setItem("pendingProfile",JSON.stringify({userId:n.user.id,userType:"privato",privateData:i,parentalConsent:a?{parentEmail:e.parentEmail,parentName:e.parentName,minorFirstName:e.firstName,minorLastName:e.lastName,minorEmail:e.email,minorBirthDate:e.birthDate,minorCodiceFiscale:t}:null}));let o="Registrazione completata! Controlla la tua email per confermare l'account.";return a&&(o="Registrazione completata! Abbiamo inviato un'email al tuo genitore/tutore per confermare il consenso. Il tuo account sar√† attivo dopo la conferma."),this.showNotification(o,"success"),{success:!0,user:n.user,requiresParentalConsent:a}}}catch(e){return console.error("Errore registrazione utente privato:",e),window.eduNetErrorHandler?window.eduNetErrorHandler.handle(e,"Private User Registration"):this.showNotification(e.message||"Errore durante la registrazione","error"),{success:!1,error:e.message}}finally{this.hideLoading()}}async sendParentalConsentEmail(e,t,i,o,r,a,s,n){try{const l=await fetch(`${window.SUPABASE_URL}/functions/v1/send-parental-consent-email`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${window.SUPABASE_ANON_KEY}`},body:JSON.stringify({minorUserId:e,parentEmail:t,parentName:i,minorFirstName:o,minorLastName:r,minorEmail:a,minorBirthDate:s,minorCodiceFiscale:n})}),c=await l.json();return l.ok?console.log("‚úÖ Email consenso parentale inviata:",c):console.error("Errore invio email consenso parentale:",c),c}catch(e){return console.error("Errore chiamata Edge Function:",e),{success:!1,error:e.message}}}async sendInstituteVerificationEmail(e,t){try{const{data:i,error:o}=await this.supabase.rpc("generate_verification_token",{p_institute_id:e});if(o)return console.error("‚ùå Errore generazione token verifica:",o),{success:!1,error:o.message};if(console.log("üìã Token verifica generato:",i),!t.email_miur)return console.warn("‚ö†Ô∏è Nessuna email MIUR disponibile per verifica"),{success:!1,error:"Email MIUR non disponibile"};const r=await fetch(`${window.SUPABASE_URL}/functions/v1/send-institute-verification-email`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${window.SUPABASE_ANON_KEY}`},body:JSON.stringify({instituteId:e,instituteName:t.institute_name,instituteCode:t.institute_code,emailMiur:t.email_miur,registrantName:t.registrant_name,registrantRole:t.registrant_role,emailAccount:t.email_account,verificationToken:i?.token})}),a=await r.json();return r.ok?console.log("‚úÖ Email verifica istituto inviata:",a):console.error("‚ùå Errore invio email verifica istituto:",a),a}catch(e){return console.error("‚ùå Errore chiamata Edge Function verifica istituto:",e),{success:!1,error:e.message}}}validateAgeSimple(e){const t=new Date,i=new Date(e);let o=t.getFullYear()-i.getFullYear();const r=t.getMonth()-i.getMonth();return(r<0||0===r&&t.getDate()<i.getDate())&&o--,o<14?{valid:!1,error:"Devi avere almeno 14 anni per registrarti"}:{valid:!0,age:o,isMinor:o<18,requiresParentalConsent:o<16,requiresMinorConsent:o>=16&&o<18}}async createParentalConsentRequest(e,t,i,o){try{const o=this.generateConsentToken(),r=new Date;r.setHours(r.getHours()+48);const{error:a}=await this.supabase.from("parental_consents").insert([{minor_user_id:e,parent_email:t,parent_name:i,consent_token:o,token_expires_at:r.toISOString()}]);if(a)return void console.error("Errore creazione richiesta consenso parentale:",a);const s=window.AppConfig.getPageUrl(`pages/legal/parental-consent.html?token=${o}`);console.log("Link conferma consenso parentale:",s),console.log("Da inviare a:",t)}catch(e){console.error("Errore nel processo di consenso parentale:",e)}}generateConsentToken(){const e=new Uint8Array(32);return crypto.getRandomValues(e),Array.from(e,e=>e.toString(16).padStart(2,"0")).join("")}async login(e,t){try{if(window.rateLimiter&&!window.rateLimiter.checkAndNotify("login",e))return{success:!1,error:"Troppi tentativi di accesso. Riprova tra qualche minuto."};if(this.showLoading("Accesso in corso..."),!e||!t)throw new Error("Email e password sono obbligatori");const i=async()=>await this.supabase.auth.signInWithPassword({email:e,password:t});let o,r;if(window.networkUtils){const e=await window.networkUtils.withRetry(i,{maxRetries:2,baseDelay:1e3,retryOn:e=>window.networkUtils.isRetryableError(e)});o=e.data,r=e.error}else{const e=await i();o=e.data,r=e.error}if(r)throw r;if(o.user){let{data:e,error:t}=await this.supabase.from("user_profiles").select("id").eq("id",o.user.id).maybeSingle();if(!e){console.log("üîç Profilo non in user_profiles, verifico school_institutes...");const{data:t,error:i}=await this.supabase.from("school_institutes").select("id").eq("id",o.user.id).maybeSingle();t?(console.log("‚úÖ Profilo istituto trovato:",t.id),e=t):i&&"PGRST116"!==i.code&&console.error("Errore verifica istituto:",i)}if(t&&"PGRST116"!==t.code&&console.error("Errore verifica profilo:",t),!e)throw console.warn("Profilo non trovato in nessuna tabella per:",o.user.id),await this.supabase.auth.signOut(),new Error("Account non completamente configurato. Contatta l'assistenza.");return console.log("‚úÖ Profilo verificato, procedo con login"),{success:!0,user:o.user}}}catch(e){console.error("Errore login:",e);let t="Errore durante l'accesso";return e.message.includes("Invalid login credentials")?t="Email o password non corretti":e.message.includes("Email not confirmed")?t="Devi confermare la tua email prima di accedere":e.message.includes("Too many requests")?t="Troppi tentativi di accesso. Riprova pi√π tardi":(e.message.includes("Profilo utente non trovato")||e.message.includes("Account non completamente configurato"))&&(t=e.message),window.eduNetErrorHandler?window.eduNetErrorHandler.handle(e,"User Login"):this.showNotification(t,"error"),{success:!1,error:t}}finally{this.hideLoading()}}async logout(){try{this.showLoading("Disconnessione in corso...");const{error:e}=await this.supabase.auth.signOut();if(e)throw e;return{success:!0}}catch(e){return console.error("Errore logout:",e),this.showNotification("Errore durante la disconnessione","error"),{success:!1,error:e.message}}finally{this.hideLoading()}}async loadUserProfile(e){try{console.log("üîÑ Caricamento profilo per utente:",e.id);const t=e.user_metadata||{},i=t.user_type||null;console.log("üìã Metadata utente:",t),console.log("üìã Tipo utente atteso dai metadata:",i);let{data:o,error:r}=await this.supabase.from("user_profiles").select("*").eq("id",e.id).maybeSingle();if(r&&"PGRST116"!==r.code&&console.error("Errore nel caricamento profilo base:",r),o){if(console.log("‚úÖ Profilo base caricato, user_type nel DB:",o.user_type),"privato"===i&&"istituto"===o.user_type&&(console.log("‚ö†Ô∏è CORREZIONE: Metadata dicono privato, DB dice istituto. Correggo..."),o.user_type="privato",this.supabase.from("user_profiles").update({user_type:"privato"}).eq("id",e.id).then(({error:e})=>{e?console.error("‚ùå Errore aggiornamento user_type:",e):console.log("‚úÖ user_type corretto nel DB")})),"istituto"===o.user_type){console.log("üè´ Caricamento dati istituto aggiuntivi...");const{data:t,error:i}=await this.supabase.from("school_institutes").select("*").eq("id",e.id).maybeSingle();console.log("üîç DEBUG ISTITUTO:",t);const{data:r}=await this.supabase.from("private_users").select("*").eq("id",e.id).maybeSingle();console.log("üîç DEBUG PRIVATE_USERS:",r),t&&(o.instituteData=t);let a=t&&t.institute_type&&t.institute_name;if(r&&(console.log("‚úÖ Utente trovato in private_users - √® un utente privato!"),a=!1),a&&t.institute_name){const e=["liceo","istituto","scuola","comprensivo","tecnico","professionale","universit√†","politecnico","accademia","conservatorio"],i=t.institute_name.toLowerCase(),o=e.some(e=>i.includes(e));if(!o&&!t.codice_meccanografico&&!t.institute_code){const e=["Scuola dell'Infanzia","Scuola Primaria","Scuola Secondaria","Liceo","Istituto Tecnico","Istituto Professionale","ITS","Universit√†"],i=e.some(e=>t.institute_type?.toLowerCase().includes(e.toLowerCase()));i?console.log("‚úÖ Tipo istituto valido, accetto:",t.institute_type):(console.warn("‚ö†Ô∏è Nome istituto non sembra una scuola reale:",t.institute_name),a=!1)}}if(!a){console.warn("‚ö†Ô∏è Dati istituto incompleti o invalidi. Verifico se √® un utente privato...");let i=!1,a=null;if(r)i=!0,a=r,console.log("‚úÖ Dati utente privato trovati:",a);else{console.log("üîç Controllo metadata utente per conferma tipo...");const t=this.currentUser?.user_metadata;if(!t||"istituto"!==t.user_type&&"istituto"!==t.type)!t||"privato"!==t.user_type&&"privato"!==t.type?(console.warn("‚ö†Ô∏è Nessun metadata chiaro sul tipo utente. Assumo privato."),i=!0,a={id:e.id,first_name:"Utente",last_name:""}):(console.log("‚úÖ Metadata conferma utente privato:",t),i=!0,a={id:e.id,first_name:t.first_name||t.name||"Utente",last_name:t.last_name||t.surname||""});else{console.log("‚úÖ Metadata confermano ISTITUTO - creo dati mancanti in school_institutes");const r={id:e.id,institute_name:t.institute_name||t.instituteName||"Istituto",institute_type:t.institute_type||t.instituteType||"Istituto Scolastico",institute_code:t.institute_code||t.instituteCode||null,verified:!(!t.institute_code&&!t.instituteCode)};console.log("üìù Creazione dati istituto:",r),this.supabase.from("school_institutes").upsert([r],{onConflict:"id"}).then(({error:e})=>{e?console.error("‚ùå Errore creazione school_institutes:",e):console.log("‚úÖ Record school_institutes creato dai metadata")}),o.instituteData=r,o.institute_name=r.institute_name,o.institute_type=r.institute_type,i=!1}}i?(console.log("‚úÖ Identificato come utente privato. Correggo tipo."),o.user_type="privato",o.privateData=a,o.first_name=a.first_name,o.last_name=a.last_name,this.supabase.from("user_profiles").update({user_type:"privato"}).eq("id",e.id).then(({error:e})=>{e?console.error("‚ùå Errore aggiornamento user_type:",e):console.log("‚úÖ user_type aggiornato a privato nel DB")}),!r&&a&&this.supabase.from("private_users").upsert([{id:e.id,first_name:a.first_name,last_name:a.last_name,privacy_level:"pubblico"}],{onConflict:"id"}).then(({error:e})=>{e?console.error("‚ùå Errore creazione private_users:",e):console.log("‚úÖ Record private_users creato")}),t&&!t.codice_meccanografico&&this.supabase.from("school_institutes").delete().eq("id",e.id).then(({error:e})=>{e?console.error("‚ùå Errore rimozione school_institutes zombie:",e):console.log("‚úÖ Record school_institutes zombie rimosso")})):console.warn("‚ö†Ô∏è Utente non trovato in private_users e metadata non conclusivi. ID:",e.id)}}else if("privato"===o.user_type){const t=e.user_metadata||{};if("istituto"===t.user_type){console.log("üè´ CORREZIONE: DB dice privato ma metadata dicono ISTITUTO!"),console.log("üìã Metadata istituto:",t),o.user_type="istituto",this.supabase.from("user_profiles").update({user_type:"istituto"}).eq("id",e.id).then(({error:e})=>{e?console.error("‚ùå Errore aggiornamento user_type:",e):console.log("‚úÖ user_type corretto a istituto nel DB")});const{data:i}=await this.supabase.from("school_institutes").select("*").eq("id",e.id).maybeSingle();if(i)console.log("‚úÖ Dati istituto gi√† esistenti:",i.institute_name),o.instituteData=i,o.institute_name=i.institute_name;else{console.log("üìù Creo dati istituto dai metadata...");const i={id:e.id,institute_name:t.institute_name||"Istituto",institute_type:t.institute_type||"Istituto Scolastico",institute_code:t.institute_code||null,verified:!!t.institute_code},{data:r,error:a}=await this.supabase.from("school_institutes").insert([i]).select().single();a?(console.error("‚ùå Errore creazione school_institutes:",a),o.instituteData=i,o.institute_name=i.institute_name):(console.log("‚úÖ Dati istituto creati:",r),o.instituteData=r,o.institute_name=r.institute_name)}this.supabase.from("private_users").delete().eq("id",e.id).then(({error:e})=>{e||console.log("üóëÔ∏è Dati private_users errati rimossi")})}else{console.log("üë§ Caricamento dati utente privato...");const{data:i,error:r}=await this.supabase.from("private_users").select("*").eq("id",e.id).maybeSingle();if(i)console.log("üë§ Dati utente privato caricati:",i),o.privateData=i,o.first_name=i.first_name,o.last_name=i.last_name;else if(console.warn("‚ö†Ô∏è Dati privato non trovati in private_users."),t.first_name||t.last_name){console.log("üìã Recupero dati dai metadata:",t);const i={id:e.id,first_name:t.first_name||"Utente",last_name:t.last_name||"",privacy_level:"pubblico"},{data:r,error:a}=await this.supabase.from("private_users").insert([i]).select().single();a?(console.error("‚ùå Errore creazione dati utente privato:",a),o.privateData=i,o.first_name=i.first_name,o.last_name=i.last_name):(console.log("‚úÖ Dati utente privato creati:",r),o.privateData=r,o.first_name=r.first_name,o.last_name=r.last_name)}else{console.log("üìß Creo dati utente privato con default...");const t={id:e.id,first_name:"Utente",last_name:"",privacy_level:"pubblico"},{data:i,error:r}=await this.supabase.from("private_users").insert([t]).select().single();r?(console.warn("‚ö†Ô∏è Impossibile creare dati in private_users:",r.message),o.privateData=t,o.first_name=t.first_name,o.last_name=t.last_name):(console.log("‚úÖ Dati utente privato creati dall'email:",i),o.privateData=i,o.first_name=i.first_name,o.last_name=i.last_name)}}}}else{const{data:t,error:i}=await this.supabase.from("school_institutes").select("*").eq("id",e.id).maybeSingle();i&&"PGRST116"!==i.code&&console.error("Errore caricamento istituto:",i),t&&(o={id:t.id,user_type:"istituto",first_name:t.institute_name,last_name:"",email:t.email,avatar_url:t.logo_url,institute_name:t.institute_name,institute_type:t.institute_type,verified:t.verified,instituteData:t},console.log("‚úÖ Profilo istituto caricato:",o.institute_name))}if(!o)return console.log("‚ö†Ô∏è Profilo non trovato, creazione in corso..."),void await this.createUserProfile(e);try{const{data:e,error:t}=await this.supabase.rpc("get_collaborator_profile");!t&&e&&e.is_collaborator&&(console.log("üë• Utente √® un COLLABORATORE!",e),o.is_collaborator=!0,o.collaborator_data=e,o.collaborator_role=e.role,o.collaborator_institute_id=e.institute_id,e.first_name&&"Collaboratore"!==e.first_name&&(o.first_name=e.first_name,o.last_name=e.last_name||""),"admin"!==e.role&&"editor"!==e.role||(o.can_manage_institute=!0,o.managed_institute_id=e.institute_id,o.managed_institute_name=e.institute_name,o.managed_institute_type=e.institute_type),console.log("‚úÖ Profilo collaboratore configurato:",{name:`${o.first_name} ${o.last_name}`,role:e.role,institute:e.institute_name}))}catch(e){console.warn("‚ö†Ô∏è Errore controllo collaboratore (non bloccante):",e)}this.userProfile=o,console.log("‚úÖ Profilo caricato:",o.user_type,o.is_collaborator?"(collaboratore)":"")}catch(e){console.error("Errore caricamento profilo:",e),this.showNotification("Errore nel caricamento del profilo","error")}}async syncUserPreferences(e){try{console.log("üîÑ Syncing user preferences for:",e);const{data:t,error:i}=await this.supabase.from("user_profiles").select("preferences").eq("id",e).maybeSingle();if(i)return void console.warn("‚ö†Ô∏è Error fetching user preferences:",i);if(t&&t.preferences)if(console.log("üé® Found preferences in DB:",t.preferences),window.EduNetPrefs&&"function"==typeof window.EduNetPrefs.save)window.EduNetPrefs.save(t.preferences),console.log("‚úÖ Global preferences updated from DB");else{const e=JSON.parse(localStorage.getItem("edunet_settings")||"{}"),i={...e,...t.preferences};localStorage.setItem("edunet_settings",JSON.stringify(i)),console.log("‚úÖ LocalStorage preferences updated from DB (fallback)")}else console.log("‚ÑπÔ∏è No preferences found in DB for this user")}catch(e){console.error("‚ùå Unexpected error syncing preferences:",e)}}async createUserProfile(e,t=null){try{console.log("üÜï Creazione nuovo profilo per utente:",e.id,"tipo:",t),t||(t="privato");const{data:i,error:o}=await this.supabase.from("user_profiles").insert([{id:e.id,user_type:t,email_verified:!!e.email_confirmed_at}]).select().single();if(o)throw console.error("‚ùå Errore creazione profilo base:",o),o;return console.log("‚úÖ Profilo base creato:",i),this.userProfile=i,i}catch(e){throw console.error("‚ùå Errore creazione profilo:",e),this.showNotification("Errore nella creazione del profilo","error"),e}}async resetPassword(e){try{if(this.showLoading("Invio email di reset..."),!e)throw new Error("Email √® obbligatoria");const{error:t}=await this.supabase.auth.resetPasswordForEmail(e,{redirectTo:window.AppConfig.getPageUrl("reset-password.html")});if(t)throw t;return this.showNotification("Email di reset inviata! Controlla la tua casella di posta.","success"),{success:!0}}catch(e){return console.error("Errore reset password:",e),this.showNotification(e.message||"Errore durante il reset della password","error"),{success:!1,error:e.message}}finally{this.hideLoading()}}async updateProfile(e){try{if(this.showLoading("Aggiornamento profilo..."),!this.currentUser)throw new Error("Utente non autenticato");const{error:t}=await this.supabase.from("user_profiles").update({profile_completed:!0,updated_at:(new Date).toISOString()}).eq("id",this.currentUser.id);if(t)throw t;if("istituto"===this.userProfile?.user_type){const{error:t}=await this.supabase.from("school_institutes").update({...e,updated_at:(new Date).toISOString()}).eq("id",this.currentUser.id);if(t)throw t}else if("privato"===this.userProfile?.user_type){const{error:t}=await this.supabase.from("private_users").update({...e,updated_at:(new Date).toISOString()}).eq("id",this.currentUser.id);if(t)throw t}return await this.loadUserProfile(this.currentUser),this.showNotification("Profilo aggiornato con successo!","success"),{success:!0}}catch(e){return console.error("Errore aggiornamento profilo:",e),this.showNotification(e.message||"Errore durante l'aggiornamento","error"),{success:!1,error:e.message}}finally{this.hideLoading()}}showNotification(e,t="info"){const i=document.querySelectorAll(".auth-notification");i.forEach(e=>e.remove());const o=document.createElement("div");o.className=`auth-notification auth-notification-${t}`,o.innerHTML=`\n            <div class="auth-notification-content">\n                <i class="fas ${this.getNotificationIcon(t)}"></i>\n                <span>${e}</span>\n                <button class="auth-notification-close" aria-label="Chiudi notifica">\n                    <i class="fas fa-times"></i>\n                </button>\n            </div>\n        `,document.body.appendChild(o);const r=()=>{o.classList.add("fade-out"),setTimeout(()=>{o.parentElement&&o.remove()},300)},a=o.querySelector(".auth-notification-close");a&&a.addEventListener("click",r),setTimeout(r,4e3)}getNotificationIcon(e){const t={success:"fa-check-circle",error:"fa-exclamation-circle",warning:"fa-exclamation-triangle",info:"fa-info-circle"};return t[e]||t.info}showLoading(e="Caricamento..."){const t=document.querySelector(".auth-loader");t&&t.remove();const i=document.createElement("div");i.className="auth-loader",i.innerHTML=`\n            <div class="auth-loader-content">\n                <div class="auth-loader-spinner"></div>\n                <p>${e}</p>\n            </div>\n        `,document.body.appendChild(i)}hideLoading(){const e=document.querySelector(".auth-loader");e&&e.remove()}closeAllModals(){const e=document.querySelectorAll(".modal.show");e.forEach(e=>{const t=bootstrap.Modal.getInstance(e);t&&t.hide()})}getCurrentUser(){return this.currentUser}getUserProfile(){return this.userProfile}isAuthenticated(){return!!this.currentUser}getUserType(){return this.userProfile?.user_type||null}isInstitute(){return"istituto"===this.getUserType()}isPrivateUser(){return"privato"===this.getUserType()}isProfileCompleted(){return this.userProfile?.profile_completed||!1}isEmailVerified(){return!!this.currentUser?.email_confirmed_at}async sendAdminInvites(e,t){const i=[];if(t.admin1Email&&t.admin1Email.trim()&&i.push(t.admin1Email.trim().toLowerCase()),t.admin2Email&&t.admin2Email.trim()&&i.push(t.admin2Email.trim().toLowerCase()),0!==i.length){console.log(`üì® Invio ${i.length} inviti admin...`);for(const t of i)try{const{error:i}=await this.supabase.rpc("invite_institute_admin",{p_institute_id:e,p_email:t,p_invited_by:e,p_role:"admin"});i?console.error(`Errore invio invito a ${t}:`,i):console.log(`‚úÖ Invito inviato a ${t}`)}catch(e){console.error(`Errore invio invito a ${t}:`,e)}}}}window.eduNetAuth=new EduNetAuth;