class EduNetPasswordReset{constructor(){this.supabase=null,this.init()}async init(){this.supabase=await window.supabaseClientManager.getClient(),this.supabase||console.warn("⚠️ Client Supabase non disponibile per PasswordReset"),this.handleUrlParams()}handleUrlParams(){const e=new URLSearchParams(window.location.search),o=e.get("type"),s=e.get("token");"recovery"===o&&s?this.handlePasswordReset(s):"email_confirmation"===o&&s&&this.handleEmailConfirmation(s)}async sendPasswordResetEmail(e){try{if(!this.supabase)throw new Error("Supabase non inizializzato");if(!e||!this.isValidEmail(e))throw new Error("Inserisci un indirizzo email valido");this.showLoading("Invio email di reset...");const{error:o}=await this.supabase.auth.resetPasswordForEmail(e,{redirectTo:window.AppConfig.getPageUrl("reset-password.html")});if(o)throw o;return this.showNotification("Email di reset inviata! Controlla la tua casella di posta e segui le istruzioni.","success"),{success:!0}}catch(e){return console.error("Errore invio email reset:",e),window.eduNetErrorHandler?window.eduNetErrorHandler.handle(e,"Password Reset Email"):this.showNotification("Errore nell'invio dell'email. Riprova più tardi.","error"),{success:!1,error:e.message}}finally{this.hideLoading()}}async handlePasswordReset(e){try{const{error:o}=await this.supabase.auth.verifyOtp({token_hash:e,type:"recovery"});if(o)throw o;this.showPasswordResetForm()}catch(e){console.error("Errore verifica token reset:",e),this.showNotification("Link di reset non valido o scaduto. Richiedi un nuovo reset.","error")}}async updatePassword(e,o){try{if(!e||!o)throw new Error("Inserisci entrambe le password");if(e!==o)throw new Error("Le password non coincidono");if(!this.isValidPassword(e))throw new Error("La password deve contenere almeno 8 caratteri, una maiuscola, una minuscola, un numero e un carattere speciale");this.showLoading("Aggiornamento password...");const{error:s}=await this.supabase.auth.updateUser({password:e});if(s)throw s;return this.showNotification("Password aggiornata con successo! Ora puoi accedere con la nuova password.","success"),setTimeout(()=>{window.location.href=window.AppConfig.getPageUrl("index.html")},3e3),{success:!0}}catch(e){return console.error("Errore aggiornamento password:",e),window.eduNetErrorHandler?window.eduNetErrorHandler.handle(e,"Password Update"):this.showNotification(e.message,"error"),{success:!1,error:e.message}}finally{this.hideLoading()}}async handleEmailConfirmation(e){try{const{error:o}=await this.supabase.auth.verifyOtp({token_hash:e,type:"email"});if(o)throw o;this.showNotification("Email confermata con successo! Ora puoi accedere al tuo account.","success"),setTimeout(()=>{window.location.href=window.AppConfig.getPageUrl("index.html")},3e3)}catch(e){console.error("Errore conferma email:",e),this.showNotification("Link di conferma non valido o scaduto. Contatta il supporto.","error")}}async resendConfirmationEmail(e){try{if(!this.supabase)throw new Error("Supabase non inizializzato");if(!e||!this.isValidEmail(e))throw new Error("Inserisci un indirizzo email valido");this.showLoading("Invio email di conferma...");const{error:o}=await this.supabase.auth.resend({type:"signup",email:e});if(o)throw o;return this.showNotification("Email di conferma inviata! Controlla la tua casella di posta.","success"),{success:!0}}catch(e){return console.error("Errore invio conferma email:",e),window.eduNetErrorHandler?window.eduNetErrorHandler.handle(e,"Email Confirmation Resend"):this.showNotification("Errore nell'invio dell'email. Riprova più tardi.","error"),{success:!1,error:e.message}}finally{this.hideLoading()}}showPasswordResetForm(){const e='\n            <div class="password-reset-form">\n                <h2>Imposta Nuova Password</h2>\n                <form id="newPasswordForm">\n                    <div class="form-group">\n                        <label for="newPassword">Nuova Password</label>\n                        <input type="password" id="newPassword" name="newPassword" \n                               data-validate="password" required>\n                    </div>\n                    <div class="form-group">\n                        <label for="confirmNewPassword">Conferma Nuova Password</label>\n                        <input type="password" id="confirmNewPassword" name="confirmNewPassword" \n                               data-validate="confirmPassword" required>\n                    </div>\n                    <button type="submit" class="btn btn-primary">Aggiorna Password</button>\n                </form>\n            </div>\n        ';document.body.innerHTML=e,document.getElementById("newPasswordForm").addEventListener("submit",async e=>{e.preventDefault();const o=new FormData(e.target);await this.updatePassword(o.get("newPassword"),o.get("confirmNewPassword"))})}isValidEmail(e){const o=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;return o.test(e)}isValidPassword(e){const o=8,s=/[A-Z]/.test(e),a=/[a-z]/.test(e),r=/\d/.test(e),i=/[!@#$%^&*(),.?":{}|<>]/.test(e);return e.length>=o&&s&&a&&r&&i}showNotification(e,o="info",s=5e3){window.eduNetAuth&&window.eduNetAuth.showNotification?window.eduNetAuth.showNotification(e,o,s):alert(e)}showLoading(e="Caricamento..."){window.eduNetAuth&&window.eduNetAuth.showLoading&&window.eduNetAuth.showLoading(e)}hideLoading(){window.eduNetAuth&&window.eduNetAuth.hideLoading&&window.eduNetAuth.hideLoading()}}window.eduNetPasswordReset=new EduNetPasswordReset,"undefined"!=typeof module&&module.exports&&(module.exports=EduNetPasswordReset);