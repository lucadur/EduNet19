class AgeVerification{constructor(){this.minAge=14,this.parentalConsentAge=16,this.adultAge=18,this.init()}init(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.setupEventListeners()):this.setupEventListeners()}setupEventListeners(){const e=document.getElementById("birthDate");if(e){const t=(new Date).toISOString().split("T")[0];e.setAttribute("max",t);const i=new Date;i.setFullYear(i.getFullYear()-100),e.setAttribute("min",i.toISOString().split("T")[0]),e.addEventListener("change",e=>this.handleBirthDateChange(e))}}calculateAge(e){const t=new Date,i=new Date(e);let n=t.getFullYear()-i.getFullYear();const r=t.getMonth()-i.getMonth();return(r<0||0===r&&t.getDate()<i.getDate())&&n--,n}handleBirthDateChange(e){const t=e.target.value;if(!t)return;const i=this.calculateAge(t),n=document.getElementById("birthDate-error"),r=document.getElementById("parentalConsentSection"),a=document.getElementById("minorConsentSection"),s=document.getElementById("parentEmail"),o=document.getElementById("parentName"),l=document.getElementById("minorConsent");return r&&(r.style.display="none"),a&&(a.style.display="none"),n&&(n.textContent=""),s&&s.removeAttribute("required"),o&&o.removeAttribute("required"),l&&l.removeAttribute("required"),i<this.minAge?(n&&(n.textContent=`Devi avere almeno ${this.minAge} anni per registrarti su EduNet19. Se hai meno di ${this.minAge} anni, chiedi a un genitore o tutore di creare un account per te.`),e.target.classList.add("is-invalid"),e.target.classList.remove("is-valid"),{valid:!1,reason:"under_minimum_age",age:i}):i<this.parentalConsentAge?(r&&(r.style.display="block",s&&s.setAttribute("required","required"),o&&o.setAttribute("required","required")),e.target.classList.remove("is-invalid"),e.target.classList.add("is-valid"),{valid:!0,requiresParentalConsent:!0,age:i}):i<this.adultAge?(a&&(a.style.display="block",l&&l.setAttribute("required","required")),e.target.classList.remove("is-invalid"),e.target.classList.add("is-valid"),{valid:!0,requiresMinorConsent:!0,age:i}):(e.target.classList.remove("is-invalid"),e.target.classList.add("is-valid"),{valid:!0,isAdult:!0,age:i})}validateAge(e){if(!e)return{valid:!1,error:"La data di nascita è obbligatoria"};const t=this.calculateAge(e);return t<this.minAge?{valid:!1,error:`Devi avere almeno ${this.minAge} anni per registrarti`,age:t}:{valid:!0,age:t,isMinor:t<this.adultAge,requiresParentalConsent:t<this.parentalConsentAge,requiresMinorConsent:t>=this.parentalConsentAge&&t<this.adultAge}}validateParentalConsent(e,t){const i=[];return e&&e.trim()?this.isValidEmail(e)||i.push("Inserisci un'email valida per il genitore/tutore"):i.push("L'email del genitore/tutore è obbligatoria"),t&&t.trim()||i.push("Il nome del genitore/tutore è obbligatorio"),{valid:0===i.length,errors:i}}validateMinorConsent(e){return e?{valid:!0}:{valid:!1,error:"Devi dichiarare di avere il consenso dei tuoi genitori per procedere"}}isValidEmail(e){const t=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;return t.test(e)}generateConsentToken(){const e=new Uint8Array(32);return crypto.getRandomValues(e),Array.from(e,e=>e.toString(16).padStart(2,"0")).join("")}getTokenExpiration(){const e=new Date;return e.setHours(e.getHours()+48),e.toISOString()}}window.ageVerification=new AgeVerification;