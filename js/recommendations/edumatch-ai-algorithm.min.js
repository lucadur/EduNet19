class EduMatchAI{constructor(){this.weights={contentSimilarity:30,behaviorAlignment:25,interestMatch:20,geographicProximity:10,networkOverlap:10,searchIntent:5},this.timeDecay={recent:1,week:.9,month:.7,quarter:.5,old:.3},this.learningRate=.1,this.minDataPoints=5}async calculateAffinity(e,t,a){try{const i=await this.analyzeContentSimilarity(e,t,a.posts,a.projects),n=await this.analyzeBehaviorAlignment(e,t,a.interactions),r=this.analyzeInterestMatch(e,t,a.tags),o=this.analyzeGeographicProximity(e.location,t.location),s=await this.analyzeNetworkOverlap(e,t),c=await this.analyzeSearchIntent(a.searches,t),l=Math.round((i*this.weights.contentSimilarity+n*this.weights.behaviorAlignment+r*this.weights.interestMatch+o*this.weights.geographicProximity+s*this.weights.networkOverlap+c*this.weights.searchIntent)/100),h={content:i,behavior:n,interests:r,geography:o,network:s,searchIntent:c},m=this.generateReasons(h,e,t);return{score:Math.min(100,Math.max(0,l)),breakdown:h,reasons:m,confidence:this.calculateConfidence(a)}}catch(e){return console.error("Errore calcolo affinity:",e),{score:50,breakdown:{},reasons:[],confidence:0}}}async analyzeContentSimilarity(e,t,a,i){let n=0;const r=[];if(a&&a.length>0){const i=this.compareThemes(this.extractThemes(a.filter(t=>t.author_id===e.id)),t.themes||[]);n+=40*i,i>.6&&r.push("Tematiche post molto simili")}if(i&&i.length>0){const a=this.compareProjects(i.filter(t=>t.creator_id===e.id),t.projects||[]);n+=40*a,a>.7&&r.push("Tipologie di progetto allineate")}const o=this.compareArrays(e.methodologies||[],t.methodologies||[]);return n+=20*o,Math.min(100,n)}async analyzeBehaviorAlignment(e,t,a){let i=0;if(!a||a.length<this.minDataPoints)return 50;const n=a.filter(t=>"like"===t.type&&t.user_id===e.id).map(e=>e.target_content),r=await this.getProfileContent(t.id),o=this.compareContent(n,r);i+=50*o;const s=this.analyzeEngagementPattern(a.filter(t=>t.user_id===e.id)),c=t.engagement_pattern||{},l=this.comparePatterns(s,c);i+=30*l;const h=this.getInteractionPreference(a,e.id),m=t.interaction_style||{},g=this.compareInteractionStyles(h,m);return i+=20*g,Math.min(100,i)}analyzeInterestMatch(e,t,a){let i=0;const n=this.compareArrays(e.tags||[],t.tags||[]);if(i+=50*n,a&&a.length>0){const e=this.compareArrays(a.map(e=>e.tag),t.tags||[]);i+=30*e}const r=this.compareArrays(e.interests||[],t.interests||[]);return i+=20*r,Math.min(100,i)}analyzeGeographicProximity(e,t){if(!e||!t)return 30;const{city:a,region:i,province:n}=this.parseLocation(e),{city:r,region:o,province:s}=this.parseLocation(t);return a&&r&&a===r?100:n&&s&&n===s?80:i&&o&&i===o?60:this.areNeighborRegions(i,o)?40:this.sameMacroArea(i,o)?25:10}async analyzeNetworkOverlap(e,t){try{const a=await this.getCommonConnections(e.id,t.id,"followers"),i=await this.getCommonConnections(e.id,t.id,"following"),n=await this.getCommonCollaborators(e.id,t.id);let r=0;return a.length>0&&(r+=Math.min(40,5*a.length)),i.length>0&&(r+=Math.min(30,4*i.length)),n.length>0&&(r+=Math.min(30,10*n.length)),Math.min(100,r)}catch(e){return console.error("Errore network analysis:",e),20}}async analyzeSearchIntent(e,t){if(!e||0===e.length)return 50;let a=0,i=0;const n=e.filter(e=>this.isRecent(e.created_at,30)).map(e=>e.query.toLowerCase().split(" ")).flat(),r=[...t.tags||[],...t.keywords||[],t.name,t.description].join(" ").toLowerCase().split(" ");for(const e of n)e.length<3||r.some(t=>t.includes(e)||e.includes(t))&&i++;const o=i/Math.max(1,n.length);return a=100*o,Math.min(100,a)}generateReasons(e,t,a){const i=[];return e.content>=70&&i.push("Contenuti e progetti molto simili ai tuoi"),e.behavior>=70&&i.push("Pattern di engagement perfettamente allineati"),e.interests>=80&&i.push("Interessi e tag quasi identici"),e.geography>=80?i.push(`Stessa zona: ${a.location}`):e.geography>=60&&i.push("Vicinanza geografica favorevole"),e.network>=60&&i.push("Molte connessioni in comune nella rete"),e.searchIntent>=70&&i.push("Corrisponde esattamente alle tue ricerche recenti"),i.length<3&&(e.content>=50&&i.push("Tematiche e approcci educativi compatibili"),e.interests>=50&&i.push("Interessi parzialmente sovrapponibili"),i.length<3&&i.push("Profilo interessante per il tuo network")),i.slice(0,4)}async updateWeightsFromFeedback(e,t,a,i){try{const n=await this.getPrediction(e,t);if(!n)return;const r="like"===a||"super_like"===a,o=r!==i;if(o){const t=this.calculateWeightAdjustments(n.breakdown,r,i);for(const[e,a]of Object.entries(t))this.weights[e]&&(this.weights[e]+=a*this.learningRate);this.normalizeWeights(),await this.saveWeights(e,this.weights),console.log("ðŸ§  Pesi aggiornati:",this.weights)}}catch(e){console.error("Errore learning:",e)}}compareArrays(e,t){if(!e||!t||0===e.length||0===t.length)return 0;const a=new Set(e.map(e=>e.toLowerCase())),i=new Set(t.map(e=>e.toLowerCase())),n=new Set([...a].filter(e=>i.has(e))),r=new Set([...a,...i]);return n.size/r.size*100}compareThemes(e,t){return this.compareArrays(e,t)/100}compareProjects(e,t){if(!e||!t)return 0;const a=e.map(e=>e.type||e.category),i=t.map(e=>e.type||e.category);return this.compareArrays(a,i)/100}comparePatterns(e,t){if(!e||!t)return 50;let a=0;const i=["daily_avg","peak_hours","preferred_days"];for(const n of i)if(e[n]&&t[n]){const i=Math.abs(e[n]-t[n]);a+=33.33*(1-i/Math.max(e[n],t[n]))}return a}compareInteractionStyles(e,t){if(!e||!t)return 50;const a=["like","comment","share","save"];let i=0;for(const n of a){const a=e[n]||0,r=t[n]||0,o=Math.max(a,r,1);i+=Math.abs(a-r)/o}return 100*(1-i/a.length)}parseLocation(e){if(!e)return{};const t=e.split(",").map(e=>e.trim());return{city:t[0]||null,region:t[1]||null,province:t[0]||null}}areNeighborRegions(e,t){const a={Lombardia:["Piemonte","Emilia-Romagna","Veneto","Trentino-Alto Adige","Liguria"],Piemonte:["Lombardia","Liguria","Emilia-Romagna","Valle d'Aosta"],Veneto:["Lombardia","Trentino-Alto Adige","Friuli-Venezia Giulia","Emilia-Romagna"],"Emilia-Romagna":["Lombardia","Piemonte","Veneto","Liguria","Toscana","Marche"],Liguria:["Piemonte","Lombardia","Emilia-Romagna","Toscana"],"Trentino-Alto Adige":["Lombardia","Veneto"],"Friuli-Venezia Giulia":["Veneto"],"Valle d'Aosta":["Piemonte"],Toscana:["Liguria","Emilia-Romagna","Marche","Umbria","Lazio"],Lazio:["Toscana","Umbria","Marche","Abruzzo","Molise","Campania"],Umbria:["Toscana","Marche","Lazio"],Marche:["Emilia-Romagna","Toscana","Umbria","Lazio","Abruzzo"],Abruzzo:["Marche","Lazio","Molise"],Molise:["Abruzzo","Lazio","Campania","Puglia"],Campania:["Lazio","Molise","Puglia","Basilicata","Calabria"],Puglia:["Molise","Campania","Basilicata"],Basilicata:["Campania","Puglia","Calabria"],Calabria:["Basilicata","Campania"],Sicilia:[],Sardegna:[]};return a[e]?.includes(t)||a[t]?.includes(e)}sameMacroArea(e,t){const a=["Lombardia","Piemonte","Veneto","Liguria","Emilia-Romagna","Trentino-Alto Adige","Friuli-Venezia Giulia","Valle d'Aosta"],i=["Toscana","Lazio","Umbria","Marche","Abruzzo"],n=["Campania","Puglia","Basilicata","Calabria","Sicilia","Sardegna","Molise"];return a.includes(e)&&a.includes(t)||i.includes(e)&&i.includes(t)||n.includes(e)&&n.includes(t)}isRecent(e,t){const a=new Date,i=new Date(e),n=(a-i)/864e5;return n<=t}getTimeDecayFactor(e){const t=(new Date-new Date(e))/864e5;return t<=7?this.timeDecay.recent:t<=30?this.timeDecay.week:t<=90?this.timeDecay.month:t<=180?this.timeDecay.quarter:this.timeDecay.old}calculateConfidence(e){let t=0;return t+=e.posts?.length||0,t+=e.projects?.length||0,t+=(e.interactions?.length||0)/10,t+=(e.searches?.length||0)/5,Math.min(100,t/50*100)}normalizeWeights(){const e=Object.values(this.weights).reduce((e,t)=>e+t,0);for(const t in this.weights)this.weights[t]=this.weights[t]/e*100}extractThemes(e){const t=e.map(e=>e.content||e.title||"").join(" ").toLowerCase().split(/\s+/),a={};for(const e of t)e.length>4&&(a[e]=(a[e]||0)+1);return Object.entries(a).sort((e,t)=>t[1]-e[1]).slice(0,20).map(([e])=>e)}compareContent(e,t){if(!e||!t)return 0;const a=this.extractKeywords(e),i=this.extractKeywords(t);return this.compareArrays(a,i)}extractKeywords(e){return Array.isArray(e)&&(e=e.map(e=>e.content||e.title||"").join(" ")),e.toLowerCase().split(/\s+/).filter(e=>e.length>4).slice(0,50)}analyzeEngagementPattern(e){const t=e.map(e=>new Date(e.created_at).getHours()),a=e.map(e=>new Date(e.created_at).getDay());return{daily_avg:e.length/30,peak_hours:this.mode(t),preferred_days:this.mode(a),total_interactions:e.length}}getInteractionPreference(e,t){const a=e.filter(e=>e.user_id===t),i=a.reduce((e,t)=>(e[t.type]=(e[t.type]||0)+1,e),{});return i}mode(e){if(!e||0===e.length)return null;const t=e.reduce((e,t)=>(e[t]=(e[t]||0)+1,e),{});return Object.entries(t).sort((e,t)=>t[1]-e[1])[0][0]}calculateWeightAdjustments(e,t,a){const i={};for(const[n,r]of Object.entries(e))t&&!a?i[n]=-Math.abs(r-50)/10:!t&&a&&(i[n]=Math.abs(r-50)/10);return i}async getProfileContent(e){return[]}async getCommonConnections(e,t,a){return[]}async getCommonCollaborators(e,t){return[]}async getPrediction(e,t){return null}async saveWeights(e,t){console.log("Saving weights for user",e,t)}}"undefined"!=typeof window&&(window.EduMatchAI=EduMatchAI);