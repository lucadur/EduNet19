"use strict";class RecommendationEngine{constructor(e,t){this.userId=e,this.supabase=t,this.cache=null,this.cacheExpiry=null,this.cacheDuration=3e5,this.weights={type:30,geographic:25,completeness:15,interests:20,engagement:10},this.typeCategories={liceo:["Liceo Classico","Liceo Scientifico","Liceo Linguistico","Liceo Artistico","Liceo delle Scienze Umane","Liceo Musicale e Coreutico","Liceo Scientifico - Scienze Applicate","Liceo Europeo","Liceo Internazionale","Liceo"],tecnico:["Istituto Tecnico","Istituto Tecnico Industriale","Istituto Tecnico Commerciale","Istituto Tecnico Agrario","Istituto Tecnico Nautico","Istituto Tecnico per il Turismo","Istituto Tecnico Tecnologico","Istituto Tecnico Economico"],professionale:["Istituto Professionale","Istituto Professionale Alberghiero","Istituto Professionale Industria e Artigianato","Istituto Professionale per i Servizi Sociali"],primo_ciclo:["Scuola Primaria","Scuola Secondaria di I Grado","Scuola dell'Infanzia","Istituto Comprensivo"],universita:["Universit√†","Politecnico","Accademia","Conservatorio"],formazione:["Centro di Formazione Professionale","ITS","Istituto Tecnico Superiore","AFAM"]},this.educationalChains=[["primo_ciclo","liceo"],["primo_ciclo","tecnico"],["primo_ciclo","professionale"],["liceo","universita"],["tecnico","universita"],["tecnico","formazione"],["professionale","formazione"]],this.relatedTypes={liceo:["tecnico","universita"],tecnico:["liceo","professionale","formazione"],professionale:["tecnico","formazione"],universita:["liceo","tecnico","formazione"],formazione:["tecnico","professionale","universita"]},this.macroAreas={nord:["Lombardia","Piemonte","Veneto","Liguria","Emilia-Romagna","Trentino-Alto Adige","Friuli-Venezia Giulia","Valle d'Aosta"],centro:["Toscana","Lazio","Umbria","Marche","Abruzzo"],sud:["Campania","Puglia","Basilicata","Calabria","Molise"],isole:["Sicilia","Sardegna"]}}async getRecommendations(e=5){try{if(this.cache&&this.cacheExpiry&&Date.now()<this.cacheExpiry)return console.log("üìã Using cached recommendations"),this.cache.slice(0,e);console.log("üîÑ Fetching fresh recommendations...");let t=null;const{data:i}=await this.supabase.from("user_profiles").select("user_type").eq("id",this.userId).maybeSingle();t=i;let s=null;const{data:n}=await this.supabase.from("school_institutes").select("institute_type, city, province, region, specializations").eq("id",this.userId).maybeSingle();n&&(s=n);const o={id:this.userId,userType:t?.user_type||"studente",instituteType:s?.institute_type||null,city:s?.city||null,province:s?.province||null,region:s?.region||null,specializations:s?.specializations||[],interests:[]},a=[...await this.getFollowedInstituteIds(),this.userId],{data:r,error:c}=await this.supabase.from("school_institutes").select("\n          id,\n          institute_name,\n          institute_type,\n          city,\n          province,\n          region,\n          description,\n          specializations,\n          logo_url\n        ").limit(80);if(c&&console.error("‚ùå Error fetching institutes:",c),c||!r||0===r.length)return console.log("üìã No institutes found"),[];const l=r.filter(e=>!a.includes(e.id)).map(e=>this.scoreInstitute(e,o)).sort((e,t)=>t.score-e.score).slice(0,2*e);return this.cache=l,this.cacheExpiry=Date.now()+this.cacheDuration,console.log(`‚úÖ Found ${l.length} recommendations`),l.slice(0,e)}catch(e){return console.error("‚ùå Error in getRecommendations:",e),[]}}async getFollowedInstituteIds(){try{const{data:e,error:t}=await this.supabase.from("user_connections").select("followed_id").eq("follower_id",this.userId).eq("status","accepted");if(!t&&e)return e.map(e=>e.followed_id);const{data:i,error:s}=await this.supabase.from("user_follows").select("following_id").eq("follower_id",this.userId);return!s&&i?i.map(e=>e.following_id):[]}catch(e){return console.warn("‚ö†Ô∏è Could not fetch followed institutes:",e.message),[]}}scoreInstitute(e,t){const i={type:0,geographic:0,completeness:0,interests:0,engagement:0};i.type=this.calcTypeAffinity(t,e),i.geographic=this.calcGeographicScore(t,e),i.completeness=this.calcCompletenessScore(e),i.interests=this.calcInterestOverlap(t,e),i.engagement=this.calcEngagementScore(e);const s=(i.type*this.weights.type+i.geographic*this.weights.geographic+i.completeness*this.weights.completeness+i.interests*this.weights.interests+i.engagement*this.weights.engagement)/100,n=this.deterministicTiebreaker(t.id,e.id),o=Math.max(5,Math.min(99,Math.round(s+n)));return{...e,score:o,breakdown:i}}calcTypeAffinity(e,t){const i=(e.instituteType||"").trim(),s=(t.institute_type||"").trim();if(!i||!s)return 40;if(i.toLowerCase()===s.toLowerCase())return 100;const n=this.getCategoryForType(i),o=this.getCategoryForType(s);return n&&o?n===o?85:this.educationalChains.some(([e,t])=>n===e&&o===t||n===t&&o===e)?65:this.relatedTypes[n]?.includes(o)?45:15:this.fuzzyTypeMatch(i,s)}getCategoryForType(e){const t=e.toLowerCase();for(const[e,i]of Object.entries(this.typeCategories))if(i.some(e=>t.includes(e.toLowerCase())||e.toLowerCase().includes(t)))return e;return null}fuzzyTypeMatch(e,t){const i=e.toLowerCase().split(/\s+/),s=t.toLowerCase().split(/\s+/),n=i.filter(e=>e.length>3&&s.includes(e));return n.length>=2?70:1===n.length?45:20}calcGeographicScore(e,t){if(!e.city&&!e.province&&!e.region)return 35;const i=(e.city||"").toLowerCase().trim(),s=(e.province||"").toLowerCase().trim(),n=(e.region||"").toLowerCase().trim(),o=(t.city||"").toLowerCase().trim(),a=(t.province||"").toLowerCase().trim(),r=(t.region||"").toLowerCase().trim();return i&&o&&i===o?100:s&&a&&s===a?80:n&&r&&n===r?60:n&&r&&this.sameMacroArea(n,r)?35:o||a||r?15:10}sameMacroArea(e,t){const i=e.toLowerCase(),s=t.toLowerCase();for(const e of Object.values(this.macroAreas)){const t=e.map(e=>e.toLowerCase());if(t.includes(i)&&t.includes(s))return!0}return!1}calcCompletenessScore(e){let t=0;const i=[[!!e.description&&e.description.length>30,25],[!!e.description&&e.description.length>150,10],[!!e.specializations&&e.specializations.length>0,20],[!!e.city,15],[!!e.province,5],[!!e.region,5],[!!e.logo_url,10],[!!e.institute_type,10]];for(const[e,s]of i)e&&(t+=s);return Math.min(100,t)}calcInterestOverlap(e,t){const i=this.normalizeArray(e.specializations),s=this.normalizeArray(e.interests),n=this.normalizeArray(t.specializations),o=new Set([...i,...s]),a=new Set(n);if(0===o.size||0===a.size)return 30;const r=[...o].filter(e=>a.has(e)),c=new Set([...o,...a]),l=r.length/c.size;let d=0;for(const e of o)for(const t of a)e!==t&&(e.includes(t)||t.includes(e))&&d++;const u=Math.min(20,5*d);return Math.min(100,Math.round(80*l+u))}normalizeArray(e){return e&&Array.isArray(e)?e.map(e=>String(e).toLowerCase().trim()).filter(e=>e.length>0):[]}deterministicTiebreaker(e,t){const i=(e||"")+":"+(t||"");let s=0;for(let e=0;e<i.length;e++)s=(s<<5)-s+i.charCodeAt(e)|0;return Math.abs(s)%7-3}calcEngagementScore(e){let t=20;const i=e.followers_count||0;i>0&&(t+=Math.min(40,Math.round(8*Math.log2(i+1))));const s=e.posts_count||0;return s>0&&(t+=Math.min(40,Math.round(7*Math.log2(s+1)))),Math.min(100,t)}async trackActivity(e,t=null,i=null,s=null){try{const{error:n}=await this.supabase.from("user_activities").insert({user_id:this.userId,activity_type:e,target_id:t,target_type:i,activity_data:s});n&&!n.message.includes("does not exist")&&console.warn("‚ö†Ô∏è Could not track activity:",n.message)}catch(e){}}async getConnectionCounts(){try{const{count:e,error:t}=await this.supabase.from("user_connections").select("*",{count:"exact",head:!0}).eq("follower_id",this.userId).eq("status","accepted"),{count:i,error:s}=await this.supabase.from("user_connections").select("*",{count:"exact",head:!0}).eq("followed_id",this.userId).eq("status","accepted");return{following:t?0:e||0,followers:s?0:i||0}}catch(e){return console.error("Error getting connection counts:",e),{following:0,followers:0}}}clearCache(){this.cache=null,this.cacheExpiry=null}async followInstitute(e){try{const{data:t}=await this.supabase.from("user_connections").select("id").eq("follower_id",this.userId).eq("followed_id",e).maybeSingle();if(t)return console.log("üìã Already following this institute"),!0;const{error:i}=await this.supabase.from("user_connections").insert({follower_id:this.userId,followed_id:e,status:"accepted",created_at:(new Date).toISOString()});return i?(console.error("‚ùå Error following institute:",i),!1):(this.clearCache(),await this.trackActivity("follow",e,"institute"),console.log("‚úÖ Successfully followed institute:",e),!0)}catch(e){return console.error("‚ùå Error in followInstitute:",e),!1}}async unfollowInstitute(e){try{const{error:t}=await this.supabase.from("user_connections").delete().eq("follower_id",this.userId).eq("followed_id",e);return t?(console.error("‚ùå Error unfollowing institute:",t),!1):(this.clearCache(),await this.trackActivity("unfollow",e,"institute"),console.log("‚úÖ Successfully unfollowed institute:",e),!0)}catch(e){return console.error("‚ùå Error in unfollowInstitute:",e),!1}}}class DiscoverManager{constructor(e){this.homepage=e,this.recommendationUI=null,this.isVisible=!1}init(e){this.recommendationUI=e,console.log("‚úÖ DiscoverManager initialized")}async renderDiscoverSection(){const e=document.getElementById("feed-content");if(e){this.isVisible=!0,e.innerHTML='\n      <div class="discover-section">\n        <div class="discover-loading">\n          <i class="fas fa-spinner fa-spin"></i>\n          <p>Caricamento suggerimenti...</p>\n        </div>\n      </div>\n    ';try{const t=window.eduNetAuth?.supabase||await(window.supabaseClientManager?.getClient());if(!t)throw new Error("Supabase not available");const{data:{user:i}}=await t.auth.getUser(),s=i?.id;let n=[];if(s){const{data:e}=await t.from("user_connections").select("followed_id").eq("follower_id",s).eq("status","accepted");e&&(n=e.map(e=>e.followed_id))}let o=[];if(this.recommendationUI&&this.recommendationUI.engine&&(o=await this.recommendationUI.engine.getRecommendations(10)),0===o.length&&t){const{data:e}=await t.from("school_institutes").select("id, institute_name, institute_type, city, province, region, description, specializations, logo_url").limit(15);if(e&&e.length>0)if(this.recommendationUI&&this.recommendationUI.engine){const i=this.recommendationUI.engine;let n={id:s,userType:"studente",instituteType:null,city:null,province:null,region:null,specializations:[],interests:[]};try{const{data:e}=await t.from("user_profiles").select("user_type").eq("id",s).maybeSingle();e&&(n.userType=e.user_type||"studente");const{data:i}=await t.from("school_institutes").select("institute_type, city, province, region, specializations").eq("id",s).maybeSingle();i&&(n.instituteType=i.institute_type||null,n.city=i.city||null,n.province=i.province||null,n.region=i.region||null,n.specializations=i.specializations||[])}catch(e){}o=e.map(e=>i.scoreInstitute(e,n)),o.sort((e,t)=>t.score-e.score)}else o=e.map(e=>({...e,score:Math.floor(20*Math.random())+40,breakdown:{}}))}o=o.filter(e=>e.id===s?(console.log("üìã Excluding self from discover:",e.institute_name),!1):!n.includes(e.id)||(console.log("üìã Excluding already followed:",e.institute_name),!1));let a=[];try{const{data:e}=await t.from("institute_posts").select("tags").eq("published",!0).gte("created_at",new Date(Date.now()-6048e5).toISOString()).limit(100);if(e&&e.length>0){const t={};e.forEach(e=>{e.tags&&Array.isArray(e.tags)&&e.tags.forEach(e=>{t[e]=(t[e]||0)+1})}),a=Object.entries(t).sort((e,t)=>t[1]-e[1]).slice(0,10)}}catch(e){console.warn("‚ö†Ô∏è Could not load trending topics:",e)}e.innerHTML=`\n        <div class="discover-section">\n          <div class="discover-header">\n            <h2><i class="fas fa-compass"></i> Scopri</h2>\n            <p>Trova istituti interessanti e contenuti di tendenza</p>\n          </div>\n          \n          \x3c!-- Istituti Consigliati --\x3e\n          <div class="discover-institutes-section">\n            <h3><i class="fas fa-school"></i> Istituti Consigliati</h3>\n            ${o.length>0?`\n              <div class="discover-grid">\n                ${o.map(e=>this.renderInstituteCard(e,!1)).join("")}\n              </div>\n            `:'\n              <div class="discover-empty-small">\n                <i class="fas fa-check-circle"></i>\n                <p>Stai gi√† seguendo tutti gli istituti disponibili!</p>\n              </div>\n            '}\n          </div>\n          \n          \x3c!-- Trending Topics --\x3e\n          ${a.length>0?`\n            <div class="discover-trending-section">\n              <h3><i class="fas fa-fire"></i> Argomenti di Tendenza</h3>\n              <div class="trending-tags">\n                ${a.map(([e,t])=>`\n                  <span class="trending-tag" data-tag="${this.escapeHtml(e)}">\n                    #${this.escapeHtml(e)}\n                    <span class="tag-count">${t}</span>\n                  </span>\n                `).join("")}\n              </div>\n            </div>\n          `:""}\n          \n          \x3c!-- Link Rapidi --\x3e\n          <div class="discover-links-section">\n            <h3><i class="fas fa-link"></i> Link Utili</h3>\n            <div class="quick-links-grid">\n              <a href="pages/legal/terms-of-service.html" class="quick-link-card">\n                <i class="fas fa-file-contract"></i>\n                <span>Termini di Servizio</span>\n              </a>\n              <a href="pages/legal/privacy-policy.html" class="quick-link-card">\n                <i class="fas fa-shield-alt"></i>\n                <span>Privacy Policy</span>\n              </a>\n              <a href="pages/legal/cookie-policy.html" class="quick-link-card">\n                <i class="fas fa-cookie-bite"></i>\n                <span>Cookie Policy</span>\n              </a>\n            </div>\n          </div>\n        </div>\n      `,this.attachDiscoverListeners(),document.querySelectorAll(".trending-tag").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.tag;if(this.homepage){this.homepage.switchFeedTab("all");const e=document.getElementById("global-search");e&&(e.value=`#${t}`,e.dispatchEvent(new Event("input")))}})})}catch(t){console.error("‚ùå Error rendering discover section:",t),e.innerHTML='\n        <div class="discover-section">\n          <div class="discover-empty">\n            <i class="fas fa-exclamation-triangle"></i>\n            <h3>Errore di caricamento</h3>\n            <p>Non √® stato possibile caricare i suggerimenti.</p>\n          </div>\n        </div>\n      '}}}renderInstituteCard(e,t=!1){const i=this.getInitials(e.institute_name);return`\n      <div class="discover-card" data-institute-id="${e.id}">\n        <div class="discover-card-header">\n          <div class="institute-avatar-large">${i}</div>\n          <div class="institute-info">\n            <h3 class="institute-name">${this.escapeHtml(e.institute_name)}</h3>\n            <span class="institute-type">${this.escapeHtml(e.institute_type||"Istituto")}</span>\n            ${e.city?`\n              <span class="institute-location">\n                <i class="fas fa-map-marker-alt"></i>\n                ${this.escapeHtml(e.city)}${e.province?`, ${e.province}`:""}\n              </span>\n            `:""}\n          </div>\n          ${e.score?`<span class="match-score">${e.score}%</span>`:""}\n        </div>\n        ${e.description?`\n          <p class="institute-description">${this.escapeHtml(e.description.substring(0,150))}${e.description.length>150?"...":""}</p>\n        `:""}\n        <div class="discover-card-actions">\n          <a href="pages/profile/profile.html?id=${e.id}" class="btn-view-profile">\n            <i class="fas fa-user"></i> Vedi Profilo\n          </a>\n          <button class="btn-follow" data-institute-id="${e.id}">\n            <i class="fas fa-plus"></i> Segui\n          </button>\n        </div>\n      </div>\n    `}attachDiscoverListeners(){document.querySelectorAll(".discover-card .btn-follow").forEach(e=>{e.addEventListener("click",async t=>{t.preventDefault();const i=e.dataset.instituteId;await this.handleFollow(i,e)})})}async handleFollow(e,t){try{const i=window.eduNetAuth?.supabase||await(window.supabaseClientManager?.getClient());if(!i)return;const{data:{user:s}}=await i.auth.getUser();if(!s)return;const{data:n}=await i.from("user_connections").select("id").eq("follower_id",s.id).eq("followed_id",e).maybeSingle();if(n)await i.from("user_connections").delete().eq("follower_id",s.id).eq("followed_id",e),t.innerHTML='<i class="fas fa-plus"></i> Segui',t.classList.remove("following");else{await i.from("user_connections").insert({follower_id:s.id,followed_id:e,status:"accepted"}),t.innerHTML='<i class="fas fa-check"></i> Seguito',t.classList.add("following");const n=t.closest(".discover-card");n&&(n.style.transition="opacity 0.3s, transform 0.3s",n.style.opacity="0",n.style.transform="scale(0.9)",setTimeout(()=>{if(n.remove(),0===document.querySelectorAll(".discover-card").length){const e=document.querySelector(".discover-grid");e&&(e.innerHTML='\n                  <div class="discover-empty" style="grid-column: 1 / -1;">\n                    <i class="fas fa-check-circle"></i>\n                    <h3>Ottimo lavoro!</h3>\n                    <p>Stai gi√† seguendo tutti gli istituti disponibili.</p>\n                  </div>\n                ')}},300))}this.recommendationUI&&this.recommendationUI.engine&&this.recommendationUI.engine.clearCache(),this.homepage&&this.homepage.loadTabCounts&&await this.homepage.loadTabCounts()}catch(e){console.error("‚ùå Error handling follow:",e)}}hideDiscoverSection(){this.isVisible=!1}getInitials(e){return e?e.split(" ").filter(e=>e.length>0).slice(0,2).map(e=>e[0].toUpperCase()).join(""):"?"}escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}}window.RecommendationEngine=RecommendationEngine,window.DiscoverManager=DiscoverManager;