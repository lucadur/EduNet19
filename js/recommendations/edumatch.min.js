class EduMatch{constructor(){this.currentCardIndex=0,this.cards=[],this.matches=[],this.likedProfiles=new Set,this.passedProfiles=new Set,this.superLikedProfiles=new Set,this.isDragging=!1,this.startX=0,this.startY=0,this.currentX=0,this.currentY=0,this.currentCard=null,this.aiEngine=new EduMatchAI,this.userActivityData=null,this.init()}init(){console.log("üéØ EduMatch: Inizializzazione sistema match..."),this.setupEventListeners(),this.loadCards()}setupEventListeners(){const t=document.querySelector(".match-action-btn.nope"),e=document.querySelector(".match-action-btn.super"),i=document.querySelector(".match-action-btn.like"),a=document.querySelector(".match-action-btn.info");t&&t.addEventListener("click",()=>this.pass()),e&&e.addEventListener("click",()=>this.superLike()),i&&i.addEventListener("click",()=>this.like()),a&&a.addEventListener("click",()=>this.showInfo()),document.addEventListener("keydown",t=>this.handleKeyboard(t))}async loadCards(){const t=document.querySelector(".edumatch-cards-container"),e=document.querySelector(".edumatch-loading"),i=document.querySelector(".edumatch-empty");this.currentCardIndex=0,this.cards=[],e&&e.classList.add("visible"),t&&(t.innerHTML=""),i&&i.classList.remove("visible");try{await this.waitForAuth(),await this.loadUserActivityData();let t=await this.loadProfilesFromDatabase();t&&0!==t.length||(console.warn("‚ö†Ô∏è Nessun profilo trovato nel database, uso profili demo"),t=this.getMockInstituteCards()),console.log(`‚úÖ Caricati ${t.length} profili`),this.cards=await this.enrichProfilesWithAI(t),this.cards.sort((t,e)=>e.affinity-t.affinity),this.renderCards()}catch(t){console.error("‚ùå Errore caricamento card:",t),this.cards=this.getMockInstituteCards(),this.renderCards()}finally{e&&e.classList.remove("visible")}}async waitForAuth(){const t=3e3,e=100;let i=0;for(;i<t;){if(window.eduNetAuth&&window.eduNetAuth.getCurrentUser())return console.log("‚úÖ EduMatch: Autenticazione pronta"),!0;await this.delay(e),i+=e}return console.warn("‚ö†Ô∏è EduMatch: Timeout autenticazione, procedo comunque"),!1}async loadUserActivityData(){try{if(!window.supabase||!window.currentUser)return void(this.userActivityData={posts:[],projects:[],interactions:[],tags:[],searches:[]});const t=window.currentUser.id,[e,i,a,s]=await Promise.all([this.getUserPosts(t),this.getUserProjects(t),this.getUserInteractions(t),this.getUserSearches(t)]);this.userActivityData={posts:e,projects:i,interactions:a,tags:this.extractRecentTags(a),searches:s},console.log("üìä User activity data loaded:",this.userActivityData)}catch(t){console.error("Errore caricamento activity data:",t),this.userActivityData={posts:[],projects:[],interactions:[],tags:[],searches:[]}}}async enrichProfilesWithAI(t){const e=[];for(const i of t)try{const t=await this.getCurrentUserProfile(),a=await this.aiEngine.calculateAffinity(t,i,this.userActivityData);e.push({...i,affinity:a.score,affinityReasons:a.reasons,affinityBreakdown:a.breakdown,confidence:a.confidence})}catch(t){console.error("Errore AI affinity per profilo:",i.id,t),e.push({...i,affinity:50,affinityReasons:["Profilo interessante per il tuo network"],affinityBreakdown:{},confidence:0})}return e}async loadProfilesFromDatabase(){try{if(!window.eduNetAuth||!window.eduNetAuth.supabase)return console.error("‚ùå Supabase non disponibile"),[];const t=window.eduNetAuth.supabase,e=window.eduNetAuth.getCurrentUser();if(!e)return console.error("‚ùå Nessun utente loggato"),[];console.log("üîç Caricamento istituti dal database...");let i=[];const{data:a,error:s}=await t.from("school_institutes").select("*").limit(50);if(s)throw s;return console.log("üìä Istituti dal database:",a),i=(a||[]).map(t=>{const e=t.cover_image||t.cover_image_url||null,i=t.logo_url||null;return console.log(`üì∏ Istituto ${t.institute_name}: cover=${e}, avatar=${i}`),{id:t.id,type:"institute",name:t.institute_name||"Istituto Sconosciuto",location:t.city&&t.province?`${t.city}, ${t.province}`:t.city||t.region||"Italia",instituteType:t.institute_type||"Istituto",image:e,avatar:i,description:t.description||t.bio||"Istituto di formazione di qualit√†",tags:this.extractTags(t),stats:{projects:0,collaborations:0,followers:0}}}),console.log(`‚úÖ Caricati ${i.length} profili reali`),i}catch(t){return console.error("‚ùå Errore caricamento profili da DB:",t),[]}}extractTags(t){const e=[];return t.specializations&&Array.isArray(t.specializations)&&e.push(...t.specializations.slice(0,3)),t.methodologies&&Array.isArray(t.methodologies)&&e.push(...t.methodologies.slice(0,2)),t.interests&&Array.isArray(t.interests)&&e.push(...t.interests.slice(0,2)),0===e.length&&e.push(t.institute_type||"Istituto","Formazione"),e.slice(0,5)}getMockInstituteCards(){return[{id:"inst_001",type:"institute",name:"Liceo Scientifico Leonardo da Vinci",location:"Milano, Lombardia",instituteType:"Liceo",image:null,description:"Eccellenza nella didattica scientifica e tecnologica. Laboratori all'avanguardia e progetti innovativi nel campo STEM.",affinity:95,affinityReasons:["Entrambi focalizzati su metodologie STEM","Progetti simili su sostenibilit√† ambientale","Vicinanza geografica (50km)","Storia di collaborazioni con licei scientifici"],tags:["STEM","Robotica","Sostenibilit√†","Coding"],stats:{projects:24,collaborations:15,followers:892}},{id:"inst_002",type:"institute",name:"Istituto Tecnico Enrico Fermi",location:"Roma, Lazio",instituteType:"Istituto Tecnico",image:null,description:"Formazione tecnica di eccellenza con focus su Industria 4.0, IoT e Automazione. Partnership con aziende leader del settore.",affinity:88,affinityReasons:["Interesse comune per tecnologie digitali","Metodologie didattiche innovative condivise","Progetti di alternanza scuola-lavoro affini","Scambio di best practices gi√† avvenuto"],tags:["Industria 4.0","IoT","Automazione","AI"],stats:{projects:31,collaborations:22,followers:1245}},{id:"inst_003",type:"institute",name:"Liceo Classico Dante Alighieri",location:"Firenze, Toscana",instituteType:"Liceo",image:null,description:"Tradizione umanistica unita all'innovazione digitale. Progetti di digitalizzazione del patrimonio culturale.",affinity:76,affinityReasons:["Approccio interdisciplinare comune","Progetti di digitalizzazione culturale","Interesse per metodologie didattiche ibride","Rete di istituti partner complementari"],tags:["Umanistica","Digital Humanities","Cultura","Arte"],stats:{projects:18,collaborations:12,followers:654}},{id:"inst_004",type:"institute",name:"Istituto Professionale Olivetti",location:"Torino, Piemonte",instituteType:"Istituto Professionale",image:null,description:"Formazione professionale di qualit√† con focus su competenze digitali, design thinking e imprenditorialit√†.",affinity:82,affinityReasons:["Programmi di formazione professionale innovativi","Collaborazioni con il territorio simili","Focus su competenze del futuro","Metodologie project-based learning"],tags:["Design Thinking","Imprenditorialit√†","Digitale","Startup"],stats:{projects:27,collaborations:19,followers:987}},{id:"inst_005",type:"institute",name:"Scuola Secondaria di I Grado Manzoni",location:"Bologna, Emilia-Romagna",instituteType:"Scuola Secondaria di I Grado",image:null,description:"Innovazione didattica nella scuola media: flipped classroom, gamification e progetti europei Erasmus+.",affinity:91,affinityReasons:["Metodologie didattiche innovative condivise","Partecipazione a progetti Erasmus+","Focus su inclusivit√† e personalizzazione","Esperienza in collaborazioni inter-grado"],tags:["Flipped Classroom","Gamification","Erasmus+","Inclusione"],stats:{projects:16,collaborations:10,followers:543}}]}renderCards(){const t=document.querySelector(".edumatch-cards-container");if(!t)return;if(t.innerHTML="",0===this.cards.length)return void this.showEmpty();const e=this.cards.slice(this.currentCardIndex,this.currentCardIndex+4);e.forEach((e,i)=>{const a=this.createCardElement(e,i);t.appendChild(a),0===i&&this.attachSwipeListeners(a)})}createCardElement(t,e){const i=document.createElement("div");i.className="edumatch-card-wrapper",i.dataset.id=t.id,t.affinity>=90||t.affinity;const a=this.getPlaceholderColor(t.name),s=this.getInitials(t.name),r=t.image&&""!==t.image.trim(),n=t.avatar&&""!==t.avatar.trim();return i.innerHTML=`\n      <div class="match-card">\n        \x3c!-- Swipe Indicators --\x3e\n        <div class="swipe-indicator nope">\n          <i class="fas fa-times"></i>\n        </div>\n        <div class="swipe-indicator like">\n          <i class="fas fa-heart"></i>\n        </div>\n        <div class="swipe-indicator super">\n          <i class="fas fa-star"></i>\n        </div>\n\n        \x3c!-- Card Image/Cover --\x3e\n        <div class="match-card-image ${r?"has-image":"no-image"}" style="${r?"":`background: ${a};`}">\n          ${r?`<img src="${t.image}" alt="${t.name}" onerror="this.style.display='none'; this.parentElement.classList.add('no-image'); this.parentElement.style.background='${a}';">`:""}\n          \n          \x3c!-- Avatar overlay (se disponibile) --\x3e\n          ${n?`\n            <div class="match-card-avatar">\n              <img src="${t.avatar}" alt="${t.name}" onerror="this.parentElement.innerHTML='<i class=\\'fas fa-school\\'></i>';">\n            </div>\n          `:`\n            <div class="match-card-avatar placeholder" style="background: ${a};">\n              <i class="fas fa-school"></i>\n            </div>\n          `}\n          \n          \x3c!-- Placeholder content quando non c'√® immagine --\x3e\n          ${r?"":`\n            <div class="match-card-placeholder">\n              <i class="fas fa-school"></i>\n              <span>${s}</span>\n            </div>\n          `}\n          \n          <div class="match-card-badge">\n            <i class="fas fa-school"></i>\n            ${t.instituteType||"Istituto"}\n          </div>\n          <div class="match-affinity-score">\n            <i class="fas fa-fire"></i>\n            ${t.affinity}%\n          </div>\n        </div>\n\n        \x3c!-- Card Content --\x3e\n        <div class="match-card-content">\n          <div class="match-card-header">\n            <div>\n              <h3 class="match-card-title">${t.name}</h3>\n              <div class="match-card-subtitle">\n                <i class="fas fa-map-marker-alt"></i>\n                ${t.location}\n              </div>\n              <div class="match-card-stats">\n                ${this.renderStats(t)}\n              </div>\n            </div>\n          </div>\n\n          <p class="match-card-description">${t.description}</p>\n\n          <div class="match-tags">\n            ${t.tags.map(t=>`<span class="match-tag"><i class="fas fa-tag"></i> ${t}</span>`).join("")}\n          </div>\n\n          <div class="match-affinity-reasons">\n            <h4>\n              <i class="fas fa-bolt"></i>\n              Perch√© ti suggeriamo questo match\n            </h4>\n            <ul>\n              ${t.affinityReasons.map(t=>`<li>${t}</li>`).join("")}\n            </ul>\n          </div>\n        </div>\n      </div>\n    `,i}getPlaceholderColor(t){const e=["linear-gradient(135deg, #667eea 0%, #764ba2 100%)","linear-gradient(135deg, #f093fb 0%, #f5576c 100%)","linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)","linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)","linear-gradient(135deg, #fa709a 0%, #fee140 100%)","linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)","linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)","linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)"];let i=0;for(let e=0;e<t.length;e++)i=t.charCodeAt(e)+((i<<5)-i);return e[Math.abs(i)%e.length]}getInitials(t){if(!t)return"?";const e=t.split(" ").filter(t=>t.length>0);return e.length>=2?(e[0][0]+e[1][0]).toUpperCase():t.substring(0,2).toUpperCase()}renderStats(t){return`\n      <div class="match-stat">\n        <i class="fas fa-project-diagram"></i>\n        <strong>${t.stats?.projects||0}</strong> progetti\n      </div>\n      <div class="match-stat">\n        <i class="fas fa-handshake"></i>\n        <strong>${t.stats?.collaborations||0}</strong> collab.\n      </div>\n    `}attachSwipeListeners(t){const e=t.querySelector(".match-card");e&&(e.addEventListener("mousedown",t=>this.startDrag(t,e)),document.addEventListener("mousemove",t=>this.drag(t,e)),document.addEventListener("mouseup",t=>this.endDrag(t,e)),e.addEventListener("touchstart",t=>this.startDrag(t,e),{passive:!0}),document.addEventListener("touchmove",t=>this.drag(t,e),{passive:!1}),document.addEventListener("touchend",t=>this.endDrag(t,e)))}startDrag(t,e){this.isDragging=!0,this.currentCard=e,e.classList.add("dragging");const i=t.type.includes("mouse")?t.clientX:t.touches[0].clientX,a=t.type.includes("mouse")?t.clientY:t.touches[0].clientY;this.startX=i,this.startY=a}drag(t,e){if(!this.isDragging||!this.currentCard)return;const i=t.type.includes("mouse")?t.clientX:t.touches[0].clientX,a=t.type.includes("mouse")?t.clientY:t.touches[0].clientY;this.currentX=i-this.startX,this.currentY=a-this.startY;const s=this.currentX/20;e.style.transform=`translate(${this.currentX}px, ${this.currentY}px) rotate(${s}deg)`,this.updateIndicators(e)}updateIndicators(t){const e=t.querySelector(".swipe-indicator.like"),i=t.querySelector(".swipe-indicator.nope"),a=t.querySelector(".swipe-indicator.super");e.classList.remove("visible"),i.classList.remove("visible"),a.classList.remove("visible"),this.currentX>100?e.classList.add("visible"):this.currentX<-100?i.classList.add("visible"):this.currentY<-100&&a.classList.add("visible")}endDrag(t,e){if(!this.isDragging||!this.currentCard)return;this.isDragging=!1,e.classList.remove("dragging");const i=150,a=100;Math.abs(this.currentX)>i?this.currentX>0?this.like(!0):this.pass(!0):this.currentY<-a?this.superLike(!0):(e.style.transform="",this.updateIndicators(e)),this.currentCard=null,this.currentX=0,this.currentY=0}async like(t=!1){const e=this.cards[this.currentCardIndex];if(!e)return;this.likedProfiles.add(e.id),await this.saveLikeAction(e,"like"),this.animateCardExit("right"),this.nextCard();const i=await this.checkForMatch(e.id);i&&setTimeout(()=>this.showMatchNotification(e),400),console.log(`üíö Like: ${e.name} (Score: ${e.affinity}%)`)}async pass(t=!1){const e=this.cards[this.currentCardIndex];e&&(this.passedProfiles.add(e.id),await this.saveLikeAction(e,"pass"),this.animateCardExit("left"),this.nextCard(),console.log(`‚ùå Pass: ${e.name} (Score era: ${e.affinity}%)`))}async superLike(t=!1){const e=this.cards[this.currentCardIndex];if(!e)return;this.superLikedProfiles.add(e.id),await this.saveLikeAction(e,"super_like"),this.animateCardExit("up"),this.nextCard();const i=await this.checkForMatch(e.id,!0);i&&setTimeout(()=>this.showMatchNotification(e,!0),400),console.log(`‚≠ê Super Like: ${e.name} (Score: ${e.affinity}%)`)}animateCardExit(t){const e=document.querySelector(".edumatch-card-wrapper:first-child");if(!e)return;const i=window.innerWidth;let a;switch(t){case"left":a=`translateX(-${i}px) rotate(-30deg)`;break;case"right":a=`translateX(${i}px) rotate(30deg)`;break;case"up":a=`translateY(-${i}px) scale(1.2)`}e.style.transition="all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55)",e.style.transform=a,e.style.opacity="0",setTimeout(()=>{e.parentNode&&e.remove()},400)}nextCard(){this.currentCardIndex++,this.currentCardIndex>=this.cards.length?this.showEmpty():setTimeout(()=>this.renderCards(),400)}showInfo(){this.cards[this.currentCardIndex]}showMatchNotification(t,e=!1){const i=document.getElementById("matchNotificationModal");if(!i)return;const a=i.querySelector(".match-notification-content p");a&&(a.textContent=e?`${t.name} ha notato il tuo Super Like! Avete un match eccezionale!`:`Hai un nuovo match con ${t.name}! Iniziate a collaborare!`),i.classList.add("show"),i.setAttribute("aria-hidden","false"),this.playMatchSound(),setTimeout(()=>this.closeMatchNotification(),5e3)}closeMatchNotification(){const t=document.getElementById("matchNotificationModal");t&&(t.classList.remove("show"),t.setAttribute("aria-hidden","true"))}playMatchSound(){}showEmpty(){const t=document.querySelector(".edumatch-empty"),e=document.querySelector(".edumatch-cards-container");t&&t.classList.add("visible"),e&&(e.innerHTML=""),console.log("‚úÖ Tutte le card visualizzate!")}showError(t){console.error("‚ùå",t),window.eduNetHomepage&&"function"==typeof window.eduNetHomepage.showNotification&&window.eduNetHomepage.showNotification(t,"error")}handleKeyboard(t){if(this.cards[this.currentCardIndex])switch(t.key){case"ArrowLeft":t.preventDefault(),this.pass();break;case"ArrowRight":t.preventDefault(),this.like();break;case"ArrowUp":t.preventDefault(),this.superLike();break;case"i":case"I":this.showInfo()}}async saveLikeAction(t,e){try{if(!window.supabase||!window.currentUser)return void console.log("üíæ Mock save:",e,t.name);const{error:i}=await supabase.from("match_actions").insert({actor_id:window.currentUser.id,target_profile_id:t.id,action_type:e,predicted_score:t.affinity,prediction_breakdown:t.affinityBreakdown});if(i)throw i;await this.aiEngine.updateWeightsFromFeedback(window.currentUser.id,t.id,e,!1)}catch(t){console.error("Errore salvataggio azione:",t)}}async checkForMatch(t,e=!1){try{if(!window.supabase||!window.currentUser)return Math.random()>(e?.5:.7);const{data:i,error:a}=await supabase.from("match_actions").select("*").eq("actor_id",t).eq("target_profile_id",window.currentUser.id).in("action_type",["like","super_like"]).single();if(a&&"PGRST116"!==a.code)throw a;return!!i&&(await this.createMatch(window.currentUser.id,t,e),!0)}catch(t){return console.error("Errore check match:",t),!1}}async createMatch(t,e,i=!1){try{if(!window.supabase)return;const{error:a}=await supabase.from("matches").insert({profile_1_id:Math.min(t,e),profile_2_id:Math.max(t,e),is_super_match:i});if(a)throw a;console.log("üéâ Match creato!")}catch(t){console.error("Errore creazione match:",t)}}async getCurrentUserProfile(){try{if(!window.supabase||!window.currentUser)return{id:"mock-user",tags:["STEM","Innovazione","Digitale"],interests:["Robotica","AI","Sostenibilit√†"],location:"Milano, Lombardia",methodologies:["PBL","Flipped Classroom"]};const{data:t,error:e}=await supabase.from("match_profiles").select("*").eq("user_id",window.currentUser.id).single();if(e)throw e;return t}catch(t){return console.error("Errore get current profile:",t),{}}}async getUserPosts(t){if(!window.supabase)return[];try{const{data:e,error:i}=await supabase.from("posts").select("*").eq("author_id",t).order("created_at",{ascending:!1}).limit(50);if(i)throw i;return e||[]}catch(t){return console.error("Errore get posts:",t),[]}}async getUserProjects(t){if(!window.supabase)return[];try{const{data:e,error:i}=await supabase.from("projects").select("*").eq("creator_id",t).order("created_at",{ascending:!1}).limit(30);if(i)throw i;return e||[]}catch(t){return console.error("Errore get projects:",t),[]}}async getUserInteractions(t){if(!window.supabase)return[];try{const{data:e,error:i}=await supabase.from("user_interactions").select("*").eq("user_id",t).order("created_at",{ascending:!1}).limit(100);if(i)throw i;return e||[]}catch(t){return console.error("Errore get interactions:",t),[]}}async getUserSearches(t){if(!window.supabase)return[];try{const{data:e,error:i}=await supabase.from("search_history").select("*").eq("user_id",t).order("created_at",{ascending:!1}).limit(50);if(i)throw i;return e||[]}catch(t){return console.error("Errore get searches:",t),[]}}extractRecentTags(t){return t.filter(t=>t.created_at>new Date(Date.now()-2592e6)).map(t=>t.context?.tags||[]).flat().filter((t,e,i)=>i.indexOf(t)===e).slice(0,20)}delay(t){return new Promise(e=>setTimeout(e,t))}}document.addEventListener("DOMContentLoaded",()=>{const t=document.querySelector(".edumatch-section");t&&setTimeout(()=>{window.eduMatch=new EduMatch,t.style.removeProperty("display"),console.log("‚úÖ EduMatch: Sezione visibile e inizializzata")},300)});