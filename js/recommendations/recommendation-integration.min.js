"use strict";class RecommendationUI{constructor(t){this.homepage=t,this.engine=null,this.recommendations=[],this.isLoading=!1,this.init()}async init(){try{if(!window.eduNetAuth||!window.eduNetAuth.supabase)return void console.warn("Auth system not ready for recommendations");const t=window.eduNetAuth.getCurrentUser();if(!t)return void console.warn("No user logged in for recommendations");this.engine=new RecommendationEngine(t.id,window.eduNetAuth.supabase),console.log("‚úÖ Recommendation system initialized"),await this.loadRecommendations(),await this.loadConnectionCounts()}catch(t){console.error("Error initializing recommendation system:",t)}}async loadRecommendations(t=5){if(!this.isLoading&&this.engine){this.isLoading=!0,this.showLoadingState();try{if(console.log("üìä Loading recommendations..."),this.recommendations=await this.engine.getRecommendations(t),0===this.recommendations.length&&window.eduNetAuth?.supabase){console.log("üìä Engine returned empty, trying direct fallback...");try{const e=window.eduNetAuth.supabase,i=window.eduNetAuth.getCurrentUser(),n=[...await this.engine.getFollowedInstituteIds(),i?.id],{data:s}=await e.from("school_institutes").select("id, institute_name, institute_type, city, province, region, description, specializations, logo_url").limit(20);if(s&&s.length>0){let o={id:i?.id,userType:"studente",instituteType:null,city:null,province:null,region:null,specializations:[],interests:[]};try{const{data:t}=await e.from("user_profiles").select("user_type").eq("id",i?.id).maybeSingle();t&&(o.userType=t.user_type||"studente");const{data:n}=await e.from("school_institutes").select("institute_type, city, province, region, specializations").eq("id",i?.id).maybeSingle();n&&(o.instituteType=n.institute_type||null,o.city=n.city||null,o.province=n.province||null,o.region=n.region||null,o.specializations=n.specializations||[])}catch(t){}this.recommendations=s.filter(t=>!n.includes(t.id)).map(t=>this.engine.scoreInstitute(t,o)).sort((t,e)=>e.score-t.score).slice(0,t)}}catch(t){console.warn("‚ö†Ô∏è Sidebar fallback also failed:",t)}}console.log(`‚úÖ Loaded ${this.recommendations.length} recommendations`),await this.renderRecommendations()}catch(t){console.error("Error loading recommendations:",t),this.showErrorState()}finally{this.isLoading=!1}}}async renderRecommendations(){const t=document.getElementById("suggested-institutes");if(!t)return;if(0===this.recommendations.length)return void this.showEmptyState();const e=await this.getFollowedInstitutes();t.innerHTML=this.recommendations.map(t=>{const i=e.includes(t.id);return`\n        <div class="institute-suggestion premium-card" data-institute-id="${t.id}">\n          <div class="suggestion-header">\n            <div class="institute-avatar">\n              ${this.getInstituteInitials(t.institute_name)}\n            </div>\n            <div class="institute-title-group">\n              <div class="institute-name">${this.escapeHtml(t.institute_name)}</div>\n              <div class="institute-meta">\n                <span class="institute-type">${this.escapeHtml(t.institute_type||"Istituto")}</span>\n                ${t.city?`\n                  <span class="institute-location">\n                    <i class="fas fa-map-marker-alt"></i>\n                    ${this.escapeHtml(t.city)}${t.province?`, ${this.escapeHtml(t.province)}`:""}\n                  </span>\n                `:""}\n              </div>\n            </div>\n          </div>\n          \n          <div class="suggestion-body">\n            <div class="recommendation-reason">\n                <i class="fas fa-magic"></i> ${this.getMatchReason(t.breakdown)}\n            </div>\n          </div>\n\n          <div class="suggestion-footer">\n            <div class="recommendation-score">\n              <span class="score-badge">${t.score}%</span>\n              <span class="score-label">Affinit√†</span>\n            </div>\n            <button class="follow-btn ${i?"following":""}" \n                    data-action="${i?"unfollow":"follow"}" \n                    data-institute-id="${t.id}">\n              <i class="fas fa-${i?"check":"plus"}"></i> \n              Segui\n            </button>\n          </div>\n        </div>\n      `}).join(""),this.attachFollowListeners()}getMatchReason(t){if(!t)return"Consigliato per te";const e=[{score:t.type||0,threshold:60,label:"Affinit√† Didattica"},{score:t.geographic||0,threshold:60,label:"Vicino a te"},{score:t.interests||0,threshold:40,label:"Interessi Comuni"},{score:t.engagement||0,threshold:50,label:"Molto Attivo"},{score:t.completeness||0,threshold:70,label:"Profilo Completo"}];let i=null;for(const t of e)t.score>=t.threshold&&(!i||t.score>i.score)&&(i=t);return i?"Affinit√† Didattica"===i.label&&(t.geographic||0)>=60||"Vicino a te"===i.label&&(t.type||0)>=60?"Stesso ambito e vicino a te":"Interessi Comuni"===i.label&&(t.type||0)>=60?"Affinit√† Didattica":i.label:"Consigliato per te"}async getFollowedInstitutes(){if(!this.engine)return[];try{const{data:t,error:e}=await window.eduNetAuth.supabase.from("user_connections").select("followed_id").eq("follower_id",this.engine.userId).eq("status","accepted");if(e)throw e;return t?t.map(t=>t.followed_id):[]}catch(t){return console.error("Error fetching followed institutes:",t),[]}}getInstituteInitials(t){if(!t)return"?";const e=t.split(" ");return e.length>=2?(e[0][0]+e[1][0]).toUpperCase():t.substring(0,2).toUpperCase()}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}attachFollowListeners(){document.querySelectorAll(".follow-btn").forEach(t=>{t.addEventListener("click",async e=>{e.stopPropagation();const i=t.dataset.instituteId,n=t.dataset.action;"follow"===n?await this.handleFollow(i,t):"unfollow"===n&&await this.handleUnfollow(i,t)})}),document.querySelectorAll(".institute-suggestion").forEach(t=>{t.addEventListener("click",e=>{if(e.target.closest(".follow-btn"))return;const i=t.dataset.instituteId;this.viewInstituteProfile(i)})})}async handleFollow(t,e){if(this.engine)try{if(e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i>',!await this.engine.followInstitute(t))throw new Error("Follow failed");e.innerHTML='<i class="fas fa-check"></i> Seguito',e.classList.add("following"),e.dataset.action="unfollow",this.homepage&&this.homepage.showNotification&&this.homepage.showNotification("Istituto seguito con successo!","success"),await this.loadConnectionCounts(),await this.addToRecentActivity("follow",t)}catch(t){console.error("Error following institute:",t),e.innerHTML='<i class="fas fa-plus"></i> Segui',this.homepage&&this.homepage.showNotification&&this.homepage.showNotification("Errore nel seguire l'istituto","error")}finally{e.disabled=!1}}async handleUnfollow(t,e){if(this.engine)try{if(e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i>',!await this.engine.unfollowInstitute(t))throw new Error("Unfollow failed");e.innerHTML='<i class="fas fa-plus"></i> Segui',e.classList.remove("following"),e.dataset.action="follow",this.homepage&&this.homepage.showNotification&&this.homepage.showNotification("Non segui pi√π questo istituto","info"),await this.loadConnectionCounts(),await this.addToRecentActivity("unfollow",t)}catch(t){console.error("Error unfollowing institute:",t),e.innerHTML='<i class="fas fa-check"></i> Seguito',this.homepage&&this.homepage.showNotification&&this.homepage.showNotification("Errore nell'annullare il follow","error")}finally{e.disabled=!1}}async addToRecentActivity(t,e){try{const{data:i}=await window.eduNetAuth.supabase.from("school_institutes").select("institute_name").eq("id",e).single();if(!i)return;const n=document.getElementById("recent-activity");if(!n)return;const s=n.querySelector(".no-activity");s&&s.remove();const o=document.createElement("div");o.className="activity-item",o.innerHTML=`\n        <div class="activity-icon ${"follow"===t?"success":"info"}">\n          <i class="fas fa-${"follow"===t?"user-plus":"user-minus"}"></i>\n        </div>\n        <div class="activity-content">\n          <p class="activity-text">\n            ${"follow"===t?"Hai iniziato a seguire":"Non segui pi√π"} \n            <strong>${this.escapeHtml(i.institute_name)}</strong>\n          </p>\n          <span class="activity-time">Adesso</span>\n        </div>\n      `,n.insertBefore(o,n.firstChild);const a=n.querySelectorAll(".activity-item");a.length>5&&a[a.length-1].remove()}catch(t){console.error("Error adding to recent activity:",t)}}viewInstituteProfile(t){window.location.href=window.AppConfig.getPageUrl(`pages/profile/profile.html?id=${t}`)}async loadConnectionCounts(){if(this.engine)try{const t=await this.engine.getConnectionCounts(),e=document.getElementById("following-count"),i=document.getElementById("followers-count");if(e){const i=e.querySelector(".count");i&&(i.textContent=t.following)}if(i){const e=i.querySelector(".count");e&&(e.textContent=t.followers)}}catch(t){console.error("Error loading connection counts:",t)}}showLoadingState(){const t=document.getElementById("suggested-institutes");t&&(t.innerHTML='\n      <div class="suggestions-loading">\n        <i class="fas fa-spinner fa-spin"></i>\n        <p>Caricamento suggerimenti...</p>\n      </div>\n    ')}showEmptyState(){const t=document.getElementById("suggested-institutes");t&&(t.innerHTML='\n      <div class="suggestions-empty">\n        <i class="fas fa-search"></i>\n        <p>Nessun suggerimento disponibile al momento</p>\n      </div>\n    ')}showErrorState(){const t=document.getElementById("suggested-institutes");t&&(t.innerHTML='\n      <div class="suggestions-empty">\n        <i class="fas fa-exclamation-triangle"></i>\n        <p>Errore nel caricamento dei suggerimenti</p>\n      </div>\n    ')}async trackActivity(t,e=null,i=null,n=null){if(this.engine)try{await this.engine.trackActivity(t,e,i,n)}catch(t){console.error("Error tracking activity:",t)}}async refreshRecommendations(){if(this.engine)try{await window.eduNetAuth.supabase.from("recommendation_cache").delete().eq("user_id",this.engine.userId)}catch(t){console.error("Error clearing cache:",t)}await this.loadRecommendations()}}class DiscoverTabManager{constructor(t){this.homepage=t,this.recommendationUI=null}init(t){this.recommendationUI=t}async renderDiscoverSection(){const t=document.getElementById("feed-content");if(!t)return;const e=t.children;for(let t of e)t.classList.contains("discover-section")||(t.style.display="none");let i=t.querySelector(".discover-section");i||(i=document.createElement("div"),i.className="discover-section",i.innerHTML='\n        <div class="discover-header">\n          <h2>Scopri</h2>\n          <p>Trova nuovi istituti e contenuti interessanti</p>\n        </div>\n        \n        \x3c!-- Trending Topics --\x3e\n        <div class="trending-topics">\n          <h3><i class="fas fa-fire"></i> Argomenti di Tendenza</h3>\n          <div id="trending-topics-list">\n            <div class="suggestions-loading">\n              <i class="fas fa-spinner fa-spin"></i>\n            </div>\n          </div>\n        </div>\n        \n        \x3c!-- Suggested Institutes (Expanded) --\x3e\n        <div class="suggested-institutes">\n          <div class="section-header">\n            <h3><i class="fas fa-school"></i> Istituti Consigliati</h3>\n          </div>\n          <div id="discover-institutes-list">\n            <div class="suggestions-loading">\n              <i class="fas fa-spinner fa-spin"></i>\n            </div>\n          </div>\n        </div>\n      ',t.appendChild(i)),i.style.display="block",await this.loadTrendingTopics(),await this.loadDiscoverInstitutes()}hideDiscoverSection(){const t=document.getElementById("feed-content");if(!t)return;const e=t.querySelector(".discover-section");e&&(e.style.display="none");const i=t.children;for(let t of i)t.classList.contains("discover-section")||t.style.removeProperty("display");setTimeout(()=>{const t=document.querySelector(".edumatch-section"),e=document.getElementById("eduMatchSection");t&&(t.style.removeProperty("display"),console.log("‚úÖ EduMatch ripristinato (class selector)")),e&&(e.style.removeProperty("display"),console.log("‚úÖ EduMatch ripristinato (id selector)"))},50)}async loadTrendingTopics(){const t=document.getElementById("trending-topics-list");if(t)try{const{data:e}=await window.eduNetAuth.supabase.from("institute_posts").select("tags").eq("published",!0).gte("created_at",new Date(Date.now()-6048e5).toISOString()).limit(100);if(!e||0===e.length)return void(t.innerHTML='<p style="color: #999; text-align: center;">Nessun argomento di tendenza</p>');const i={};e.forEach(t=>{t.tags&&Array.isArray(t.tags)&&t.tags.forEach(t=>{i[t]=(i[t]||0)+1})});const n=Object.entries(i).sort((t,e)=>e[1]-t[1]).slice(0,10);if(0===n.length)return void(t.innerHTML='<p style="color: #999; text-align: center;">Nessun argomento di tendenza</p>');t.innerHTML=n.map(([t,e])=>`\n        <span class="topic-tag" data-tag="${t}">\n          #${t}\n          <span class="topic-count">${e}</span>\n        </span>\n      `).join(""),t.querySelectorAll(".topic-tag").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.tag;this.searchByTag(e)})})}catch(e){console.error("Error loading trending topics:",e),t.innerHTML='<p style="color: #999; text-align: center;">Errore nel caricamento</p>'}}async loadDiscoverInstitutes(){const t=document.getElementById("discover-institutes-list");if(t&&this.recommendationUI&&this.recommendationUI.engine)try{const e=await this.recommendationUI.engine.getRecommendations(10);if(0===e.length)return void(t.innerHTML='<p style="color: #999; text-align: center;">Nessun istituto da suggerire</p>');const i=await this.recommendationUI.getFollowedInstitutes();t.innerHTML=e.map(t=>{const e=i.includes(t.id);return`\n          <div class="institute-suggestion" data-institute-id="${t.id}">\n            <div class="institute-avatar">\n              ${this.recommendationUI.getInstituteInitials(t.institute_name)}\n            </div>\n            <div class="institute-info">\n              <div class="institute-name">${this.recommendationUI.escapeHtml(t.institute_name)}</div>\n              <div class="institute-type">${this.recommendationUI.escapeHtml(t.institute_type||"Istituto")}</div>\n              ${t.city?`\n                <div class="institute-location">\n                  <i class="fas fa-map-marker-alt"></i>\n                  ${this.recommendationUI.escapeHtml(t.city)}\n                </div>\n              `:""}\n              <div class="recommendation-score">\n                <span class="score-badge">${t.score}%</span>\n                <span>Match</span>\n              </div>\n            </div>\n            <button class="follow-btn ${e?"following":""}" \n                    data-action="${e?"unfollow":"follow"}" \n                    data-institute-id="${t.id}">\n              <i class="fas fa-${e?"check":"plus"}"></i> \n              ${e?"Seguito":"Segui"}\n            </button>\n          </div>\n        `}).join(""),this.recommendationUI.attachFollowListeners()}catch(e){console.error("Error loading discover institutes:",e),t.innerHTML='<p style="color: #999; text-align: center;">Errore nel caricamento</p>'}}searchByTag(t){if(this.homepage){this.homepage.switchFeedTab("all");const e=document.getElementById("global-search");e&&(e.value=`#${t}`,e.dispatchEvent(new Event("input")))}}}"undefined"!=typeof window&&(window.RecommendationUI=RecommendationUI,window.DiscoverTabManager=DiscoverTabManager,window.DiscoverManagerIntegration=DiscoverTabManager);