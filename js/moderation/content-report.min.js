class ContentReportManager{constructor(){this.categories=[{id:"cyberbullying",label:"Cyberbullismo",icon:"fas fa-user-slash",priority:"high"},{id:"inappropriate",label:"Contenuto inappropriato",icon:"fas fa-ban",priority:"normal"},{id:"spam",label:"Spam o pubblicitÃ ",icon:"fas fa-ad",priority:"low"},{id:"privacy",label:"Violazione privacy",icon:"fas fa-user-secret",priority:"high"},{id:"misinformation",label:"Informazioni false",icon:"fas fa-exclamation-triangle",priority:"normal"},{id:"harassment",label:"Molestie o minacce",icon:"fas fa-angry",priority:"high"},{id:"other",label:"Altro",icon:"fas fa-flag",priority:"normal"}],this.modal=null,this.currentReport=null,this.init()}init(){this.createModal(),this.attachEventListeners()}createModal(){if(document.getElementById("reportModal"))return void(this.modal=document.getElementById("reportModal"));const n=`\n            <div id="reportModal" class="report-modal" role="dialog" aria-labelledby="report-title" aria-hidden="true">\n                <div class="report-modal-backdrop"></div>\n                <div class="report-modal-container">\n                    <div class="report-modal-content">\n                        <header class="report-modal-header">\n                            <h2 id="report-title" class="report-modal-title">\n                                <i class="fas fa-flag"></i>\n                                Segnala Contenuto\n                            </h2>\n                            <button class="report-modal-close" aria-label="Chiudi">\n                                <i class="fas fa-times"></i>\n                            </button>\n                        </header>\n                        \n                        <div class="report-modal-body">\n                            <p class="report-intro">\n                                Seleziona il motivo della segnalazione. Le segnalazioni vengono esaminate entro 24 ore.\n                            </p>\n                            \n                            <div class="report-categories">\n                                ${this.categories.map(n=>`\n                                    <label class="report-category-option">\n                                        <input type="radio" name="reportCategory" value="${n.id}" data-priority="${n.priority}">\n                                        <span class="report-category-card">\n                                            <i class="${n.icon}"></i>\n                                            <span>${n.label}</span>\n                                        </span>\n                                    </label>\n                                `).join("")}\n                            </div>\n                            \n                            <div class="report-description-section" style="display: none;">\n                                <label for="reportDescription" class="report-label">\n                                    Descrivi il problema (opzionale)\n                                </label>\n                                <textarea \n                                    id="reportDescription" \n                                    class="report-textarea" \n                                    placeholder="Fornisci dettagli aggiuntivi che possano aiutarci a valutare la segnalazione..."\n                                    maxlength="500"\n                                ></textarea>\n                                <div class="report-char-count">\n                                    <span id="reportCharCount">0</span>/500\n                                </div>\n                            </div>\n                            \n                            <div class="report-cyberbullying-info" style="display: none;">\n                                <div class="report-info-box warning">\n                                    <i class="fas fa-exclamation-triangle"></i>\n                                    <div>\n                                        <strong>Segnalazione di Cyberbullismo</strong>\n                                        <p>Se sei vittima di cyberbullismo o conosci qualcuno che lo Ã¨, puoi anche contattare:</p>\n                                        <ul>\n                                            <li><strong>Telefono Azzurro:</strong> 19696 (gratuito, attivo 24/7)</li>\n                                            <li><strong>Email:</strong> <a href="mailto:cyberbullismo@edunet19.it">cyberbullismo@edunet19.it</a></li>\n                                        </ul>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                        \n                        <footer class="report-modal-footer">\n                            <button class="btn btn-secondary report-cancel-btn">Annulla</button>\n                            <button class="btn btn-primary report-submit-btn" disabled>\n                                <i class="fas fa-paper-plane"></i>\n                                Invia Segnalazione\n                            </button>\n                        </footer>\n                    </div>\n                </div>\n            </div>\n        `;document.body.insertAdjacentHTML("beforeend",n),this.modal=document.getElementById("reportModal"),this.injectStyles()}injectStyles(){if(document.getElementById("report-modal-styles"))return;const n='\n            <style id="report-modal-styles">\n                .report-modal {\n                    display: none;\n                    position: fixed;\n                    top: 0;\n                    left: 0;\n                    width: 100%;\n                    height: 100%;\n                    z-index: 10000;\n                }\n                \n                .report-modal.active {\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                }\n                \n                .report-modal-backdrop {\n                    position: absolute;\n                    top: 0;\n                    left: 0;\n                    width: 100%;\n                    height: 100%;\n                    background: rgba(0, 0, 0, 0.6);\n                    backdrop-filter: blur(4px);\n                }\n                \n                .report-modal-container {\n                    position: relative;\n                    width: 90%;\n                    max-width: 500px;\n                    max-height: 90vh;\n                    overflow-y: auto;\n                }\n                \n                .report-modal-content {\n                    background: white;\n                    border-radius: 16px;\n                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n                    overflow: hidden;\n                }\n                \n                .report-modal-header {\n                    display: flex;\n                    align-items: center;\n                    justify-content: space-between;\n                    padding: 1.25rem 1.5rem;\n                    background: linear-gradient(135deg, #ef4444, #dc2626);\n                    color: white;\n                }\n                \n                .report-modal-title {\n                    display: flex;\n                    align-items: center;\n                    gap: 0.75rem;\n                    font-size: 1.25rem;\n                    font-weight: 600;\n                    margin: 0;\n                }\n                \n                .report-modal-close {\n                    background: rgba(255, 255, 255, 0.2);\n                    border: none;\n                    color: white;\n                    width: 36px;\n                    height: 36px;\n                    border-radius: 50%;\n                    cursor: pointer;\n                    transition: background 0.2s;\n                }\n                \n                .report-modal-close:hover {\n                    background: rgba(255, 255, 255, 0.3);\n                }\n                \n                .report-modal-body {\n                    padding: 1.5rem;\n                }\n                \n                .report-intro {\n                    color: #6b7280;\n                    margin-bottom: 1.25rem;\n                    font-size: 0.95rem;\n                }\n                \n                .report-categories {\n                    display: grid;\n                    grid-template-columns: repeat(2, 1fr);\n                    gap: 0.75rem;\n                }\n                \n                .report-category-option {\n                    cursor: pointer;\n                }\n                \n                .report-category-option input {\n                    display: none;\n                }\n                \n                .report-category-card {\n                    display: flex;\n                    flex-direction: column;\n                    align-items: center;\n                    gap: 0.5rem;\n                    padding: 1rem;\n                    border: 2px solid #e5e7eb;\n                    border-radius: 12px;\n                    transition: all 0.2s;\n                    text-align: center;\n                }\n                \n                .report-category-card i {\n                    font-size: 1.5rem;\n                    color: #6b7280;\n                }\n                \n                .report-category-card span {\n                    font-size: 0.85rem;\n                    color: #374151;\n                    font-weight: 500;\n                }\n                \n                .report-category-option input:checked + .report-category-card {\n                    border-color: #ef4444;\n                    background: #fef2f2;\n                }\n                \n                .report-category-option input:checked + .report-category-card i {\n                    color: #ef4444;\n                }\n                \n                .report-category-option:hover .report-category-card {\n                    border-color: #d1d5db;\n                    background: #f9fafb;\n                }\n                \n                .report-description-section {\n                    margin-top: 1.25rem;\n                }\n                \n                .report-label {\n                    display: block;\n                    font-weight: 500;\n                    color: #374151;\n                    margin-bottom: 0.5rem;\n                }\n                \n                .report-textarea {\n                    width: 100%;\n                    min-height: 100px;\n                    padding: 0.75rem;\n                    border: 2px solid #e5e7eb;\n                    border-radius: 8px;\n                    resize: vertical;\n                    font-family: inherit;\n                    font-size: 0.95rem;\n                }\n                \n                .report-textarea:focus {\n                    outline: none;\n                    border-color: #3b82f6;\n                }\n                \n                .report-char-count {\n                    text-align: right;\n                    font-size: 0.8rem;\n                    color: #9ca3af;\n                    margin-top: 0.25rem;\n                }\n                \n                .report-info-box {\n                    display: flex;\n                    gap: 1rem;\n                    padding: 1rem;\n                    border-radius: 8px;\n                    margin-top: 1rem;\n                }\n                \n                .report-info-box.warning {\n                    background: #fef3c7;\n                    border: 1px solid #f59e0b;\n                }\n                \n                .report-info-box.warning i {\n                    color: #f59e0b;\n                    font-size: 1.25rem;\n                }\n                \n                .report-info-box strong {\n                    display: block;\n                    margin-bottom: 0.5rem;\n                    color: #92400e;\n                }\n                \n                .report-info-box p {\n                    margin: 0 0 0.5rem;\n                    font-size: 0.9rem;\n                    color: #78350f;\n                }\n                \n                .report-info-box ul {\n                    margin: 0;\n                    padding-left: 1.25rem;\n                    font-size: 0.85rem;\n                    color: #78350f;\n                }\n                \n                .report-info-box a {\n                    color: #b45309;\n                }\n                \n                .report-modal-footer {\n                    display: flex;\n                    justify-content: flex-end;\n                    gap: 0.75rem;\n                    padding: 1rem 1.5rem;\n                    background: #f9fafb;\n                    border-top: 1px solid #e5e7eb;\n                }\n                \n                .report-submit-btn:disabled {\n                    opacity: 0.5;\n                    cursor: not-allowed;\n                }\n                \n                /* Dark theme */\n                body.dark-theme .report-modal-content {\n                    background: #1f2937;\n                }\n                \n                body.dark-theme .report-intro {\n                    color: #9ca3af;\n                }\n                \n                body.dark-theme .report-category-card {\n                    border-color: #374151;\n                    background: #111827;\n                }\n                \n                body.dark-theme .report-category-card span {\n                    color: #e5e7eb;\n                }\n                \n                body.dark-theme .report-category-option input:checked + .report-category-card {\n                    background: rgba(239, 68, 68, 0.15);\n                }\n                \n                body.dark-theme .report-category-option:hover .report-category-card {\n                    border-color: #4b5563;\n                    background: #1f2937;\n                }\n                \n                body.dark-theme .report-label {\n                    color: #e5e7eb;\n                }\n                \n                body.dark-theme .report-textarea {\n                    background: #111827;\n                    border-color: #374151;\n                    color: #f9fafb;\n                }\n                \n                body.dark-theme .report-modal-footer {\n                    background: #111827;\n                    border-top-color: #374151;\n                }\n                \n                body.dark-theme .report-info-box.warning {\n                    background: rgba(245, 158, 11, 0.15);\n                    border-color: rgba(245, 158, 11, 0.4);\n                }\n                \n                body.dark-theme .report-info-box.warning strong,\n                body.dark-theme .report-info-box.warning p,\n                body.dark-theme .report-info-box.warning ul {\n                    color: #fcd34d;\n                }\n                \n                @media (max-width: 480px) {\n                    .report-categories {\n                        grid-template-columns: 1fr;\n                    }\n                }\n            </style>\n        ';document.head.insertAdjacentHTML("beforeend",n)}attachEventListeners(){if(!this.modal)return;const n=this.modal.querySelector(".report-modal-close");n?.addEventListener("click",()=>this.close());const e=this.modal.querySelector(".report-modal-backdrop");e?.addEventListener("click",()=>this.close());const o=this.modal.querySelector(".report-cancel-btn");o?.addEventListener("click",()=>this.close());const r=this.modal.querySelectorAll('input[name="reportCategory"]');r.forEach(n=>{n.addEventListener("change",n=>this.onCategoryChange(n))});const t=this.modal.querySelector("#reportDescription");t?.addEventListener("input",n=>{const e=n.target.value.length;document.getElementById("reportCharCount").textContent=e});const a=this.modal.querySelector(".report-submit-btn");a?.addEventListener("click",()=>this.submit()),document.addEventListener("keydown",n=>{"Escape"===n.key&&this.modal.classList.contains("active")&&this.close()})}onCategoryChange(n){const e=n.target.value,o=this.modal.querySelector(".report-description-section"),r=this.modal.querySelector(".report-cyberbullying-info"),t=this.modal.querySelector(".report-submit-btn");o.style.display="block",r.style.display="cyberbullying"===e?"block":"none",t.disabled=!1}open(n,e,o=null){this.currentReport={contentType:n,contentId:e,authorId:o};const r=this.modal.querySelectorAll('input[name="reportCategory"]');r.forEach(n=>n.checked=!1);const t=this.modal.querySelector("#reportDescription");t&&(t.value="");const a=document.getElementById("reportCharCount");a&&(a.textContent="0");const i=this.modal.querySelector(".report-description-section");i&&(i.style.display="none");const l=this.modal.querySelector(".report-cyberbullying-info");l&&(l.style.display="none");const s=this.modal.querySelector(".report-submit-btn");s&&(s.disabled=!0),this.modal.classList.add("active"),this.modal.setAttribute("aria-hidden","false"),document.body.style.overflow="hidden"}close(){this.modal.classList.remove("active"),this.modal.setAttribute("aria-hidden","true"),document.body.style.overflow="",this.currentReport=null}async submit(){if(!this.currentReport)return;const n=this.modal.querySelector('input[name="reportCategory"]:checked');if(!n)return;const e=n.value,o=n.dataset.priority,r=this.modal.querySelector("#reportDescription")?.value||"",t=this.modal.querySelector(".report-submit-btn");t.disabled=!0,t.innerHTML='<i class="fas fa-spinner fa-spin"></i> Invio...';try{await this.sendReport({contentType:this.currentReport.contentType,contentId:this.currentReport.contentId,authorId:this.currentReport.authorId,category:e,priority:o,description:r}),this.close(),this.showNotification("ðŸ“¢ Segnalazione inviata. Grazie per aiutarci a mantenere la community sicura!","success")}catch(n){console.error("Error submitting report:",n),this.showNotification("Errore nell'invio della segnalazione. Riprova.","error"),t.disabled=!1,t.innerHTML='<i class="fas fa-paper-plane"></i> Invia Segnalazione'}}async sendReport(n){if(!window.supabaseClientManager?.client)return void console.log("Demo mode: sendReport",n);const e=await window.supabaseClientManager.getClient(),{data:{user:o}}=await e.auth.getUser();if(!o)throw new Error("User not authenticated");const{error:r}=await e.from("content_reports").insert({reporter_id:o.id,reported_user_id:n.authorId,reported_content_type:n.contentType,reported_content_id:n.contentId,report_reason:n.category,report_description:n.description,category:n.category,priority:n.priority,status:"pending"});if(r)throw r}showNotification(n,e="info"){window.homepageManager?.showNotification?window.homepageManager.showNotification(n,e):window.showNotification?window.showNotification(n,e):alert(n)}}window.contentReportManager=new ContentReportManager,window.openReportModal=function(n,e,o=null){window.contentReportManager&&window.contentReportManager.open(n,e,o)};