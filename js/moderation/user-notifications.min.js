class ModerationNotifications{constructor(){this.supabase=null,this.currentUser=null,this.pendingNotifications=[],this.syncInterval=null,this.initialized=!1}async init(){if(!this.initialized)try{await this.waitForSupabase();const{data:{user:n}}=await this.supabase.auth.getUser();if(!n)return;this.currentUser=n,this.initialized=!0,await this.checkNotifications(),this.startSilentSync()}catch(n){console.error("[ModerationNotifications] Init error:",n)}}async waitForSupabase(){return new Promise(n=>{const e=async()=>{if(window.supabaseClientManager)try{if(this.supabase=await window.supabaseClientManager.getClient(),this.supabase)return void n()}catch(n){}setTimeout(e,100)};e()})}startSilentSync(){this.syncInterval=setInterval(()=>{this.checkNotifications(!0)},6e4)}stopSync(){this.syncInterval&&(clearInterval(this.syncInterval),this.syncInterval=null)}async checkNotifications(n=!1){if(this.currentUser)try{const{data:e,error:t}=await this.supabase.from("moderation_actions").select("*").eq("user_id",this.currentUser.id).eq("user_notified",!1).order("created_at",{ascending:!1});if(t)return void console.error("[ModerationNotifications] Error fetching:",t);e&&e.length>0&&!n&&(this.pendingNotifications=e,this.showNotificationModal(e[0]))}catch(n){console.error("[ModerationNotifications] Check error:",n)}}showNotificationModal(n){const e=document.getElementById("moderationNotificationModal");e&&e.remove();const t={content_deleted:"Contenuto Rimosso",content_deleted_permanent:"Contenuto Eliminato Definitivamente",content_shadowban:"Contenuto Nascosto",content_restored:"Contenuto Ripristinato",warning:"Avvertimento",suspension_24h:"Sospensione 24 ore",suspension_7d:"Sospensione 7 giorni",suspension_30d:"Sospensione 30 giorni",ban:"Account Sospeso"},o={content_deleted:"fa-trash-alt",content_deleted_permanent:"fa-trash",content_shadowban:"fa-eye-slash",content_restored:"fa-undo",warning:"fa-exclamation-triangle",suspension_24h:"fa-clock",suspension_7d:"fa-calendar-week",suspension_30d:"fa-calendar-alt",ban:"fa-ban"},i={content_deleted:"#ef4444",content_deleted_permanent:"#991b1b",content_shadowban:"#f59e0b",content_restored:"#22c55e",warning:"#f59e0b",suspension_24h:"#ef4444",suspension_7d:"#ef4444",suspension_30d:"#dc2626",ban:"#991b1b"},a={post:"post",comment:"commento"},s=n.action_type||"warning",r=t[s]||"Azione di Moderazione",d=o[s]||"fa-info-circle",c=i[s]||"#3b82f6",l=a[n.content_type]||"contenuto",p="rejected"!==n.appeal_status&&"approved"!==n.appeal_status,m=document.createElement("div");m.id="moderationNotificationModal",m.innerHTML=`\n            <div class="mod-notif-backdrop"></div>\n            <div class="mod-notif-container">\n                <div class="mod-notif-content">\n                    <div class="mod-notif-header">\n                        <div class="mod-notif-icon" style="background: ${c}20; color: ${c};">\n                            <i class="fas ${d}"></i>\n                        </div>\n                        <h2>${r}</h2>\n                    </div>\n                    \n                    <div class="mod-notif-body">\n                        <p class="mod-notif-message">\n                            ${this.getActionMessage(n,l)}\n                        </p>\n                        \n                        ${n.reason?`\n                            <div class="mod-notif-reason">\n                                <strong>Motivo:</strong>\n                                <p>${this.escapeHtml(n.reason)}</p>\n                            </div>\n                        `:""}\n                        \n                        ${n.suspension_until?`\n                            <div class="mod-notif-suspension">\n                                <i class="fas fa-clock"></i>\n                                <span>Fino al: ${new Date(n.suspension_until).toLocaleDateString("it-IT",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}</span>\n                            </div>\n                        `:""}\n                        \n                        <div class="mod-notif-info">\n                            <i class="fas fa-info-circle"></i>\n                            <p>\n                                Se ritieni che questa decisione sia stata presa per errore, \n                                puoi presentare un ricorso spiegando le tue ragioni. \n                                Il nostro team esaminerà la tua richiesta.\n                            </p>\n                        </div>\n                        \n                        ${p?'\n                            <div class="mod-notif-appeal-section" id="appealSection">\n                                <button class="mod-notif-btn-appeal" id="showAppealFormBtn">\n                                    <i class="fas fa-balance-scale"></i>\n                                    Presenta Ricorso\n                                </button>\n                                \n                                <div class="mod-notif-appeal-form" id="appealForm" style="display: none;">\n                                    <label>Spiega perché ritieni che la decisione sia errata:</label>\n                                    <textarea id="appealText" placeholder="Descrivi le tue ragioni..." maxlength="1000"></textarea>\n                                    <div class="mod-notif-appeal-actions">\n                                        <button class="mod-notif-btn-cancel" id="cancelAppealBtn">Annulla</button>\n                                        <button class="mod-notif-btn-submit" id="submitAppealBtn">\n                                            <i class="fas fa-paper-plane"></i>\n                                            Invia Ricorso\n                                        </button>\n                                    </div>\n                                </div>\n                            </div>\n                        ':"pending"===n.appeal_status?'\n                            <div class="mod-notif-appeal-pending">\n                                <i class="fas fa-hourglass-half"></i>\n                                <span>Ricorso in attesa di revisione</span>\n                            </div>\n                        ':""}\n                    </div>\n                    \n                    <div class="mod-notif-footer">\n                        <button class="mod-notif-btn-acknowledge" id="acknowledgeBtn">\n                            Ho capito\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `,document.body.appendChild(m),this.injectStyles(),this.attachModalEvents(m,n),requestAnimationFrame(()=>{m.classList.add("active")})}getActionMessage(n,e){const t={content_deleted:`Il tuo ${e} è stato rimosso perché viola le nostre linee guida della community.`,content_deleted_permanent:`Il tuo ${e} è stato eliminato definitivamente dalla piattaforma.`,content_shadowban:`Il tuo ${e} è stato nascosto dalla visualizzazione pubblica a causa di una violazione delle linee guida.`,content_restored:`Il tuo ${e} è stato ripristinato e ora è nuovamente visibile.`,warning:"Hai ricevuto un avvertimento per il tuo comportamento sulla piattaforma.",suspension_24h:"Il tuo account è stato temporaneamente sospeso per 24 ore.",suspension_7d:"Il tuo account è stato sospeso per 7 giorni.",suspension_30d:"Il tuo account è stato sospeso per 30 giorni.",ban:"Il tuo account è stato sospeso a tempo indeterminato."};return t[n.action_type]||"È stata intrapresa un'azione di moderazione sul tuo account."}attachModalEvents(n,e){const t=n.querySelector(".mod-notif-backdrop"),o=n.querySelector("#acknowledgeBtn"),i=n.querySelector("#showAppealFormBtn"),a=n.querySelector("#cancelAppealBtn"),s=n.querySelector("#submitAppealBtn"),r=n.querySelector("#appealForm");o?.addEventListener("click",()=>{this.acknowledgeNotification(e.id),this.closeModal(n)}),t?.addEventListener("click",()=>{this.acknowledgeNotification(e.id),this.closeModal(n)}),i?.addEventListener("click",()=>{i.style.display="none",r.style.display="block"}),a?.addEventListener("click",()=>{r.style.display="none",i.style.display="flex"}),s?.addEventListener("click",()=>{this.submitAppeal(e.id,n)})}async acknowledgeNotification(n){try{await this.supabase.from("moderation_actions").update({user_notified:!0,user_notified_at:(new Date).toISOString()}).eq("id",n),this.pendingNotifications=this.pendingNotifications.filter(e=>e.id!==n),this.pendingNotifications.length>0&&setTimeout(()=>{this.showNotificationModal(this.pendingNotifications[0])},500)}catch(n){console.error("[ModerationNotifications] Acknowledge error:",n)}}async submitAppeal(n,e){const t=e.querySelector("#appealText")?.value?.trim(),o=e.querySelector("#submitAppealBtn");if(t)if(t.length<20)this.showToast("La motivazione deve essere più dettagliata (min. 20 caratteri)","warning");else{o.disabled=!0,o.innerHTML='<i class="fas fa-spinner fa-spin"></i> Invio...';try{const{error:o}=await this.supabase.from("moderation_actions").update({appeal_status:"pending",appeal_text:t,appeal_submitted_at:(new Date).toISOString(),user_notified:!0,user_notified_at:(new Date).toISOString()}).eq("id",n);if(o)throw o;this.showToast("Ricorso inviato con successo! Riceverai una risposta a breve.","success"),this.closeModal(e),this.pendingNotifications=this.pendingNotifications.filter(e=>e.id!==n)}catch(n){console.error("[ModerationNotifications] Appeal error:",n),this.showToast("Errore nell'invio del ricorso. Riprova.","error"),o.disabled=!1,o.innerHTML='<i class="fas fa-paper-plane"></i> Invia Ricorso'}}else this.showToast("Inserisci una motivazione per il ricorso","warning")}closeModal(n){n.classList.remove("active"),setTimeout(()=>n.remove(),300)}showToast(n,e="info"){const t=document.createElement("div");t.className=`mod-notif-toast ${e}`,t.innerHTML=`\n            <i class="fas ${"success"===e?"fa-check-circle":"error"===e?"fa-times-circle":"fa-exclamation-circle"}"></i>\n            <span>${n}</span>\n        `,document.body.appendChild(t),requestAnimationFrame(()=>t.classList.add("show")),setTimeout(()=>{t.classList.remove("show"),setTimeout(()=>t.remove(),300)},4e3)}escapeHtml(n){const e=document.createElement("div");return e.textContent=n,e.innerHTML}injectStyles(){if(document.getElementById("moderationNotificationStyles"))return;const n=document.createElement("style");n.id="moderationNotificationStyles",n.textContent="\n            #moderationNotificationModal {\n                position: fixed;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                z-index: 10000;\n                opacity: 0;\n                visibility: hidden;\n                transition: opacity 0.3s, visibility 0.3s;\n            }\n            \n            #moderationNotificationModal.active {\n                opacity: 1;\n                visibility: visible;\n            }\n            \n            .mod-notif-backdrop {\n                position: absolute;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                background: rgba(0, 0, 0, 0.7);\n                backdrop-filter: blur(4px);\n            }\n            \n            .mod-notif-container {\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                width: 90%;\n                max-width: 500px;\n                max-height: 90vh;\n                overflow-y: auto;\n            }\n            \n            .mod-notif-content {\n                background: #1e293b;\n                border-radius: 16px;\n                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);\n                overflow: hidden;\n            }\n            \n            .mod-notif-header {\n                padding: 1.5rem;\n                text-align: center;\n                border-bottom: 1px solid #334155;\n            }\n            \n            .mod-notif-icon {\n                width: 64px;\n                height: 64px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                margin: 0 auto 1rem;\n                font-size: 1.75rem;\n            }\n            \n            .mod-notif-header h2 {\n                color: #f1f5f9;\n                font-size: 1.25rem;\n                font-weight: 600;\n                margin: 0;\n            }\n            \n            .mod-notif-body {\n                padding: 1.5rem;\n            }\n            \n            .mod-notif-message {\n                color: #e2e8f0;\n                font-size: 1rem;\n                line-height: 1.6;\n                margin: 0 0 1rem;\n            }\n            \n            .mod-notif-reason {\n                background: #0f172a;\n                border-radius: 8px;\n                padding: 1rem;\n                margin-bottom: 1rem;\n            }\n            \n            .mod-notif-reason strong {\n                color: #94a3b8;\n                font-size: 0.875rem;\n                display: block;\n                margin-bottom: 0.5rem;\n            }\n            \n            .mod-notif-reason p {\n                color: #e2e8f0;\n                margin: 0;\n                font-size: 0.95rem;\n            }\n            \n            .mod-notif-suspension {\n                display: flex;\n                align-items: center;\n                gap: 0.5rem;\n                padding: 0.75rem 1rem;\n                background: rgba(239, 68, 68, 0.1);\n                border: 1px solid rgba(239, 68, 68, 0.3);\n                border-radius: 8px;\n                color: #fca5a5;\n                font-size: 0.9rem;\n                margin-bottom: 1rem;\n            }\n            \n            .mod-notif-info {\n                display: flex;\n                gap: 0.75rem;\n                padding: 1rem;\n                background: rgba(59, 130, 246, 0.1);\n                border: 1px solid rgba(59, 130, 246, 0.2);\n                border-radius: 8px;\n                margin-bottom: 1rem;\n            }\n            \n            .mod-notif-info i {\n                color: #60a5fa;\n                font-size: 1rem;\n                margin-top: 0.125rem;\n            }\n            \n            .mod-notif-info p {\n                color: #94a3b8;\n                font-size: 0.875rem;\n                line-height: 1.5;\n                margin: 0;\n            }\n            \n            .mod-notif-appeal-section {\n                margin-top: 1rem;\n            }\n            \n            .mod-notif-btn-appeal {\n                width: 100%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 0.5rem;\n                padding: 0.875rem;\n                background: transparent;\n                border: 2px solid #3b82f6;\n                border-radius: 8px;\n                color: #3b82f6;\n                font-size: 0.95rem;\n                font-weight: 500;\n                cursor: pointer;\n                transition: all 0.2s;\n            }\n            \n            .mod-notif-btn-appeal:hover {\n                background: #3b82f6;\n                color: white;\n            }\n            \n            .mod-notif-appeal-form {\n                margin-top: 1rem;\n            }\n            \n            .mod-notif-appeal-form label {\n                display: block;\n                color: #94a3b8;\n                font-size: 0.875rem;\n                margin-bottom: 0.5rem;\n            }\n            \n            .mod-notif-appeal-form textarea {\n                width: 100%;\n                min-height: 120px;\n                padding: 0.875rem;\n                background: #0f172a;\n                border: 1px solid #334155;\n                border-radius: 8px;\n                color: #e2e8f0;\n                font-size: 0.95rem;\n                resize: vertical;\n                font-family: inherit;\n            }\n            \n            .mod-notif-appeal-form textarea:focus {\n                outline: none;\n                border-color: #3b82f6;\n            }\n            \n            .mod-notif-appeal-actions {\n                display: flex;\n                gap: 0.75rem;\n                margin-top: 0.75rem;\n            }\n            \n            .mod-notif-btn-cancel {\n                flex: 1;\n                padding: 0.75rem;\n                background: transparent;\n                border: 1px solid #475569;\n                border-radius: 8px;\n                color: #94a3b8;\n                font-size: 0.9rem;\n                cursor: pointer;\n                transition: all 0.2s;\n            }\n            \n            .mod-notif-btn-cancel:hover {\n                background: #334155;\n            }\n            \n            .mod-notif-btn-submit {\n                flex: 2;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 0.5rem;\n                padding: 0.75rem;\n                background: #3b82f6;\n                border: none;\n                border-radius: 8px;\n                color: white;\n                font-size: 0.9rem;\n                font-weight: 500;\n                cursor: pointer;\n                transition: all 0.2s;\n            }\n            \n            .mod-notif-btn-submit:hover:not(:disabled) {\n                background: #2563eb;\n            }\n            \n            .mod-notif-btn-submit:disabled {\n                opacity: 0.7;\n                cursor: not-allowed;\n            }\n            \n            .mod-notif-appeal-pending {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 0.5rem;\n                padding: 0.875rem;\n                background: rgba(245, 158, 11, 0.1);\n                border: 1px solid rgba(245, 158, 11, 0.3);\n                border-radius: 8px;\n                color: #fbbf24;\n                font-size: 0.9rem;\n            }\n            \n            .mod-notif-footer {\n                padding: 1rem 1.5rem;\n                border-top: 1px solid #334155;\n            }\n            \n            .mod-notif-btn-acknowledge {\n                width: 100%;\n                padding: 0.875rem;\n                background: #475569;\n                border: none;\n                border-radius: 8px;\n                color: white;\n                font-size: 1rem;\n                font-weight: 500;\n                cursor: pointer;\n                transition: all 0.2s;\n            }\n            \n            .mod-notif-btn-acknowledge:hover {\n                background: #64748b;\n            }\n            \n            /* Toast */\n            .mod-notif-toast {\n                position: fixed;\n                bottom: 2rem;\n                left: 50%;\n                transform: translateX(-50%) translateY(100px);\n                display: flex;\n                align-items: center;\n                gap: 0.75rem;\n                padding: 1rem 1.5rem;\n                background: #1e293b;\n                border-radius: 12px;\n                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);\n                color: white;\n                font-size: 0.95rem;\n                z-index: 10001;\n                opacity: 0;\n                transition: all 0.3s ease;\n            }\n            \n            .mod-notif-toast.show {\n                transform: translateX(-50%) translateY(0);\n                opacity: 1;\n            }\n            \n            .mod-notif-toast.success { border-left: 4px solid #22c55e; }\n            .mod-notif-toast.success i { color: #22c55e; }\n            .mod-notif-toast.error { border-left: 4px solid #ef4444; }\n            .mod-notif-toast.error i { color: #ef4444; }\n            .mod-notif-toast.warning { border-left: 4px solid #f59e0b; }\n            .mod-notif-toast.warning i { color: #f59e0b; }\n            \n            @media (max-width: 640px) {\n                .mod-notif-container {\n                    width: 95%;\n                }\n                \n                .mod-notif-header, .mod-notif-body, .mod-notif-footer {\n                    padding: 1rem;\n                }\n            }\n        ",document.head.appendChild(n)}}window.moderationNotifications=new ModerationNotifications,document.addEventListener("DOMContentLoaded",()=>{window.moderationNotifications.init()});