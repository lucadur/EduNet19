"use strict";class SavedPostsManager{constructor(){this.currentFilter="all",this.savedPosts=[],this.isLoading=!1,this.init()}async init(){this.setupEventListeners(),await this.updateSavedCount()}setupEventListeners(){const t=document.querySelectorAll(".saved-filter-btn");t.forEach(t=>{t.addEventListener("click",t=>{const e=t.currentTarget.dataset.savedFilter;this.applyFilter(e)})});const e=document.getElementById("back-to-feed-btn");e&&e.addEventListener("click",()=>{this.hideSavedPosts();const t=document.querySelector('[data-section="feed"]');t&&t.click()})}async showSavedPosts(){console.log("ðŸ“‚ showSavedPosts called");const t=document.getElementById("saved-posts-section"),e=document.getElementById("feed-content"),s=document.getElementById("load-more-section"),o=document.getElementById("eduMatchSection"),a=document.querySelector(".feed-header"),n=document.querySelector(".smart-filters"),i=document.querySelector(".feed-tabs");console.log("ðŸ“‚ Elements found:",{savedSection:!!t,feedContent:!!e,eduMatchSection:!!o,feedHeader:!!a}),t?(e&&(e.style.display="none",e.classList.add("hidden")),s&&(s.style.display="none"),o&&(o.style.display="none"),a&&(a.style.display="none"),n&&(n.style.display="none"),i&&(i.style.display="none"),t.classList.remove("hidden"),t.style.display="block",window.scrollTo({top:0,behavior:"smooth"}),console.log("âœ… Saved section should now be visible"),await this.loadSavedPosts()):console.error("âŒ saved-posts-section not found!")}hideSavedPosts(){console.log("ðŸ“‚ hideSavedPosts called");const t=document.getElementById("saved-posts-section"),e=document.getElementById("feed-content"),s=document.getElementById("load-more-section"),o=document.getElementById("eduMatchSection"),a=document.querySelector(".feed-header"),n=document.querySelector(".smart-filters"),i=document.querySelector(".feed-tabs");t&&(t.classList.add("hidden"),t.style.display="none"),e&&(e.style.display="",e.classList.remove("hidden")),s&&(s.style.display="block"),o&&(o.style.display=""),a&&(a.style.display=""),n&&(n.style.display=""),i&&(i.style.display=""),window.scrollTo({top:0,behavior:"smooth"}),console.log("âœ… Feed restored")}async loadSavedPosts(){if(this.isLoading)return;this.isLoading=!0;const t=document.getElementById("saved-loading"),e=document.getElementById("saved-empty");document.getElementById("saved-posts-content");try{if(t&&t.classList.remove("hidden"),e&&e.classList.add("hidden"),!window.supabaseClientManager?.client)return console.log("Supabase not available, showing empty state"),void this.showEmptyState();const s=await window.supabaseClientManager.getClient(),{data:{user:o}}=await s.auth.getUser();if(!o)return console.log("User not authenticated"),void this.showEmptyState();console.log("Fetching saved posts for user:",o.id);const{data:a,error:n}=await s.from("saved_posts").select("id, created_at, post_id, user_id").eq("user_id",o.id).order("created_at",{ascending:!1});if(console.log("Saved posts query result:",{savedData:a,error:n,count:a?.length}),n)return console.error("Error loading saved posts:",n),void this.showEmptyState();const i=(a||[]).map(t=>t.post_id);if(console.log("Post IDs to fetch:",i),0===i.length)return console.log("No saved posts found, showing empty state"),this.savedPosts=[],await this.updateStats(),void this.renderSavedPosts();const{data:d,error:r}=await s.from("institute_posts").select("id, title, content, institute_id, post_type, image_urls, created_at, likes_count, comments_count, views_count").in("id",i);console.log("Posts data fetched:",{postsData:d,postsError:r,count:d?.length}),r&&console.error("Error loading posts details:",r);const c=[...new Set((d||[]).map(t=>t.institute_id))],l={};for(const t of c)try{const{data:e}=await s.from("school_institutes").select("institute_name").eq("id",t).maybeSingle();e&&(l[t]=e.institute_name)}catch(e){console.warn("Could not load author for institute:",t)}const u={};(d||[]).forEach(t=>{u[t.id]={...t,author_name:l[t.institute_id]||"Istituto"}}),this.savedPosts=(a||[]).map(t=>{const e=u[t.post_id];return e?{saved_id:t.id,saved_at:t.created_at,post:{...e,author_id:e.institute_id,likes:e.likes_count,comments:e.comments_count,shares:0,views:e.views_count,image_url:e.image_urls?.[0]||null}}:null}).filter(t=>null!==t),console.log(`Loaded ${this.savedPosts.length} saved posts`),await this.updateStats(),this.renderSavedPosts()}catch(t){console.error("Error in loadSavedPosts:",t),this.showEmptyState()}finally{this.isLoading=!1,t&&t.classList.add("hidden")}}async updateSavedCount(){try{if(!window.supabaseClientManager?.client)return;const t=await window.supabaseClientManager.getClient(),{data:{user:e}}=await t.auth.getUser();if(!e)return;const{count:s,error:o}=await t.from("saved_posts").select("*",{count:"exact",head:!0}).eq("user_id",e.id);if(o)throw o;const a=s||0,n=document.getElementById("saved-count");n&&(n.textContent=a,n.style.display=a>0?"inline-flex":"none");const i=document.getElementById("mobile-saved-count");i&&(i.textContent=a,i.style.display=a>0?"inline-flex":"none")}catch(t){console.error("Error updating saved count:",t)}}async updateStats(){const t=this.savedPosts.length,e=document.getElementById("total-saved-count");e&&(e.textContent=t);const s=document.getElementById("saved-count");s&&(s.textContent=t,s.style.display=t>0?"inline-flex":"none");const o=document.getElementById("mobile-saved-count");o&&(o.textContent=t,o.style.display=t>0?"inline-flex":"none");const a=new Date;a.setDate(a.getDate()-7);const n=this.savedPosts.filter(t=>{const e=new Date(t.saved_at);return e>=a}).length,i=document.getElementById("saved-this-week-count");i&&(i.textContent=n);const d={};this.savedPosts.forEach(t=>{const e=t.post?.category||"Altro";d[e]=(d[e]||0)+1});let r="-",c=0;Object.entries(d).forEach(([t,e])=>{e>c&&(c=e,r=t)});const l=document.getElementById("most-saved-category");l&&(l.textContent=r)}renderSavedPosts(){const t=document.getElementById("saved-posts-content"),e=document.getElementById("saved-empty");if(!t)return;const s=t.querySelectorAll(".saved-post-item");if(s.forEach(t=>t.remove()),0===this.savedPosts.length)return void this.showEmptyState();e&&e.classList.add("hidden");let o=[...this.savedPosts];switch(this.currentFilter){case"recent":default:break;case"oldest":o.reverse();break;case"most-liked":o.sort((t,e)=>(e.post?.likes||0)-(t.post?.likes||0))}o.forEach(e=>{const s=this.createSavedPostElement(e);t.appendChild(s)})}createSavedPostElement(t){const e=t.post,s=new Date(t.saved_at),o=new Date(e.created_at),a=document.createElement("article");a.className="saved-post-item",a.dataset.postId=e.id,a.dataset.savedId=t.saved_id;const n=this.getTimeAgo(s),i=this.getTimeAgo(o),d=e.author_name||"Istituto Autore",r=e.institute_id||e.author_id;return window.avatarManager&&r&&window.avatarManager.loadUserAvatar(r).then(t=>{if(t){const e=a.querySelector(".saved-post-author-avatar");e&&(e.src=t)}}).catch(t=>{console.warn(`Could not load avatar for saved post ${e.id}:`,t)}),a.innerHTML=`\n      <div class="saved-post-header">\n        <div class="saved-post-meta">\n          <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40'%3E%3Crect fill='%236366f1' width='40' height='40'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='white' font-size='16' font-family='Arial'%3E${d.charAt(0).toUpperCase()}%3C/text%3E%3C/svg%3E" alt="${d}" class="saved-post-author-avatar">\n          <div class="saved-post-author-info">\n            <h4>${d}</h4>\n            <p>${i}</p>\n          </div>\n        </div>\n        <div class="saved-post-actions">\n          <button class="saved-action-btn share-btn" title="Condividi" data-post-id="${e.id}">\n            <i class="fas fa-share"></i>\n          </button>\n          <button class="saved-action-btn remove-saved" title="Rimuovi dai salvati" data-saved-id="${t.saved_id}" data-post-id="${e.id}">\n            <i class="fas fa-bookmark"></i>\n          </button>\n        </div>\n      </div>\n      <div class="saved-post-content">\n        <h3>${this.escapeHtml(e.title||"Post senza titolo")}</h3>\n        <p>${this.escapeHtml(e.content||"")}</p>\n      </div>\n      <div class="saved-post-footer">\n        <span class="saved-post-stat">\n          <i class="fas fa-heart"></i>\n          ${e.likes||0}\n        </span>\n        <span class="saved-post-stat">\n          <i class="fas fa-comment"></i>\n          ${e.comments||0}\n        </span>\n        <span class="saved-post-stat">\n          <i class="fas fa-share"></i>\n          ${e.shares||0}\n        </span>\n        <span class="saved-date">Salvato ${n}</span>\n      </div>\n    `,this.attachSavedPostListeners(a),a}attachSavedPostListeners(t){const e=t.querySelector(".remove-saved");e&&e.addEventListener("click",async e=>{e.stopPropagation();const s=e.currentTarget.dataset.savedId,o=e.currentTarget.dataset.postId;await this.removeFromSaved(s,o,t)});const s=t.querySelector(".share-btn");s&&s.addEventListener("click",async t=>{t.stopPropagation();const e=t.currentTarget.dataset.postId;await this.sharePost(e)}),t.addEventListener("click",e=>{if(e.target.closest(".saved-action-btn"))return;const s=t.dataset.postId;console.log("ðŸ“ Navigating to post:",s),this.navigateToPost(s)})}async removeFromSaved(t,e,s){try{if(!window.supabaseClientManager?.client)return;const o=await window.supabaseClientManager.getClient(),{error:a}=await o.from("saved_posts").delete().eq("id",t);if(a)throw a;s.style.opacity="0",s.style.transform="translateX(100px)",setTimeout(()=>{s.remove(),this.savedPosts=this.savedPosts.filter(e=>e.saved_id!==t),this.updateStats(),0===this.savedPosts.length&&this.showEmptyState()},300),window.eduNetHomepage&&window.eduNetHomepage.showNotification("Post rimosso dai salvati","success"),await this.trackActivity("unsave_post",e)}catch(t){console.error("Error removing saved post:",t),window.eduNetHomepage&&window.eduNetHomepage.showNotification("Errore nella rimozione","error")}}async sharePost(t){const e=window.AppConfig.getPageUrl(`post/${t}`);if(navigator.share)try{await navigator.share({title:"Post da EduNet19",url:e}),await this.trackActivity("share_post",t)}catch(t){"AbortError"!==t.name&&console.error("Share error:",t)}else await navigator.clipboard.writeText(e),window.eduNetHomepage&&window.eduNetHomepage.showNotification("ðŸ”— Link copiato negli appunti","success")}applyFilter(t){this.currentFilter=t;const e=document.querySelectorAll(".saved-filter-btn");e.forEach(e=>{e.dataset.savedFilter===t?e.classList.add("active"):e.classList.remove("active")}),this.renderSavedPosts()}showEmptyState(){const t=document.getElementById("saved-empty"),e=document.getElementById("saved-posts-content");if(t&&t.classList.remove("hidden"),e){const t=e.querySelectorAll(".saved-post-item");t.forEach(t=>t.remove())}const s=document.getElementById("total-saved-count");s&&(s.textContent="0");const o=document.getElementById("saved-this-week-count");o&&(o.textContent="0");const a=document.getElementById("most-saved-category");a&&(a.textContent="-")}async trackActivity(t,e){try{if(!window.supabaseClientManager?.client)return;const s=await window.supabaseClientManager.getClient(),{data:{user:o}}=await s.auth.getUser();if(!o)return;const{error:a}=await s.from("user_activities").insert({user_id:o.id,activity_type:t,target_type:"post",target_id:e});a&&"PGRST116"!==a.code&&console.log("Activity tracking error:",a.message)}catch(t){console.log("Activity tracking failed:",t.message)}}getTimeAgo(t){const e=Math.floor((new Date-t)/1e3);let s=e/31536e3;return s>1?Math.floor(s)+" anni fa":(s=e/2592e3,s>1?Math.floor(s)+" mesi fa":(s=e/86400,s>1?Math.floor(s)+" giorni fa":(s=e/3600,s>1?Math.floor(s)+" ore fa":(s=e/60,s>1?Math.floor(s)+" minuti fa":Math.floor(e)+" secondi fa"))))}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}navigateToPost(t){console.log("ðŸ“ Navigating to post in feed:",t),this.hideSavedPosts(),setTimeout(()=>{if(window.eduNetHomepage&&"function"==typeof window.eduNetHomepage.navigateToPost)window.eduNetHomepage.navigateToPost(t);else{const e=document.querySelector(`[data-post-id="${t}"]`);e?(console.log("âœ… Post found in feed, scrolling..."),e.scrollIntoView({behavior:"smooth",block:"center"}),e.classList.add("post-highlighted"),setTimeout(()=>{e.classList.remove("post-highlighted")},3e3)):(console.log("âš ï¸ Post not found, redirecting..."),window.location.href=window.AppConfig.getPageUrl(`homepage.html#post/${t}`))}},150)}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.savedPostsManager=new SavedPostsManager}):window.savedPostsManager=new SavedPostsManager,console.log("ðŸ’¾ Saved Posts Manager - Script loaded successfully");