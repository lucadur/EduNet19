"use strict";class ConnectionsPage{constructor(){this.supabase=null,this.currentUser=null,this.currentTab="following",this.init()}async init(){try{if(await this.waitForSupabase(),await this.waitForAuth(),this.currentUser=window.eduNetAuth?.getCurrentUser(),!this.currentUser)return void(window.location.href=window.AppConfig.getPageUrl("index.html"));this.setupTabs(),this.setupEventListeners(),await this.loadFollowing(),console.log("âœ… Connections page initialized")}catch(t){console.error("Error initializing connections page:",t)}}async waitForSupabase(){return new Promise(t=>{const e=()=>{window.supabaseClientManager?window.supabaseClientManager.getClient().then(e=>{this.supabase=e,t()}):setTimeout(e,100)};e()})}async waitForAuth(){return new Promise(t=>{const e=()=>{window.eduNetAuth&&window.eduNetAuth.isInitialized?t():setTimeout(e,100)};e()})}setupTabs(){const t=document.querySelectorAll(".tab-btn");t.forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.tab;this.switchTab(e)})})}async switchTab(t){this.currentTab=t,document.querySelectorAll(".tab-btn").forEach(e=>{e.classList.toggle("active",e.dataset.tab===t)}),document.querySelectorAll(".tab-content").forEach(t=>{t.classList.remove("active")});const e=document.getElementById(`${t}-tab`);e&&e.classList.add("active"),"following"===t?await this.loadFollowing():await this.loadFollowers()}async loadFollowing(){const t=document.getElementById("following-list");try{const{data:e,error:n}=await this.supabase.from("user_connections").select("followed_id").eq("follower_id",this.currentUser.id).eq("status","accepted");if(n)throw n;const a=document.getElementById("following-count");if(a){const t=a.querySelector(".count, .badge");t?t.textContent=e?.length||0:a.textContent=e?.length||0}if(!e||0===e.length)return void(t.innerHTML='\n          <div class="empty-state">\n            <i class="fas fa-user-plus"></i>\n            <p>Non segui ancora nessuno</p>\n            <a href="../../homepage.html" class="btn btn-primary">Scopri Istituti</a>\n          </div>\n        ');const s=await this.loadUsersDetails(e.map(t=>t.followed_id));t.innerHTML=s.map(t=>this.createUserCard(t,"following")).join(""),this.loadAvatars()}catch(e){console.error("Error loading following:",e),t.innerHTML='<div class="error-state">Errore nel caricamento</div>'}}async loadFollowers(){const t=document.getElementById("followers-list");try{const{data:e,error:n}=await this.supabase.from("user_connections").select("follower_id").eq("followed_id",this.currentUser.id).eq("status","accepted");if(n)throw n;const a=document.getElementById("followers-count");if(a){const t=a.querySelector(".count, .badge");t?t.textContent=e?.length||0:a.textContent=e?.length||0}if(!e||0===e.length)return void(t.innerHTML='\n          <div class="empty-state">\n            <i class="fas fa-users"></i>\n            <p>Nessuno ti segue ancora</p>\n          </div>\n        ');const s=await this.loadUsersDetails(e.map(t=>t.follower_id));t.innerHTML=s.map(t=>this.createUserCard(t,"followers")).join(""),this.loadAvatars()}catch(e){console.error("Error loading followers:",e),t.innerHTML='<div class="error-state">Errore nel caricamento</div>'}}async loadUsersDetails(t){const e=[];for(const n of t)try{const{data:t}=await this.supabase.from("user_profiles").select("user_type").eq("id",n).maybeSingle();if(!t)continue;let a={id:n,user_type:t.user_type};if("istituto"===t.user_type){const{data:t}=await this.supabase.from("school_institutes").select("institute_name, city, logo_url").eq("id",n).maybeSingle();t&&(a.name=t.institute_name,a.location=t.city,a.avatar_url=t.logo_url)}else{const{data:t}=await this.supabase.from("private_users").select("first_name, last_name, avatar_url").eq("id",n).maybeSingle();t&&(a.name=`${t.first_name} ${t.last_name}`,a.avatar_url=t.avatar_url)}e.push(a)}catch(t){console.error("Error loading user details:",t)}return e}createUserCard(t,e){const n="istituto"===t.user_type?"Istituto":"Utente Privato";return`\n      <div class="connection-card" data-user-id="${t.id}">\n        <div class="connection-avatar" data-user-id="${t.id}">\n          <i class="fas fa-${"istituto"===t.user_type?"school":"user"}"></i>\n        </div>\n        <div class="connection-info">\n          <h4>${t.name||"Utente"}</h4>\n          <p class="connection-type">${n}</p>\n          ${t.location?`<p class="connection-location"><i class="fas fa-map-marker-alt"></i> ${t.location}</p>`:""}\n        </div>\n        <div class="connection-actions">\n          <a href="profile.html?id=${t.id}" class="btn btn-outline btn-sm">\n            <i class="fas fa-eye"></i>\n            Visualizza\n          </a>\n          ${"following"===e?`\n            <button class="btn btn-outline btn-sm unfollow-btn" data-user-id="${t.id}">\n              <i class="fas fa-user-minus"></i>\n              Smetti di seguire\n            </button>\n          `:""}\n        </div>\n      </div>\n    `}loadAvatars(){window.avatarManager&&document.querySelectorAll(".connection-avatar").forEach(async t=>{const e=t.dataset.userId;if(e){const n=await window.avatarManager.loadUserAvatar(e);if(n){t.style.backgroundImage=`url(${n})`,t.style.backgroundSize="cover",t.style.backgroundPosition="center";const e=t.querySelector("i");e&&(e.style.display="none")}}})}async handleUnfollow(t){try{const{error:e}=await this.supabase.from("user_connections").delete().eq("follower_id",this.currentUser.id).eq("followed_id",t);if(e)throw e;await this.loadFollowing()}catch(t){console.error("Error unfollowing user:",t),alert("Errore durante l'operazione. Riprova.")}}setupEventListeners(){document.addEventListener("click",t=>{if(t.target.closest(".unfollow-btn")){const e=t.target.closest(".unfollow-btn"),n=e.dataset.userId;n&&confirm("Vuoi smettere di seguire questo utente?")&&this.handleUnfollow(n)}})}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.connectionsPage=new ConnectionsPage}):window.connectionsPage=new ConnectionsPage;