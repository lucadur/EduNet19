class ReviewModerationPanel{constructor(){this.instituteId=null,this.pendingReviews=[],this.supabase=null}async init(e){this.instituteId=e,window.supabaseClientManager?(this.supabase=await window.supabaseClientManager.getClient(),await this.loadPendingReviews(),this.render()):console.error("❌ Supabase client manager not available")}async loadPendingReviews(){const{data:e,error:i}=await this.supabase.from("institute_reviews").select("*").eq("reviewed_institute_id",this.instituteId).eq("is_verified",!1).order("created_at",{ascending:!1});if(i)return void console.error("Errore caricamento recensioni in sospeso:",i);if(!e||0===e.length)return void(this.pendingReviews=[]);const t=await Promise.all(e.map(async e=>{let i=null;if("institute"===e.reviewer_type){const{data:t}=await this.supabase.from("school_institutes").select("institute_name, logo_url").eq("id",e.reviewer_id).single();t&&(i={name:t.institute_name,avatar_url:t.logo_url,type:"institute"})}else{const{data:t}=await this.supabase.from("private_users").select("first_name, last_name, avatar_url").eq("id",e.reviewer_id).single();t&&(i={name:`${t.first_name} ${t.last_name}`,avatar_url:t.avatar_url,type:"private"})}return{...e,reviewer_data:i||{name:"Utente sconosciuto",avatar_url:null,type:"unknown"}}}));this.pendingReviews=t}render(){const e=document.getElementById("review-moderation-panel");e&&(0!==this.pendingReviews.length?e.innerHTML=`\n            <div class="moderation-header">\n                <h3>Recensioni da verificare (${this.pendingReviews.length})</h3>\n                <p class="text-muted">Approva o rifiuta le recensioni degli utenti privati</p>\n            </div>\n            <div class="pending-reviews-list">\n                ${this.pendingReviews.map(e=>this.renderPendingReview(e)).join("")}\n            </div>\n        `:e.innerHTML='\n                <div class="moderation-empty">\n                    <p>✅ Nessuna recensione in attesa di verifica</p>\n                </div>\n            ')}renderPendingReview(e){const i="★".repeat(e.rating)+"☆".repeat(5-e.rating),t=e.reviewer_data?.name||"Utente",n=e.reviewer_data?.avatar_url,a="institute"===e.reviewer_data?.type?"Istituto":"Utente privato",r=n||`https://ui-avatars.com/api/?name=${encodeURIComponent(t)}&background=random`,s=e.updated_at&&new Date(e.updated_at)>new Date(e.created_at),o=s?'<span class="badge badge-warning" style="margin-left: 8px; font-size: 0.8em;">Modificata</span>':"";return`\n            <div class="pending-review-card" data-review-id="${e.id}">\n                <div class="pending-review-header">\n                    <img src="${r}" \n                         alt="${t}" \n                         class="reviewer-avatar-small"\n                         onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(t)}&background=random';">\n                    <div class="reviewer-info-small">\n                        <div class="reviewer-name-small">\n                            ${t}\n                            <span class="badge ${"institute"===e.reviewer_data?.type?"badge-institute":"badge-private"}">${a}</span>\n                            ${o}\n                        </div>\n                        <div class="review-stars-small">${i}</div>\n                        <div class="review-date-small">${this.formatDate(e.created_at)}</div>\n                    </div>\n                </div>\n                \n                ${e.review_text?`\n                    <div class="pending-review-text">${this.escapeHtml(e.review_text)}</div>\n                `:""}\n                \n                <div class="moderation-actions">\n                    <button class="btn btn-approve" onclick="moderationPanel.approveReview('${e.id}')">\n                        ✓ Approva\n                    </button>\n                    <button class="btn btn-reject" onclick="moderationPanel.rejectReview('${e.id}')">\n                        ✗ Rifiuta\n                    </button>\n                </div>\n            </div>\n        `}async approveReview(e){if(!this.supabase){if(!window.supabaseClientManager)return void console.error("❌ Supabase client manager not available");this.supabase=await window.supabaseClientManager.getClient()}const{error:i}=await this.supabase.from("institute_reviews").update({status:"approved",is_verified:!0}).eq("id",e);if(i)return console.error("Errore approvazione recensione:",i),void alert("Errore durante l'approvazione");this.pendingReviews=this.pendingReviews.filter(i=>i.id!==e),this.render(),this.updateBadgeCount(),alert("✅ Recensione approvata e pubblicata")}async rejectReview(e){if(!this.supabase){if(!window.supabaseClientManager)return void console.error("❌ Supabase client manager not available");this.supabase=await window.supabaseClientManager.getClient()}if(!confirm("Sei sicuro di voler rifiutare questa recensione? Verrà eliminata definitivamente."))return;const{error:i}=await this.supabase.from("institute_reviews").delete().eq("id",e);if(i)return console.error("Errore rifiuto recensione:",i),void alert("Errore durante il rifiuto");this.pendingReviews=this.pendingReviews.filter(i=>i.id!==e),this.render(),this.updateBadgeCount(),alert("✅ Recensione rifiutata ed eliminata")}updateBadgeCount(){const e=document.getElementById("pending-reviews-badge");if(e){const i=this.pendingReviews.length;e.textContent=i,e.style.display=i>0?"inline-block":"none"}}formatDate(e){const i=new Date(e);return i.toLocaleDateString("it-IT",{day:"numeric",month:"short",year:"numeric"})}escapeHtml(e){const i=document.createElement("div");return i.textContent=e,i.innerHTML}}const moderationPanel=new ReviewModerationPanel;async function loadPendingReviewsCount(e){if(!window.supabaseClientManager)return void console.error("❌ Supabase client manager not available");const i=await window.supabaseClientManager.getClient(),{count:t,error:n}=await i.from("institute_reviews").select("*",{count:"exact",head:!0}).eq("reviewed_institute_id",e).eq("is_verified",!1).eq("reviewer_type","private");if(!n&&t>0){const e=document.getElementById("pending-reviews-badge");e&&(e.textContent=t,e.style.display="inline-block")}}