class CreatePage{constructor(){console.log("ðŸš€ðŸš€ðŸš€ CREATE PAGE V2.0 - GALLERY FIX LOADED ðŸš€ðŸš€ðŸš€"),this.currentUser=null,this.supabase=null,this.init()}async init(){console.log("ðŸ“ CreatePage initializing..."),await this.initSupabase(),await this.checkAuthentication(),window.avatarManager&&await window.avatarManager.loadCurrentUserAvatar(),this.setupEventListeners(),await this.loadDrafts(),console.log("âœ… CreatePage initialized")}async initSupabase(){if(window.supabaseClientManager){this.supabase=await window.supabaseClientManager.getClient();const{data:{user:e}}=await this.supabase.auth.getUser();this.currentUser=e}}async checkAuthentication(){if(!this.currentUser)return console.log("User not authenticated, redirecting to login"),void(window.location.href=window.AppConfig.getPageUrl("index.html"));const{data:e}=await this.supabase.from("user_profiles").select("user_type").eq("id",this.currentUser.id).single();let t="istituto"===e?.user_type;if(!t){const{data:e}=await this.supabase.rpc("get_collaborator_profile");!e?.is_collaborator||"admin"!==e.role&&"editor"!==e.role||(t=!0,this.collaboratorData=e,console.log("ðŸ‘¥ Collaboratore autorizzato a creare contenuti:",e))}if(!t)return alert("Solo gli istituti scolastici e i loro collaboratori possono creare contenuti"),void(window.location.href=window.AppConfig.getPageUrl("homepage.html"));await this.loadUserProfile()}async loadUserProfile(){try{if(!this.supabase||!this.currentUser)return;const{data:e,error:t}=await this.supabase.from("user_profiles").select("*").eq("id",this.currentUser.id).single();if(t)return void console.error("Error loading profile:",t);let o="Utente",a="Utente";if(this.collaboratorData){const e={admin:"Amministratore",editor:"Editor",viewer:"Visualizzatore"};o=`${this.collaboratorData.first_name||""} ${this.collaboratorData.last_name||""}`.trim()||"Collaboratore",a=`${e[this.collaboratorData.role]||"Collaboratore"} - ${this.collaboratorData.institute_name}`,console.log("ðŸ‘¥ Profilo collaboratore caricato:",o,a)}else if("istituto"===e.user_type){const{data:e,error:t}=await this.supabase.from("school_institutes").select("institute_name, institute_type").eq("id",this.currentUser.id).maybeSingle();!t&&e&&(o=e.institute_name||"Istituto",a=e.institute_type||"Istituto Scolastico")}else if("privato"===e.user_type){const{data:e}=await this.supabase.rpc("get_collaborator_profile");if(e?.is_collaborator){const t={admin:"Amministratore",editor:"Editor",viewer:"Visualizzatore"};o=`${e.first_name||""} ${e.last_name||""}`.trim()||"Collaboratore",a=`${t[e.role]||"Collaboratore"} - ${e.institute_name}`,this.collaboratorData=e}else{const{data:e,error:t}=await this.supabase.from("private_users").select("first_name, last_name").eq("id",this.currentUser.id).maybeSingle();if(!t&&e){const t=e.first_name||"",s=e.last_name||"";o=`${t} ${s}`.trim()||"Utente Privato",a="Utente Privato"}}}const s=document.getElementById("user-name"),i=document.getElementById("user-full-name"),n=document.getElementById("user-type-display");s&&(s.textContent=o),i&&(i.textContent=o),n&&(n.textContent=a);const r=document.getElementById("mobile-user-name"),l=document.getElementById("mobile-user-type");r&&(r.textContent=o),l&&(l.textContent=a),console.log("âœ… User profile loaded:",o)}catch(e){console.error("Error in loadUserProfile:",e)}}setupEventListeners(){const e=document.getElementById("logout-btn"),t=document.getElementById("mobile-logout");e&&e.addEventListener("click",()=>this.handleLogout()),t&&t.addEventListener("click",()=>this.handleLogout()),this.setupDropdowns(),this.setupCategoryFilters(),this.setupMobileMenu(),this.setupSearch(),window.mobileSearch&&window.mobileSearch.init()}setupDropdowns(){const e=document.querySelectorAll(".nav-item.dropdown");e.forEach(e=>{const t=e.querySelector(".nav-button");t&&t.addEventListener("click",t=>{t.stopPropagation(),document.querySelectorAll(".nav-item.dropdown.open").forEach(t=>{t!==e&&t.classList.remove("open")}),e.classList.toggle("open")})}),document.addEventListener("click",()=>{document.querySelectorAll(".nav-item.dropdown.open").forEach(e=>{e.classList.remove("open")})})}setupMobileMenu(){const e=document.getElementById("mobile-menu-toggle"),t=document.getElementById("mobile-menu-overlay"),o=document.getElementById("mobile-menu-close");e&&t&&e.addEventListener("click",()=>{t.classList.toggle("show"),e.classList.toggle("active"),document.body.style.overflow=t.classList.contains("show")?"hidden":""}),o&&o.addEventListener("click",()=>{t.classList.remove("show"),e.classList.remove("active"),document.body.style.overflow=""}),t&&t.addEventListener("click",o=>{o.target===t&&(t.classList.remove("show"),e.classList.remove("active"),document.body.style.overflow="")})}setupSearch(){const e=document.getElementById("global-search"),t=document.querySelector(".search-clear"),o=document.getElementById("search-results");e&&(e.addEventListener("input",e=>{const a=e.target.value.trim();t&&(t.style.display=a?"block":"none"),o&&(o.style.display=a?"block":"none"),clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(()=>{a&&this.performSearch(a)},300)}),e.addEventListener("focus",()=>{e.value.trim()&&o&&(o.style.display="block")})),t&&t.addEventListener("click",()=>{e&&(e.value="",t.style.display="none"),o&&(o.style.display="none")}),document.addEventListener("click",e=>{o&&!e.target.closest(".nav-search")&&(o.style.display="none")})}async performSearch(e){const t=document.getElementById("search-results");if(t){t.innerHTML='<div class="search-loading">Ricerca in corso...</div>';try{console.log("Searching for:",e);const t=[];if(window.eduNetProfileManager)try{console.log("Searching profiles with ProfileManager...");const o=await window.eduNetProfileManager.searchProfiles(e);if(console.log("Profile search results:",o),o&&o.length>0)for(const a of o){let o=!1,s=!1;if(window.supabaseClientManager){const t=await window.supabaseClientManager.getClient(),{data:i}=await t.from("user_privacy_settings").select("profile_visibility, searchable_by_email").eq("user_id",a.id).maybeSingle();i&&("private"===i.profile_visibility&&(o=!0),!1===i.searchable_by_email&&e.includes("@")&&(s=!0))}if(o||s)continue;let i=null;window.avatarManager&&(i=await window.avatarManager.loadUserAvatar(a.id)),"istituto"===a.user_type&&a.school_institutes?t.push({type:"institute",name:a.school_institutes.institute_name,location:a.school_institutes.city||"Posizione non specificata",id:a.id,avatarUrl:i}):"privato"===a.user_type&&a.private_users&&console.log("ðŸ”’ Utente privato escluso dalla ricerca per privacy")}}catch(e){console.error("Error searching profiles:",e)}else console.warn("ProfileManager not available");if(this.supabase||window.supabaseClientManager)try{console.log("Searching posts with Supabase...");const o=this.supabase||await window.supabaseClientManager.getClient();if(o){const{data:a,error:s}=await o.from("institute_posts").select("id, title, content, post_type, institute_id, tags").or(`title.ilike.%${e}%, content.ilike.%${e}%`).eq("published",!0).order("created_at",{ascending:!1}).limit(10);console.log("Post search results:",a,"Error:",s);let i=[];if(!s){const{data:t,error:a}=await o.from("institute_posts").select("id, title, content, post_type, institute_id, tags").contains("tags",[e.toLowerCase()]).eq("published",!0).order("created_at",{ascending:!1}).limit(10);!a&&t&&(i=t)}const n=[...a||[],...i],r=Array.from(new Map(n.map(e=>[e.id,e])).values());if(r.length>0)for(const e of r){let a="Autore sconosciuto",s=null;try{const{data:t,error:i}=await o.from("school_institutes").select("institute_name").eq("id",e.institute_id).maybeSingle();!i&&t&&(a=t.institute_name),window.avatarManager&&(s=await window.avatarManager.loadUserAvatar(e.institute_id))}catch(t){console.warn("Could not fetch author for post:",e.id)}const i=this.getPostTypeInfo(e.post_type);t.push({type:"post",post_type:e.post_type,author_id:e.institute_id,authorId:e.institute_id,avatarUrl:s,badge:i.label,badgeIcon:i.icon,badgeClass:i.class,title:e.title,author:a,tags:e.tags||[],id:e.id})}else s&&console.error("Supabase posts query error:",s)}}catch(e){console.error("Error searching posts:",e)}else console.warn("SupabaseClientManager not available");console.log("Final search results:",t),this.displaySearchResults(t)}catch(e){console.error("Search error:",e),this.displaySearchResults([])}}}displaySearchResults(e){const t=document.getElementById("search-results");t&&(0===e.length?t.innerHTML='\n        <div class="search-no-results">\n          <i class="fas fa-database" aria-hidden="true"></i>\n          <p>Nessun risultato trovato nel database</p>\n          <small>Assicurati che il database Supabase sia configurato correttamente</small>\n        </div>\n      ':(t.innerHTML=e.map(e=>{const t="post"===e.type?e.authorId:e.id,o=e.avatarUrl?`<img src="${e.avatarUrl}" alt="Avatar" class="search-result-avatar" data-user-id="${t}">`:`<div class="search-result-avatar search-result-avatar-default" data-user-id="${t}">\n               <i class="fas fa-${"institute"===e.type?"school":"user"===e.type?"user":"school"}"></i>\n             </div>`;return"post"===e.type?`\n            <div class="search-result-item" data-id="${e.id||""}" data-type="${e.type}" data-post-type="${e.post_type||""}">\n              ${o}\n              <div class="search-result-main">\n                <div class="search-result-header" style="display: flex; justify-content: space-between; align-items: center;">\n                  <span class="result-author" style="margin: 0; font-weight: 600; color: var(--color-gray-700); font-size: 0.85rem;">${e.author}</span>\n                  <span class="search-badge ${e.badgeClass||""}" style="font-size: 0.7rem; padding: 0.25rem 0.6rem;">\n                    <i class="${e.badgeIcon||"fas fa-file-alt"}"></i>\n                    ${e.badge||"Post"}\n                  </span>\n                </div>\n                <div class="result-content" style="margin-top: 0.25rem;">\n                  <h4 style="margin-bottom: 0.25rem;">${e.title}</h4>\n                  ${e.tags&&e.tags.length>0?`\n                    <div class="result-tags">\n                      ${e.tags.slice(0,3).map(e=>`<span class="result-tag">#${e}</span>`).join("")}\n                      ${e.tags.length>3?`<span class="result-tag-more">+${e.tags.length-3}</span>`:""}\n                    </div>\n                  `:""}\n                </div>\n              </div>\n            </div>\n          `:`\n            <div class="search-result-item" data-id="${e.id||""}" data-type="${e.type}">\n              ${o}\n              <div class="result-content">\n                <h4>${e.name||e.title}</h4>\n                <p>${e.location||e.author||e.category}</p>\n              </div>\n            </div>\n          `}).join(""),t.querySelectorAll(".search-result-item").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.type,o=e.dataset.id;console.log("Search - Clicked result:",t,o),"institute"===t||"user"===t?window.location.href=window.AppConfig.getPageUrl(`pages/profile/profile.html?id=${o}`):"post"===t&&(window.location.href=window.AppConfig.getPageUrl(`homepage.html#post/${o}`))})})))}getPostTypeInfo(e){const t={post:{label:"Post",icon:"fas fa-align-left",class:"badge-post"},project:{label:"Progetto",icon:"fas fa-lightbulb",class:"badge-project"},methodology:{label:"Metodologia",icon:"fas fa-book-open",class:"badge-methodology"},event:{label:"Galleria",icon:"fas fa-images",class:"badge-gallery"},collaboration:{label:"Collaborazione",icon:"fas fa-handshake",class:"badge-collaboration"},educational_experience:{label:"Esperienza",icon:"fas fa-graduation-cap",class:"badge-educational"}};return t[e]||t.post}openCreationModal(e){console.log("Opening creation modal for type:",e),this.scrollPosition=window.pageYOffset;const t=document.getElementById(`modal-${e}`);if(t){t.style.display="flex",document.body.classList.add("modal-open"),document.body.style.overflow="hidden",document.body.style.top=`-${this.scrollPosition}px`;const o=document.getElementById(`form-${e}`);o&&(o.onsubmit=t=>{t.preventDefault(),this.handleFormSubmit(e,o)})}else console.warn(`Modal for type "${e}" not found, using fallback`),window.eduNetSocial?window.eduNetSocial.showCreatePostModal(e):(console.error("Social features not available"),this.showNotification("Sistema non disponibile, riprova piÃ¹ tardi","error"))}async handleFormSubmit(e,t){console.log(`Submitting ${e} form`);try{const o=new FormData(t),a={};for(let[e,t]of o.entries())t instanceof File||(a[e]=t);if(console.log("Form data:",a),"gallery"===e){const e=t.querySelector('input[type="file"][name="images"]');if(!(e&&e.files.length>0))throw new Error("Nessuna immagine selezionata");a.imageFiles=Array.from(e.files),console.log(`Found ${a.imageFiles.length} images to upload`),this.showUploadProgress(a.imageFiles.length)}const s=await this.publishContent(e,a);if(s.error)throw s.error;"gallery"===e&&this.hideUploadProgress(),this.showNotification(`${this.getTypeLabel(e)} pubblicato con successo!`,"success"),window.closeCreationModal(e),t.reset(),setTimeout(()=>{window.location.href=window.AppConfig.getPageUrl("homepage.html")},1500)}catch(e){console.error("Error publishing content:",e),this.hideUploadProgress(),this.showNotification("Errore durante la pubblicazione. Riprova.","error")}}showUploadProgress(e){const t=document.getElementById("gallery-upload-progress"),o=document.getElementById("gallery-submit-btn");t&&(t.style.display="flex",this.updateUploadProgress(0,e)),o&&(o.disabled=!0)}updateUploadProgress(e,t){const o=document.getElementById("upload-progress-fill"),a=document.getElementById("upload-progress-count"),s=document.getElementById("upload-status-text"),i=e/t*100;o&&(o.style.width=`${i}%`),a&&(a.textContent=`${e} / ${t} immagini`),s&&e<t?s.textContent="Compressione e upload delle immagini...":s&&(s.textContent="Finalizzazione...")}hideUploadProgress(){const e=document.getElementById("gallery-upload-progress"),t=document.getElementById("gallery-submit-btn");e&&(e.style.display="none"),t&&(t.disabled=!1)}async publishContent(e,t){if(!this.supabase||!this.currentUser)throw new Error("Non autenticato");const o={post:"post",project:"project",methodology:"methodology",gallery:"event",experience:"educational_experience",collaboration:"collaboration"},a=o[e]||"post",s={institute_id:this.currentUser.id,title:t.title,content:t.description||t.content||t.context||"",post_type:a,category:t.category||t.type||e,tags:t.tags?t.tags.split(",").map(e=>e.trim()).filter(e=>e):[],published:!0,published_at:(new Date).toISOString()};if("gallery"===e&&t.imageFiles&&t.imageFiles.length>0){console.log(`Uploading ${t.imageFiles.length} images...`);const e=[],o=Math.min(t.imageFiles.length,20);for(let a=0;a<o;a++){const s=t.imageFiles[a];try{let t=s;if(s.size>1048576){console.log(`ðŸ“¦ Compressing image ${a+1} (${(s.size/1024/1024).toFixed(2)}MB)...`);const e={maxSizeMB:1,maxWidthOrHeight:1920,useWebWorker:!0,fileType:s.type,initialQuality:.8,alwaysKeepResolution:!1};t=await imageCompression(s,e),console.log(`âœ… Image ${a+1} compressed: ${(s.size/1024/1024).toFixed(2)}MB â†’ ${(t.size/1024/1024).toFixed(2)}MB`)}const i=t.name.split(".").pop(),n=`${this.currentUser.id}/${Date.now()}_${a}.${i}`,{data:r,error:l}=await this.supabase.storage.from("post-images").upload(n,t,{cacheControl:"3600",upsert:!1});if(l){console.error(`Error uploading image ${a}:`,l);continue}const{data:{publicUrl:c}}=this.supabase.storage.from("post-images").getPublicUrl(n);e.push(c),console.log(`Image ${a+1} uploaded successfully`),this.updateUploadProgress(a+1,o)}catch(n){console.error(`Error processing image ${a}:`,n)}}if(!(e.length>0))throw new Error("Nessuna immagine caricata con successo");s.image_urls=e,s.image_url=e[0],console.log(`Successfully uploaded ${e.length} images`)}"project"===e?(s.attachments={type:"project",category:t.category||"",duration:t.duration||"",objectives:t.objectives||"",resources:t.resources||""},s.target_audience=t.duration?[t.duration]:[],s.subject_areas=t.objectives?[t.objectives]:[]):"methodology"===e?(s.attachments={type:"methodology",methodology_type:t.type||"",level:t.level||"",application:t.application||"",benefits:t.benefits||""},s.target_audience=t.level?[t.level]:[],s.subject_areas=t.application?[t.application]:[]):"collaboration"===e?(s.attachments={type:"collaboration",collaboration_type:t.type||"",duration:t.duration||"",looking_for:t.looking_for||"",benefits:t.benefits||""},s.target_audience=t.looking_for?[t.looking_for]:[],s.subject_areas=t.benefits?[t.benefits]:[]):"experience"===e?(s.attachments={type:"experience",experience_type:t.type||"",date:t.date||"",context:t.context||"",learnings:t.learnings||""},s.target_audience=t.date?[t.date]:[],s.subject_areas=t.learnings?[t.learnings]:[]):"gallery"===e?s.attachments={type:"gallery"}:"post"===e&&(s.attachments={type:"post"});const{data:i,error:n}=await this.supabase.from("institute_posts").insert([s]).select().single();return{data:i,error:n}}getTypeLabel(e){const t={post:"Post",project:"Progetto",methodology:"Metodologia",gallery:"Galleria",experience:"Esperienza",collaboration:"Collaborazione"};return t[e]||"Contenuto"}showNotification(e,t="info"){const o=document.createElement("div");o.className=`notification notification-${t}`,o.innerHTML=`\n      <div class="notification-content">\n        <i class="fas fa-${"success"===t?"check-circle":"info-circle"}"></i>\n        <span>${e}</span>\n      </div>\n    `,document.body.appendChild(o),setTimeout(()=>{o.classList.add("show")},100),setTimeout(()=>{o.remove()},3e3)}async loadDrafts(){try{if(!this.supabase||!this.currentUser)return;const e=document.getElementById("drafts-section");e&&(e.style.display="none")}catch(e){console.error("Error loading drafts:",e)}}viewAllDrafts(){console.log("View all drafts"),this.showNotification("FunzionalitÃ  bozze in arrivo!","info")}async handleLogout(){if(confirm("Sei sicuro di voler uscire?"))try{this.supabase&&await this.supabase.auth.signOut(),window.location.href=window.AppConfig.getPageUrl("index.html")}catch(e){console.error("Error during logout:",e),window.location.href=window.AppConfig.getPageUrl("index.html")}}setupCategoryFilters(){const e=document.querySelectorAll("[data-filter]");e.forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const o=e.dataset.filter;console.log("Filtering by:",o),window.location.href=window.AppConfig.getPageUrl(`homepage.html?filter=${o}`)})})}showNotification(e,t="info"){const o=document.createElement("div");o.className=`notification notification-${t}`,o.style.cssText=`\n      position: fixed;\n      top: calc(var(--top-nav-height) + var(--space-4));\n      right: var(--space-4);\n      background: ${"success"===t?"#10b981":"error"===t?"#ef4444":"#3b82f6"};\n      color: white;\n      padding: var(--space-4) var(--space-6);\n      border-radius: var(--radius-lg);\n      box-shadow: var(--shadow-lg);\n      z-index: 9999;\n      animation: slideInRight 0.3s ease-out;\n    `,o.innerHTML=`\n      <div style="display: flex; align-items: center; gap: var(--space-3);">\n        <i class="fas fa-${"success"===t?"check-circle":"error"===t?"exclamation-circle":"info-circle"}"></i>\n        <span>${e}</span>\n      </div>\n    `,document.body.appendChild(o),setTimeout(()=>{o.style.animation="slideOutRight 0.3s ease-in",setTimeout(()=>o.remove(),300)},3e3)}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.createPage=new CreatePage}):window.createPage=new CreatePage,console.log("ðŸ“ Create Page - Script loaded successfully"),window.closeCreationModal=function(e){const t=document.getElementById(`modal-${e}`);t&&(t.style.display="none",document.body.classList.remove("modal-open"),document.body.style.overflow="",document.body.style.top="",window.createPage&&void 0!==window.createPage.scrollPosition&&window.scrollTo(0,window.createPage.scrollPosition))},document.addEventListener("keydown",e=>{if("Escape"===e.key){const e=document.querySelectorAll('.creation-modal[style*="display: flex"]');e.forEach(e=>{e.style.display="none"}),e.length>0&&(document.body.classList.remove("modal-open"),document.body.style.overflow="",document.body.style.top="",window.createPage&&void 0!==window.createPage.scrollPosition&&window.scrollTo(0,window.createPage.scrollPosition))}});