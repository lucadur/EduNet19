class InstituteContactManager{constructor(){this.instituteEmail=null,this.instituteName=null,this.userEmail=null,this.userName=null,this.templates={info:{subject:"Richiesta informazioni",body:"Buongiorno,\n\nvorrei ricevere maggiori informazioni riguardo...\n\nGrazie per la disponibilit√†.\n\nCordiali saluti"},collaboration:{subject:"Proposta di collaborazione",body:"Buongiorno,\n\nvi scrivo per proporre una collaborazione riguardante...\n\nRimango a disposizione per ulteriori dettagli.\n\nCordiali saluti"},visit:{subject:"Richiesta visita istituto",body:"Buongiorno,\n\nvorrei richiedere la possibilit√† di visitare il vostro istituto per...\n\nGrazie per la disponibilit√†.\n\nCordiali saluti"},other:{subject:"Contatto",body:"Buongiorno,\n\n"}}}async init(t,e){console.log("üìß Initializing contact system for institute:",t),this.instituteEmail=e?.email||e?.contact_email,this.instituteName=e?.institute_name||e?.name,await this.loadUserInfo(),this.shouldShowContactForm(t)&&(this.renderContactForm(),this.setupEventListeners()),console.log("‚úÖ Contact system initialized")}async loadUserInfo(){try{const t=window.supabaseClientManager?await window.supabaseClientManager.getClient():window.supabase;if(!t)return;const{data:{user:e}}=await t.auth.getUser();if(!e)return;const{data:n}=await t.from("user_profiles").select("user_type, full_name, email").eq("id",e.id).single();n&&(this.userType=n.user_type,this.userName=n.full_name,this.userEmail=n.email||e.email)}catch(t){console.error("Error loading user info:",t)}}shouldShowContactForm(t){const e=window.profilePage?.currentUserId,n=e===t,i="privato"===this.userType;return i&&!n&&this.instituteEmail}renderContactForm(){const t=document.getElementById("contact-institute-container");t?(t.innerHTML=`\n            <div class="contact-institute-section">\n                <div class="contact-header">\n                    <span class="contact-icon">‚úâÔ∏è</span>\n                    <h3>Contatta ${this.instituteName||"l'istituto"}</h3>\n                </div>\n                \n                <p class="contact-description">\n                    Compila il form per inviare un'email all'istituto. \n                    Si aprir√† il tuo client email predefinito con il messaggio precompilato.\n                </p>\n\n                <form id="contact-form" class="contact-form">\n                    <div class="form-group">\n                        <label>Tipo di richiesta</label>\n                        <div class="contact-template-selector">\n                            <div class="template-chip active" data-template="info">\n                                üìã Informazioni\n                            </div>\n                            <div class="template-chip" data-template="collaboration">\n                                ü§ù Collaborazione\n                            </div>\n                            <div class="template-chip" data-template="visit">\n                                üè´ Visita\n                            </div>\n                            <div class="template-chip" data-template="other">\n                                üí¨ Altro\n                            </div>\n                        </div>\n                    </div>\n\n                    <div class="form-group">\n                        <label for="contact-subject">Oggetto *</label>\n                        <input \n                            type="text" \n                            id="contact-subject" \n                            name="subject"\n                            placeholder="Oggetto dell'email"\n                            required\n                            maxlength="100">\n                    </div>\n\n                    <div class="form-group">\n                        <label for="contact-message">Messaggio *</label>\n                        <textarea \n                            id="contact-message" \n                            name="message"\n                            placeholder="Scrivi qui il tuo messaggio..."\n                            required\n                            minlength="20"\n                            maxlength="1000"></textarea>\n                        <small class="char-counter">0 / 1000 caratteri</small>\n                    </div>\n\n                    <div class="contact-info-box">\n                        <div class="contact-info-item">\n                            <svg fill="currentColor" viewBox="0 0 20 20">\n                                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>\n                                <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>\n                            </svg>\n                            <span>Email: <strong>${this.instituteEmail}</strong></span>\n                        </div>\n                    </div>\n\n                    <div class="contact-actions">\n                        <button type="button" class="btn-contact btn-contact-secondary" id="reset-form-btn">\n                            üîÑ Reimposta\n                        </button>\n                        <button type="submit" class="btn-contact btn-contact-primary">\n                            üìß Apri Email\n                        </button>\n                    </div>\n                </form>\n            </div>\n        `,this.applyTemplate("info")):console.warn("Contact container not found")}setupEventListeners(){const t=document.getElementById("contact-form"),e=(document.getElementById("contact-subject"),document.getElementById("contact-message")),n=document.querySelector(".char-counter"),i=document.getElementById("reset-form-btn"),a=document.querySelectorAll(".template-chip");a.forEach(t=>{t.addEventListener("click",()=>{a.forEach(t=>t.classList.remove("active")),t.classList.add("active");const e=t.dataset.template;this.applyTemplate(e)})}),e&&n&&e.addEventListener("input",()=>{const t=e.value.length;n.textContent=`${t} / 1000 caratteri`,n.style.color=t>900?"#f44336":t>700?"#ff9800":"#999"}),i&&i.addEventListener("click",()=>{const t=document.querySelector(".template-chip.active"),e=t?.dataset.template||"info";this.applyTemplate(e)}),t&&t.addEventListener("submit",t=>{t.preventDefault(),this.openEmailClient()})}applyTemplate(t){const e=this.templates[t];if(!e)return;const n=document.getElementById("contact-subject"),i=document.getElementById("contact-message");n&&(n.value=e.subject),i&&(i.value=e.body,i.dispatchEvent(new Event("input")))}openEmailClient(){const t=document.getElementById("contact-subject")?.value||"",e=document.getElementById("contact-message")?.value||"";if(!t||!e)return void alert("Compila tutti i campi obbligatori");if(e.length<20)return void alert("Il messaggio deve contenere almeno 20 caratteri");const n=`\n\n---\n${this.userName||"Utente"}\n${this.userEmail||""}`,i=e+n,a=this.buildMailtoUrl(this.instituteEmail,t,i);console.log("üìß Opening email client..."),window.location.href=a,this.showSuccessMessage()}buildMailtoUrl(t,e,n){const i=new URLSearchParams({subject:e,body:n});return`mailto:${encodeURIComponent(t)}?${i.toString()}`}showSuccessMessage(){const t=document.getElementById("contact-form");if(!t)return;const e=document.createElement("div");e.className="contact-success-message",e.innerHTML="\n            <span>‚úÖ</span>\n            <span>Client email aperto! Controlla la tua applicazione email.</span>\n        ",t.parentElement.insertBefore(e,t),setTimeout(()=>{e.remove()},5e3)}}const instituteContactManager=new InstituteContactManager;