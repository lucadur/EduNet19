class InstituteAutocomplete{constructor(){this.schools=[],this.isLoading=!1,this.isLoaded=!1,this.loadError=!1,this.selectedSchool=null,this.input=null,this.dropdown=null,this.verificationBadge=null,this.maxResults=10,this.minChars=3,this.debounceTimer=null,this.debounceDelay=300}async init(){try{if(console.log("üè´ Inizializzazione sistema verifica istituti..."),this.input=document.getElementById("instituteName"),!this.input)return void console.warn("‚ö†Ô∏è Campo instituteName non trovato, skip autocomplete");this.createUI(),this.attachEventListeners(),this.loadSchoolData(),console.log("‚úÖ Sistema verifica istituti inizializzato")}catch(e){console.error("‚ùå Errore inizializzazione autocomplete:",e),this.loadError=!0}}createUI(){const e=this.input.parentNode;if(!e||!e.classList.contains("input-group"))return void console.warn("‚ö†Ô∏è input-group non trovato, skip UI creation");const t=document.createElement("div");t.className="autocomplete-wrapper",e.parentNode.insertBefore(t,e),t.appendChild(e),this.dropdown=document.createElement("div"),this.dropdown.className="autocomplete-dropdown",this.dropdown.style.display="none",t.appendChild(this.dropdown),this.verificationBadge=document.createElement("span"),this.verificationBadge.className="verification-badge",this.verificationBadge.style.display="none",t.parentNode.insertBefore(this.verificationBadge,t.nextSibling);const i=document.createElement("div");i.className="autocomplete-loading",i.innerHTML='<i class="fas fa-spinner fa-spin"></i> Caricamento database scuole...',i.style.display="none",i.id="autocomplete-loading",t.parentNode.insertBefore(i,t.nextSibling)}attachEventListeners(){this.input.addEventListener("input",e=>{clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.handleInput(e.target.value)},this.debounceDelay)}),this.input.addEventListener("focus",()=>{this.input.value.length>=this.minChars&&this.handleInput(this.input.value)}),document.addEventListener("click",e=>{this.input.contains(e.target)||this.dropdown.contains(e.target)||this.hideDropdown()}),this.input.addEventListener("keydown",e=>{this.handleKeyboard(e)})}async loadSchoolData(){if(this.isLoading||this.isLoaded)return;this.isLoading=!0;const e=document.getElementById("autocomplete-loading");e&&(e.style.display="block");try{console.log("üì• Caricamento database scuole MIUR...");const t=["db scuole/scuole-statali.json","db scuole/scuole-paritarie.json","db scuole/scuole-statali-province-autonome.json","db scuole/scuole-paritarie-province-autonome.json"],i=t.map(e=>fetch(e).then(e=>e.json()).catch(t=>(console.warn(`‚ö†Ô∏è Errore caricamento ${e}:`,t),null))),s=await Promise.all(i);s.forEach((e,i)=>{e&&e["@graph"]&&(console.log(`‚úÖ Caricato ${t[i]}: ${e["@graph"].length} scuole`),this.processSchoolData(e["@graph"]))}),this.isLoaded=!0,console.log(`‚úÖ Database completo: ${this.schools.length} scuole caricate`),e&&(e.innerHTML='<i class="fas fa-check"></i> Database caricato',setTimeout(()=>e.style.display="none",2e3))}catch(t){console.error("‚ùå Errore caricamento database:",t),this.loadError=!0,e&&(e.innerHTML='<i class="fas fa-exclamation-triangle"></i> Database non disponibile',e.style.color="#f59e0b")}finally{this.isLoading=!1}}processSchoolData(e){e.forEach(e=>{e["miur:DENOMINAZIONESCUOLA"]&&this.schools.push({name:e["miur:DENOMINAZIONESCUOLA"].trim(),code:e["miur:CODICESCUOLA"]||"",type:e["miur:DESCRIZIONETIPOLOGIAGRADOISTRUZIONESCUOLA"]||"",address:e["miur:INDIRIZZOSCUOLA"]||"",city:e["miur:DESCRIZIONECOMUNE"]||"",province:e["miur:PROVINCIA"]||"",region:e["miur:REGIONE"]||"",email:e["miur:INDIRIZZOEMAILSCUOLA"]||"",pec:e["miur:INDIRIZZOPECSCUOLA"]||"",website:e["miur:SITOWEBSCUOLA"]||"",cap:e["miur:CAPSCUOLA"]?e["miur:CAPSCUOLA"].toString():"",phone:"",verified:!0})})}handleInput(e){if(!e||e.length<this.minChars)return this.hideDropdown(),this.hideVerificationBadge(),void(this.selectedSchool=null);if(!this.isLoaded)return void this.showDropdown([{isMessage:!0,text:this.isLoading?"‚è≥ Caricamento database in corso...":"‚ö†Ô∏è Database non disponibile - puoi comunque registrarti"}]);const t=this.searchSchools(e);0===t.length?(this.showDropdown([{isMessage:!0,text:"üîç Nessuna scuola trovata - puoi comunque registrarti manualmente"}]),this.hideVerificationBadge()):this.showDropdown(t)}searchSchools(e){const t=e.toLowerCase(),i=t.split(" ").filter(e=>e.length>0);return this.schools.map(e=>{let s=0;const o=e.name.toLowerCase();o===t&&(s+=1e3),o.startsWith(t)&&(s+=500),o.includes(t)&&(s+=100);const n=i.every(e=>o.includes(e));return n&&(s+=50*i.length),e.city&&e.city.toLowerCase().includes(t)&&(s+=25),e.province&&e.province.toLowerCase().includes(t)&&(s+=25),{school:e,score:s}}).filter(e=>e.score>0).sort((e,t)=>t.score-e.score).slice(0,this.maxResults).map(e=>e.school)}showDropdown(e){this.dropdown.innerHTML="",e.forEach((e,t)=>{const i=document.createElement("div");i.className="autocomplete-item",i.dataset.index=t,e.isMessage?(i.className+=" autocomplete-message",i.innerHTML=e.text):(i.innerHTML=`\n          <div class="autocomplete-item-main">\n            <i class="fas fa-school"></i>\n            <span class="autocomplete-item-name">${this.highlightMatch(e.name,this.input.value)}</span>\n            ${e.verified?'<i class="fas fa-check-circle verified-icon" title="Scuola verificata"></i>':""}\n          </div>\n          <div class="autocomplete-item-details">\n            ${e.type?`<span class="detail-type">${e.type}</span>`:""}\n            ${e.city?`<span class="detail-location"><i class="fas fa-map-marker-alt"></i> ${e.city}${e.province?` (${e.province})`:""}</span>`:""}\n          </div>\n        `,e.isMessage||i.addEventListener("click",()=>this.selectSchool(e))),this.dropdown.appendChild(i)}),this.dropdown.style.display="block"}hideDropdown(){this.dropdown.style.display="none"}highlightMatch(e,t){if(!t)return e;const i=new RegExp(`(${t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");return e.replace(i,"<mark>$1</mark>")}selectSchool(e){this.selectedSchool=e,this.input.value=e.name,this.hideDropdown(),this.showVerificationBadge(e),this.autofillFields(e),console.log("‚úÖ Scuola selezionata:",e.name)}showVerificationBadge(e){e.verified&&(this.verificationBadge.innerHTML='<i class="fas fa-check-circle"></i> Scuola Verificata',this.verificationBadge.className="verification-badge verified",this.verificationBadge.style.display="inline-block")}hideVerificationBadge(){this.verificationBadge.style.display="none"}autofillFields(e){const t=document.getElementById("instituteType");if(t&&e.type){const i={"SCUOLA INFANZIA":"Scuola dell'Infanzia","SCUOLA PRIMARIA":"Scuola Primaria","SCUOLA SECONDARIA I GRADO":"Scuola Secondaria di I Grado",LICEO:"Liceo","ISTITUTO TECNICO":"Istituto Tecnico","ISTITUTO PROFESSIONALE":"Istituto Professionale","ISTITUTO SUPERIORE":"Liceo",UNIVERSITA:"Universit√†"},s=i[e.type.toUpperCase()]||e.type;Array.from(t.options).forEach(e=>{(e.value.includes(s)||e.text.includes(s))&&(t.value=e.value)})}this.setHiddenField("institute-email-hidden",e.email),this.setHiddenField("institute-address-hidden",e.address),this.setHiddenField("institute-city-hidden",e.city),this.setHiddenField("institute-province-hidden",e.province),this.setHiddenField("institute-website-hidden",e.website),this.setHiddenField("institute-phone-hidden",""),this.setHiddenField("institute-code-hidden",e.code),console.log("‚úÖ Campi auto-compilati:",{name:e.name,code:e.code,email:e.email,address:e.address,city:e.city,province:e.province,website:e.website}),console.log("üîç Verifica campi hidden:",{emailField:!!document.getElementById("institute-email-hidden"),addressField:!!document.getElementById("institute-address-hidden"),cityField:!!document.getElementById("institute-city-hidden"),provinceField:!!document.getElementById("institute-province-hidden"),websiteField:!!document.getElementById("institute-website-hidden")})}setHiddenField(e,t){const i=document.getElementById(e);i&&t&&(i.value=t)}handleKeyboard(e){const t=this.dropdown.querySelectorAll(".autocomplete-item:not(.autocomplete-message)");if(0===t.length)return;const i=this.dropdown.querySelector(".autocomplete-item.active");let s=i?parseInt(i.dataset.index):-1;switch(e.key){case"ArrowDown":e.preventDefault(),s=Math.min(s+1,t.length-1);break;case"ArrowUp":e.preventDefault(),s=Math.max(s-1,0);break;case"Enter":return e.preventDefault(),void(i&&i.click());case"Escape":return void this.hideDropdown();default:return}t.forEach(e=>e.classList.remove("active")),t[s]&&(t[s].classList.add("active"),t[s].scrollIntoView({block:"nearest"}))}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.instituteAutocomplete=new InstituteAutocomplete,window.instituteAutocomplete.init()}):(window.instituteAutocomplete=new InstituteAutocomplete,window.instituteAutocomplete.init());