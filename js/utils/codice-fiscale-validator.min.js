class CodiceFiscaleValidator{constructor(){this.monthCodes={A:1,B:2,C:3,D:4,E:5,H:6,L:7,M:8,P:9,R:10,S:11,T:12},this.monthLetters=["A","B","C","D","E","H","L","M","P","R","S","T"],this.consonants="BCDFGHJKLMNPQRSTVWXYZ",this.vowels="AEIOU",this.oddValues={0:1,1:0,2:5,3:7,4:9,5:13,6:15,7:17,8:19,9:21,A:1,B:0,C:5,D:7,E:9,F:13,G:15,H:17,I:19,J:21,K:2,L:4,M:18,N:20,O:11,P:3,Q:6,R:8,S:12,T:14,U:16,V:10,W:22,X:25,Y:24,Z:23},this.evenValues={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7,I:8,J:9,K:10,L:11,M:12,N:13,O:14,P:15,Q:16,R:17,S:18,T:19,U:20,V:21,W:22,X:23,Y:24,Z:25},this.omocodiaChars={0:"L",1:"M",2:"N",3:"P",4:"Q",5:"R",6:"S",7:"T",8:"U",9:"V"},this.omocodiaReverse={L:"0",M:"1",N:"2",P:"3",Q:"4",R:"5",S:"6",T:"7",U:"8",V:"9"},this.omocodiaPositions=[6,7,9,10,12,13,14]}normalizeString(e){return e?e.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^A-Z]/g,""):""}getConsonants(e){return e.split("").filter(e=>this.consonants.includes(e)).join("")}getVowels(e){return e.split("").filter(e=>this.vowels.includes(e)).join("")}generateSurnameCode(e){const t=this.normalizeString(e),r=this.getConsonants(t),a=this.getVowels(t);let o=r+a+"XXX";return o.substring(0,3)}generateNameCode(e){const t=this.normalizeString(e),r=this.getConsonants(t),a=this.getVowels(t);let o;return r.length>=4?o=r[0]+r[2]+r[3]:(o=r+a+"XXX",o=o.substring(0,3)),o}generateBirthDateCode(e,t){const r=new Date(e),a=r.getFullYear().toString().slice(-2),o=this.monthLetters[r.getMonth()];let n=r.getDate();return"F"===t&&(n+=40),a+o+n.toString().padStart(2,"0")}calculateCheckChar(e){let t=0;for(let r=0;r<15;r++){const a=e[r];t+=r%2==0?this.oddValues[a]:this.evenValues[a]}const r=t%26;return String.fromCharCode(65+r)}normalizeOmocodia(e){let t=e.toUpperCase();for(const e of this.omocodiaPositions){const r=t[e];this.omocodiaReverse[r]&&(t=t.substring(0,e)+this.omocodiaReverse[r]+t.substring(e+1))}return t}extractBirthDate(e){const t=this.normalizeOmocodia(e);let r=parseInt(t.substring(6,8));const a=t[8];let o=parseInt(t.substring(9,11));const n=(new Date).getFullYear()%100,s=r<=n?2e3+r:1900+r,i=o>40?"F":"M";o>40&&(o-=40);const l=this.monthCodes[a];return!l||o<1||o>31?null:{date:new Date(s,l-1,o),gender:i,year:s,month:l,day:o}}calculateAge(e){const t=new Date,r=new Date(e);let a=t.getFullYear()-r.getFullYear();const o=t.getMonth()-r.getMonth();return(o<0||0===o&&t.getDate()<r.getDate())&&a--,a}validateFormat(e){if(!e||"string"!=typeof e)return{valid:!1,error:"Codice fiscale mancante"};const t=e.toUpperCase().trim();if(16!==t.length)return{valid:!1,error:"Il codice fiscale deve essere di 16 caratteri"};const r=/^[A-Z]{6}[A-Z0-9]{2}[A-Z][A-Z0-9]{2}[A-Z][A-Z0-9]{3}[A-Z]$/;return r.test(t)?{valid:!0,normalized:t}:{valid:!1,error:"Formato codice fiscale non valido"}}validateCheckChar(e){const t=e.toUpperCase(),r=this.calculateCheckChar(t.substring(0,15));return t[15]===r}compareSurnameCode(e,t){const r=e.substring(0,3),a=this.generateSurnameCode(t);return r===a}compareNameCode(e,t){const r=e.substring(3,6),a=this.generateNameCode(t);return r===a}compareBirthDate(e,t){const r=this.extractBirthDate(e);if(!r)return!1;const a=new Date(t);return r.year===a.getFullYear()&&r.month===a.getMonth()+1&&r.day===a.getDate()}validate(e,t,r,a){const o=[],n=this.validateFormat(e);if(!n.valid)return{valid:!1,errors:[n.error]};const s=this.normalizeOmocodia(n.normalized);this.validateCheckChar(s)||o.push("Carattere di controllo non valido"),this.compareSurnameCode(s,r)||o.push("Il cognome non corrisponde al codice fiscale"),this.compareNameCode(s,t)||o.push("Il nome non corrisponde al codice fiscale"),this.compareBirthDate(s,a)||o.push("La data di nascita non corrisponde al codice fiscale");const i=this.extractBirthDate(s),l=i?this.calculateAge(i.date):null;return{valid:0===o.length,errors:o,birthInfo:i,age:l,normalized:s}}validateForRegistration(e,t,r,a){const o=this.validate(e,t,r,a);if(!o.valid)return{canRegister:!1,errors:o.errors,ageCategory:null};const n=o.age;return n<14?{canRegister:!1,errors:["Devi avere almeno 14 anni per registrarti su EduNet19"],ageCategory:"under_14",age:n}:n<16?{canRegister:!0,requiresParentalConsent:!0,errors:[],ageCategory:"14_15",age:n,message:"Per completare la registrazione Ã¨ necessario il consenso di un genitore o tutore."}:n<18?{canRegister:!0,requiresMinorDeclaration:!0,errors:[],ageCategory:"16_17",age:n,message:"Dichiara di avere il consenso dei tuoi genitori per procedere."}:{canRegister:!0,errors:[],ageCategory:"adult",age:n}}}window.codiceFiscaleValidator=new CodiceFiscaleValidator;