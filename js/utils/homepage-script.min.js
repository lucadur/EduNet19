"use strict";class EduNetHomepage{constructor(){this.isInitialized=!1,this.currentUser=null,this.userProfile=null,this.feedData=[],this.currentFeedType="all",this.currentPage=1,this.isLoading=!1,this.hasMoreContent=!0,this.activeFilters=null,this.elements={},this.eventListeners=new Map,this.intersectionObserver=null,this.searchTimer=null,this.handleResize=this.handleResize.bind(this),this.handleScroll=this.handleScroll.bind(this),this.handleKeydown=this.handleKeydown.bind(this),this.handleClick=this.handleClick.bind(this),this.init()}async init(){try{console.log("üè† EduNet19 Homepage - Initializing..."),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.handleDOMReady()):await this.handleDOMReady()}catch(e){console.error("‚ùå Failed to initialize homepage:",e),this.handleInitializationError(e)}}async handleDOMReady(){try{console.log("üè† EduNet19 Homepage - DOM Ready, starting initialization..."),this.cacheElements(),this.setupEventListeners();try{await this.waitForAuthSystem()}catch(e){return void console.error("Auth system failed to initialize:",e)}await this.checkAuthentication(),this.initializeUI(),await this.loadInitialData(),this.checkScrollToPost(),this.hideLoadingScreen(),this.isInitialized=!0,console.log("‚úÖ EduNet19 Homepage - Initialized successfully")}catch(e){console.error("‚ùå Failed to initialize homepage DOM:",e),this.handleInitializationError(e)}}cacheElements(){this.elements={loadingScreen:document.getElementById("loading-screen"),searchInput:document.getElementById("global-search"),searchResults:document.getElementById("search-results"),searchClear:document.querySelector(".search-clear"),notificationsBtn:document.getElementById("notifications-btn"),messagesBtn:document.getElementById("messages-btn"),userMenuBtn:document.getElementById("user-menu-btn"),mobileMenuToggle:document.getElementById("mobile-menu-toggle"),mobileMenuOverlay:document.getElementById("mobile-menu-overlay"),mobileMenuClose:document.getElementById("mobile-menu-close"),logoutBtn:document.getElementById("logout-btn"),userAvatar:document.getElementById("user-avatar"),userName:document.getElementById("user-name"),userFullName:document.getElementById("user-full-name"),userTypeDisplay:document.getElementById("user-type-display"),mobileUserName:document.getElementById("mobile-user-name"),mobileUserType:document.getElementById("mobile-user-type"),mobileUserAvatar:document.getElementById("mobile-user-avatar"),feedTabs:document.querySelectorAll(".feed-tab"),contentFilter:document.getElementById("content-filter"),instituteTypeFilter:document.getElementById("institute-type-filter"),dateFilter:document.getElementById("date-filter"),sortFilter:document.getElementById("sort-filter"),engagementFilter:document.getElementById("engagement-filter"),createPostSection:document.getElementById("create-post-section"),createPostTrigger:document.getElementById("create-post-trigger"),feedContent:document.getElementById("feed-content"),feedLoading:document.getElementById("feed-loading"),feedEmpty:document.getElementById("feed-empty"),loadMoreBtn:document.getElementById("load-more-btn"),filterChips:document.querySelectorAll(".filter-chip"),advancedFiltersToggle:document.getElementById("advanced-filters-toggle"),advancedFiltersPanel:document.getElementById("advanced-filters-panel"),resetFiltersBtn:document.getElementById("reset-filters"),applyFiltersBtn:document.getElementById("apply-filters"),favoritesList:document.getElementById("favorites-list"),recentActivity:document.getElementById("recent-activity"),trendingTopics:document.getElementById("trending-topics"),suggestedInstitutes:document.getElementById("suggested-institutes"),instituteStats:document.getElementById("institute-stats"),postsCount:document.getElementById("posts-count"),followersCount:document.getElementById("followers-count"),viewsCount:document.getElementById("views-count"),ratingAverage:document.getElementById("rating-average"),mobileNavItems:document.querySelectorAll(".mobile-nav-item"),mobileMenuItems:document.querySelectorAll(".mobile-menu-item"),mobileCreatePost:document.getElementById("mobile-create-post"),mobileCreateProject:document.getElementById("mobile-create-project"),mobileLogout:document.getElementById("mobile-logout"),dropdowns:document.querySelectorAll(".dropdown"),createPostModal:document.getElementById("createPostModal")}}setupEventListeners(){window.addEventListener("resize",this.handleResize),window.addEventListener("scroll",this.handleScroll),document.addEventListener("keydown",this.handleKeydown),document.addEventListener("click",this.handleClick),this.elements.searchInput&&(this.elements.searchInput.addEventListener("input",e=>{this.handleSearch(e.target.value)}),this.elements.searchInput.addEventListener("focus",()=>{this.showSearchResults()})),this.elements.searchClear&&this.elements.searchClear.addEventListener("click",()=>{this.clearSearch()}),this.setupDropdowns(),this.elements.feedTabs.forEach(e=>{e.addEventListener("click",()=>{this.switchFeedTab(e.dataset.feed)})}),this.elements.contentFilter&&this.elements.contentFilter.addEventListener("change",()=>{this.applyFilters()}),this.elements.instituteTypeFilter&&this.elements.instituteTypeFilter.addEventListener("change",()=>{this.applyFilters()}),this.elements.dateFilter&&this.elements.dateFilter.addEventListener("change",()=>{this.applyFilters()}),this.elements.sortFilter&&this.elements.sortFilter.addEventListener("change",()=>{this.applyFilters()}),this.elements.engagementFilter&&this.elements.engagementFilter.addEventListener("change",()=>{this.applyFilters()}),this.elements.filterChips.forEach(e=>{e.addEventListener("click",()=>{this.handleFilterChipClick(e)})}),this.elements.advancedFiltersToggle&&this.elements.advancedFiltersToggle.addEventListener("click",()=>{this.toggleAdvancedFilters()}),this.elements.resetFiltersBtn&&this.elements.resetFiltersBtn.addEventListener("click",()=>{this.resetFilters()}),this.elements.applyFiltersBtn&&this.elements.applyFiltersBtn.addEventListener("click",()=>{this.applyFilters()}),this.elements.createPostTrigger&&this.elements.createPostTrigger.addEventListener("click",()=>{console.log("üìù Create post trigger clicked"),this.handlePostActionClick("text")}),this.elements.loadMoreBtn&&this.elements.loadMoreBtn.addEventListener("click",()=>{this.loadMoreContent()}),this.elements.mobileMenuToggle&&this.elements.mobileMenuToggle.addEventListener("click",()=>{this.toggleMobileMenu()}),this.elements.mobileMenuClose&&this.elements.mobileMenuClose.addEventListener("click",()=>{this.toggleMobileMenu()}),this.elements.mobileMenuOverlay&&this.elements.mobileMenuOverlay.addEventListener("click",e=>{e.target===this.elements.mobileMenuOverlay&&this.toggleMobileMenu()}),this.elements.mobileMenuItems&&this.elements.mobileMenuItems.forEach(e=>{e.addEventListener("click",t=>{const s=e.dataset.section;s&&(this.switchSection(s),this.toggleMobileMenu())})}),this.elements.mobileNavItems&&this.elements.mobileNavItems.forEach(e=>{e.addEventListener("click",t=>{if(e.classList.contains("create-btn")||"profile"===e.dataset.section)return;t.preventDefault();const s=e.dataset.section;s&&this.switchSection(s)})}),document.querySelectorAll(".sidebar-nav .nav-link").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const s=e.dataset.section;s&&this.switchSection(s)})}),this.elements.mobileCreatePost&&this.elements.mobileCreatePost.addEventListener("click",()=>{this.openCreatePostModal("post"),this.toggleMobileMenu()}),this.elements.mobileCreateProject&&this.elements.mobileCreateProject.addEventListener("click",()=>{this.openCreatePostModal("project"),this.toggleMobileMenu()}),this.elements.mobileLogout&&this.elements.mobileLogout.addEventListener("click",()=>{this.handleLogout()}),this.elements.logoutBtn&&this.elements.logoutBtn.addEventListener("click",()=>{this.handleLogout()}),this.setupInfiniteScroll()}setupDropdowns(){document.querySelectorAll(".nav-item").forEach(e=>{const t=e.querySelector(".nav-button");t&&t.addEventListener("click",t=>{t.stopPropagation(),this.toggleDropdown(e)})}),document.addEventListener("click",()=>{this.closeAllDropdowns()})}setupInfiniteScroll(){"IntersectionObserver"in window&&(this.intersectionObserver=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&this.hasMoreContent&&!this.isLoading&&this.loadMoreContent()})},{threshold:.1,rootMargin:"100px"}))}async waitForAuthSystem(){let e=0;return new Promise((t,s)=>{const i=()=>{window.eduNetAuth&&window.eduNetAuth.isInitialized?(console.log("Auth system available and initialized"),t()):e>=1e4?(console.error("Auth system not available after waiting, redirecting to login"),s(new Error("Auth system timeout")),window.location.href=window.AppConfig.getPageUrl("index.html")):(console.log(`Waiting for auth system... (${e}ms/10000ms)`),e+=100,setTimeout(i,100))};i()})}async checkAuthentication(){if(console.log("üîê Controllo autenticazione..."),!window.eduNetAuth||!window.eduNetAuth.isAuthenticated())return console.log("‚ùå Utente non autenticato, reindirizzamento al login"),window.eduNetAuth&&window.eduNetAuth.supabase&&await window.eduNetAuth.supabase.auth.signOut(),void(window.location.href=window.AppConfig.getPageUrl("index.html"));if(this.currentUser=window.eduNetAuth.getCurrentUser(),this.userProfile=window.eduNetAuth.getUserProfile(),console.log("üë§ Utente corrente:",this.currentUser),console.log("üìã Profilo utente:",this.userProfile),!this.currentUser||!this.userProfile){console.log("‚è≥ Profilo utente non ancora disponibile, attesa in corso...");let e=0;const t=30;for(;(!this.currentUser||!this.userProfile)&&e<t;)await new Promise(e=>setTimeout(e,100)),this.currentUser=window.eduNetAuth.getCurrentUser(),this.userProfile=window.eduNetAuth.getUserProfile(),e++,e%10==0&&console.log(`‚è≥ Tentativo ${e}/${t} - Utente: ${!!this.currentUser}, Profilo: ${!!this.userProfile}`);if(!this.currentUser||!this.userProfile)return console.error("‚ùå Profilo utente non disponibile dopo l'attesa. Possibile account incompleto."),this.showNotification("Impossibile caricare il profilo utente. Effettua nuovamente l'accesso o contatta l'assistenza.","error"),window.eduNetAuth&&window.eduNetAuth.supabase&&await window.eduNetAuth.supabase.auth.signOut(),void setTimeout(()=>{window.location.href=window.AppConfig.getPageUrl("index.html")},2e3)}console.log("‚úÖ Utente autenticato:",this.currentUser.email),console.log("‚úÖ Profilo caricato:",this.userProfile),this.checkInstituteVerification()}checkInstituteVerification(){const e=this.userProfile?.user_type;if("istituto"!==e)return;const t=this.userProfile?.verification_status;"verified"===t||!0===this.userProfile?.verified||(console.log("‚ö†Ô∏è Istituto non verificato, mostro banner avviso"),this.showVerificationWarningBanner(t))}showVerificationWarningBanner(e){const t=document.getElementById("verification-warning-banner");t&&t.remove();const s="pending_verification"===e||"verification_sent"===e,i=document.createElement("div");i.id="verification-warning-banner",i.className="verification-warning-banner",i.innerHTML=`\n      <div class="banner-content">\n        <i class="fas ${s?"fa-clock":"fa-exclamation-triangle"}"></i>\n        <div class="banner-text">\n          <strong>${s?"Verifica in corso":"Istituto non verificato"}</strong>\n          <p>${s?"Abbiamo inviato una richiesta di verifica all'email ufficiale MIUR. Controlla la casella di posta dell'istituto.":"Il tuo istituto non √® ancora verificato. Alcune funzionalit√† potrebbero essere limitate."}</p>\n        </div>\n        <button class="banner-close" onclick="this.parentElement.parentElement.remove()">\n          <i class="fas fa-times"></i>\n        </button>\n      </div>\n    `;const n=document.querySelector(".main-content")||document.querySelector("main");n&&n.insertBefore(i,n.firstChild)}initializeUI(){this.updateUserInfo(),this.setupUserTypeSpecificUI(),this.initializeSidebar(),this.handleResize()}updateUserInfo(){if(!this.currentUser||!this.userProfile)return;console.log("üîç [updateUserInfo] userProfile:",this.userProfile),console.log("üîç [updateUserInfo] institute_name:",this.userProfile.institute_name),console.log("üîç [updateUserInfo] instituteData:",this.userProfile.instituteData);const e=this.getDisplayName(),t=this.getUserTypeDisplay();console.log("üîç [updateUserInfo] displayName:",e),console.log("üîç [updateUserInfo] userType:",t),this.elements.userName&&(this.elements.userName.textContent=e),this.elements.userFullName&&(this.elements.userFullName.textContent=e),this.elements.userTypeDisplay&&(this.elements.userTypeDisplay.textContent=t),window.avatarManager&&window.avatarManager.loadCurrentUserAvatar();const s=document.getElementById("manage-admins");s&&"istituto"===this.userProfile?.user_type&&(s.style.display="flex"),this.checkAdminRole()}async checkAdminRole(){try{const e=await(window.supabaseClientManager?.getClient());if(!e||!this.currentUser)return;const{data:t,error:s}=await e.from("admin_users").select("role").eq("user_id",this.currentUser.id).maybeSingle();if(s)return;if(t){const e=document.getElementById("moderation-center");e&&(e.style.display="flex"),console.log("‚úÖ User is admin/moderator:",t.role)}}catch(e){}}getDisplayName(){return this.userProfile?this.userProfile.is_collaborator&&this.userProfile.collaborator_data?`${this.userProfile.first_name||this.userProfile.collaborator_data.first_name||""} ${this.userProfile.last_name||this.userProfile.collaborator_data.last_name||""}`.trim()||"Collaboratore":"istituto"===this.userProfile.user_type?this.userProfile.institute_name||this.userProfile.instituteData?.institute_name||"Istituto":`${this.userProfile.first_name||""} ${this.userProfile.last_name||""}`.trim()||"Utente":"Utente"}getUserTypeDisplay(){if(!this.userProfile)return"Utente";if(this.userProfile.is_collaborator&&this.userProfile.collaborator_data){const e={admin:"Amministratore",editor:"Editor",viewer:"Visualizzatore"}[this.userProfile.collaborator_role]||"Collaboratore",t=this.userProfile.collaborator_data.institute_name||"";return t?`${e} - ${t}`:e}if("istituto"===this.userProfile.user_type){const e=this.userProfile.institute_type||this.userProfile.instituteData?.institute_type;return e&&"Altro"!==e?e:"Istituto Scolastico"}return"Utente Privato"}setupUserTypeSpecificUI(){const e="istituto"===this.userProfile?.user_type||this.userProfile?.can_manage_institute;this.elements.createPostSection&&(this.elements.createPostSection.style.display=e?"block":"none"),this.elements.instituteStats&&(this.elements.instituteStats.style.display=e?"block":"none"),this.updateQuickActions(e)}updateQuickActions(e){const t=document.querySelector(".quick-actions");t&&(t.innerHTML=e?'\n        <button class="quick-action-btn" id="create-post-btn">\n          <i class="fas fa-plus" aria-hidden="true"></i>\n          <span>Nuovo Post</span>\n        </button>\n        <button class="quick-action-btn" id="create-project-btn">\n          <i class="fas fa-lightbulb" aria-hidden="true"></i>\n          <span>Nuovo Progetto</span>\n        </button>\n      ':'\n        <button class="quick-action-btn" id="discover-institutes">\n          <i class="fas fa-compass" aria-hidden="true"></i>\n          <span>Scopri Istituti</span>\n        </button>\n      ',this.attachQuickActionListeners())}attachQuickActionListeners(){const e=document.getElementById("create-post-btn"),t=document.getElementById("create-project-btn"),s=document.getElementById("discover-institutes");e&&e.addEventListener("click",()=>{window.eduNetSocial&&window.eduNetSocial.showCreatePostModal("post")}),t&&t.addEventListener("click",()=>{window.eduNetSocial&&window.eduNetSocial.showCreatePostModal("project")}),s&&s.addEventListener("click",()=>this.switchSection("explore")),document.querySelectorAll(".post-action-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.type;this.handlePostActionClick(t)})}),this.attachSidebarListeners()}handlePostActionClick(e){if(console.log("üìù handlePostActionClick called with type:",e),"istituto"===this.userProfile?.user_type||this.userProfile?.can_manage_institute)return window.eduNetSocial?void this.openCreateModal(e):(console.warn("‚ö†Ô∏è eduNetSocial non disponibile, attendo..."),void setTimeout(()=>{if(window.eduNetSocial)this.openCreateModal(e);else{const t=`pages/main/create.html?type=${encodeURIComponent(e)}`,s=window.AppConfig&&"function"==typeof window.AppConfig.getPageUrl?window.AppConfig.getPageUrl(t):t;window.location.href=s}},500));this.showNotification("Solo gli istituti e i loro collaboratori possono creare contenuti","warning")}openCreateModal(e){if(console.log("üìù Opening create modal for type:",e),!window.eduNetSocial)return console.error("‚ùå eduNetSocial non disponibile"),void this.showNotification("Sistema di pubblicazione non disponibile. Ricarica la pagina.","error");switch(e){case"text":console.log("üìù Calling showCreatePostModal for post"),window.eduNetSocial.showCreatePostModal("post");break;case"image":this.showNotification("Funzionalit√† foto in arrivo!","info");break;case"project":console.log("üìù Calling showCreatePostModal for project"),window.eduNetSocial.showCreatePostModal("project");break;case"methodology":console.log("üìù Calling showCreatePostModal for methodology"),window.eduNetSocial.showCreatePostModal("methodology");break;default:console.warn("Tipo di post non riconosciuto:",e)}}showNotification(e,t="info"){const s=document.createElement("div");s.className=`notification notification-${t}`,s.innerHTML=`\n      <div class="notification-content">\n        <i class="fas fa-${this.getNotificationIcon(t)}" aria-hidden="true"></i>\n        <span>${e}</span>\n      </div>\n      <button class="notification-close">\n        <i class="fas fa-times" aria-hidden="true"></i>\n      </button>\n    `,document.body.appendChild(s),setTimeout(()=>{s.parentNode&&s.remove()},5e3),s.querySelector(".notification-close").addEventListener("click",()=>{s.remove()}),setTimeout(()=>{s.classList.add("show")},100)}getNotificationIcon(e){return{info:"info-circle",success:"check-circle",warning:"exclamation-triangle",error:"times-circle"}[e]||"info-circle"}attachSidebarListeners(){document.querySelectorAll(".nav-link").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const s=e.dataset.section;s&&(this.switchSection(s),this.updateActiveNavLink(e))})}),document.querySelectorAll(".quick-link").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const s=e.getAttribute("href");s&&"#"!==s&&window.open(s,"_blank")})}),document.querySelectorAll("#discover-institutes").forEach(e=>{e.addEventListener("click",()=>{this.switchSection("explore")})})}updateActiveNavLink(e){document.querySelectorAll(".nav-link").forEach(e=>{e.classList.remove("active")}),e.classList.add("active");const t=e.dataset.section;document.querySelectorAll(".mobile-nav-item").forEach(e=>{e.classList.toggle("active",e.dataset.section===t)})}initializeSidebar(){this.loadFavorites(),this.loadRecentActivity(),this.loadTrendingTopics(),this.loadSuggestedInstitutes(),"istituto"===this.userProfile?.user_type&&this.loadInstituteStatistics()}async loadInitialData(){try{this.currentPage=1,this.hasMoreContent=!0,this.feedData=[],this.showFeedLoading(),await this.loadTabCounts(),await this.loadFeedContent()}catch(e){console.error("Error loading initial data:",e),this.showFeedError("Errore nel caricamento dei contenuti")}}async loadTabCounts(){try{const e=window.eduNetSocial?.supabase||await(window.supabaseClientManager?.getClient());if(!e)return void console.warn("‚ö†Ô∏è Supabase client not available for tab counts");const{data:{user:t}}=await e.auth.getUser(),[s,i,n,a]=await Promise.all([e.from("institute_posts").select("id",{count:"exact",head:!0}).eq("published",!0),e.from("institute_posts").select("id",{count:"exact",head:!0}).eq("published",!0).eq("post_type","project"),e.from("institute_posts").select("id",{count:"exact",head:!0}).eq("published",!0).eq("post_type","methodology"),t?e.from("user_connections").select("id",{count:"exact",head:!0}).eq("follower_id",t.id).eq("status","accepted"):Promise.resolve({count:0})]);this.updateTabBadge("all",s.count||0),this.updateTabBadge("following",a.count||0),this.updateTabBadge("projects",i.count||0),this.updateTabBadge("methodologies",n.count||0),console.log("‚úÖ Tab counts loaded:",{all:s.count,following:a.count,projects:i.count,methodologies:n.count})}catch(e){console.error("‚ùå Error loading tab counts:",e),this.updateTabBadge("all",0),this.updateTabBadge("following",0),this.updateTabBadge("projects",0),this.updateTabBadge("methodologies",0)}}updateTabBadge(e,t){const s=document.getElementById(`tab-count-${e}`);s&&(t>0?(s.textContent=t>999?"999+":t,s.style.display=""):(s.textContent="",s.style.display="none"))}async loadFeedContent(){if(!this.isLoading){this.isLoading=!0;try{const e=await this.fetchFeedData();1===this.currentPage?(this.feedData=e,this.renderFeed()):(this.feedData.push(...e),this.appendToFeed(e)),this.hasMoreContent=10===e.length,this.updateLoadMoreButton()}catch(e){console.error("Error loading feed content:",e),this.showFeedError("Errore nel caricamento del feed")}finally{this.isLoading=!1,this.hideFeedLoading()}}}async fetchFeedData(){try{if(window.eduNetSocial&&window.eduNetSocial.supabase){console.log("Attempting to fetch posts from database...");try{let e=[];if("following"===this.currentFeedType){const t=window.eduNetAuth?.getCurrentUser();if(t){const{data:s,error:i}=await window.eduNetSocial.supabase.from("user_connections").select("followed_id").eq("follower_id",t.id).eq("status","accepted");if(i)console.warn("Error fetching connections:",i);else{if(!(s&&s.length>0))return console.log("User is not following anyone"),[];e=s.map(e=>e.followed_id),console.log(`User follows ${e.length} profiles`)}}}let t=window.eduNetSocial.supabase.from("institute_posts").select("id, institute_id, title, content, post_type, category, tags, target_audience, subject_areas, attachments, image_url, image_urls, published, created_at, updated_at, likes_count, comments_count, views_count").eq("published",!0);"following"===this.currentFeedType&&e.length>0&&(t=t.in("institute_id",e)),"projects"===this.currentFeedType&&(t=t.eq("post_type","project")),"methodologies"===this.currentFeedType&&(t=t.eq("post_type","methodology"));const{data:s,error:i}=await t.order("created_at",{ascending:!1}).range(10*(this.currentPage-1),10*this.currentPage-1);if(i)throw"PGRST205"===i.code||"PGRST116"===i.code||i.message.includes("404")||i.message.includes("Could not find the table")?(console.log("Posts table not found, using mock data"),new Error("TABLE_NOT_FOUND")):i;if(s&&s.length>0){console.log(`Fetched ${s.length} real posts from database`);const e=s.map(e=>({...e,author_id:e.institute_id,is_published:e.published})),t=window.eduNetAuth?.getCurrentUser(),i=t?.id;let n=new Set;if(i)try{const{data:e}=await window.eduNetSocial.supabase.from("post_likes").select("post_id").eq("user_id",i);e&&(n=new Set(e.map(e=>e.post_id)))}catch(e){console.warn("Could not fetch user likes:",e)}const a=e.map(e=>e.id);let o={};try{const{data:e}=await window.eduNetSocial.supabase.from("post_likes").select("post_id").in("post_id",a);e&&e.forEach(e=>{o[e.post_id]=(o[e.post_id]||0)+1})}catch(e){console.warn("Could not fetch like counts:",e)}return await Promise.all(e.map(async e=>{let t="Utente";try{const[s,i]=await Promise.allSettled([window.eduNetSocial.supabase.from("school_institutes").select("institute_name").eq("id",e.institute_id).maybeSingle(),window.eduNetSocial.supabase.from("private_users").select("first_name, last_name").eq("id",e.institute_id).maybeSingle()]);if("fulfilled"===s.status&&s.value.data)t=s.value.data.institute_name;else if("fulfilled"===i.status&&i.value.data){const e=i.value.data;t=`${e.first_name} ${e.last_name}`}}catch(t){console.warn("Could not fetch author for post:",e.id)}return{id:e.id,title:e.title,content:e.content,author:t,author_id:e.institute_id,created_at:new Date(e.created_at),likes:o[e.id]||0,comments:e.comments_count||0,post_type:e.post_type,category:e.category,tags:e.tags||[],target_audience:e.target_audience,subject_areas:e.subject_areas||[],image_urls:e.image_urls||[],image_url:e.image_url,isLikedByUser:n.has(e.id)}}))}return console.log("No posts found in database"),[]}catch(e){return"TABLE_NOT_FOUND"===e.message?(console.log("Posts table not found"),[]):(console.log("Database connection issue"),[])}}}catch(e){return console.error("Error fetching posts:",e),[]}return[]}renderFeed(){if(!this.elements.feedContent)return;if(0===this.feedData.length)return void this.showEmptyFeed();this.elements.feedContent.innerHTML="";const e=this.feedData.some(e=>"string"==typeof e.id&&e.id.startsWith("post_"));this.feedData.forEach(t=>{const s=this.createPostElement(t,e);this.elements.feedContent.appendChild(s)}),e&&this.showMockDataBanner(),this.hideEmptyFeed(),this.setupInfiniteScrollObserver(),e||this.loadCommentCounts(),this.updateSavedPostsIndicators()}async loadCommentCounts(){if(window.supabaseClientManager)try{const e=await window.supabaseClientManager.getClient();if(!e)return;const t=this.feedData.map(e=>e.id);if(0===t.length)return;const{data:s,error:i}=await e.from("post_comments").select("post_id").in("post_id",t).is("parent_comment_id",null);if(i)return void console.error("Error loading comment counts:",i);const n={};s.forEach(e=>{n[e.post_id]=(n[e.post_id]||0)+1}),Object.keys(n).forEach(e=>{const t=n[e],s=document.querySelector(`[data-post-id="${e}"]`);if(s){const e=s.querySelector(".comment-btn span");e&&(e.textContent=t)}}),console.log("Comment counts loaded:",n)}catch(e){console.error("Error in loadCommentCounts:",e)}}appendToFeed(e){if(!this.elements.feedContent)return;const t=e.some(e=>"string"==typeof e.id&&e.id.startsWith("post_"));e.forEach(e=>{const s=this.createPostElement(e,t);this.elements.feedContent.appendChild(s)}),this.updateSavedPostsIndicators()}createPostElement(e,t=!1){const s=document.createElement("article");s.className="post-card feed-post",s.dataset.postId=e.id,s.dataset.postType=e.post_type||"notizia",s.dataset.createdAt=e.created_at||(new Date).toISOString(),s.dataset.isMock=t;const i=t?'<span class="mock-indicator">Demo</span>':"",n=t?"":`<button class="bookmark-btn" \n                 data-post-id="${e.id}" \n                 aria-label="Salva post" \n                 title="Salva post">\n           <i class="far fa-bookmark" aria-hidden="true"></i>\n         </button>`,a=this.getPostTypeInfo(e.post_type),o=this.getPostContentByType(e);s.innerHTML=`\n      <div class="post-header">\n        <div class="post-author">\n          <div class="author-avatar" data-user-id="${e.author_id||""}">\n            <i class="fas fa-school" aria-hidden="true"></i>\n          </div>\n          <div class="author-info">\n            <h3 class="author-name">${e.author}</h3>\n            <time class="post-time" datetime="${e.created_at.toISOString()}">\n              ${this.formatTimeAgo(e.created_at)}\n            </time>\n          </div>\n        </div>\n        <span class="post-type-badge ${a.class}">\n          <i class="${a.icon}"></i>\n          ${a.label}\n        </span>\n        <div class="post-actions">\n          ${i}\n          ${n}\n          <button class="post-menu-btn" aria-label="Menu post" data-post-id="${e.id}">\n            <i class="fas fa-ellipsis-h" aria-hidden="true"></i>\n          </button>\n          ${this.createPostDropdownMenu(e,t)}\n        </div>\n      </div>\n      \n      ${o}\n      \n      <div class="post-footer">\n        <div class="post-stats">\n          <button class="stat-btn like-btn ${t?"disabled":""} ${e.isLikedByUser?"liked":""}" \n                  data-post-id="${e.id}" \n                  ${t?'disabled title="Funzionalit√† non disponibile in modalit√† demo"':""}>\n            <i class="${e.isLikedByUser?"fas":"far"} fa-heart" aria-hidden="true" style="${e.isLikedByUser?"color: #e53e3e;":""}"></i>\n            <span>${e.likes||0}</span>\n          </button>\n          <button class="stat-btn comment-btn ${t?"disabled":""}" \n                  data-post-id="${e.id}"\n                  ${t?'disabled title="Funzionalit√† non disponibile in modalit√† demo"':""}>\n            <i class="far fa-comment" aria-hidden="true"></i>\n            <span>${e.comments||0}</span>\n          </button>\n          <button class="stat-btn share-btn ${t?"disabled":""}" \n                  data-post-id="${e.id}"\n                  ${t?'disabled title="Funzionalit√† non disponibile in modalit√† demo"':""}>\n            <i class="fas fa-share" aria-hidden="true"></i>\n            <span>Condividi</span>\n          </button>\n        </div>\n      </div>\n      \n      <div class="comments-section">\n        <button class="comments-toggle ${t?"disabled":""}" \n                data-post-id="${e.id}"\n                ${t?'disabled title="Funzionalit√† non disponibile in modalit√† demo"':""}>\n          <i class="fas fa-chevron-down" aria-hidden="true"></i>\n          ${t?"Commenti non disponibili in demo":"Mostra commenti"}\n        </button>\n        <div class="comments-container" id="comments-${e.id}">\n          ${this.renderCommentForm(e.id,t)}\n          <div class="comments-list-container"></div>\n        </div>\n      </div>\n    `,window.avatarManager&&e.author_id&&window.avatarManager.loadUserAvatar(e.author_id).then(e=>{if(e){const t=s.querySelector(".author-avatar");if(t){t.style.backgroundImage=`url(${e})`,t.style.backgroundSize="cover",t.style.backgroundPosition="center";const s=t.querySelector("i");s&&(s.style.display="none")}}}).catch(t=>{console.warn(`Could not load avatar for post ${e.id}:`,t)}),t||this.attachPostEventListeners(s,e);const r=s.querySelector(".post-image-carousel");return r&&this.initializeCarousel(r),s}renderCommentForm(e,t=!1){const s="istituto"===this.userProfile?.user_type;return t?`\n        <div class="comment-form">\n          <textarea class="comment-input" \n                    placeholder="Commenti non disponibili in modalit√† demo" \n                    rows="3" \n                    disabled></textarea>\n          <button class="comment-submit disabled" \n                  data-post-id="${e}"\n                  disabled>\n            <i class="fas fa-paper-plane" aria-hidden="true"></i>\n            Commenta\n          </button>\n        </div>\n      `:s?`\n      <div class="comment-form">\n        <textarea class="comment-input" \n                  placeholder="Scrivi un commento..." \n                  rows="3"></textarea>\n        <button class="comment-submit" \n                data-post-id="${e}">\n          <i class="fas fa-paper-plane" aria-hidden="true"></i>\n          Commenta\n        </button>\n      </div>\n    `:""}initializeCarousel(e){const t=e.querySelector(".carousel-track"),s=Array.from(e.querySelectorAll(".carousel-slide")),i=e.querySelector(".carousel-btn.prev"),n=e.querySelector(".carousel-btn.next"),a=Array.from(e.querySelectorAll(".carousel-dot")),o=e.querySelector(".current-slide");let r=0;const l=s.length,c=()=>{t.style.transform=`translateX(-${100*r}%)`,o&&(o.textContent=r+1),a.forEach((e,t)=>{e.classList.toggle("active",t===r)}),i&&(i.disabled=!1),n&&(n.disabled=!1)};i&&i.addEventListener("click",e=>{e.stopPropagation(),r>0?r--:r=l-1,c()}),n&&n.addEventListener("click",e=>{e.stopPropagation(),r<l-1?r++:r=0,c()}),a.forEach((e,t)=>{e.addEventListener("click",e=>{e.stopPropagation(),r=t,c()})});let d=0,u=0,h=!1;t.addEventListener("touchstart",e=>{d=e.touches[0].clientX,h=!0,t.classList.add("dragging")},{passive:!0}),t.addEventListener("touchmove",e=>{if(!h)return;u=e.touches[0].clientX;const s=u-d;t.style.transform=`translateX(calc(-${100*r}% + ${s}px))`},{passive:!0}),t.addEventListener("touchend",()=>{if(!h)return;h=!1,t.classList.remove("dragging");const e=u-d;Math.abs(e)>50&&(r=e>0?r>0?r-1:l-1:r<l-1?r+1:0),c()},{passive:!0}),e.addEventListener("keydown",e=>{"ArrowLeft"===e.key&&r>0?(r--,c()):"ArrowRight"===e.key&&r<l-1&&(r++,c())}),c()}createPostDropdownMenu(e,t){const s=e.author_id===this.currentUser?.id;return`\n      <div class="post-dropdown-menu" data-post-id="${e.id}">\n        <button class="post-dropdown-item" data-action="copy-link">\n          <i class="fas fa-link"></i>\n          <span>Copia link</span>\n        </button>\n        <button class="post-dropdown-item" data-action="share">\n          <i class="fas fa-share-alt"></i>\n          <span>Condividi</span>\n        </button>\n        <div class="post-dropdown-divider"></div>\n        <button class="post-dropdown-item" data-action="mute-author">\n          <i class="fas fa-volume-mute"></i>\n          <span>Non seguire ${e.author}</span>\n        </button>\n        <button class="post-dropdown-item" data-action="hide-post">\n          <i class="far fa-eye-slash"></i>\n          <span>Nascondi post</span>\n        </button>\n        <button class="post-dropdown-item" data-action="report">\n          <i class="fas fa-flag"></i>\n          <span>Segnala contenuto</span>\n        </button>\n        ${s&&!t?'\n          <div class="post-dropdown-divider"></div>\n          <button class="post-dropdown-item owner-only" data-action="edit">\n            <i class="fas fa-edit"></i>\n            <span>Modifica post</span>\n          </button>\n          <button class="post-dropdown-item owner-only danger" data-action="delete">\n            <i class="fas fa-trash-alt"></i>\n            <span>Elimina post</span>\n          </button>\n        ':""}\n      </div>\n    `}getPostTypeInfo(e){const t={post:{label:"Post",icon:"fas fa-align-left",class:"badge-post"},news:{label:"News",icon:"fas fa-newspaper",class:"badge-news"},project:{label:"Progetto",icon:"fas fa-lightbulb",class:"badge-project"},methodology:{label:"Metodologia",icon:"fas fa-book-open",class:"badge-methodology"},event:{label:"Galleria",icon:"fas fa-images",class:"badge-gallery"},collaboration:{label:"Collaborazione",icon:"fas fa-handshake",class:"badge-collaboration"},educational_experience:{label:"Esperienza Educativa",icon:"fas fa-graduation-cap",class:"badge-educational"},notizia:{label:"Post",icon:"fas fa-align-left",class:"badge-post"},progetto:{label:"Progetto",icon:"fas fa-lightbulb",class:"badge-project"},metodologia:{label:"Metodologia",icon:"fas fa-book-open",class:"badge-methodology"},evento:{label:"Galleria",icon:"fas fa-images",class:"badge-gallery"}};return t[e]||t.post}getPostContentByType(e){switch(e.post_type||"post"){case"project":case"progetto":return this.renderProjectContent(e);case"methodology":case"metodologia":return this.renderMethodologyContent(e);case"event":case"evento":return this.renderGalleryContent(e);case"collaboration":return this.renderCollaborationContent(e);case"educational_experience":return this.renderEducationalExperienceContent(e);default:return this.renderPostContent(e)}}renderPostContent(e){return`\n      <div class="post-content">\n        <h2 class="post-title">${e.title}</h2>\n        <p class="post-text">${e.content||""}</p>\n        \n        ${e.tags&&e.tags.length>0?`\n          <div class="post-tags">\n            ${e.tags.map(e=>`<span class="post-tag">#${e}</span>`).join("")}\n          </div>\n        `:""}\n        \n        ${e.image_url?`\n          <div class="post-image-container">\n            <img src="${e.image_url}" alt="${e.title||"Post image"}">\n          </div>\n        `:""}\n      </div>\n    `}renderProjectContent(e){const t=e.attachments||{},s=t.category||e.category||"",i=t.duration||e.target_audience&&e.target_audience[0]||"",n=t.objectives||e.subject_areas&&e.subject_areas[0]||"",a=t.resources||"";return`\n      <div class="post-content post-project">\n        <h2 class="post-title">${e.title}</h2>\n        \n        ${s?`\n          <div class="project-meta-item">\n            <i class="fas fa-folder"></i>\n            <strong>Categoria:</strong> <span>${s}</span>\n          </div>\n        `:""}\n        \n        ${i?`\n          <div class="project-meta-item">\n            <i class="fas fa-clock"></i>\n            <strong>Durata:</strong> <span>${i}</span>\n          </div>\n        `:""}\n        \n        <div class="post-description">\n          <p class="post-text">${e.content||""}</p>\n        </div>\n        \n        ${n?`\n          <div class="project-section">\n            <div class="section-header">\n              <i class="fas fa-bullseye"></i>\n              <strong>Obiettivi Didattici</strong>\n            </div>\n            <p class="section-content">${n}</p>\n          </div>\n        `:""}\n        \n        ${a?`\n          <div class="project-section">\n            <div class="section-header">\n              <i class="fas fa-tools"></i>\n              <strong>Risorse Necessarie</strong>\n            </div>\n            <p class="section-content">${a}</p>\n          </div>\n        `:""}\n        \n        ${e.tags&&e.tags.length>0?`\n          <div class="post-tags">\n            ${e.tags.map(e=>`<span class="post-tag">#${e}</span>`).join("")}\n          </div>\n        `:""}\n      </div>\n    `}renderMethodologyContent(e){const t=e.attachments||{},s=t.methodology_type||e.category||"",i=t.level||e.target_audience&&e.target_audience[0]||"",n=t.application||e.subject_areas&&e.subject_areas[0]||"",a=t.benefits||"";return`\n      <div class="post-content post-methodology">\n        <h2 class="post-title">${e.title}</h2>\n        \n        ${s?`\n          <div class="methodology-meta-item">\n            <i class="fas fa-tag"></i>\n            <strong>Tipo:</strong> <span>${s}</span>\n          </div>\n        `:""}\n        \n        ${i?`\n          <div class="methodology-meta-item">\n            <i class="fas fa-graduation-cap"></i>\n            <strong>Livello Scolastico:</strong> <span>${i}</span>\n          </div>\n        `:""}\n        \n        <div class="post-description">\n          <p class="post-text">${e.content||""}</p>\n        </div>\n        \n        ${n?`\n          <div class="methodology-section">\n            <div class="section-header">\n              <i class="fas fa-chalkboard-teacher"></i>\n              <strong>Modalit√† di Applicazione</strong>\n            </div>\n            <p class="section-content">${n}</p>\n          </div>\n        `:""}\n        \n        ${a?`\n          <div class="methodology-section">\n            <div class="section-header">\n              <i class="fas fa-star"></i>\n              <strong>Benefici e Risultati</strong>\n            </div>\n            <p class="section-content">${a}</p>\n          </div>\n        `:""}\n        \n        ${e.tags&&e.tags.length>0?`\n          <div class="post-tags">\n            ${e.tags.map(e=>`<span class="post-tag">#${e}</span>`).join("")}\n          </div>\n        `:""}\n      </div>\n    `}renderGalleryContent(e){return console.log("üñºÔ∏è Gallery Debug:",{title:e.title,image_urls:e.image_urls,type:typeof e.image_urls,isArray:Array.isArray(e.image_urls),length:e.image_urls?.length}),`\n      <div class="post-content post-gallery">\n        <h2 class="post-title">${e.title}</h2>\n        <p class="post-text">${e.content||""}</p>\n        \n        ${e.image_urls&&e.image_urls.length>1?`\n          <div class="post-image-carousel" data-post-id="${e.id}">\n            <div class="carousel-container">\n              <div class="carousel-track">\n                ${e.image_urls.map((e,t)=>`\n                  <div class="carousel-slide">\n                    <img src="${e}" alt="Foto ${t+1}" loading="lazy">\n                  </div>\n                `).join("")}\n              </div>\n              <button class="carousel-btn prev" aria-label="Immagine precedente">\n                <i class="fas fa-chevron-left"></i>\n              </button>\n              <button class="carousel-btn next" aria-label="Immagine successiva">\n                <i class="fas fa-chevron-right"></i>\n              </button>\n              <div class="carousel-counter">\n                <span class="current-slide">1</span> / ${e.image_urls.length}\n              </div>\n              <div class="carousel-dots">\n                ${e.image_urls.map((e,t)=>`\n                  <button class="carousel-dot ${0===t?"active":""}" data-slide="${t}" aria-label="Vai a foto ${t+1}"></button>\n                `).join("")}\n              </div>\n            </div>\n          </div>\n        `:e.image_urls&&1===e.image_urls.length||e.image_url?`\n          <div class="post-single-image">\n            <img src="${e.image_urls?e.image_urls[0]:e.image_url}" alt="${e.title||"Immagine"}" loading="lazy">\n          </div>\n        `:""}\n        \n        ${e.tags&&e.tags.length>0?`\n          <div class="post-tags">\n            ${e.tags.map(e=>`<span class="post-tag">#${e}</span>`).join("")}\n          </div>\n        `:""}\n      </div>\n    `}renderCollaborationContent(e){const t=e.attachments||{},s=t.collaboration_type||e.category||"",i=t.duration||"",n=t.looking_for||e.target_audience&&e.target_audience[0]||"",a=t.benefits||e.subject_areas&&e.subject_areas[0]||"";return`\n      <div class="post-content post-collaboration">\n        <h2 class="post-title">${e.title}</h2>\n        \n        ${s?`\n          <div class="collaboration-meta-item">\n            <i class="fas fa-handshake"></i>\n            <strong>Tipo:</strong> <span>${s}</span>\n          </div>\n        `:""}\n        \n        ${i?`\n          <div class="collaboration-meta-item">\n            <i class="fas fa-clock"></i>\n            <strong>Durata Prevista:</strong> <span>${i}</span>\n          </div>\n        `:""}\n        \n        <div class="post-description">\n          <p class="post-text">${e.content||""}</p>\n        </div>\n        \n        ${n?`\n          <div class="collaboration-section">\n            <div class="section-header">\n              <i class="fas fa-search"></i>\n              <strong>Cerchiamo</strong>\n            </div>\n            <p class="section-content">${n}</p>\n          </div>\n        `:""}\n        \n        ${a?`\n          <div class="collaboration-section">\n            <div class="section-header">\n              <i class="fas fa-gift"></i>\n              <strong>Benefici Attesi</strong>\n            </div>\n            <p class="section-content">${a}</p>\n          </div>\n        `:""}\n        \n        ${e.image_url?`\n          <div class="post-image-container">\n            <img src="${e.image_url}" alt="${e.title||"Collaborazione"}">\n          </div>\n        `:""}\n        \n        ${e.tags&&e.tags.length>0?`\n          <div class="post-tags">\n            ${e.tags.map(e=>`<span class="post-tag">#${e}</span>`).join("")}\n          </div>\n        `:""}\n      </div>\n    `}renderEducationalExperienceContent(e){const t=e.attachments||{},s=t.experience_type||e.category||"",i=t.date||e.target_audience&&e.target_audience[0]||"",n=t.context||"",a=t.learnings||e.subject_areas&&e.subject_areas[0]||"";return`\n      <div class="post-content post-educational">\n        <h2 class="post-title">${e.title}</h2>\n        \n        ${s?`\n          <div class="experience-meta-item">\n            <i class="fas fa-bookmark"></i>\n            <strong>Tipo:</strong> <span>${s}</span>\n          </div>\n        `:""}\n        \n        ${i?`\n          <div class="experience-meta-item">\n            <i class="fas fa-calendar-alt"></i>\n            <strong>Data:</strong> <span>${i}</span>\n          </div>\n        `:""}\n        \n        ${n?`\n          <div class="experience-section">\n            <div class="section-header">\n              <i class="fas fa-info-circle"></i>\n              <strong>Contesto</strong>\n            </div>\n            <p class="section-content">${n}</p>\n          </div>\n        `:""}\n        \n        <div class="post-description">\n          <p class="post-text">${e.content||""}</p>\n        </div>\n        \n        ${a?`\n          <div class="experience-section">\n            <div class="section-header">\n              <i class="fas fa-lightbulb"></i>\n              <strong>Lezioni Apprese</strong>\n            </div>\n            <p class="section-content">${a}</p>\n          </div>\n        `:""}\n        \n        ${e.image_url?`\n          <div class="post-image-container">\n            <img src="${e.image_url}" alt="${e.title||"Esperienza Educativa"}">\n          </div>\n        `:""}\n        \n        ${e.tags&&e.tags.length>0?`\n          <div class="post-tags">\n            ${e.tags.map(e=>`<span class="post-tag">#${e}</span>`).join("")}\n          </div>\n        `:""}\n      </div>\n    `}attachPostEventListeners(e,t){const s=t.id,i=e.querySelector(".author-name");i&&t.author_id&&(i.style.cursor="pointer",i.title="Visualizza profilo",i.addEventListener("click",e=>{e.stopPropagation(),this.navigateToProfile(t.author_id)}));const n=e.querySelector(".post-type-badge");n&&(n.addEventListener("click",e=>{e.stopPropagation();const s=t.post_type;s&&this.filterByPostType(s)}),n.style.cursor="pointer",n.title="Clicca per filtrare per questo tipo"),e.querySelectorAll(".post-tag").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const s=e.textContent.replace("#","").trim();s&&this.searchByTag(s)}),e.style.cursor="pointer",e.title="Clicca per cercare questo tag"});const a=e.querySelector(".bookmark-btn");a&&a.addEventListener("click",async e=>{e.stopPropagation(),await this.toggleBookmark(s,a)});const o=e.querySelector(".post-menu-btn"),r=e.querySelector(".post-dropdown-menu");o&&r&&(o.addEventListener("click",e=>{e.stopPropagation(),this.togglePostMenu(r)}),r.querySelectorAll(".post-dropdown-item").forEach(s=>{s.addEventListener("click",i=>{i.stopPropagation();const n=s.dataset.action;this.handlePostMenuAction(n,t,e),this.closeAllPostMenus()})}));const l=e.querySelector(".like-btn");l&&l.addEventListener("click",()=>{window.eduNetSocial&&window.eduNetSocial.toggleLike(s,l)}),[e.querySelector(".comment-btn"),e.querySelector(".comments-toggle")].forEach(t=>{t&&t.addEventListener("click",()=>{this.toggleComments(s,e)})});const c=e.querySelector(".share-btn");c&&c.addEventListener("click",()=>{const e=t.title,i=window.AppConfig.getPageUrl(`post/${s}`);window.eduNetSocial&&window.eduNetSocial.showShareModal(s,e,i)});const d=e.querySelector(".comment-submit"),u=e.querySelector(".comment-input");d&&u&&(d.addEventListener("click",()=>{const t=u.value.trim();if(t&&window.eduNetSocial){const i=e.querySelector(".comments-list-container");window.eduNetSocial.addComment(s,t,i).then(()=>{u.value=""})}}),u.addEventListener("keydown",e=>{e.ctrlKey&&"Enter"===e.key&&d.click()}))}toggleComments(e,t){const s=t.querySelector(".comments-container"),i=t.querySelector(".comments-toggle"),n=i.querySelector("i"),a=t.querySelector(".comments-list-container");s.classList.contains("show")?(s.classList.remove("show"),n.className="fas fa-chevron-down",i.innerHTML='<i class="fas fa-chevron-down" aria-hidden="true"></i> Mostra commenti'):(s.classList.add("show"),n.className="fas fa-chevron-up",i.innerHTML='<i class="fas fa-chevron-up" aria-hidden="true"></i> Nascondi commenti',""===a.innerHTML&&window.eduNetSocial&&window.eduNetSocial.showComments(e,a))}formatTimeAgo(e){const t=new Date-e,s=Math.floor(t/6e4),i=Math.floor(t/36e5),n=Math.floor(t/864e5);return s<1?"Ora":s<60?`${s}m fa`:i<24?`${i}h fa`:n<7?`${n}g fa`:e.toLocaleDateString("it-IT")}showFeedLoading(){this.elements.feedLoading&&(this.elements.feedLoading.style.display="block")}hideFeedLoading(){this.elements.feedLoading&&(this.elements.feedLoading.style.display="none")}showEmptyFeed(){if(!this.elements.feedContent)return;const e=this.getEmptyStateContent(this.currentFeedType);this.elements.feedContent.innerHTML=`\n      <div class="feed-empty">\n        <div class="empty-state-icon">\n          <i class="${e.icon}" aria-hidden="true"></i>\n        </div>\n        <h3>${e.title}</h3>\n        <p>${e.message}</p>\n        ${e.action?`\n          <button class="btn btn-primary" onclick="${e.action.onclick}">\n            <i class="${e.action.icon}" aria-hidden="true"></i>\n            ${e.action.label}\n          </button>\n        `:""}\n      </div>\n    `}getEmptyStateContent(e){const t={all:{icon:"fas fa-newspaper",title:"Nessun contenuto disponibile",message:"Non ci sono ancora pubblicazioni sulla piattaforma. Torna pi√π tardi per scoprire nuovi contenuti!",action:{icon:"fas fa-compass",label:"Scopri Istituti",onclick:"if(window.eduNetHomepage) window.eduNetHomepage.switchFeedTab('discover')"}},following:{icon:"fas fa-user-friends",title:"Inizia a seguire qualcuno",message:"Non stai ancora seguendo nessun profilo. Scopri istituti interessanti e inizia a seguirli per vedere i loro contenuti qui.",action:{icon:"fas fa-compass",label:"Scopri Istituti",onclick:"if(window.eduNetHomepage) window.eduNetHomepage.switchFeedTab('discover')"}},projects:{icon:"fas fa-rocket",title:"Nessun progetto disponibile",message:"Non ci sono ancora progetti didattici pubblicati. Gli istituti possono condividere i loro progetti qui.",action:null},methodologies:{icon:"fas fa-graduation-cap",title:"Nessuna metodologia disponibile",message:"Non ci sono ancora metodologie didattiche pubblicate. Gli istituti possono condividere le loro metodologie qui.",action:null},discover:{icon:"fas fa-compass",title:"Esplora la piattaforma",message:"Usa la sezione EduMatch qui sopra per trovare istituti con cui collaborare.",action:null}};return t[e]||t.all}hideEmptyFeed(){this.elements.feedEmpty&&(this.elements.feedEmpty.style.display="none")}showFeedError(e){this.elements.feedContent&&(this.elements.feedContent.innerHTML=`\n        <div class="feed-error">\n          <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>\n          <h3>Errore di caricamento</h3>\n          <p>${e}</p>\n          <button class="btn btn-primary" onclick="window.location.reload()">\n            <i class="fas fa-refresh" aria-hidden="true"></i>\n            Ricarica pagina\n          </button>\n        </div>\n      `)}showMockDataBanner(){if(document.getElementById("mock-data-banner"))return;const e=document.createElement("div");e.id="mock-data-banner",e.className="mock-data-banner",e.innerHTML='\n      <div class="banner-content">\n        <i class="fas fa-info-circle" aria-hidden="true"></i>\n        <div class="banner-text">\n          <strong>Modalit√† Demo - Database Non Configurato</strong>\n          <p>Stai visualizzando dati di esempio. Per abilitare tutte le funzionalit√†, configura il database seguendo la guida in <code>setup-database.md</code></p>\n        </div>\n        <button class="banner-close" onclick="this.parentElement.parentElement.remove()">\n          <i class="fas fa-times" aria-hidden="true"></i>\n        </button>\n      </div>\n    ',this.elements.feedContent&&this.elements.feedContent.insertBefore(e,this.elements.feedContent.firstChild)}setupInfiniteScrollObserver(){this.intersectionObserver&&this.elements.loadMoreBtn&&this.intersectionObserver.observe(this.elements.loadMoreBtn)}updateLoadMoreButton(){const e=document.getElementById("load-more-section");e&&(e.style.display=this.hasMoreContent?"block":"none")}async loadMoreContent(){!this.isLoading&&this.hasMoreContent&&(this.currentPage++,await this.loadFeedContent())}async switchFeedTab(e){if(this.isLoading&&this.currentFeedType===e)return;this.currentFeedType=e,this.elements.feedContent&&this.elements.feedContent.classList.add("loading"),this.elements.feedTabs.forEach(t=>{const s=t.dataset.feed===e;t.classList.toggle("active",s),t.setAttribute("aria-selected",s?"true":"false")});const t="projects"===e||"methodologies"===e?e:"all";this.elements.filterChips.forEach(e=>{e.classList.toggle("active",e.dataset.filter===t)}),this.resetAdvancedFilters(!1),await this.loadInitialData(),this.elements.feedContent&&this.elements.feedContent.classList.remove("loading")}applyFilters(){const e=this.getActiveFilters();this.showFeedLoading(),setTimeout(()=>{this.filterFeedContent(e),this.hideFeedLoading(),this.updateFilterIndicators(e);const t=this.countActiveFilters(e);t>0&&this.showNotification(`Filtri applicati: ${t} attivi`,"success")},300)}getActiveFilters(){return{content:this.elements.contentFilter?.value||"all",instituteType:this.elements.instituteTypeFilter?.value||"all",date:this.elements.dateFilter?.value||"all",sort:this.elements.sortFilter?.value||"recent",engagement:this.elements.engagementFilter?.value||"all",quickFilter:document.querySelector(".filter-chip.active")?.dataset.filter||"all"}}filterFeedContent(e){this.loadFeedContent(e)}countActiveFilters(e){let t=0;return"all"!==e.content&&t++,"all"!==e.instituteType&&t++,"all"!==e.date&&t++,"recent"!==e.sort&&t++,"all"!==e.engagement&&t++,"all"!==e.quickFilter&&t++,t}updateFilterIndicators(e){const t=this.countActiveFilters(e),s=this.elements.advancedFiltersToggle;s&&(t>0?(s.classList.add("has-active-filters"),s.querySelector("span").textContent=`Filtri Avanzati (${t})`):(s.classList.remove("has-active-filters"),s.querySelector("span").textContent="Filtri Avanzati"))}handleFilterChipClick(e){this.elements.filterChips.forEach(e=>{e.classList.remove("active")}),e.classList.add("active");const t=e.dataset.filter;"projects"===t||"methodologies"===t?this.switchFeedTab(t):"all"===t?this.switchFeedTab("all"):this.applyQuickFilter(t)}applyQuickFilter(e){switch(this.resetAdvancedFilters(!1),e){case"all":break;case"projects":this.elements.contentFilter&&(this.elements.contentFilter.value="project");break;case"methodologies":this.elements.contentFilter&&(this.elements.contentFilter.value="methodology");break;case"recent":this.elements.sortFilter&&(this.elements.sortFilter.value="recent"),this.elements.dateFilter&&(this.elements.dateFilter.value="week");break;case"popular":this.elements.sortFilter&&(this.elements.sortFilter.value="popular"),this.elements.engagementFilter&&(this.elements.engagementFilter.value="high")}this.applyFilters()}toggleAdvancedFilters(){const e=this.elements.advancedFiltersToggle,t=this.elements.advancedFiltersPanel;e&&t&&(e.classList.contains("active")?(e.classList.remove("active"),t.classList.remove("show")):(e.classList.add("active"),t.classList.add("show")))}resetFilters(){this.elements.contentFilter&&(this.elements.contentFilter.value="all"),this.elements.instituteTypeFilter&&(this.elements.instituteTypeFilter.value="all"),this.elements.dateFilter&&(this.elements.dateFilter.value="all"),this.elements.sortFilter&&(this.elements.sortFilter.value="recent"),this.elements.engagementFilter&&(this.elements.engagementFilter.value="all"),this.elements.filterChips.forEach(e=>{e.classList.remove("active"),"all"===e.dataset.filter&&e.classList.add("active")}),this.applyFilters(),this.showNotification("Filtri ripristinati","info")}resetAdvancedFilters(e=!0){this.elements.contentFilter&&(this.elements.contentFilter.value="all"),this.elements.instituteTypeFilter&&(this.elements.instituteTypeFilter.value="all"),this.elements.dateFilter&&(this.elements.dateFilter.value="all"),this.elements.sortFilter&&(this.elements.sortFilter.value="recent"),this.elements.engagementFilter&&(this.elements.engagementFilter.value="all"),e&&this.showNotification("Filtri avanzati ripristinati","info")}handleSearch(e){if(clearTimeout(this.searchTimer),""===e.trim())return this.hideSearchResults(),void this.hideSearchClear();this.showSearchClear(),this.searchTimer=setTimeout(()=>{this.performSearch(e)},300)}async performSearch(e){try{console.log("Searching for:",e);const t=[];if(window.eduNetProfileManager)try{console.log("Searching profiles with ProfileManager...");const s=await window.eduNetProfileManager.searchProfiles(e);if(console.log("Profile search results:",s),s&&s.length>0)for(const i of s){let s=!1,n=!1;if(window.supabaseClientManager){const t=await window.supabaseClientManager.getClient(),{data:a}=await t.from("user_privacy_settings").select("profile_visibility, searchable_by_email").eq("user_id",i.id).single();a&&("private"===a.profile_visibility&&(s=!0),!1===a.searchable_by_email&&e.includes("@")&&(n=!0))}if(s||n)continue;let a=null;if(window.avatarManager&&(a=await window.avatarManager.loadUserAvatar(i.id)),"istituto"===i.user_type&&i.school_institutes){let e=!0;if(window.miurValidator){const t=await window.miurValidator.validateInstitute({instituteName:i.school_institutes.institute_name,instituteCode:i.school_institutes.institute_code});!t.isValid&&t.confidence<.3&&(console.log("üö´ Istituto filtrato (non valido MIUR):",i.school_institutes.institute_name),e=!1)}e&&t.push({type:"institute",name:i.school_institutes.institute_name,location:i.school_institutes.city||"Posizione non specificata",id:i.id,avatarUrl:a})}else"privato"===i.user_type&&i.private_users&&console.log("üîí Utente privato escluso dalla ricerca per privacy")}}catch(e){console.error("Error searching profiles:",e)}else console.warn("ProfileManager not available");if(window.supabaseClientManager)try{console.log("Searching posts with Supabase...");const s=await window.supabaseClientManager.getClient();if(s){const{data:i,error:n}=await s.from("institute_posts").select("id, title, content, post_type, institute_id, tags").or(`title.ilike.%${e}%, content.ilike.%${e}%`).eq("published",!0).order("created_at",{ascending:!1}).limit(10);console.log("Post search results:",i,"Error:",n);let a=[];if(!n){const{data:t,error:i}=await s.from("institute_posts").select("id, title, content, post_type, institute_id, tags").contains("tags",[e.toLowerCase()]).eq("published",!0).order("created_at",{ascending:!1}).limit(10);!i&&t&&(a=t)}const o=[...i||[],...a],r=Array.from(new Map(o.map(e=>[e.id,e])).values());if(r.length>0)for(const e of r){let i="Autore sconosciuto",n=null;try{const{data:t,error:a}=await s.from("school_institutes").select("institute_name").eq("id",e.institute_id).maybeSingle();!a&&t&&(i=t.institute_name),window.avatarManager&&(n=await window.avatarManager.loadUserAvatar(e.institute_id))}catch(t){console.warn("Could not fetch author for post:",e.id)}const a=this.getPostTypeInfo(e.post_type);t.push({type:"post",post_type:e.post_type,author_id:e.institute_id,authorId:e.institute_id,avatarUrl:n,badge:a.label,badgeIcon:a.icon,badgeClass:a.class,title:e.title,author:i,tags:e.tags||[],id:e.id})}else n&&console.error("Supabase posts query error:",n)}}catch(e){console.error("Error searching posts:",e)}else console.warn("SupabaseClientManager not available");console.log("Final search results:",t),this.displaySearchResults(t)}catch(e){console.error("Search error:",e),this.displaySearchResults([])}}displaySearchResults(e){this.elements.searchResults&&(0===e.length?this.elements.searchResults.innerHTML='\n        <div class="search-no-results">\n          <i class="fas fa-database" aria-hidden="true"></i>\n          <p>Nessun risultato trovato nel database</p>\n          <small>Assicurati che il database Supabase sia configurato correttamente</small>\n        </div>\n      ':(this.elements.searchResults.innerHTML=e.map(e=>{const t="post"===e.type?e.authorId:e.id,s=e.avatarUrl?`<img src="${e.avatarUrl}" alt="Avatar" class="search-result-avatar" data-user-id="${t}">`:`<div class="search-result-avatar search-result-avatar-default" data-user-id="${t}">\n               <i class="fas fa-${"institute"===e.type?"school":"user"===e.type?"user":"school"}"></i>\n             </div>`;return"post"===e.type?`\n            <div class="search-result-item" data-id="${e.id||""}" data-type="${e.type}" data-post-type="${e.post_type||""}">\n              ${s}\n              <div class="search-result-main">\n                <div class="search-result-header" style="display: flex; justify-content: space-between; align-items: center;">\n                  <span class="result-author" style="margin: 0; font-weight: 600; color: var(--color-gray-700); font-size: 0.85rem;">${e.author}</span>\n                  <span class="search-badge ${e.badgeClass||""}" style="font-size: 0.7rem; padding: 0.25rem 0.6rem;">\n                    <i class="${e.badgeIcon||"fas fa-file-alt"}"></i>\n                    ${e.badge||"Post"}\n                  </span>\n                </div>\n                <div class="result-content" style="margin-top: 0.25rem;">\n                  <h4 style="margin-bottom: 0.25rem;">${e.title}</h4>\n                  ${e.tags&&e.tags.length>0?`\n                    <div class="result-tags">\n                      ${e.tags.slice(0,3).map(e=>`<span class="result-tag">#${e}</span>`).join("")}\n                      ${e.tags.length>3?`<span class="result-tag-more">+${e.tags.length-3}</span>`:""}\n                    </div>\n                  `:""}\n                </div>\n              </div>\n            </div>\n          `:`\n            <div class="search-result-item" data-id="${e.id||""}" data-type="${e.type}">\n              ${s}\n              <div class="result-content">\n                <h4>${e.name||e.title}</h4>\n                <p>${e.location||e.author||e.category}</p>\n              </div>\n            </div>\n          `}).join(""),this.elements.searchResults.querySelectorAll(".search-result-item").forEach(e=>{e.addEventListener("click",t=>{const s=e.dataset.type,i=e.dataset.id,n=e.dataset.postType;console.log("Clicked search result:",s,i,n),"institute"===s?(console.log("Navigating to institute profile:",i),this.navigateToProfile(i)):"user"===s?(console.log("Navigating to user profile:",i),this.navigateToProfile(i)):"post"===s&&this.navigateToPost(i),this.hideSearchResults(),this.clearSearch()});const t=e.querySelector(".search-badge");t&&t.addEventListener("click",t=>{t.stopPropagation();const s=e.dataset.postType;s&&(this.filterByPostType(s),this.hideSearchResults(),this.clearSearch())})})),this.showSearchResults())}async searchByTag(e){console.log("Searching by tag:",e),this.elements.searchInput&&(this.elements.searchInput.value=e),await this.performSearch(e),this.showSearchResults()}async filterByPostType(e){console.log("Filtering by post type:",e);try{if(!window.supabaseClientManager)return;const t=await window.supabaseClientManager.getClient();if(!t)return;this.showLoadingState();const{data:s,error:i}=await t.from("institute_posts").select("*").eq("published",!0).eq("post_type",e).order("created_at",{ascending:!1}).limit(20);if(i)return console.error("Error filtering posts:",i),void this.showNotification("Errore durante il filtro","error");if(!s||0===s.length){this.showEmptyFeed();const t={notizia:"Post",progetto:"Progetti",metodologia:"Metodologie",evento:"Gallerie"};return void this.showNotification(`Nessun ${t[e]||"contenuto"} trovato`,"info")}const n=s.map(e=>({...e,author_id:e.institute_id,is_published:e.published})),a=await Promise.all(n.map(async e=>{let s="Utente";try{const{data:i}=await t.from("school_institutes").select("institute_name").eq("id",e.institute_id).maybeSingle();i&&(s=i.institute_name)}catch(t){console.warn("Could not fetch author for post:",e.id)}return{id:e.id,title:e.title,content:e.content,author:s,author_id:e.institute_id,created_at:new Date(e.created_at),likes:e.likes_count||0,comments:e.comments_count||0,post_type:e.post_type,category:e.category,tags:e.tags||[],target_audience:e.target_audience,subject_areas:e.subject_areas||[],image_urls:e.image_urls||[],image_url:e.image_url}}));this.feedData=a,this.renderFeed();const o={notizia:"Post",progetto:"Progetti",metodologia:"Metodologie",evento:"Gallerie"};this.showNotification(`Filtro applicato: ${o[e]||e}`,"success")}catch(e){console.error("Error in filterByPostType:",e),this.showNotification("Errore durante il filtro","error")}}getSearchIcon(e){return{institute:"school",user:"user",post:"file-alt",methodology:"book-open",project:"lightbulb"}[e]||"search"}showSearchResults(){this.elements.searchResults&&(this.elements.searchResults.style.display="block")}hideSearchResults(){this.elements.searchResults&&(this.elements.searchResults.style.display="none")}showSearchClear(){this.elements.searchClear&&(this.elements.searchClear.style.display="block")}hideSearchClear(){this.elements.searchClear&&(this.elements.searchClear.style.display="none")}navigateToPost(e){try{const t=document.querySelector(`[data-post-id="${e}"]`);t?(t.scrollIntoView({behavior:"smooth",block:"center"}),t.classList.add("post-highlighted"),setTimeout(()=>{t.classList.remove("post-highlighted")},3e3),this.showNotification("Post trovato nel feed","success")):(this.switchFeedTab("all"),this.showNotification("Caricamento post...","info"),setTimeout(()=>{const t=document.querySelector(`[data-post-id="${e}"]`);t?(t.scrollIntoView({behavior:"smooth",block:"center"}),t.classList.add("post-highlighted"),setTimeout(()=>{t.classList.remove("post-highlighted")},3e3)):this.showNotification("Post non trovato nel feed corrente","warning")},1e3))}catch(e){console.error("Error navigating to post:",e),this.showNotification("Errore nella navigazione al post","error")}}clearSearch(){this.elements.searchInput&&(this.elements.searchInput.value=""),this.hideSearchResults(),this.hideSearchClear()}toggleDropdown(e){const t=e.classList.contains("open");this.closeAllDropdowns(),t||e.classList.add("open")}closeAllDropdowns(){document.querySelectorAll(".nav-item.open").forEach(e=>{e.classList.remove("open")})}toggleMobileMenu(){this.elements.mobileMenuToggle&&this.elements.mobileMenuOverlay&&(this.elements.mobileMenuToggle.classList.toggle("active"),this.elements.mobileMenuOverlay.classList.toggle("show"),this.elements.mobileMenuOverlay.classList.contains("show")?(document.body.style.overflow="hidden",this.updateMobileUserInfo()):document.body.style.overflow="")}updateMobileUserInfo(){this.currentUser&&(this.elements.mobileUserName&&(this.elements.mobileUserName.textContent=this.getDisplayName()),this.elements.mobileUserType&&(this.elements.mobileUserType.textContent=this.getUserTypeDisplay()),this.elements.mobileUserAvatar)}switchSection(e){console.log("Switching to section:",e),this.elements.mobileNavItems.forEach(t=>{t.classList.toggle("active",t.dataset.section===e)}),document.querySelectorAll(".sidebar-nav .nav-link").forEach(t=>{t.classList.toggle("active",t.dataset.section===e)}),"saved"===e?window.savedPostsManager&&window.savedPostsManager.showSavedPosts():window.savedPostsManager&&window.savedPostsManager.hideSavedPosts()}openCreatePostModal(e="post"){console.log("Opening create post modal for type:",e),this.handlePostActionClick("post"===e?"text":e)}handleLike(e){console.log("Liking post:",e)}handleComment(e){console.log("Commenting on post:",e)}handleShare(e){console.log("Sharing post:",e)}async handleLogout(){try{window.eduNetAuth&&await window.eduNetAuth.logout(),window.location.href=window.AppConfig.getPageUrl("index.html")}catch(e){console.error("Logout error:",e)}}async loadFavorites(){console.log("Loading favorites...")}async loadRecentActivity(){try{if(!window.eduNetSocial||!window.eduNetSocial.supabase)return void console.log("Social features not available yet");const e=document.getElementById("recent-activity");if(!e)return;e.innerHTML='\n        <div class="activity-loading">\n          <i class="fas fa-spinner fa-spin"></i>\n          <p>Caricamento attivit√†...</p>\n        </div>\n      ',console.log("Attempting to fetch user activities...");try{const{data:t,error:s}=await window.eduNetSocial.supabase.from("user_activities").select("*").eq("user_id",this.currentUser?.id).order("created_at",{ascending:!1}).limit(10);if(s){if("PGRST205"===s.code||"PGRST116"===s.code||s.message.includes("404")||s.message.includes("Could not find the table"))return console.log("User activities table not found, showing empty state"),void(e.innerHTML='\n              <div class="no-activity">\n                <i class="fas fa-clock"></i>\n                <p>Nessuna attivit√† recente</p>\n                <small>Le attivit√† appariranno qui quando interagirai con i post</small>\n              </div>\n            ');throw new Error("DATABASE_ERROR")}console.log(`Fetched ${t?.length||0} activities`);const i=await Promise.all((t||[]).map(async e=>{try{if("post"===e.target_type&&e.target_id){const{data:t}=await window.eduNetSocial.supabase.from("institute_posts").select("title").eq("id",e.target_id).maybeSingle();return{...e,post_title:t?.title||"Post eliminato"}}return e}catch(t){return e}}));this.renderRecentActivity(i,e)}catch(t){t.message,e.innerHTML='\n          <div class="no-activity">\n            <i class="fas fa-clock"></i>\n            <p>Nessuna attivit√† recente</p>\n            <small>Le attivit√† appariranno qui quando interagirai con i post</small>\n          </div>\n        '}}catch(e){const t=document.getElementById("recent-activity");t&&(t.innerHTML='\n          <div class="no-activity">\n            <i class="fas fa-clock"></i>\n            <p>Nessuna attivit√† recente</p>\n            <small>Le attivit√† appariranno qui quando interagirai con i post</small>\n          </div>\n        ')}}renderRecentActivity(e,t){if(!e||0===e.length)return void(t.innerHTML='\n        <div class="no-activity">\n          <i class="fas fa-clock"></i>\n          <p>Nessuna attivit√† recente</p>\n          <small>Le attivit√† appariranno qui quando interagirai con i post</small>\n        </div>\n      ');const s=e.length,i=e.slice(0,5),n=Math.max(0,s-5),a=i.map(e=>`\n        <div class="activity-item">\n          <div class="activity-icon">\n            <i class="${this.getActivityIcon(e.activity_type)}"></i>\n          </div>\n          <div class="activity-content">\n            <p class="activity-text">${this.getActivityText(e)}</p>\n            <span class="activity-time">${this.formatTimeAgo(new Date(e.created_at))}</span>\n          </div>\n        </div>\n      `).join(""),o=e.slice(5).map(e=>`\n        <div class="activity-item">\n          <div class="activity-icon">\n            <i class="${this.getActivityIcon(e.activity_type)}"></i>\n          </div>\n          <div class="activity-content">\n            <p class="activity-text">${this.getActivityText(e)}</p>\n            <span class="activity-time">${this.formatTimeAgo(new Date(e.created_at))}</span>\n          </div>\n        </div>\n      `).join("");if(t.innerHTML=`\n      <div class="activity-list">\n        ${a}\n        ${n>0?`\n          <div class="activity-hidden" id="activity-hidden" style="display: none;">\n            ${o}\n          </div>\n          <button class="activity-show-all" id="activity-show-all-btn" aria-label="Mostra tutte le attivit√†">\n            <span>Vedi tutte</span>\n            <span class="activity-count-badge">${s}</span>\n            <i class="fas fa-chevron-down"></i>\n          </button>\n        `:""}\n      </div>\n    `,n>0){const e=t.querySelector("#activity-show-all-btn"),i=t.querySelector("#activity-hidden");e&&i&&e.addEventListener("click",()=>{"none"!==i.style.display?(i.style.display="none",e.innerHTML=`\n              <span>Vedi tutte</span>\n              <span class="activity-count-badge">${s}</span>\n              <i class="fas fa-chevron-down"></i>\n            `):(i.style.display="block",e.innerHTML=`\n              <span>Mostra meno</span>\n              <span class="activity-count-badge">${s}</span>\n              <i class="fas fa-chevron-up"></i>\n            `)})}}getActivityIcon(e){return{like:"fas fa-heart",unlike:"far fa-heart",comment:"fas fa-comment",share:"fas fa-share",share_post:"fas fa-share-alt",post_created:"fas fa-plus-circle",post_updated:"fas fa-edit",save_post:"fas fa-bookmark",unsave_post:"far fa-bookmark",mute_user:"fas fa-volume-mute",hide_post:"far fa-eye-slash",report_post:"fas fa-flag",delete_post:"fas fa-trash-alt"}[e]||"fas fa-circle"}getActivityText(e){const t=e.post_title||"un post";switch(e.activity_type){case"like":return`Hai messo like a "${t}"`;case"unlike":return`Hai rimosso il like da "${t}"`;case"comment":return`Hai commentato "${t}"`;case"share":return`Hai condiviso "${t}" su ${e.metadata?.platform||"una piattaforma"}`;case"share_post":return`Hai condiviso "${t}"`;case"post_created":return`Hai creato il post "${t}"`;case"post_updated":return`Hai aggiornato il post "${t}"`;case"save_post":return`Hai salvato "${t}" nei preferiti`;case"unsave_post":return`Hai rimosso "${t}" dai salvati`;case"mute_user":return"Hai silenziato un autore";case"hide_post":return`Hai nascosto "${t}"`;case"report_post":return`Hai segnalato "${t}"`;case"delete_post":return`Hai eliminato "${t}"`;default:return`Attivit√† su "${t}"`}}async loadTrendingTopics(){console.log("Loading trending topics...");const e=document.getElementById("trending-topics-discover");if(e)try{const t=window.eduNetSocial?.supabase;if(!t)return void console.warn("Supabase not available for trending topics");const{data:s,error:i}=await t.from("institute_posts").select("tags").eq("published",!0).not("tags","is",null).limit(100);if(i)throw i;const n={};s?.forEach(e=>{e.tags&&Array.isArray(e.tags)&&e.tags.forEach(e=>{n[e]=(n[e]||0)+1})});const a=Object.entries(n).sort((e,t)=>t[1]-e[1]).slice(0,8).map(([e,t])=>({tag:e,count:t}));a.length>0?(e.innerHTML=a.map(({tag:e,count:t})=>`\n          <div class="trending-topic" data-tag="${e}">\n            <span class="topic-name">#${e}</span>\n            <span class="topic-count">${t} post</span>\n          </div>\n        `).join(""),e.querySelectorAll(".trending-topic").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.tag;this.elements.searchInput&&(this.elements.searchInput.value=t,this.performSearch(t))})})):e.innerHTML='\n          <div class="no-trends">\n            <i class="fas fa-chart-line"></i>\n            <p>Nessun trend disponibile</p>\n          </div>\n        '}catch(t){console.error("Error loading trending topics:",t),e.innerHTML='\n        <div class="no-trends">\n          <i class="fas fa-exclamation-circle"></i>\n          <p>Errore nel caricamento</p>\n        </div>\n      '}}async loadSuggestedInstitutes(){console.log("Loading suggested institutes...");const e=document.getElementById("suggested-institutes-discover");if(e)try{const t=window.eduNetSocial?.supabase;if(!t)return void console.warn("Supabase not available for suggested institutes");const{data:s,error:i}=await t.from("school_institutes").select("id, institute_name, institute_type, city").limit(5);if(i)throw i;if(s&&s.length>0){const t=await Promise.all(s.map(async e=>{let t=null;if(window.avatarManager)try{t=await window.avatarManager.loadUserAvatar(e.id)}catch(t){console.warn("Could not load avatar for:",e.id)}const s=t?`<img src="${t}" alt="${e.institute_name}">`:'<div class="institute-avatar-default"><i class="fas fa-school"></i></div>';return`\n            <div class="suggested-institute" data-id="${e.id}">\n              <div class="institute-avatar">${s}</div>\n              <div class="institute-info">\n                <h4>${e.institute_name}</h4>\n                <p>${e.institute_type||"Istituto"} ‚Ä¢ ${e.city||"Italia"}</p>\n              </div>\n              <button class="btn-follow" data-id="${e.id}">\n                <i class="fas fa-plus"></i>\n                Segui\n              </button>\n            </div>\n          `}));e.innerHTML=t.join(""),e.querySelectorAll(".suggested-institute").forEach(e=>{e.addEventListener("click",t=>{if(!t.target.closest(".btn-follow")){const t=e.dataset.id;window.location.href=window.AppConfig.getPageUrl(`pages/profile/profile.html?id=${t}`)}})}),e.querySelectorAll(".btn-follow").forEach(e=>{e.addEventListener("click",async t=>{t.stopPropagation(),e.dataset.id,e.innerHTML='<i class="fas fa-check"></i> Seguito',e.classList.add("following"),e.disabled=!0})})}else e.innerHTML='\n          <div class="no-suggestions">\n            <i class="fas fa-lightbulb"></i>\n            <p>Nessun suggerimento disponibile</p>\n          </div>\n        '}catch(t){console.error("Error loading suggested institutes:",t),e.innerHTML='\n        <div class="no-suggestions">\n          <i class="fas fa-exclamation-circle"></i>\n          <p>Errore nel caricamento</p>\n        </div>\n      '}}async loadInstituteStatistics(){try{if(!window.eduNetSocial||!window.eduNetSocial.supabase)return void console.log("Social features not available for statistics");console.log("Loading institute statistics...");let e={posts:0,likes:0,comments:0,shares:0};try{const{count:t,error:s}=await window.eduNetSocial.supabase.from("posts").select("*",{count:"exact",head:!0}).eq("is_published",!0);s||(e.posts=t||0);const{count:i,error:n}=await window.eduNetSocial.supabase.from("post_likes").select("*",{count:"exact",head:!0});n||(e.likes=i||0);const{count:a,error:o}=await window.eduNetSocial.supabase.from("post_comments").select("*",{count:"exact",head:!0});o||(e.comments=a||0);const{count:r,error:l}=await window.eduNetSocial.supabase.from("post_shares").select("*",{count:"exact",head:!0});l||(e.shares=r||0),console.log("Dynamic statistics loaded:",e)}catch(t){console.log("Error fetching dynamic statistics, using fallback values"),e={posts:9,likes:5,comments:0,shares:0}}console.log("Statistics updated:",e),this.updateStatisticsDisplay(e)}catch(e){console.log("Error loading statistics:",e.message),this.updateStatisticsDisplay({posts:0,likes:0,comments:0,shares:0})}}updateStatisticsDisplay(e){const t=document.getElementById("posts-count");t&&(t.textContent=this.formatNumber(e.posts));const s=document.getElementById("views-count");if(s){const t=e.likes+e.comments+e.shares;s.textContent=this.formatNumber(t)}const i=document.getElementById("rating-average");if(i){const t=e.posts>0?(e.likes+e.comments)/e.posts:0,s=Math.min(5,Math.max(0,t/10));i.textContent=s.toFixed(1)}console.log("üìä Statistics updated:",e)}formatNumber(e){return e>=1e6?(e/1e6).toFixed(1)+"M":e>=1e3?(e/1e3).toFixed(1)+"K":e.toString()}handleResize(){window.innerWidth<1024&&this.closeAllDropdowns()}handleScroll(){const e=window.scrollY,t=document.querySelector(".top-nav");t&&t.classList.toggle("scrolled",e>10)}handleKeydown(e){"Escape"===e.key&&(this.closeAllDropdowns(),this.hideSearchResults()),(e.ctrlKey||e.metaKey)&&"k"===e.key&&(e.preventDefault(),this.elements.searchInput&&this.elements.searchInput.focus())}togglePostMenu(e){const t=e.classList.contains("show");if(this.closeAllPostMenus(),!t){e.classList.add("show");const t=e.closest(".post-card");t&&t.classList.add("menu-open"),window.innerWidth<=768&&this.showPostMenuOverlay()}}showPostMenuOverlay(){let e=document.querySelector(".post-dropdown-overlay");e||(e=document.createElement("div"),e.className="post-dropdown-overlay",document.body.appendChild(e),e.addEventListener("click",()=>this.closeAllPostMenus())),e.offsetHeight,e.classList.add("show")}hidePostMenuOverlay(){const e=document.querySelector(".post-dropdown-overlay");e&&e.classList.remove("show")}closeAllPostMenus(){document.querySelectorAll(".post-dropdown-menu.show").forEach(e=>{e.classList.remove("show");const t=e.closest(".post-card");t&&t.classList.remove("menu-open")}),this.hidePostMenuOverlay()}async handlePostMenuAction(e,t,s){switch(console.log("Post menu action:",e,t),e){case"copy-link":const i=window.AppConfig.getPageUrl(`post/${t.id}`);await navigator.clipboard.writeText(i),this.showNotification("üîó Link copiato negli appunti","success");break;case"share":const n=window.AppConfig.getPageUrl(`post/${t.id}`);if(navigator.share)try{await navigator.share({title:t.title,text:t.content.substring(0,100)+"...",url:n}),this.showNotification("‚úÖ Contenuto condiviso","success")}catch(e){"AbortError"!==e.name&&console.error("Share error:",e)}else await navigator.clipboard.writeText(n),this.showNotification("üîó Link copiato per condividere","success");break;case"mute-author":await this.muteAuthor(t.author_id),this.showNotification(`üîï Non vedrai pi√π post di ${t.author}`,"info");break;case"hide-post":s.style.display="none",await this.hidePost(t.id),this.showNotification("‚úÖ Post nascosto","success");break;case"report":window.contentReportManager?window.contentReportManager.open("post",t.id,t.author_id):(await this.reportPost(t.id),this.showNotification("üì¢ Segnalazione inviata. Grazie per aiutarci a mantenere la community sicura","success"));break;case"edit":this.showNotification("‚úèÔ∏è Modifica post - Funzionalit√† in sviluppo","info");break;case"delete":confirm("Sei sicuro di voler eliminare questo post? L'azione non pu√≤ essere annullata.")&&(await this.deletePost(t.id),s.remove(),this.showNotification("üóëÔ∏è Post eliminato","success"));break;default:console.warn("Unknown action:",e)}}async toggleBookmark(e,t){try{const s=t.querySelector("i"),i=s.classList.contains("fas");t.style.transform="scale(0.8)",setTimeout(()=>{t.style.transform=""},200),i?(await this.unsavePost(e),s.classList.remove("fas"),s.classList.add("far"),t.classList.remove("saved"),t.setAttribute("aria-label","Salva post"),t.setAttribute("title","Salva post"),this.showNotification("üìë Post rimosso dai salvati","info"),window.savedPostsManager&&await window.savedPostsManager.updateSavedCount()):(await this.savePost(e),s.classList.remove("far"),s.classList.add("fas"),t.classList.add("saved"),t.setAttribute("aria-label","Rimuovi dai salvati"),t.setAttribute("title","Rimuovi dai salvati"),this.showNotification("üíæ Post salvato nei preferiti","success"),window.savedPostsManager&&await window.savedPostsManager.updateSavedCount())}catch(e){console.error("Error toggling bookmark:",e),this.showNotification("‚ùå Errore durante il salvataggio","error")}}async updateSavedPostsIndicators(){try{if(!window.supabaseClientManager?.client)return;const e=await window.supabaseClientManager.getClient(),{data:{user:t}}=await e.auth.getUser();if(!t)return;const{data:s,error:i}=await e.from("saved_posts").select("post_id").eq("user_id",t.id);if(i)return void console.error("Error fetching saved posts:",i);const n=new Set(s.map(e=>e.post_id));document.querySelectorAll(".post-card").forEach(e=>{const t=e.dataset.postId,s=e.querySelector(".bookmark-btn"),i=s?.querySelector("i");s&&i&&(n.has(t)?(i.classList.remove("far"),i.classList.add("fas"),s.classList.add("saved"),s.setAttribute("aria-label","Rimuovi dai salvati"),s.setAttribute("title","Rimuovi dai salvati")):(i.classList.remove("fas"),i.classList.add("far"),s.classList.remove("saved"),s.setAttribute("aria-label","Salva post"),s.setAttribute("title","Salva post")))})}catch(e){console.error("Error updating saved posts indicators:",e)}}async savePost(e){try{if(!window.supabaseClientManager?.client)return void console.log("Demo mode: savePost",e);if(!e)return console.warn("‚ö†Ô∏è ID post mancante"),void this.showNotification("‚ö†Ô∏è Errore: ID post non valido","warning");const t=await window.supabaseClientManager.getClient(),{data:{user:s}}=await t.auth.getUser();if(!s)throw new Error("User not authenticated");console.log("üíæ Attempting to save post:",e);const{data:i,error:n}=await t.from("institute_posts").select("id").eq("id",e).maybeSingle();if(n)return console.error("‚ùå Error checking post existence:",n),void this.showNotification("Errore nella verifica del post","error");if(!i)return console.warn("‚ùå Post not found in institute_posts:",e),void this.showNotification("‚ö†Ô∏è Post non trovato nel database","warning");console.log("‚úÖ Post exists in database, proceeding to save");const{data:a}=await t.from("saved_posts").select("id").eq("user_id",s.id).eq("post_id",e).maybeSingle();if(a)return console.log("Post already saved"),void this.showNotification("üìå Post gi√† salvato","info");const{error:o}=await t.from("saved_posts").insert({user_id:s.id,post_id:e});if(o&&"23505"!==o.code)throw o;await this.trackActivity("save_post",e)}catch(e){throw console.error("Error saving post:",e),e}}async unsavePost(e){try{if(!window.supabaseClientManager?.client)return void console.log("Demo mode: unsavePost",e);if(!e)return void console.warn("‚ö†Ô∏è ID post mancante");const t=await window.supabaseClientManager.getClient(),{data:{user:s}}=await t.auth.getUser();if(!s)throw new Error("User not authenticated");console.log("üóëÔ∏è Removing post from saved:",e);const{error:i}=await t.from("saved_posts").delete().eq("user_id",s.id).eq("post_id",e);if(i)throw i;console.log("‚úÖ Post removed from saved"),await this.trackActivity("unsave_post",e)}catch(e){throw console.error("Error removing saved post:",e),e}}async muteAuthor(e){try{if(!window.supabaseClientManager?.client)return void console.log("Demo mode: muteAuthor",e);const t=await window.supabaseClientManager.getClient(),{data:{user:s}}=await t.auth.getUser();if(!s)throw new Error("User not authenticated");const{error:i}=await t.from("muted_users").insert({user_id:s.id,muted_user_id:e});if(i&&"23505"!==i.code)throw i;await this.trackActivity("mute_user",e)}catch(e){throw console.error("Error muting author:",e),e}}async hidePost(e){try{if(!window.supabaseClientManager?.client)return void console.log("Demo mode: hidePost",e);const t=await window.supabaseClientManager.getClient(),{data:{user:s}}=await t.auth.getUser();if(!s)throw new Error("User not authenticated");const{error:i}=await t.from("hidden_posts").insert({user_id:s.id,post_id:e});if(i&&"23505"!==i.code)throw i;await this.trackActivity("hide_post",e)}catch(e){throw console.error("Error hiding post:",e),e}}async reportPost(e){try{if(!window.supabaseClientManager?.client)return void console.log("Demo mode: reportPost",e);const t=await window.supabaseClientManager.getClient(),{data:{user:s}}=await t.auth.getUser();if(!s)throw new Error("User not authenticated");const{error:i}=await t.from("content_reports").insert({reporter_id:s.id,reported_content_type:"post",reported_content_id:e,reason:"user_report",status:"pending"});if(i)throw i;await this.trackActivity("report_post",e)}catch(e){throw console.error("Error reporting post:",e),e}}async deletePost(e){try{if(!window.supabaseClientManager?.client)return void console.log("Demo mode: deletePost",e);const t=await window.supabaseClientManager.getClient(),{data:{user:s}}=await t.auth.getUser();if(!s)throw new Error("User not authenticated");const{error:i}=await t.from("institute_posts").delete().eq("id",e).eq("institute_id",s.id);if(i)throw console.error("Error deleting post:",i),i;console.log(`Post ${e} deleted successfully`),await this.trackActivity("delete_post",e)}catch(e){throw console.error("Error deleting post:",e),e}}async trackActivity(e,t){try{if(!window.supabaseClientManager?.client)return;const s=await window.supabaseClientManager.getClient(),{data:{user:i}}=await s.auth.getUser();if(!i)return;const{error:n}=await s.from("user_activities").insert({user_id:i.id,activity_type:e,target_type:"post",target_id:t});n&&"PGRST116"!==n.code&&console.log("Activity tracking error:",n.message)}catch(e){console.log("Activity tracking failed:",e.message)}}navigateToProfile(e){e?(console.log("Navigating to profile:",e),window.location.href=window.AppConfig.getPageUrl(`pages/profile/profile.html?id=${e}`)):console.warn("No user ID provided for profile navigation")}handleClick(e){const t=e.target;t.closest(".nav-search")||this.hideSearchResults(),t.closest(".post-actions")||this.closeAllPostMenus()}checkScrollToPost(){let e=sessionStorage.getItem("scrollToPost");if(e&&sessionStorage.removeItem("scrollToPost"),!e){const t=window.location.hash;if(t){const s=t.match(/^#post[-\/](.+)$/);s&&(e=s[1],history.replaceState(null,"",window.location.pathname+window.location.search))}}e&&(console.log("üìå Scroll-to-post requested:",e),setTimeout(()=>{this.navigateToPost(e)},1200))}hideLoadingScreen(){this.elements.loadingScreen&&(this.elements.loadingScreen.classList.add("hidden"),setTimeout(()=>{this.elements.loadingScreen.style.display="none"},350))}handleInitializationError(e){console.error("Homepage initialization error:",e),this.hideLoadingScreen(),document.body.innerHTML='\n      <div class="initialization-error">\n        <div class="error-content">\n          <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>\n          <h1>Errore di Caricamento</h1>\n          <p>Si √® verificato un errore durante il caricamento della homepage.</p>\n          <button class="btn btn-primary" onclick="window.location.reload()">\n            <i class="fas fa-refresh" aria-hidden="true"></i>\n            Ricarica Pagina\n          </button>\n          <a href="index.html" class="btn btn-outline">\n            <i class="fas fa-home" aria-hidden="true"></i>\n            Torna alla Home\n          </a>\n        </div>\n      </div>\n    '}destroy(){window.removeEventListener("resize",this.handleResize),window.removeEventListener("scroll",this.handleScroll),document.removeEventListener("keydown",this.handleKeydown),document.removeEventListener("click",this.handleClick),this.intersectionObserver&&this.intersectionObserver.disconnect(),this.searchTimer&&clearTimeout(this.searchTimer),console.log("EduNet19 Homepage destroyed")}applyFilters(e){console.log("üìä Homepage applying filters:",e),console.log("üìä Filter state:",JSON.stringify(e,null,2)),this.activeFilters=e;const t=document.getElementById("feed-content");if(!t)return void console.warn("Feed content not found");const s=t.querySelectorAll(".feed-post");console.log(`üìä Total posts in feed: ${s.length}`),s.forEach((e,t)=>{const s=e.getAttribute("data-post-type");console.log(`Post ${t}: type="${s}"`)});const i=e.tab||"all";let n=[];switch(i){case"projects":n=["project","progetto"];break;case"methodologies":n=["methodology","metodologia"];break;case"following":case"saved":case"all":default:n=e.contentTypes;break;case"discover":return}console.log(`üìä Tab: ${i}, Tab content types:`,n);const a=e.contentTypes.length>0&&e.contentTypes.length<7,o="all"!==e.period,r=e.instituteTypes.length>0,l="all"!==i&&"saved"!==i;if(console.log(`üìä Filters active - Content: ${a}, Period: ${o}, Institute: ${r}, Tab: ${l}`),!(a||o||r||l)){console.log("üìä No filters active, showing all posts"),s.forEach(e=>{e.style.display=""});const e=t.querySelector(".feed-empty");return void(e&&(e.style.display="none"))}let c=0;s.forEach(t=>{let s=!0;const i=t.getAttribute("data-post-type");if(l&&(n.includes(i)||(s=!1)),a&&s&&(e.contentTypes.includes(i)||(s=!1)),o&&s){const i=t.getAttribute("data-created-at");if(i){const t=new Date(i),n=new Date;switch(e.period){case"today":t<new Date(n.setHours(0,0,0,0))&&(s=!1);break;case"week":t<new Date(n.setDate(n.getDate()-7))&&(s=!1);break;case"month":t<new Date(n.setMonth(n.getMonth()-1))&&(s=!1)}}}t.style.display=s?"":"none",s&&c++}),console.log(`üìä Visible posts after filtering: ${c}`);let d=t.querySelector(".feed-empty");0===c?(d||(d=document.createElement("div"),d.className="feed-empty",t.appendChild(d)),d.innerHTML='\n        <div class="empty-state-icon">\n          <i class="fas fa-filter"></i>\n        </div>\n        <h3>Nessun contenuto trovato</h3>\n        <p>Non ci sono post che corrispondono ai filtri selezionati.</p>\n        <p class="empty-state-hint">Prova a modificare i filtri o a rimuoverli per vedere pi√π contenuti.</p>\n      ',d.style.display="flex"):d&&(d.style.display="none")}countMatchingPosts(e){const t=document.getElementById("feed-content");if(!t)return 0;const s=t.querySelectorAll(".feed-post"),i=e.contentTypes.length>0&&e.contentTypes.length<7,n="all"!==e.period,a=e.instituteTypes.length>0;if(!i&&!n&&!a)return s.length;let o=0;return s.forEach(t=>{let s=!0;if(i){const i=t.getAttribute("data-post-type");e.contentTypes.includes(i)||(s=!1)}if(n&&s){const i=t.getAttribute("data-created-at");if(i){const t=new Date(i),n=new Date;switch(e.period){case"today":t<new Date(n.setHours(0,0,0,0))&&(s=!1);break;case"week":t<new Date(n.setDate(n.getDate()-7))&&(s=!1);break;case"month":t<new Date(n.setMonth(n.getMonth()-1))&&(s=!1)}}}s&&o++}),o}}window.eduNetHomepage=new EduNetHomepage,console.log("üè† EduNet19 Homepage - Script loaded successfully");