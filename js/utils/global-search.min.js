class GlobalSearch{constructor(){this.elements={input:document.getElementById("global-search"),results:document.getElementById("search-results"),clearBtn:document.querySelector(".nav-search .search-clear")},this.searchTimer=null,this.init()}init(){this.elements.input&&this.elements.results?(console.log("ðŸ” GlobalSearch initializing..."),this.setupEventListeners()):console.warn("GlobalSearch: Elements not found")}setupEventListeners(){this.elements.input.addEventListener("input",e=>{const t=e.target.value;this.handleSearch(t)}),this.elements.input.addEventListener("focus",()=>{this.elements.input.value.trim().length>0&&this.showSearchResults()}),document.addEventListener("click",e=>{e.target.closest(".nav-search")||this.hideSearchResults()}),this.elements.clearBtn&&this.elements.clearBtn.addEventListener("click",()=>{this.clearSearch(),this.elements.input.focus()})}handleSearch(e){if(clearTimeout(this.searchTimer),""===e.trim())return this.hideSearchResults(),void this.hideSearchClear();this.showSearchClear(),this.searchTimer=setTimeout(()=>{this.performSearch(e)},300)}showSearchClear(){this.elements.clearBtn&&(this.elements.clearBtn.style.display="block")}hideSearchClear(){this.elements.clearBtn&&(this.elements.clearBtn.style.display="none")}showSearchResults(){""!==this.elements.results.innerHTML.trim()&&(this.elements.results.style.display="block")}hideSearchResults(){this.elements.results.style.display="none"}clearSearch(){this.elements.input.value="",this.hideSearchResults(),this.hideSearchClear()}async performSearch(e){this.elements.results.style.display="block",this.elements.results.innerHTML='\n            <div class="search-loading">\n                <div class="loading-spinner-small"></div>\n                <p>Ricerca in corso...</p>\n            </div>\n        ';try{console.log("GlobalSearch: Searching for:",e);const t=[],a=window.supabaseClientManager?await window.supabaseClientManager.getClient():null;if(window.eduNetProfileManager)try{const a=await window.eduNetProfileManager.searchProfiles(e);if(a&&a.length>0)for(const s of a){let a=!1,i=!1;if(window.supabaseClientManager){const t=await window.supabaseClientManager.getClient(),{data:n}=await t.from("user_privacy_settings").select("profile_visibility, searchable_by_email").eq("user_id",s.id).maybeSingle();n&&("private"===n.profile_visibility&&(a=!0),!1===n.searchable_by_email&&e.includes("@")&&(i=!0))}if(a||i)continue;let n=null;if(window.avatarManager)try{n=await window.avatarManager.loadUserAvatar(s.id)}catch(e){console.warn("Avatar load error",e)}"istituto"===s.user_type&&s.school_institutes?t.push({type:"institute",name:s.school_institutes.institute_name,location:s.school_institutes.city||"Posizione non specificata",id:s.id,avatarUrl:n}):"privato"===s.user_type&&s.private_users}}catch(e){console.error("GlobalSearch: Profile search error",e)}else if(a)try{console.log("GlobalSearch: ProfileManager missing, using fallback search");const{data:s}=await a.from("school_institutes").select("id, institute_name, city").ilike("institute_name",`%${e}%`).limit(5);if(s)for(const e of s){const{data:s}=await a.from("user_privacy_settings").select("profile_visibility, searchable_by_email").eq("user_id",e.id).maybeSingle();if(s&&"private"===s.profile_visibility)continue;if(window.miurValidator){const t=await window.miurValidator.validateInstitute({instituteName:e.institute_name,instituteCode:e.institute_code});if(!t.isValid&&t.confidence<.3){console.log("ðŸš« Istituto filtrato (non valido MIUR):",e.institute_name);continue}}let i=null;if(window.avatarManager)try{i=await window.avatarManager.loadUserAvatar(e.id)}catch(e){}t.push({type:"institute",name:e.institute_name,location:e.city||"Posizione non specificata",id:e.id,avatarUrl:i})}}catch(e){console.error("GlobalSearch: Fallback search error",e)}if(window.supabaseClientManager)try{const a=await window.supabaseClientManager.getClient(),{data:s,error:i}=await a.from("institute_posts").select("id, title, content, post_type, institute_id, tags").or(`title.ilike.%${e}%, content.ilike.%${e}%`).eq("published",!0).order("created_at",{ascending:!1}).limit(5);let n=[];if(!i){const{data:t,error:s}=await a.from("institute_posts").select("id, title, content, post_type, institute_id, tags").contains("tags",[e.toLowerCase()]).eq("published",!0).order("created_at",{ascending:!1}).limit(5);!s&&t&&(n=t)}const l=[...s||[],...n],r=Array.from(new Map(l.map(e=>[e.id,e])).values());if(r.length>0)for(const e of r){let s="Autore sconosciuto",i=null;try{const{data:t}=await a.from("school_institutes").select("institute_name").eq("id",e.institute_id).maybeSingle();t&&(s=t.institute_name),window.avatarManager&&(i=await window.avatarManager.loadUserAvatar(e.institute_id))}catch(e){console.warn("Post author fetch error",e)}const n=this.getPostBadgeInfo(e.post_type);t.push({type:"post",post_type:e.post_type,title:e.title,author:s,id:e.id,authorId:e.institute_id,avatarUrl:i,tags:e.tags||[],badgeClass:n.class,badgeIcon:n.icon,badgeLabel:n.label})}}catch(e){console.error("GlobalSearch: Post search error",e)}this.displaySearchResults(t)}catch(e){console.error("GlobalSearch: Critical error",e),this.displaySearchResults([])}}displaySearchResults(e){0!==e.length?(this.elements.results.innerHTML=e.map(e=>{const t="post"===e.type?e.authorId:e.id,a=e.avatarUrl?`<img src="${e.avatarUrl}" alt="Avatar" class="search-result-avatar" data-user-id="${t}">`:`<div class="search-result-avatar search-result-avatar-default" data-user-id="${t}">\n                     <i class="fas fa-${"institute"===e.type?"school":"user"===e.type?"user":"file-alt"}"></i>\n                   </div>`;return"post"===e.type?`\n                    <div class="search-result-item" data-id="${e.id}" data-type="post">\n                        ${a}\n                        <div class="search-result-main">\n                            <div class="search-result-header">\n                                <span class="result-author" style="margin: 0; font-weight: 600; color: var(--color-gray-700);">${e.author}</span>\n                                <span class="search-badge ${e.badgeClass}" style="font-size: 0.65rem; padding: 0.2rem 0.5rem;">\n                                    <i class="${e.badgeIcon}"></i> ${e.badgeLabel}\n                                </span>\n                            </div>\n                            <div class="result-content">\n                                <h4 style="margin-top: 0.25rem;">${e.title}</h4>\n                            </div>\n                        </div>\n                    </div>\n                `:`\n                    <div class="search-result-item" data-id="${e.id}" data-type="${e.type}">\n                        ${a}\n                        <div class="result-content">\n                            <h4>${e.name}</h4>\n                            <p>${e.location}</p>\n                        </div>\n                    </div>\n                `}).join(""),this.elements.results.querySelectorAll(".search-result-item").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.id,a=e.dataset.type,s=window.location.pathname.includes("/pages/")?"../../":"./";if(s.endsWith("/"),window.location.pathname.includes("/pages/profile/"),"institute"===a||"user"===a){const e=window.location.origin;window.location.href=`${e}/pages/profile/profile.html?id=${t}`}else"post"===a&&(window.location.pathname.includes("/pages/")?window.location.href=`../../homepage.html#post/${t}`:window.location.href=`homepage.html#post/${t}`);this.hideSearchResults()})})):this.elements.results.innerHTML='\n                <div class="search-no-results">\n                    <i class="fas fa-search" aria-hidden="true"></i>\n                    <p>Nessun risultato trovato</p>\n                </div>\n            '}getPostBadgeInfo(e){const t={notizia:{label:"Post",icon:"fas fa-align-left",class:"badge-post"},progetto:{label:"Progetto",icon:"fas fa-lightbulb",class:"badge-project"},metodologia:{label:"Metodologia",icon:"fas fa-book-open",class:"badge-methodology"},evento:{label:"Galleria",icon:"fas fa-images",class:"badge-gallery"},gallery:{label:"Galleria",icon:"fas fa-images",class:"badge-gallery"},experience:{label:"Esperienza",icon:"fas fa-star",class:"badge-experience"},collaboration:{label:"Collaborazione",icon:"fas fa-handshake",class:"badge-collaboration"}};return t[e]||t.notizia}}document.addEventListener("DOMContentLoaded",()=>{!window.eduNetHomepage&&document.getElementById("global-search")&&(window.globalSearch=new GlobalSearch)});