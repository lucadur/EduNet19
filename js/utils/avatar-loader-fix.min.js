!function(){"use strict";class a{constructor(){this.avatarCache=new Map,this.pendingRequests=new Map,this.init()}async init(){console.log("ðŸŽ¨ Avatar Loader Fix - Initializing..."),await this.waitForAvatarManager(),this.enhanceAvatarManager(),this.setupMutationObserver(),this.loadAllVisibleAvatars(),console.log("âœ… Avatar Loader Fix - Ready")}async waitForAvatarManager(){return new Promise(a=>{const e=()=>{window.avatarManager?a():setTimeout(e,50)};e()})}enhanceAvatarManager(){if(!window.avatarManager)return;const a=window.avatarManager.loadUserAvatar.bind(window.avatarManager);window.avatarManager.loadUserAvatar=async e=>{if(this.avatarCache.has(e))return this.avatarCache.get(e);if(this.pendingRequests.has(e))return this.pendingRequests.get(e);const t=a(e).then(a=>(this.avatarCache.set(e,a),this.pendingRequests.delete(e),a)).catch(a=>(console.warn(`Failed to load avatar for user ${e}:`,a),this.pendingRequests.delete(e),null));return this.pendingRequests.set(e,t),t},console.log("âœ… Avatar Manager enhanced with caching")}setupMutationObserver(){const a=new MutationObserver(a=>{a.forEach(a=>{a.addedNodes.forEach(a=>{a.nodeType===Node.ELEMENT_NODE&&this.loadAvatarsInElement(a)})})});a.observe(document.body,{childList:!0,subtree:!0}),console.log("âœ… Mutation observer active for dynamic avatars")}loadAllVisibleAvatars(){this.loadAvatarsInElement(document.body)}loadAvatarsInElement(a){const e=[".author-avatar",".comment-avatar",".search-result-avatar",".saved-post-author-avatar",".user-avatar-small",'[id^="comment-avatar-"]',"[data-user-id]"];e.forEach(e=>{const t=a.querySelectorAll?a.querySelectorAll(e):[];t.forEach(a=>this.loadAvatarForElement(a))})}async loadAvatarForElement(a){if("true"===a.dataset.avatarLoaded)return;let e=a.dataset.userId;if(!e){const t=a.closest("[data-post-id]");t&&(e=t.dataset.authorId)}if(!e){const t=a.closest("[data-comment-id]");t&&(e=t.dataset.userId)}if(!e&&a.id){const t=a.id.match(/comment-avatar-(.+)/);if(t){const a=t[1];e=await this.getUserIdFromComment(a)}}if(e){a.dataset.avatarLoaded="loading";try{const t=await window.avatarManager.loadUserAvatar(e);if(t){if("IMG"===a.tagName)a.src=t,a.alt="Avatar";else if(a.classList.contains("author-avatar")||a.classList.contains("comment-avatar")){a.style.backgroundImage=`url(${t})`,a.style.backgroundSize="cover",a.style.backgroundPosition="center";const e=a.querySelector("i");e&&e.remove()}else a.style.backgroundImage=`url(${t})`;a.dataset.avatarLoaded="true"}else a.dataset.avatarLoaded="failed"}catch(e){console.error("Error loading avatar:",e),a.dataset.avatarLoaded="failed"}}else console.warn("Could not determine user ID for avatar element:",a)}async getUserIdFromComment(a){try{if(!window.supabaseClientManager)return null;const e=await window.supabaseClientManager.getClient(),{data:t,error:r}=await e.from("post_comments").select("user_id").eq("id",a).single();if(r)throw r;return t?.user_id}catch(a){return console.error("Error fetching user ID from comment:",a),null}}async preloadAvatars(a){const e=a.map(a=>window.avatarManager.loadUserAvatar(a));try{await Promise.all(e),console.log(`âœ… Preloaded ${a.length} avatars`)}catch(a){console.warn("Some avatars failed to preload:",a)}}clearCache(){this.avatarCache.clear(),this.pendingRequests.clear(),console.log("ðŸ—‘ï¸ Avatar cache cleared")}reloadAllAvatars(){this.clearCache(),document.querySelectorAll("[data-avatar-loaded]").forEach(a=>{a.dataset.avatarLoaded="false"}),this.loadAllVisibleAvatars(),console.log("ðŸ”„ All avatars reloaded")}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.avatarLoaderFix=new a}):window.avatarLoaderFix=new a}();