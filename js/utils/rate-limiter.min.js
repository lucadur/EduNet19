"use strict";class EduNetRateLimiter{constructor(){this.attempts=new Map,this.configs={login:{maxAttempts:5,windowMs:6e4,blockMs:3e5},register:{maxAttempts:3,windowMs:6e4,blockMs:6e5},passwordReset:{maxAttempts:3,windowMs:3e5,blockMs:9e5},comment:{maxAttempts:10,windowMs:6e4,blockMs:12e4},post:{maxAttempts:5,windowMs:3e5,blockMs:6e5},like:{maxAttempts:30,windowMs:6e4,blockMs:6e4},search:{maxAttempts:20,windowMs:6e4,blockMs:6e4},api:{maxAttempts:100,windowMs:6e4,blockMs:12e4}},this.blocks=new Map,this.loadPersistedBlocks(),console.log("ðŸ›¡ï¸ EduNetRateLimiter initialized")}loadPersistedBlocks(){try{const t=localStorage.getItem("edunet_rate_blocks");if(t){const e=JSON.parse(t),s=Date.now();for(const[t,o]of Object.entries(e))o>s&&this.blocks.set(t,o)}}catch(t){}}persistBlocks(){try{const t={};this.blocks.forEach((e,s)=>{t[s]=e}),localStorage.setItem("edunet_rate_blocks",JSON.stringify(t))}catch(t){}}check(t,e="default"){const s=this.configs[t]||this.configs.api,o=`${t}:${e}`,i=Date.now(),a=this.blocks.get(o);if(a&&a>i){const e=Math.ceil((a-i)/1e3);return{allowed:!1,blocked:!0,retryAfter:e,message:this.getBlockMessage(t,e)}}a&&(this.blocks.delete(o),this.persistBlocks());let r=this.attempts.get(o)||[];if(r=r.filter(t=>i-t<s.windowMs),r.length>=s.maxAttempts){const e=i+s.blockMs;this.blocks.set(o,e),this.persistBlocks();const a=Math.ceil(s.blockMs/1e3);return{allowed:!1,blocked:!0,retryAfter:a,message:this.getBlockMessage(t,a)}}return r.push(i),this.attempts.set(o,r),{allowed:!0,remaining:s.maxAttempts-r.length,resetIn:Math.ceil(s.windowMs/1e3)}}record(t,e="default"){const s=`${t}:${e}`,o=Date.now();let i=this.attempts.get(s)||[];i.push(o),this.attempts.set(s,i)}reset(t,e="default"){const s=`${t}:${e}`;this.attempts.delete(s),this.blocks.delete(s),this.persistBlocks()}getBlockMessage(t,e){const s=Math.ceil(e/60),o=e%60,i=s>0?`${s} minut${1===s?"o":"i"}${o>0?` e ${o} secondi`:""}`:`${o} secondi`,a={login:`Troppi tentativi di accesso. Riprova tra ${i}.`,register:`Troppe registrazioni. Riprova tra ${i}.`,passwordReset:`Troppe richieste di reset password. Riprova tra ${i}.`,comment:`Stai commentando troppo velocemente. Riprova tra ${i}.`,post:`Stai pubblicando troppo velocemente. Riprova tra ${i}.`,like:`Troppi like in poco tempo. Riprova tra ${i}.`,search:`Troppe ricerche. Riprova tra ${i}.`,api:`Troppe richieste. Riprova tra ${i}.`};return a[t]||`Riprova tra ${i}.`}checkAndNotify(t,e="default"){const s=this.check(t,e);return!!s.allowed||(window.eduNetAuth&&window.eduNetAuth.showNotification?window.eduNetAuth.showNotification(s.message,"warning"):window.eduNetErrorHandler&&window.eduNetErrorHandler.showErrorNotification({message:s.message}),!1)}protect(t,e="default"){return s=>async(...o)=>this.checkAndNotify(t,e)?s(...o):{success:!1,rateLimited:!0}}cleanup(){const t=Date.now();this.attempts.forEach((e,s)=>{const o=this.configs[s.split(":")[0]]||this.configs.api,i=e.filter(e=>t-e<o.windowMs);0===i.length?this.attempts.delete(s):this.attempts.set(s,i)}),this.blocks.forEach((e,s)=>{e<=t&&this.blocks.delete(s)}),this.persistBlocks()}}window.rateLimiter=new EduNetRateLimiter,setInterval(()=>{window.rateLimiter&&window.rateLimiter.cleanup()},3e5);