!function(){"use strict";const e=document.getElementById("mobileSearchBtn"),t=document.getElementById("mobileSearchOverlay"),a=document.getElementById("mobileSearchBack"),i=document.getElementById("mobileSearchInput"),s=document.getElementById("mobileSearchClear"),n=document.getElementById("mobileSearchResults");if(!e||!t)return;let o=null;function l(){t.classList.remove("active"),document.body.classList.remove("mobile-search-active"),i&&(i.value=""),s&&(s.style.display="none"),r()}function r(){n&&(n.innerHTML='\n      <div class="mobile-search-empty">\n        <div class="quick-suggestions">\n          <h3>Suggerimenti</h3>\n          <div class="suggestion-item" data-query="Istituti Roma">\n            <i class="fas fa-search"></i>\n            <span>Istituti Roma</span>\n          </div>\n          <div class="suggestion-item" data-query="Progetti STEM">\n            <i class="fas fa-search"></i>\n            <span>Progetti STEM</span>\n          </div>\n          <div class="suggestion-item" data-query="Metodologie innovative">\n            <i class="fas fa-search"></i>\n            <span>Metodologie innovative</span>\n          </div>\n        </div>\n      </div>\n    ',c())}function c(){const e=n?.querySelectorAll(".suggestion-item[data-query]");e?.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.query;i&&t&&(i.value=t,d(t))})})}async function d(e){if(n){n.innerHTML='\n      <div class="mobile-search-no-results">\n        <i class="fas fa-spinner fa-spin"></i>\n        <p>Ricerca in corso...</p>\n      </div>\n    ';try{console.log("Mobile search for:",e);const t=[],a=window.supabaseClientManager?await window.supabaseClientManager.getClient():null;if(!a)throw new Error("Supabase client not available");try{const{data:i,error:s}=await a.from("school_institutes").select("id, institute_name, institute_type, city").ilike("institute_name",`*${e}*`).limit(10);if(s)console.error("Institutes search error:",s);else if(i&&i.length>0)for(const s of i){const{data:i}=await a.from("user_privacy_settings").select("profile_visibility, searchable_by_email").eq("user_id",s.id).maybeSingle();if(i&&"private"===i.profile_visibility)continue;if(i&&!1===i.searchable_by_email&&e.includes("@"))continue;let n=null;if(window.avatarManager)try{n=await window.avatarManager.loadUserAvatar(s.id)}catch(e){console.warn("Could not load avatar for institute:",s.id)}if(t.push({type:"institute",name:s.institute_name||"Istituto",location:`${s.institute_type||"Istituto"} - ${s.city||"Posizione non specificata"}`,avatarUrl:n,id:s.id}),t.length>=5)break}}catch(e){console.error("Error searching institutes:",e)}try{const{data:i,error:s}=await a.from("institute_posts").select("id, title, post_type, institute_id, tags").ilike("title",`*${e}*`).eq("published",!0).limit(10);if(s)console.error("Posts search error:",s);else if(i&&i.length>0)for(const e of i){let i="Autore sconosciuto",s=null;try{const{data:t}=await a.from("school_institutes").select("institute_name").eq("id",e.institute_id).maybeSingle();t&&(i=t.institute_name||"Istituto"),window.avatarManager&&(s=await window.avatarManager.loadUserAvatar(e.institute_id))}catch(t){console.warn("Could not fetch author for post:",e.id)}t.push({type:e.post_type||"post",title:e.title,author:i,avatarUrl:s,tags:e.tags||[],id:e.id,authorId:e.institute_id})}}catch(e){console.error("Error searching posts:",e)}console.log("Mobile search results:",t),u(t)}catch(e){console.error("Mobile search error:",e),u([])}}}function u(e){if(n)if(0===e.length)n.innerHTML='\n        <div class="mobile-search-no-results">\n          <i class="fas fa-search"></i>\n          <p>Nessun risultato trovato</p>\n          <small>Prova con parole chiave diverse</small>\n        </div>\n      ';else{const t=e.map(e=>{const t="notizia"===e.type||"progetto"===e.type||"metodologia"===e.type||"evento"===e.type||"post"===e.type?e.authorId:e.id,a=e.avatarUrl?`<img src="${e.avatarUrl}" alt="Avatar" class="search-result-avatar" data-user-id="${t}">`:`<div class="search-result-avatar search-result-avatar-default" data-user-id="${t}">\n               <i class="fas fa-${"institute"===e.type?"school":"user"===e.type?"user":"school"}"></i>\n             </div>`;if("notizia"===e.type||"progetto"===e.type||"metodologia"===e.type||"evento"===e.type||"post"===e.type){const t=g(e.type);return`\n            <div class="search-result-item" data-id="${e.id||""}" data-type="${e.type}">\n              ${a}\n              <div class="search-result-main">\n                <div class="search-result-header" style="display: flex; justify-content: space-between; align-items: center;">\n                  <span class="result-author" style="margin: 0; font-weight: 600; color: var(--color-gray-700); font-size: 0.85rem;">${e.author}</span>\n                  <span class="search-badge ${t.class}" style="font-size: 0.7rem; padding: 0.25rem 0.6rem;">\n                    <i class="${t.icon}"></i>\n                    ${t.label}\n                  </span>\n                </div>\n                <div class="result-content" style="margin-top: 0.25rem;">\n                  <h4 style="margin-bottom: 0.25rem;">${e.title}</h4>\n                  ${e.tags&&e.tags.length>0?`\n                    <div class="result-tags">\n                      ${e.tags.slice(0,3).map(e=>`<span class="result-tag">#${e}</span>`).join("")}\n                      ${e.tags.length>3?`<span class="result-tag-more">+${e.tags.length-3}</span>`:""}\n                    </div>\n                  `:""}\n                </div>\n              </div>\n            </div>\n          `}return`\n            <div class="search-result-item" data-id="${e.id||""}" data-type="${e.type}">\n              ${a}\n              <div class="result-content">\n                <h4>${e.name||e.title}</h4>\n                <p>${e.location||e.author||e.category||""}</p>\n              </div>\n            </div>\n          `}).join("");n.innerHTML=`<div class="mobile-search-results-container">${t}</div>`,n.querySelectorAll(".search-result-item").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.type,a=e.dataset.id;console.log("Mobile search - Clicked result:",t,a),"institute"===t||"user"===t?window.location.href=window.AppConfig.getPageUrl(`pages/profile/profile.html?id=${a}`):"notizia"!==t&&"progetto"!==t&&"metodologia"!==t&&"evento"!==t||(window.eduNetHomepage&&"function"==typeof window.eduNetHomepage.navigateToPost?window.eduNetHomepage.navigateToPost(a):window.location.href=window.AppConfig.getPageUrl(`homepage.html#post/${a}`)),l()})})}}function g(e){const t={notizia:{label:"Post",icon:"fas fa-align-left",class:"badge-post"},progetto:{label:"Progetto",icon:"fas fa-lightbulb",class:"badge-project"},metodologia:{label:"Metodologia",icon:"fas fa-book-open",class:"badge-methodology"},evento:{label:"Galleria",icon:"fas fa-images",class:"badge-gallery"}};return t[e]||t.notizia}e.addEventListener("click",()=>{t.classList.add("active"),document.body.classList.add("mobile-search-active"),setTimeout(()=>i?.focus(),300)}),a?.addEventListener("click",l),document.addEventListener("keydown",e=>{"Escape"===e.key&&t.classList.contains("active")&&l()}),i?.addEventListener("input",e=>{const t=e.target.value.trim();s&&(s.style.display=t?"flex":"none"),clearTimeout(o),0===t.length?r():t.length>=2&&(o=setTimeout(()=>{d(t)},300))}),s?.addEventListener("click",()=>{i&&(i.value="",s.style.display="none",i.focus(),r())}),c()}();