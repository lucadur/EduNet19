class MIURValidator{constructor(){this.miurDatabase=null,this.isLoaded=!1,this.schoolNames=new Set,this.schoolCodes=new Set}async loadDatabase(){if(!this.isLoaded){console.log("ðŸ” MIUR Validator - Caricamento database...");try{const e=this.getBasePath(),[a,t,s,o]=await Promise.all([fetch(`${e}db scuole/scuole-statali.json`).then(e=>e.json()).catch(()=>({"@graph":[]})),fetch(`${e}db scuole/scuole-paritarie.json`).then(e=>e.json()).catch(()=>({"@graph":[]})),fetch(`${e}db scuole/scuole-statali-province-autonome.json`).then(e=>e.json()).catch(()=>({"@graph":[]})),fetch(`${e}db scuole/scuole-paritarie-province-autonome.json`).then(e=>e.json()).catch(()=>({"@graph":[]}))]);this.miurDatabase=[...a["@graph"]||[],...t["@graph"]||[],...s["@graph"]||[],...o["@graph"]||[]],this.miurDatabase.forEach(e=>{const a=(e["miur:DENOMINAZIONESCUOLA"]||"").toUpperCase().trim(),t=e["miur:CODICESCUOLA"]||"";a&&this.schoolNames.add(a),t&&this.schoolCodes.add(t)}),this.isLoaded=!0,console.log(`âœ… MIUR Validator - Database caricato: ${this.schoolNames.size} nomi, ${this.schoolCodes.size} codici`)}catch(e){console.error("âŒ MIUR Validator - Errore caricamento:",e)}}}getBasePath(){const e=window.location.pathname;return e.includes("/pages/")?"../../":""}async isValidInstituteName(e){if(!e)return{valid:!1,reason:"Nome vuoto"};await this.loadDatabase();const a=e.toUpperCase().trim();if(this.schoolNames.has(a))return{valid:!0,matchType:"exact",confidence:1};const t=this.findPartialMatch(a);if(t)return{valid:!0,matchType:"partial",confidence:t.confidence,matchedName:t.name};const s=this.hasSchoolKeywords(a);return s.found?{valid:!1,reason:"Non trovato nel database MIUR",hasKeywords:!0,keywords:s.keywords}:{valid:!1,reason:"Nome non corrisponde a nessuna scuola MIUR"}}async isValidSchoolCode(e){if(!e)return{valid:!1,reason:"Codice vuoto"};await this.loadDatabase();const a=e.toUpperCase().trim();return this.schoolCodes.has(a)?{valid:!0}:{valid:!1,reason:"Codice meccanografico non trovato"}}findPartialMatch(e){let a=null,t=0;for(const s of this.schoolNames){const o=this.calculateSimilarity(e,s);o>t&&o>=.7&&(t=o,a=s)}return a?{name:a,confidence:t}:null}calculateSimilarity(e,a){const t=new Set(e.replace(/[^\w\s]/g,"").split(/\s+/).filter(e=>e.length>2)),s=new Set(a.replace(/[^\w\s]/g,"").split(/\s+/).filter(e=>e.length>2));if(0===t.size||0===s.size)return 0;const o=new Set([...t].filter(e=>s.has(e))),i=new Set([...t,...s]),n=o.size/i.size,c=Math.max(o.size/t.size,o.size/s.size);return.4*n+.6*c}static EXCLUDED_SCHOOL_TYPES=["SCUOLA INFANZIA","SCUOLA DELL'INFANZIA","SCUOLA PRIMARIA","SCUOLA ELEMENTARE"];isSchoolTypeAllowed(e){if(!e||"Non Disponibile"===e)return!1;const a=e.toUpperCase().trim();for(const e of MIURValidator.EXCLUDED_SCHOOL_TYPES)if(a.includes(e))return!1;const t=["PRIMO GRADO","SECONDARIA","LICEO","TECNICO","PROFESSIONALE","SUPERIORE","MAGISTRALE","UNIVERSITÃ€","UNIVERSITA","POLITECNICO","ACCADEMIA","CONSERVATORIO","ITS","COMPRENSIVO"];return t.some(e=>a.includes(e))}hasSchoolKeywords(e){const a=["ISTITUTO","LICEO","COMPRENSIVO","TECNICO","PROFESSIONALE","SECONDARIA","SUPERIORE","CONVITTO","CONSERVATORIO","ACCADEMIA","ITS","ITIS","IPSIA","IPSSAR","IPSEOA","ITCG","ITCS","ITC","UNIVERSITÃ€","POLITECNICO"],t=a.filter(a=>e.includes(a));return{found:t.length>0,keywords:t}}async validateInstitute(e){const a={isValid:!1,confidence:0,reasons:[],suggestions:[]},{instituteName:t,instituteCode:s,email:o}=e;if(s){const e=await this.isValidSchoolCode(s);if(e.valid)return a.isValid=!0,a.confidence=1,a.reasons.push("Codice meccanografico valido"),a}if(t){const e=await this.isValidInstituteName(t);if(e.valid)return a.isValid=!0,a.confidence=e.confidence,a.reasons.push(`Nome trovato nel database MIUR (${e.matchType})`),e.matchedName&&a.suggestions.push(`Nome suggerito: ${e.matchedName}`),a;e.hasKeywords&&(a.confidence=.3,a.reasons.push("Contiene parole chiave scolastiche ma non trovato nel database"),a.suggestions.push("Verifica il nome esatto della scuola nel database MIUR"))}if(o){const e=o.toLowerCase();(e.endsWith("@istruzione.it")||e.endsWith("@pec.istruzione.it")||e.includes(".edu.it"))&&(a.confidence=Math.max(a.confidence,.7),a.reasons.push("Email istituzionale riconosciuta"))}if(t){const e=[/^[a-z0-9]{3,8}$/i,/^[A-Z][a-z]+ [A-Z][a-z]+$/,/test/i,/prova/i,/^Istituto Scolastico$/i,/^Scuola$/i],s=e.some(e=>e.test(t));s&&a.confidence<.5&&(a.reasons.push("Nome sospetto - potrebbe non essere un istituto reale"),a.suggestions.push("Usa il sistema di autocompilazione MIUR per selezionare la scuola corretta"))}return a.isValid=a.confidence>=.5,a}async filterValidInstitutes(e){await this.loadDatabase();const a=[];for(const t of e){const e=await this.validateInstitute({instituteName:t.institute_name,instituteCode:t.institute_code,email:t.email});e.isValid&&a.push({...t,miur_validation:e})}return a}}window.miurValidator=new MIURValidator,console.log("âœ… MIUR Validator - Loaded");