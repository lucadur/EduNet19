class MIURAutocomplete{constructor(){this.miurDatabase=null,this.isLoading=!1,this.isLoaded=!1}async loadDatabase(){if(this.isLoaded)return this.miurDatabase;if(this.isLoading)return await new Promise(o=>{const i=setInterval(()=>{this.isLoaded&&(clearInterval(i),o())},100)}),this.miurDatabase;this.isLoading=!0,console.log("üì• Caricamento database MIUR...");try{const[o,i,e,t]=await Promise.all([fetch("../../db scuole/scuole-statali.json").then(o=>o.json()),fetch("../../db scuole/scuole-paritarie.json").then(o=>o.json()),fetch("../../db scuole/scuole-statali-province-autonome.json").then(o=>o.json()),fetch("../../db scuole/scuole-paritarie-province-autonome.json").then(o=>o.json())]);return this.miurDatabase=[...o["@graph"],...i["@graph"],...e["@graph"],...t["@graph"]],this.isLoaded=!0,this.isLoading=!1,console.log(`‚úÖ Database MIUR caricato: ${this.miurDatabase.length} scuole`),this.miurDatabase}catch(o){throw console.error("‚ùå Errore caricamento database MIUR:",o),this.isLoading=!1,o}}async findSchoolByCode(o){this.isLoaded||await this.loadDatabase();const i=this.miurDatabase.find(i=>i["miur:CODICESCUOLA"]===o||i["miur:CODICEISTITUTORIFERIMENTO"]===o);if(!i)return console.warn(`‚ö†Ô∏è Scuola non trovata: ${o}`),null;const e=i["miur:DESCRIZIONETIPOLOGIAGRADOISTRUZIONESCUOLA"]||"";return this.isSchoolTypeAllowed(e)?this.extractSchoolData(i):(console.warn(`‚ö†Ô∏è Tipo di scuola non ammesso: ${e}`),{error:!0,message:"Al momento sono supportate solo scuole medie, superiori e universit√†.",schoolType:e})}async searchSchools(o,i=10){this.isLoaded||await this.loadDatabase();const e=o.toLowerCase(),t=this.miurDatabase.filter(o=>{const i=(o["miur:DENOMINAZIONESCUOLA"]||"").toLowerCase(),t=(o["miur:DESCRIZIONECOMUNE"]||"").toLowerCase(),I=o["miur:DESCRIZIONETIPOLOGIAGRADOISTRUZIONESCUOLA"]||"";return!!this.isSchoolTypeAllowed(I)&&(i.includes(e)||t.includes(e))}).slice(0,i).map(o=>this.extractSchoolData(o));return t}extractSchoolData(o){const i=this.normalizeSchoolType(o["miur:DESCRIZIONETIPOLOGIAGRADOISTRUZIONESCUOLA"]),e={codice_scuola:o["miur:CODICESCUOLA"]||null,codice_istituto_riferimento:o["miur:CODICEISTITUTORIFERIMENTO"]||null,institute_name:this.cleanValue(o["miur:DENOMINAZIONESCUOLA"]),institute_type:i,email:this.cleanValue(o["miur:INDIRIZZOEMAILSCUOLA"]),pec:this.cleanValue(o["miur:INDIRIZZOPECSCUOLA"]),website:this.cleanValue(o["miur:SITOWEBSCUOLA"]),address:this.cleanValue(o["miur:INDIRIZZOSCUOLA"]),city:this.cleanValue(o["miur:DESCRIZIONECOMUNE"]),province:this.cleanValue(o["miur:PROVINCIA"]),cap:o["miur:CAPSCUOLA"]?String(o["miur:CAPSCUOLA"]).replace(".0",""):null,regione:this.cleanValue(o["miur:REGIONE"]),area_geografica:this.cleanValue(o["miur:AREAGEOGRAFICA"]),anno_scolastico:o["miur:ANNOSCOLASTICO"],fonte:"MIUR",data_import:(new Date).toISOString()};return e}static MIUR_TYPE_MAPPINGS={"SCUOLA PRIMO GRADO":"Scuola Secondaria di I Grado","SCUOLA SEC. PRIMO GRADO NON STATALE":"Scuola Secondaria di I Grado","SCUOLA SEC. PRIMO GRADO STATALE":"Scuola Secondaria di I Grado","LICEO SCIENTIFICO":"Liceo","LICEO CLASSICO":"Liceo","LICEO ARTISTICO":"Liceo","LICEO LINGUISTICO":"Liceo","ISTITUTO TECNICO INDUSTRIALE":"Istituto Tecnico","ISTITUTO TECNICO COMMERCIALE":"Istituto Tecnico","ISTITUTO TECNICO PER GEOMETRI":"Istituto Tecnico","ISTITUTO TECNICO AGRARIO":"Istituto Tecnico","ISTITUTO TECNICO NAUTICO":"Istituto Tecnico","ISTITUTO TECNICO AERONAUTICO":"Istituto Tecnico","ISTITUTO TECNICO PER IL TURISMO":"Istituto Tecnico","IST TEC COMMERCIALE E PER GEOMETRI":"Istituto Tecnico","IST TECNICO ECONOMICO E TECNOLOGICO":"Istituto Tecnico","ISTITUTO TECNICO PER ATTIVITA' SOCIALI (GIA' ITF)":"Istituto Tecnico","IST PROF INDUSTRIA E ARTIGIANATO":"Istituto Professionale","IST PROF ALBERGHIERO":"Istituto Professionale","IST PROF PER I SERVIZI ALBERGHIERI E RISTORAZIONE":"Istituto Professionale","IST PROF PER I SERVIZI COMMERCIALI E TURISTICI":"Istituto Professionale","IST PROF PER I SERVIZI COMMERCIALI":"Istituto Professionale","IST PROF PER I SERVIZI SOCIALI":"Istituto Professionale","IST PROF PER I SERVIZI TURISTICI":"Istituto Professionale","IST PROF PER I SERVIZI PUBBLICITARI":"Istituto Professionale","IST PROF PER I SERVIZI COMM TUR E DELLA PUBB":"Istituto Professionale","IST PROF PER L'AGRICOLTURA E L'AMBIENTE":"Istituto Professionale","IST PROF PER L'AGRICOLTURA":"Istituto Professionale","IST PROF INDUSTRIA E ARTIGIANATO PER CIECHI":"Istituto Professionale","IST PROF INDUSTRIA E ARTIGIANATO PER SORDOMUTI":"Istituto Professionale","IST PROF INDUSTRIA E ATTIVITA' MARINARE":"Istituto Professionale","IST PROF CINEMATOGRAFIA E TELEVISIONE":"Istituto Professionale","SCUOLA SEC. SECONDO GRADO NON STATALE":"Scuola Secondaria di II Grado","SCUOLA SEC. SECONDO GRADO STATALE":"Scuola Secondaria di II Grado","ISTITUTO SUPERIORE":"Scuola Secondaria di II Grado","ISTITUTO MAGISTRALE":"Liceo","SCUOLA MAGISTRALE":"Liceo","ISTITUTO D'ARTE":"Liceo","CONVITTO NAZIONALE":"Scuola Secondaria di II Grado","CONVITTO ANNESSO":"Scuola Secondaria di II Grado",EDUCANDATO:"Scuola Secondaria di II Grado","ISTITUTO COMPRENSIVO":"Scuola Secondaria di I Grado"};static EXCLUDED_SCHOOL_TYPES=["SCUOLA INFANZIA","SCUOLA PRIMARIA","CENTRO TERRITORIALE"];isSchoolTypeAllowed(o){if(!o||"Non Disponibile"===o)return!1;const i=o.toUpperCase().trim();for(const o of MIURAutocomplete.EXCLUDED_SCHOOL_TYPES)if(i.includes(o))return!1;if(MIURAutocomplete.MIUR_TYPE_MAPPINGS[i])return!0;if(i.includes("SEC.")&&i.includes("SECONDO GRADO"))return!0;if(i.includes("SEC.")&&i.includes("PRIMO GRADO"))return!0;const e=["LICEO","TECNICO","PROFESSIONALE","SUPERIORE","MAGISTRALE","IST PROF","IST TEC"];return!!e.some(o=>i.includes(o))||(console.warn(`‚ö†Ô∏è Tipo scuola non riconosciuto: "${o}"`),!1)}normalizeSchoolType(o){if(!o||"Non Disponibile"===o)return null;const i=o.toUpperCase().trim();return MIURAutocomplete.MIUR_TYPE_MAPPINGS[i]?MIURAutocomplete.MIUR_TYPE_MAPPINGS[i]:i.includes("SEC.")&&i.includes("SECONDO GRADO")?"Scuola Secondaria di II Grado":i.includes("SEC.")&&i.includes("PRIMO GRADO")?"Scuola Secondaria di I Grado":i.includes("LICEO")?"Liceo":i.includes("IST PROF")||i.includes("PROFESSIONALE")?"Istituto Professionale":i.includes("IST TEC")||i.includes("TECNICO")?"Istituto Tecnico":i.includes("SUPERIORE")?"Scuola Secondaria di II Grado":i.includes("MAGISTRALE")?"Liceo":i.includes("COMPRENSIVO")?"Scuola Secondaria di I Grado":(console.warn(`‚ö†Ô∏è Tipo MIUR non mappato: "${o}"`),null)}cleanValue(o){return o&&"Non Disponibile"!==o&&"NON DISPONIBILE"!==o&&""!==o.trim()?o.trim():null}validateData(o){const i=[],e=[];return o.institute_name||i.push("Nome istituto mancante"),o.codice_scuola||i.push("Codice scuola mancante"),o.email||e.push('Email non disponibile - Inseriscila manualmente nel campo "Email Amministratore"'),o.website||e.push("Sito web non disponibile nel database MIUR"),o.address||e.push("Indirizzo non disponibile nel database MIUR"),{isValid:0===i.length,errors:i,warnings:e}}formatForDatabase(o){return{institute_name:o.institute_name,institute_type:o.institute_type||"Altro",institute_code:o.codice_scuola,email:o.email,website:o.website,address:o.address,city:o.city,province:o.province,miur_data:{codice_scuola:o.codice_scuola,codice_istituto_riferimento:o.codice_istituto_riferimento,pec:o.pec,cap:o.cap,regione:o.regione,area_geografica:o.area_geografica,anno_scolastico:o.anno_scolastico,fonte:o.fonte,data_import:o.data_import}}}}window.miurAutocomplete=new MIURAutocomplete,console.log("‚úÖ MIUR Autocomplete - Loaded");