class AvatarManager{constructor(){this.supabase=null,this.currentUserAvatar=null,this.init()}async init(){window.supabaseClientManager&&(this.supabase=await window.supabaseClientManager.getClient(),await this.loadCurrentUserAvatar())}async loadCurrentUserAvatar(){try{if(!this.supabase)return void console.log("Supabase not available yet");const{data:{user:a}}=await this.supabase.auth.getUser();if(!a)return void console.log("No user logged in");console.log("Loading avatar for user:",a.id);const{data:e}=await this.supabase.from("user_profiles").select("user_type").eq("id",a.id).maybeSingle();if(!e)return void console.log("No user profile found");if("istituto"===e.user_type){const{data:e,error:t}=await this.supabase.from("school_institutes").select("logo_url").eq("id",a.id).maybeSingle();t&&console.error("Error loading institute profile:",t),e?.logo_url?(console.log("Found institute avatar:",e.logo_url),this.currentUserAvatar=e.logo_url,this.updateAllAvatars(e.logo_url)):console.log("No avatar found for institute")}else if("privato"===e.user_type){const{data:e,error:t}=await this.supabase.from("private_users").select("avatar_url").eq("id",a.id).maybeSingle();t&&console.error("Error loading private profile:",t),e?.avatar_url?(console.log("Found private user avatar:",e.avatar_url),this.currentUserAvatar=e.avatar_url,this.updateAllAvatars(e.avatar_url)):console.log("No avatar found for private user")}else console.log("Unknown user type:",e.user_type)}catch(a){console.error("Error loading user avatar:",a)}}updateAllAvatars(a){a&&(console.log("Updating all avatars with URL:",a),this.setAvatarImage("user-avatar",a),this.setAvatarImage("user-avatar-large",a),this.setAvatarImage("mobile-user-avatar",a),this.setAvatarBackground("profile-avatar",a),this.updateUserPostAvatars(a))}setAvatarImage(a,e){const t=document.getElementById(a);if(t)if(console.log("Setting avatar image for:",a,"Tag:",t.tagName),"IMG"===t.tagName){t.src=e,t.style.display="block",t.style.width="",t.style.height="",t.onerror=()=>{console.error("Failed to load avatar image:",e),t.style.display="none";const a=t.parentElement?.querySelector(".default-avatar, .default-avatar-large, .mobile-default-avatar");a&&(a.style.display="block")};const a=t.parentElement?.querySelector(".default-avatar, .default-avatar-large, .mobile-default-avatar");a&&(a.style.display="none")}else console.warn("Element is not an IMG tag:",a,t.tagName)}setAvatarBackground(a,e){const t=document.getElementById(a);if(!t)return;console.log("Setting avatar background for:",a),t.style.backgroundImage=`url(${e})`,t.style.backgroundSize="cover",t.style.backgroundPosition="center",t.style.backgroundRepeat="no-repeat";const r=t.querySelector("i");r&&(r.style.display="none")}setAvatar(a,e,t="medium"){console.warn("setAvatar is deprecated, use setAvatarImage or setAvatarBackground instead");const r=document.getElementById(a);r&&("IMG"===r.tagName?this.setAvatarImage(a,e):("profile-avatar"===r.id||r.classList.contains("comment-avatar")||r.classList.contains("author-avatar"))&&this.setAvatarBackground(a,e))}updateUserPostAvatars(a){const e=document.querySelectorAll(".user-avatar-small, .comment-avatar, .post-author-avatar");e.forEach(e=>{if("true"===e.dataset.isCurrentUser){e.style.backgroundImage=`url(${a})`,e.style.backgroundSize="cover",e.style.backgroundPosition="center";const t=e.querySelector("i");t&&(t.style.display="none")}})}async loadUserAvatar(a){try{if(!this.supabase)return null;const{data:e}=await this.supabase.from("user_profiles").select("user_type").eq("id",a).maybeSingle();if(!e)return null;if("istituto"===e.user_type){const{data:e}=await this.supabase.from("school_institutes").select("logo_url").eq("id",a).maybeSingle();return e?.logo_url||null}if("privato"===e.user_type){const{data:e}=await this.supabase.from("private_users").select("avatar_url").eq("id",a).maybeSingle();return e?.avatar_url||null}return null}catch(e){return console.error("Error loading avatar for user:",a,e),null}}setAvatarByUrl(a,e){if(!a||!e)return;"IMG"===a.tagName?(a.src=e,a.style.display="block",a.onerror=()=>{a.style.display="none"}):(a.classList.contains("comment-avatar")||a.classList.contains("author-avatar")||a.classList.contains("profile-avatar")||a.classList.contains("user-avatar-small"))&&(a.style.backgroundImage=`url(${e})`,a.style.backgroundSize="cover",a.style.backgroundPosition="center",a.style.backgroundRepeat="no-repeat");const t=a.querySelector("i");t&&(t.style.display="none")}createAvatarElement(a,e="avatar",t="medium"){const r=document.createElement("div");return r.className=e,a?(r.style.backgroundImage=`url(${a})`,r.style.backgroundSize="cover",r.style.backgroundPosition="center",r.style.backgroundRepeat="no-repeat"):r.innerHTML='<i class="fas fa-user-circle"></i>',r}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.avatarManager=new AvatarManager}):window.avatarManager=new AvatarManager,console.log("ðŸ‘¤ Avatar Manager - Script loaded successfully");