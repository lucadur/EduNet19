class CollaboratorsManager{constructor(){this.supabase=null,this.currentUser=null,this.instituteId=null,this.instituteName=null,this.collaborators=[],this.maxCollaborators=3,this.isOwner=!1,this.canManage=!1}async init(t){if(console.log("üë• CollaboratorsManager initializing..."),!window.supabaseClientManager)return console.error("‚ùå Supabase client not available"),!1;this.supabase=await window.supabaseClientManager.getClient();const{data:{user:e}}=await this.supabase.auth.getUser();return this.currentUser=e,this.instituteId=t,this.currentUser&&this.instituteId?(await this.loadInstituteName(),this.isOwner=this.instituteId===this.currentUser.id,this.canManage=await this.checkCanManage(),await this.loadCollaborators(),this.setupUI(),console.log("‚úÖ CollaboratorsManager initialized"),!0):(console.error("‚ùå Missing user or institute ID"),!1)}async loadInstituteName(){try{const{data:t}=await this.supabase.from("school_institutes").select("institute_name").eq("id",this.instituteId).single();this.instituteName=t?.institute_name||"Istituto"}catch(t){this.instituteName="Istituto"}}async checkCanManage(){if(this.isOwner)return!0;try{const{data:t}=await this.supabase.rpc("can_manage_collaborators",{p_institute_id:this.instituteId,p_user_id:this.currentUser.id});return!0===t}catch(t){return this.isOwner}}async loadCollaborators(){try{console.log("üìã Loading collaborators for institute:",this.instituteId),console.log("üìã Current user ID:",this.currentUser?.id);const{data:t,error:e}=await this.supabase.rpc("get_institute_collaborators",{p_institute_id:this.instituteId});if(e)throw console.error("‚ùå RPC error details:",{message:e.message,code:e.code,details:e.details,hint:e.hint}),e;this.collaborators=t||[],console.log("üìã Collaborators loaded:",this.collaborators.length,this.collaborators),this.renderCollaboratorsList()}catch(t){console.error("‚ùå Error loading collaborators:",t),this.collaborators=[],this.renderCollaboratorsList()}}setupUI(){const t=document.getElementById("collaborators-section");if(console.log("üë• setupUI - container found:",!!t,"canManage:",this.canManage,"isOwner:",this.isOwner),!t)return void console.warn("üë• Sezione collaboratori non trovata nel DOM");if(!this.canManage)return console.log("üë• Utente non pu√≤ gestire collaboratori, nascondo sezione"),void(t.style.display="none");console.log("üë• Mostrando sezione collaboratori"),t.style.display="";const e=document.getElementById("add-collaborator-btn");console.log("üë• Add button found:",!!e),e&&e.addEventListener("click",()=>{console.log("üë• Add button clicked!"),this.showInviteModal()});const i=document.getElementById("invite-collaborator-form");console.log("üë• Invite form found:",!!i),i&&i.addEventListener("submit",t=>{console.log("üë• Form submitted!"),this.handleInvite(t)});const n=document.getElementById("close-invite-modal");n&&n.addEventListener("click",()=>this.hideInviteModal());const a=document.getElementById("invite-modal");a&&a.addEventListener("click",t=>{t.target===a&&this.hideInviteModal()});const o=document.getElementById("close-link-modal");o&&o.addEventListener("click",()=>this.hideLinkModal())}renderCollaboratorsList(){const t=document.getElementById("collaborators-list"),e=document.getElementById("collaborators-count"),i=document.getElementById("add-collaborator-btn");if(!t)return;const n=this.collaborators.filter(t=>"pending"===t.status).length,a=this.collaborators.filter(t=>"active"===t.status).length,o=n+a;if(e&&(e.textContent=`${o}/${this.maxCollaborators}`,e.className="collaborators-badge",n>0&&e.classList.add("has-pending")),i&&(i.disabled=o>=this.maxCollaborators,o>=this.maxCollaborators&&(i.title="Limite massimo di collaboratori raggiunto")),0===this.collaborators.length)return void(t.innerHTML='\n        <div class="collaborators-empty">\n          <i class="fas fa-user-plus"></i>\n          <p>Nessun collaboratore aggiunto</p>\n          <span>Invita fino a 3 persone a gestire questo profilo</span>\n        </div>\n      ');const s=this.collaborators.filter(t=>"pending"===t.status),r=this.collaborators.filter(t=>"active"===t.status);let l="";s.length>0&&(l+=`\n        <div class="collaborators-section-header pending-header">\n          <i class="fas fa-clock"></i>\n          <span>In attesa di accettazione (${s.length})</span>\n        </div>\n      `,l+=s.map(t=>this.renderCollaboratorCard(t)).join("")),r.length>0&&(s.length>0&&(l+=`\n          <div class="collaborators-section-header active-header">\n            <i class="fas fa-check-circle"></i>\n            <span>Collaboratori attivi (${r.length})</span>\n          </div>\n        `),l+=r.map(t=>this.renderCollaboratorCard(t)).join("")),t.innerHTML=l,this.attachCardListeners()}renderCollaboratorCard(t){const e="active"===t.status?"status-active":"status-pending",i="active"===t.status?"Attivo":"In attesa",n="active"===t.status?"fa-check-circle":"fa-clock",a="pending"===t.status?"collaborator-card pending":"collaborator-card",o={admin:"Amministratore",editor:"Editor",viewer:"Visualizzatore"},s={admin:"fa-user-shield",editor:"fa-edit",viewer:"fa-eye"};let r="";if("pending"===t.status&&t.invited_at){const e=new Date(t.invited_at),i=new Date,n=Math.floor((i-e)/864e5);r=0===n?"Invitato oggi":1===n?"Invitato ieri":`Invitato ${n} giorni fa`}return`\n      <div class="${a}" data-id="${t.id}" data-token="${t.invite_token||""}">\n        <div class="collaborator-avatar">\n          <i class="fas fa-user-circle"></i>\n        </div>\n        <div class="collaborator-info">\n          <div class="collaborator-email">${this.escapeHtml(t.email)}</div>\n          <div class="collaborator-meta">\n            <span class="collaborator-role">\n              <i class="fas ${s[t.role]}"></i>\n              ${o[t.role]}\n            </span>\n            <span class="collaborator-status ${e}">\n              <i class="fas ${n}"></i>\n              ${i}\n            </span>\n            ${r?`<span class="collaborator-pending-info">${r}</span>`:""}\n          </div>\n        </div>\n        <div class="collaborator-actions">\n          ${"pending"===t.status?`\n            <button class="btn-icon btn-copy-link" data-id="${t.id}" title="Copia link invito">\n              <i class="fas fa-link"></i>\n            </button>\n            <button class="btn-icon btn-resend" data-id="${t.id}" title="Reinvia invito">\n              <i class="fas fa-paper-plane"></i>\n            </button>\n          `:""}\n          <button class="btn-icon btn-edit-role" data-id="${t.id}" title="Modifica ruolo">\n            <i class="fas fa-user-cog"></i>\n          </button>\n          <button class="btn-icon btn-remove btn-danger" data-id="${t.id}" title="Rimuovi">\n            <i class="fas fa-trash"></i>\n          </button>\n        </div>\n      </div>\n    `}attachCardListeners(){document.querySelectorAll(".btn-copy-link").forEach(t=>{t.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.copyInviteLink(t.dataset.id)})}),document.querySelectorAll(".btn-resend").forEach(t=>{t.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.resendInvite(t.dataset.id)})}),document.querySelectorAll(".btn-edit-role").forEach(t=>{t.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.showEditRoleModal(t.dataset.id)})}),document.querySelectorAll(".btn-remove").forEach(t=>{t.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.removeCollaborator(t.dataset.id)})})}showInviteModal(){const t=document.getElementById("invite-modal");t&&(t.classList.add("active"),document.getElementById("invite-email")?.focus())}hideInviteModal(){const t=document.getElementById("invite-modal");t&&(t.classList.remove("active"),document.getElementById("invite-collaborator-form")?.reset())}showLinkModal(t,e){let i=document.getElementById("link-modal");i||(i=document.createElement("div"),i.id="link-modal",i.className="modal-overlay",i.innerHTML='\n        <div class="modal-content modal-sm">\n          <div class="modal-header success-header">\n            <h3><i class="fas fa-check-circle"></i> Invito Creato!</h3>\n            <button type="button" class="modal-close" id="close-link-modal">\n              <i class="fas fa-times"></i>\n            </button>\n          </div>\n          <div class="modal-body">\n            <p class="link-modal-text">Condividi questo link con <strong id="link-modal-email"></strong>:</p>\n            <div class="invite-link-box">\n              <input type="text" id="invite-link-input" readonly>\n              <button type="button" class="btn-copy" id="copy-link-btn">\n                <i class="fas fa-copy"></i>\n                Copia\n              </button>\n            </div>\n            <p class="link-modal-hint">\n              <i class="fas fa-info-circle"></i>\n              Il collaboratore dovr√† accedere con questo link per accettare l\'invito.\n            </p>\n          </div>\n          <div class="modal-footer">\n            <button type="button" class="btn-primary" onclick="document.getElementById(\'link-modal\').classList.remove(\'active\')">\n              <i class="fas fa-check"></i> Ho capito\n            </button>\n          </div>\n        </div>\n      ',document.body.appendChild(i),i.querySelector("#close-link-modal")?.addEventListener("click",()=>this.hideLinkModal()),i.addEventListener("click",t=>{t.target===i&&this.hideLinkModal()}),i.querySelector("#copy-link-btn")?.addEventListener("click",()=>{const t=document.getElementById("invite-link-input");if(t){t.select(),navigator.clipboard.writeText(t.value);const e=i.querySelector("#copy-link-btn");e.innerHTML='<i class="fas fa-check"></i> Copiato!',setTimeout(()=>{e.innerHTML='<i class="fas fa-copy"></i> Copia'},2e3)}})),document.getElementById("link-modal-email").textContent=e,document.getElementById("invite-link-input").value=t,i.classList.add("active")}hideLinkModal(){const t=document.getElementById("link-modal");t&&t.classList.remove("active")}async handleInvite(t){t.preventDefault();const e=document.getElementById("invite-email"),i=document.getElementById("invite-role"),n=t.target.querySelector('button[type="submit"]'),a=e?.value?.trim().toLowerCase(),o=i?.value||"editor";if(a)if(this.isValidEmail(a))if(this.collaborators.some(t=>t.email===a))this.showNotification("Questo utente √® gi√† stato invitato","error");else if(this.collaborators.length>=this.maxCollaborators)this.showNotification("Limite massimo di collaboratori raggiunto","error");else{n&&(n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin"></i> Invio...');try{const t=this.generateToken();console.log("üìù Inserting collaborator via RPC:",{institute_id:this.instituteId,email:a,role:o});const{data:e,error:i}=await this.supabase.rpc("insert_collaborator",{p_institute_id:this.instituteId,p_email:a,p_role:o,p_invite_token:t});if(console.log("üìù Insert result:",{data:e,error:i}),i)throw i;const n=window.AppConfig.getPageUrl(`pages/profile/accept-invite.html?token=${t}`);try{const{data:e}=await this.supabase.functions.invoke("send-collaborator-invite",{body:{email:a,inviteToken:t,instituteName:this.instituteName,role:o,inviterName:this.currentUser.email,siteUrl:window.location.origin}});console.log("üìß Edge function response:",e)}catch(t){console.warn("‚ö†Ô∏è Edge function error (non-blocking):",t)}this.hideInviteModal(),this.showLinkModal(n,a),await this.loadCollaborators()}catch(t){console.error("‚ùå Error inviting collaborator:",t),this.showNotification(t.message||"Errore durante l'invito","error")}finally{n&&(n.disabled=!1,n.innerHTML='<i class="fas fa-paper-plane"></i> Invia Invito')}}else this.showNotification("Indirizzo email non valido","error");else this.showNotification("Inserisci un indirizzo email","error")}async copyInviteLink(t){const e=this.collaborators.find(e=>e.id===t);if(!e||!e.invite_token)return void this.showNotification("Link non disponibile","error");const i=window.AppConfig.getPageUrl(`pages/profile/accept-invite.html?token=${e.invite_token}`);try{await navigator.clipboard.writeText(i),this.showNotification("Link copiato negli appunti!","success")}catch(t){this.showLinkModal(i,e.email)}}async resendInvite(t){const e=this.collaborators.find(e=>e.id===t);if(e){console.log("üìß Resending invite to:",e.email);try{const i=this.generateToken();console.log("üìß New token generated");const{data:n,error:a}=await this.supabase.rpc("update_collaborator_invite",{p_collaborator_id:t,p_new_token:i});if(console.log("üìß RPC result:",{data:n,error:a}),a)throw a;const o=window.AppConfig.getPageUrl(`pages/profile/accept-invite.html?token=${i}`);console.log("üìß Calling Edge Function...");try{const{data:t,error:n}=await this.supabase.functions.invoke("send-collaborator-invite",{body:{email:e.email,inviteToken:i,instituteName:this.instituteName,role:e.role,inviterName:this.currentUser.email,siteUrl:window.location.origin}});console.log("üìß Edge function response:",t,n)}catch(t){console.warn("‚ö†Ô∏è Edge function error:",t)}this.showLinkModal(o,e.email),await this.loadCollaborators(),this.showNotification("Invito reinviato!","success")}catch(t){console.error("‚ùå Error resending invite:",t),this.showNotification("Errore durante il reinvio","error")}}}showEditRoleModal(t){const e=this.collaborators.find(e=>e.id===t);if(!e)return;const i=prompt(`Seleziona nuovo ruolo per ${e.email}:\n\n‚Ä¢ admin - Pu√≤ gestire tutto inclusi collaboratori\n‚Ä¢ editor - Pu√≤ modificare profilo e pubblicare\n‚Ä¢ viewer - Solo visualizzazione\n\nInserisci: admin, editor o viewer`,e.role);i&&["admin","editor","viewer"].includes(i.toLowerCase())&&this.updateRole(t,i.toLowerCase())}async updateRole(t,e){try{const{error:i}=await this.supabase.rpc("update_collaborator_role",{p_collaborator_id:t,p_new_role:e});if(i)throw i;this.showNotification("Ruolo aggiornato","success"),await this.loadCollaborators()}catch(t){console.error("‚ùå Error updating role:",t),this.showNotification("Errore durante l'aggiornamento","error")}}async removeCollaborator(t){const e=this.collaborators.find(e=>e.id===t);e&&this.showRemoveConfirmModal(e)}showRemoveConfirmModal(t){const e=document.getElementById("remove-confirm-modal");e&&e.remove();const i="active"===t.status,n=i&&t.user_id,a=document.createElement("div");a.id="remove-confirm-modal",a.className="modal-overlay active",a.innerHTML=`\n      <div class="modal-content modal-md">\n        <div class="modal-header danger-header">\n          <h3><i class="fas fa-exclamation-triangle"></i> Rimuovi Collaboratore</h3>\n          <button type="button" class="modal-close" id="close-remove-modal">\n            <i class="fas fa-times"></i>\n          </button>\n        </div>\n        <div class="modal-body">\n          <div class="remove-confirm-info">\n            <p class="remove-email"><strong>${this.escapeHtml(t.email)}</strong></p>\n            <p class="remove-status">Stato: ${i?"Attivo":"In attesa di accettazione"}</p>\n          </div>\n          \n          ${n?'\n            <div class="remove-options">\n              <label class="remove-option">\n                <input type="radio" name="remove-type" value="collaborator-only" checked>\n                <div class="option-content">\n                  <span class="option-title"><i class="fas fa-user-minus"></i> Rimuovi solo dai collaboratori</span>\n                  <span class="option-desc">L\'utente non potr√† pi√π gestire questo istituto, ma il suo account rimarr√† attivo su EduNet19.</span>\n                </div>\n              </label>\n              <label class="remove-option danger-option">\n                <input type="radio" name="remove-type" value="delete-account">\n                <div class="option-content">\n                  <span class="option-title"><i class="fas fa-user-times"></i> Elimina anche l\'account</span>\n                  <span class="option-desc">\n                    <strong>‚ö†Ô∏è ATTENZIONE:</strong> Questa azione eliminer√† completamente l\'account dell\'utente da EduNet19. \n                    Tutti i suoi dati verranno cancellati permanentemente. Questa azione √® <strong>IRREVERSIBILE</strong>.\n                  </span>\n                </div>\n              </label>\n            </div>\n          ':`\n            <div class="remove-warning">\n              <i class="fas fa-info-circle"></i>\n              <p>${i?"Rimuovendo questo collaboratore, non potr√† pi√π gestire questo istituto.":"L'invito verr√† annullato e l'utente non potr√† pi√π accettarlo."}</p>\n            </div>\n          `}\n          \n          <div class="remove-confirm-checkbox">\n            <label>\n              <input type="checkbox" id="confirm-remove-checkbox">\n              <span>Confermo di voler procedere con questa azione</span>\n            </label>\n          </div>\n        </div>\n        <div class="modal-footer">\n          <button type="button" class="btn-secondary" id="cancel-remove-btn">\n            <i class="fas fa-times"></i> Annulla\n          </button>\n          <button type="button" class="btn-danger" id="confirm-remove-btn" disabled>\n            <i class="fas fa-trash"></i> Rimuovi\n          </button>\n        </div>\n      </div>\n    `,document.body.appendChild(a);const o=document.getElementById("confirm-remove-checkbox"),s=document.getElementById("confirm-remove-btn"),r=document.getElementById("cancel-remove-btn"),l=document.getElementById("close-remove-modal");o.addEventListener("change",()=>{s.disabled=!o.checked});const c=()=>a.remove();r.addEventListener("click",c),l.addEventListener("click",c),a.addEventListener("click",t=>{t.target===a&&c()}),s.addEventListener("click",async()=>{const e=n&&"delete-account"===document.querySelector('input[name="remove-type"]:checked')?.value;s.disabled=!0,s.innerHTML='<i class="fas fa-spinner fa-spin"></i> Rimozione...';try{const{data:i,error:n}=await this.supabase.rpc("delete_collaborator_with_account",{p_collaborator_id:t.id,p_delete_account:e});if(n)throw n;if(!i.success)throw new Error(i.error||"Errore durante la rimozione");c(),i.account_deleted?this.showNotification(`Collaboratore e account di ${t.email} eliminati`,"success"):this.showNotification("Collaboratore rimosso","success"),await this.loadCollaborators()}catch(t){console.error("‚ùå Error removing collaborator:",t),this.showNotification(t.message||"Errore durante la rimozione","error"),s.disabled=!1,s.innerHTML='<i class="fas fa-trash"></i> Rimuovi'}})}generateToken(){const t=new Uint8Array(32);return crypto.getRandomValues(t),Array.from(t,t=>t.toString(16).padStart(2,"0")).join("")}isValidEmail(t){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}showNotification(t,e="info"){if(window.showNotification)return void window.showNotification(t,e);const i=document.createElement("div");i.className=`toast-notification toast-${e}`,i.innerHTML=`\n      <i class="fas fa-${"error"===e?"exclamation-circle":"check-circle"}"></i>\n      <span>${t}</span>\n    `,i.style.cssText=`\n      position: fixed;\n      bottom: 20px;\n      right: 20px;\n      padding: 12px 20px;\n      background: ${"error"===e?"#ef4444":"#10b981"};\n      color: white;\n      border-radius: 8px;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      z-index: 10000;\n      animation: slideIn 0.3s ease;\n    `,document.body.appendChild(i),setTimeout(()=>i.remove(),3e3)}}class AcceptInviteHandler{constructor(){this.supabase=null,this.token=null,this.inviteDetails=null,this.currentUser=null}async init(){const t=new URLSearchParams(window.location.search);if(this.token=t.get("token"),!this.token)return void this.showError("Link di invito non valido");if(!window.supabaseClientManager)return void this.showError("Errore di connessione");if(this.supabase=await window.supabaseClientManager.getClient(),await this.loadInviteDetailsPublic(),!this.inviteDetails)return;const{data:{user:e}}=await this.supabase.auth.getUser();this.currentUser=e,e?this.inviteDetails.email===e.email?this.showNameForm():this.showError(`Questo invito √® per <strong>${this.inviteDetails.email}</strong>.<br><br>Sei loggato come <strong>${e.email}</strong>.<br><br>Effettua il logout e accedi con l'account corretto.`):this.showAuthForm()}async loadInviteDetailsPublic(){try{const{data:t,error:e}=await this.supabase.rpc("get_invite_details",{p_token:this.token});if(console.log("Invite details:",t,e),e||!t.success)return void this.showError(t?.error||"Invito non trovato o gi√† utilizzato");this.inviteDetails=t}catch(t){console.error("‚ùå Error loading invite details:",t),this.showError("Errore durante il caricamento dell'invito")}}showAuthForm(){const t=document.getElementById("invite-status");if(!t)return;const e={admin:"Amministratore",editor:"Editor",viewer:"Visualizzatore"};t.innerHTML=`\n      <div class="invite-form">\n        <h2>Sei stato invitato!</h2>\n        <p class="invite-subtitle">Crea un account o accedi per accettare l'invito</p>\n        \n        <div class="invite-info-box">\n          <p>\n            <i class="fas fa-building"></i> \n            Invitato come <strong>${e[this.inviteDetails.role]||this.inviteDetails.role}</strong> \n            per <strong>${this.escapeHtml(this.inviteDetails.institute_name)}</strong>\n          </p>\n          <p style="margin-top: 8px; font-size: 13px;">\n            <i class="fas fa-envelope"></i> Email: <strong>${this.escapeHtml(this.inviteDetails.email)}</strong>\n          </p>\n        </div>\n        \n        <div class="auth-tabs">\n          <button type="button" class="auth-tab active" data-tab="register">Registrati</button>\n          <button type="button" class="auth-tab" data-tab="login">Accedi</button>\n        </div>\n        \n        <form id="auth-form">\n          <div id="register-fields">\n            <div class="form-row">\n              <div class="form-group">\n                <label for="first-name">Nome <span class="required">*</span></label>\n                <input type="text" id="first-name" name="first_name" required placeholder="Il tuo nome">\n              </div>\n              <div class="form-group">\n                <label for="last-name">Cognome <span class="required">*</span></label>\n                <input type="text" id="last-name" name="last_name" required placeholder="Il tuo cognome">\n              </div>\n            </div>\n          </div>\n          \n          <div class="form-group">\n            <label for="auth-email">Email</label>\n            <input type="email" id="auth-email" value="${this.escapeHtml(this.inviteDetails.email)}" readonly \n                   style="background: #f3f4f6; cursor: not-allowed;">\n            <small style="color: #6b7280; font-size: 12px;">L'email √® quella dell'invito e non pu√≤ essere modificata</small>\n          </div>\n          \n          <div class="form-group">\n            <label for="auth-password">Password <span class="required">*</span></label>\n            <input type="password" id="auth-password" name="password" required placeholder="Crea una password" minlength="6">\n            <small id="password-hint" style="color: #6b7280; font-size: 12px;">Minimo 6 caratteri</small>\n          </div>\n          \n          <div class="form-actions">\n            <button type="submit" class="btn-primary" id="auth-submit-btn">\n              <i class="fas fa-user-plus"></i> <span>Registrati e Accetta</span>\n            </button>\n          </div>\n          \n          <div id="auth-error" style="display: none; margin-top: 16px; padding: 12px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; color: #dc2626; font-size: 14px;"></div>\n        </form>\n      </div>\n    `;const i=t.querySelectorAll(".auth-tab"),n=document.getElementById("register-fields"),a=document.getElementById("auth-submit-btn"),o=document.getElementById("password-hint");i.forEach(t=>{t.addEventListener("click",()=>{i.forEach(t=>t.classList.remove("active")),t.classList.add("active");const e="register"===t.dataset.tab;n.style.display=e?"block":"none",a.querySelector("span").textContent=e?"Registrati e Accetta":"Accedi e Accetta",a.querySelector("i").className=e?"fas fa-user-plus":"fas fa-sign-in-alt",o.textContent=e?"Minimo 6 caratteri":"Inserisci la tua password",document.getElementById("first-name").required=e,document.getElementById("last-name").required=e})});const s=document.getElementById("auth-form");s.addEventListener("submit",t=>this.handleAuthSubmit(t)),document.getElementById("first-name")?.focus()}async handleAuthSubmit(t){t.preventDefault();const e="register"===document.querySelector(".auth-tab.active")?.dataset.tab,i=this.inviteDetails.email,n=document.getElementById("auth-password")?.value,a=document.getElementById("first-name")?.value?.trim(),o=document.getElementById("last-name")?.value?.trim(),s=document.getElementById("auth-submit-btn"),r=document.getElementById("auth-error");if(r.style.display="none",!n||n.length<6)return r.textContent="La password deve essere di almeno 6 caratteri",void(r.style.display="block");if(e&&(!a||!o))return r.textContent="Inserisci nome e cognome",void(r.style.display="block");s.disabled=!0,s.innerHTML='<i class="fas fa-spinner fa-spin"></i> <span>Attendere...</span>';try{let t;if(t=e?await this.supabase.auth.signUp({email:i,password:n,options:{data:{first_name:a,last_name:o,user_type:"collaborator",invite_type:"collaborator"}}}):await this.supabase.auth.signInWithPassword({email:i,password:n}),t.error){console.error("Auth error:",t.error);let i=t.error.message;return i.includes("Invalid login credentials")?i='Credenziali non valide. Se non hai un account, usa la tab "Registrati".':i.includes("User already registered")?i='Esiste gi√† un account con questa email. Usa la tab "Accedi".':i.includes("Email not confirmed")&&(i="Devi confermare la tua email prima di accedere. Controlla la tua casella di posta."),r.textContent=i,r.style.display="block",s.disabled=!1,void(s.innerHTML=e?'<i class="fas fa-user-plus"></i> <span>Registrati e Accetta</span>':'<i class="fas fa-sign-in-alt"></i> <span>Accedi e Accetta</span>')}if(this.currentUser=t.data.user,e&&!t.data.session)return void this.showEmailConfirmation();await this.acceptInviteAfterAuth(a,o)}catch(t){console.error("‚ùå Auth error:",t),r.textContent="Errore durante l'autenticazione. Riprova.",r.style.display="block",s.disabled=!1,s.innerHTML=e?'<i class="fas fa-user-plus"></i> <span>Registrati e Accetta</span>':'<i class="fas fa-sign-in-alt"></i> <span>Accedi e Accetta</span>'}}showEmailConfirmation(){const t=document.getElementById("invite-status");t&&(t.innerHTML=`\n        <div class="invite-success" style="background: #fef3c7; border: 1px solid #fbbf24;">\n          <i class="fas fa-envelope" style="color: #f59e0b;"></i>\n          <h2 style="color: #92400e;">Conferma la tua email</h2>\n          <p style="color: #78350f;">\n            Ti abbiamo inviato un'email di conferma a <strong>${this.escapeHtml(this.inviteDetails.email)}</strong>.<br><br>\n            Clicca sul link nell'email per confermare il tuo account, poi torna su questa pagina per accettare l'invito.\n          </p>\n          <a href="${window.location.href}" class="btn-primary" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);">\n            <i class="fas fa-refresh"></i> Ho confermato, ricarica\n          </a>\n        </div>\n      `)}async acceptInviteAfterAuth(t,e){try{const{data:i,error:n}=await this.supabase.rpc("accept_collaborator_invite",{p_token:this.token,p_first_name:t||"",p_last_name:e||""});if(console.log("Accept invite result:",i,n),n)return console.error("RPC error:",n),void this.showError("Errore durante l'accettazione dell'invito");if(!i.success)return void this.showError(i.error||"Errore durante l'accettazione");this.showSuccess(i.institute_name||"l'istituto",t||"Collaboratore")}catch(t){console.error("‚ùå Error accepting invite:",t),this.showError("Errore durante l'accettazione dell'invito")}}showNameForm(){const t=document.getElementById("invite-status");if(!t)return;const e={admin:"Amministratore",editor:"Editor",viewer:"Visualizzatore"};t.innerHTML=`\n      <div class="invite-form">\n        <h2>Benvenuto!</h2>\n        <p class="invite-subtitle">Completa il tuo profilo per accettare l'invito</p>\n        \n        <div class="invite-info-box">\n          <p>\n            <i class="fas fa-building"></i> \n            Sei stato invitato come <strong>${e[this.inviteDetails.role]||this.inviteDetails.role}</strong> \n            per <strong>${this.escapeHtml(this.inviteDetails.institute_name)}</strong>\n          </p>\n        </div>\n        \n        <form id="accept-invite-form">\n          <div class="form-row">\n            <div class="form-group">\n              <label for="first-name">Nome <span class="required">*</span></label>\n              <input type="text" id="first-name" name="first_name" required placeholder="Il tuo nome">\n            </div>\n            <div class="form-group">\n              <label for="last-name">Cognome <span class="required">*</span></label>\n              <input type="text" id="last-name" name="last_name" required placeholder="Il tuo cognome">\n            </div>\n          </div>\n          \n          <div class="form-actions">\n            <button type="submit" class="btn-primary">\n              <i class="fas fa-check"></i> Accetta Invito\n            </button>\n          </div>\n        </form>\n      </div>\n    `;const i=document.getElementById("accept-invite-form");i.addEventListener("submit",t=>this.handleAcceptSubmit(t)),document.getElementById("first-name")?.focus()}async handleAcceptSubmit(t){t.preventDefault();const e=document.getElementById("first-name")?.value?.trim(),i=document.getElementById("last-name")?.value?.trim(),n=t.target.querySelector('button[type="submit"]');if(e&&i){n&&(n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin"></i> Accettazione in corso...');try{const{data:t,error:n}=await this.supabase.rpc("accept_collaborator_invite",{p_token:this.token,p_first_name:e,p_last_name:i});if(console.log("Accept invite result:",t,n),n)return console.error("RPC error:",n),void this.showError("Errore durante l'accettazione dell'invito");if(!t.success)return void this.showError(t.error||"Errore durante l'accettazione");this.showSuccess(t.institute_name||"l'istituto",e)}catch(t){console.error("‚ùå Error accepting invite:",t),this.showError("Errore durante l'accettazione dell'invito")}}else alert("Inserisci nome e cognome")}showError(t){const e=document.getElementById("invite-status");e&&(e.innerHTML=`\n        <div class="invite-error">\n          <i class="fas fa-times-circle"></i>\n          <h2>Invito non valido</h2>\n          <p>${t}</p>\n          <a href="../../homepage.html" class="btn-primary">Torna alla Home</a>\n        </div>\n      `)}showSuccess(t,e){const i=document.getElementById("invite-status");i&&(i.innerHTML=`\n        <div class="invite-success">\n          <i class="fas fa-check-circle"></i>\n          <h2>Benvenuto, ${this.escapeHtml(e)}!</h2>\n          <p>Ora sei un collaboratore di <strong>${this.escapeHtml(t)}</strong></p>\n          <a href="../../homepage.html" class="btn-primary">\n            <i class="fas fa-home"></i> Vai alla Home\n          </a>\n        </div>\n      `)}escapeHtml(t){const e=document.createElement("div");return e.textContent=t||"",e.innerHTML}}window.CollaboratorsManager=CollaboratorsManager,window.AcceptInviteHandler=AcceptInviteHandler,document.addEventListener("DOMContentLoaded",()=>{if(document.getElementById("invite-status")){const t=new AcceptInviteHandler;t.init()}});