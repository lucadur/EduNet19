class EduNetReviewManager{constructor(){this.supabase=window.eduNetAuth?window.eduNetAuth.supabase:null,this.currentInstituteId=null,this.currentUser=null,this.currentUserType=null,this.editingReviewId=null,this.reviewsListEl=null,this.reviewFormEl=null,this.ratingSummaryEl=null}async init(e){if(this.currentInstituteId=e,window.supabaseClientManager?this.supabase=await window.supabaseClientManager.getClient():window.eduNetAuth&&window.eduNetAuth.supabase&&(this.supabase=window.eduNetAuth.supabase),this.supabase||(console.error("Supabase non inizializzato in ReviewManager - tentativo recupero tardivo"),window.supabaseClientManager&&(await new Promise(e=>setTimeout(e,500)),this.supabase=await window.supabaseClientManager.getClient())),this.supabase){if(window.eduNetAuth){const e=window.eduNetAuth.getCurrentUser();e&&(this.currentUser=e)}else if(this.supabase.auth){const{data:{user:e}}=await this.supabase.auth.getUser();this.currentUser=e}if(this.currentUser){if(window.eduNetProfileManager){const e=await window.eduNetProfileManager.loadCurrentUserProfile();this.currentUserType=e?.user_type||"private"}else try{const{data:e}=await this.supabase.from("user_profiles").select("user_type").eq("id",this.currentUser.id).maybeSingle();this.currentUserType=e?.user_type||"private"}catch(e){console.warn("Errore recupero tipo utente in ReviewManager",e),this.currentUserType="private"}console.log("ReviewManager: User Type detected:",this.currentUserType)}this.bindElements(),await this.loadReviews()}else console.error("❌ ERRORE FATALE: Supabase non disponibile in ReviewManager")}bindElements(){this.reviewsListEl=document.getElementById("reviews-list"),this.reviewFormEl=document.getElementById("review-form"),this.ratingSummaryEl=document.getElementById("rating-summary"),this.reviewFormEl&&this.reviewFormEl.addEventListener("submit",e=>this.handleReviewSubmit(e)),this.updateFormVisibility()}updateFormVisibility(){const e=document.getElementById("review-comment-group");if(e)if("private"===this.currentUserType){e.style.display="none";const t=e.querySelector("textarea");t&&t.removeAttribute("required")}else"institute"===this.currentUserType&&(e.style.display="block")}async loadReviews(){if(this.reviewsListEl){this.reviewsListEl.innerHTML='<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Caricamento recensioni...</div>';try{let e=this.supabase.from("institute_reviews").select("\n                    *,\n                    reviewer:reviewer_id (\n                        display_name,\n                        avatar_url,\n                        user_type\n                    )\n                ").eq("reviewed_institute_id",this.currentInstituteId).order("created_at",{ascending:!1});const t=this.currentUser&&this.currentUser.id===this.currentInstituteId;t||(e=this.currentUser?e.or(`status.eq.approved,reviewer_id.eq.${this.currentUser.id}`):e.eq("status","approved"));const{data:i,error:n}=await e;if(n)throw n;this.renderReviews(i,t),this.updateRatingSummary(i),t&&this.loadWrittenReviews()}catch(e){console.error("Errore caricamento recensioni:",e),this.reviewsListEl.innerHTML='<div class="error-message">Impossibile caricare le recensioni.</div>'}}}async loadWrittenReviews(){const e=document.createElement("div");e.id="written-reviews-section",e.className="reviews-section",e.style.marginTop="40px",e.innerHTML='<h3>Le tue recensioni inviate</h3><div id="written-reviews-list" class="reviews-list"></div>',this.reviewsListEl&&!document.getElementById("written-reviews-section")&&this.reviewsListEl.parentNode.appendChild(e);const t=document.getElementById("written-reviews-list");if(t){t.innerHTML='<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Caricamento...</div>';try{const{data:e,error:i}=await this.supabase.from("institute_reviews").select("\n                    *,\n                    reviewed_institute:school_institutes!institute_reviews_reviewed_institute_id_fkey(\n                        institute_name,\n                        logo_url,\n                        city\n                    )\n                ").eq("reviewer_id",this.currentUser.id).order("created_at",{ascending:!1});if(i)throw i;if(!e||0===e.length)return void(t.innerHTML='<p class="text-muted">Non hai ancora scritto recensioni.</p>');t.innerHTML=e.map(e=>{const t=e.reviewed_institute?.institute_name||"Istituto",i=e.reviewed_institute?.logo_url||"assets/images/default-institute.png",n="approved"===e.status?'<span class="badge badge-success">Approvata</span>':"rejected"===e.status?'<span class="badge badge-danger">Rifiutata</span>':'<span class="badge badge-warning">In attesa</span>';return`\n                    <div class="review-card">\n                        <div class="review-header">\n                            <img src="${i}" alt="${t}" class="reviewer-avatar">\n                            <div class="reviewer-info">\n                                <div class="reviewer-name">\n                                    A: ${this.escapeHtml(t)}\n                                    ${n}\n                                </div>\n                                <div class="review-meta">\n                                    <div class="stars-container size-small">\n                                        ${this.renderStars(e.rating)}\n                                    </div>\n                                    <span class="review-date">${new Date(e.created_at).toLocaleDateString("it-IT")}</span>\n                                </div>\n                            </div>\n                        </div>\n                        <div class="review-content">\n                            ${e.comment?`<div class="review-text">${this.escapeHtml(e.comment)}</div>`:""}\n                        </div>\n                    </div>\n                `}).join("")}catch(e){console.error("Errore caricamento recensioni inviate:",e),t.innerHTML='<div class="error-message">Impossibile caricare le recensioni inviate.</div>'}}}renderReviews(e,t){e&&0!==e.length?this.reviewsListEl.innerHTML=e.map(e=>{const i="pending"===e.status,n="rejected"===e.status,s=e.reviewer?.display_name||"Utente EduNet",r=e.reviewer?.avatar_url,a="institute"===e.reviewer?.user_type?"Istituto":"Privato",o="institute"===e.reviewer?.user_type?"badge-institute":"badge-private";let d="";t&&i&&(d=`\n                    <div class="moderation-actions">\n                        <button class="btn-reject" onclick="window.eduNetReviewManager.moderateReview('${e.id}', 'rejected')">\n                            <i class="fas fa-times"></i> Rifiuta\n                        </button>\n                        <button class="btn-approve" onclick="window.eduNetReviewManager.moderateReview('${e.id}', 'approved')">\n                            <i class="fas fa-check"></i> Approva\n                        </button>\n                    </div>\n                `);let c="";i&&(c='<span class="pending-badge">In attesa di approvazione</span>'),n&&t&&(c='<span class="pending-badge" style="background:red;">Rifiutata</span>');const l=this.currentUser&&e.reviewer_id===this.currentUser.id;let u="";if(l){const t=JSON.stringify(e).replace(/"/g,"&quot;");u=`\n                    <button class="btn-text" onclick='window.eduNetReviewManager.handleEditReview(${t})' style="margin-left: auto; color: var(--color-primary); font-size: 0.9em;">\n                        <i class="fas fa-edit"></i> Modifica\n                    </button>\n                `}if(!t&&n)return"";const v=r?`<img src="${r}" alt="${s}" class="reviewer-avatar" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">\n                   <div class="reviewer-avatar default-avatar-fallback" style="display:none; align-items:center; justify-content:center; background:#eee; border-radius:50%; width:40px; height:40px;"><i class="fas fa-user" style="color:#666;"></i></div>`:'<div class="reviewer-avatar default-avatar-fallback" style="display:flex; align-items:center; justify-content:center; background:#eee; border-radius:50%; width:40px; height:40px;"><i class="fas fa-user" style="color:#666;"></i></div>';return`\n                <div class="review-card ${i?"pending":""}" data-id="${e.id}">\n                    <div class="review-header">\n                        <div class="avatar-container">\n                            ${v}\n                        </div>\n                        <div class="reviewer-info">\n                            <div class="reviewer-name">\n                                ${this.escapeHtml(s)}\n                                <span class="badge ${o}">${a}</span>\n                                ${c}\n                            </div>\n                            <div class="review-meta">\n                                <div class="stars-container size-small">\n                                    ${this.renderStars(e.rating)}\n                                </div>\n                                <span class="review-date">${new Date(e.created_at).toLocaleDateString("it-IT")}</span>\n                            </div>\n                        </div>\n                        ${u}\n                    </div>\n                    <div class="review-content">\n                        ${e.comment?`<div class="review-text">${this.escapeHtml(e.comment)}</div>`:""}\n                    </div>\n                    ${d}\n                </div>\n            `}).join(""):this.reviewsListEl.innerHTML='\n                <div class="no-reviews">\n                    <i class="far fa-comment-alt"></i>\n                    <p>Nessuna recensione ancora presente.</p>\n                </div>\n            '}renderStars(e){let t="";for(let i=1;i<=5;i++){const n=i<=e?"fas":"far",s=i<=e?"filled":"";t+=`<i class="${n} fa-star star ${s}"></i>`}return t}async handleReviewSubmit(e){if(e.preventDefault(),!this.currentUser)return void alert("Devi effettuare l'accesso per scrivere una recensione.");const t=document.querySelector('input[name="rating"]:checked')?.value,i=document.getElementById("review-comment")?.value;if(t)try{const e={reviewed_institute_id:this.currentInstituteId,reviewer_id:this.currentUser.id,rating:parseInt(t),comment:"institute"===this.currentUserType?i:null,status:"pending",is_verified:!1,reviewer_type:this.currentUserType};let n;if(this.editingReviewId){e.updated_at=(new Date).toISOString();const{error:t}=await this.supabase.from("institute_reviews").update(e).eq("id",this.editingReviewId);n=t}else{const{error:t}=await this.supabase.from("institute_reviews").insert(e);n=t}if(n)throw n;const s=this.editingReviewId?"Recensione aggiornata! Sarà visibile dopo l'approvazione.":"Recensione inviata con successo! Sarà visibile dopo l'approvazione dell'istituto.";alert(s),this.resetForm(),this.loadReviews()}catch(e){console.error("Errore invio recensione:",e),alert("Errore durante l'invio della recensione.")}else alert("Seleziona una valutazione in stelle.")}resetForm(){this.reviewFormEl.reset(),this.editingReviewId=null;const e=this.reviewFormEl.querySelector('button[type="submit"]');e&&(e.innerHTML='Invia Recensione <i class="fas fa-paper-plane"></i>');const t=document.getElementById("cancel-edit-btn");t&&t.remove()}handleEditReview(e){this.editingReviewId=e.id;const t=document.querySelector(`input[name="rating"][value="${e.rating}"]`);t&&(t.checked=!0);const i=document.getElementById("review-comment");i&&e.comment&&(i.value=e.comment),this.reviewFormEl.scrollIntoView({behavior:"smooth"});const n=this.reviewFormEl.querySelector('button[type="submit"]');if(n&&(n.innerHTML='Aggiorna Recensione <i class="fas fa-sync"></i>'),!document.getElementById("cancel-edit-btn")){const e=document.createElement("button");e.id="cancel-edit-btn",e.type="button",e.className="btn-secondary",e.style.marginLeft="10px",e.innerHTML="Annulla",e.onclick=()=>this.resetForm(),n.parentNode.appendChild(e)}}async moderateReview(e,t){try{const{error:i}=await this.supabase.from("institute_reviews").update({status:t}).eq("id",e);if(i)throw i;await this.loadReviews()}catch(e){console.error("Errore moderazione recensione:",e),alert("Errore durante l'aggiornamento della recensione.")}}updateRatingSummary(e){const t=e.filter(e=>"approved"===e.status);if(0===t.length)return;const i=t.length,n=t.reduce((e,t)=>e+t.rating,0),s=(n/i).toFixed(1),r=document.querySelector(".rating-number"),a=document.querySelector(".rating-count");r&&(r.textContent=s),a&&(a.textContent=`${i} Recensioni`)}escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}}window.eduNetReviewManager=new EduNetReviewManager;