class ProfileGallery{constructor(){this.maxPhotos=20,this.photos=[],this.currentLightboxIndex=0,this.init()}init(){this.setupEventListeners()}setupEventListeners(){const e=document.getElementById("gallery-upload-btn");e&&e.addEventListener("click",()=>this.openUploadModal());const t=document.getElementById("gallery-tab-btn");t&&t.addEventListener("click",async()=>{await this.loadGallery()})}async loadGallery(){const e=document.getElementById("gallery-grid");if(e)try{const e=await window.supabaseClientManager.getClient();if(!e)return console.error("❌ Supabase client not available"),void this.showError("Errore di connessione. Ricarica la pagina.");const{data:{user:t}}=await e.auth.getUser();if(!t)return;const{data:o,error:l}=await e.from("profile_gallery").select("*").eq("user_id",t.id).order("created_at",{ascending:!1}).limit(this.maxPhotos);if(l)throw l;this.photos=o||[],this.renderGallery()}catch(e){console.error("Error loading gallery:",e),this.showError("Errore nel caricamento della galleria")}}renderGallery(){const e=document.getElementById("gallery-grid"),t=document.getElementById("gallery-empty"),o=document.querySelector(".gallery-content"),l=document.getElementById("gallery-upload-btn"),a=e.querySelectorAll(".gallery-item");if(a.forEach(e=>e.remove()),0===this.photos.length)return t&&(t.style.display="flex"),l&&(l.style.display="none"),void(o&&o.classList.add("has-empty-state"));t&&(t.style.display="none"),l&&(l.style.display=""),o&&o.classList.remove("has-empty-state"),this.photos.forEach((t,o)=>{const l=this.createPhotoElement(t,o);e.appendChild(l)}),this.updateCounter()}createPhotoElement(e,t){const o=document.createElement("div");o.className="gallery-item",o.setAttribute("data-photo-id",e.id);const l=this.getPhotoUrl(e.photo_url),a=new Date(e.created_at).toLocaleDateString("it-IT",{day:"numeric",month:"long",year:"numeric"});return o.innerHTML=`\n      <div class="gallery-image-container">\n        <img src="${l}" alt="${e.caption||"Foto istituto"}" class="gallery-image" loading="lazy">\n      </div>\n      <div class="gallery-item-overlay">\n        <div class="gallery-item-info">\n          <p class="gallery-item-date">${a}</p>\n          ${e.caption?`<p class="gallery-item-caption">${this.escapeHtml(e.caption)}</p>`:""}\n        </div>\n      </div>\n      <div class="gallery-item-actions">\n        <button class="gallery-action-btn delete" onclick="profileGallery.deletePhoto('${e.id}')" aria-label="Elimina foto">\n          <i class="fas fa-trash"></i>\n        </button>\n      </div>\n    `,o.addEventListener("click",e=>{e.target.closest(".gallery-action-btn")||this.openLightbox(t)}),o}getPhotoUrl(e){if(!e)return"";if(e.startsWith("http"))return e;const t=window.supabaseClientManager?.client;if(!t)return console.warn("Supabase not ready, returning placeholder"),"";const{data:o}=t.storage.from("profile-gallery").getPublicUrl(e);return o.publicUrl}openUploadModal(){if(this.photos.length>=this.maxPhotos)return void this.showError(`Hai raggiunto il limite massimo di ${this.maxPhotos} foto`);let e=document.getElementById("gallery-upload-modal");e||(e=this.createUploadModal(),document.body.appendChild(e)),e.classList.add("active"),document.body.style.overflow="hidden"}createUploadModal(){const e=document.createElement("div");e.id="gallery-upload-modal",e.className="gallery-upload-modal",e.innerHTML='\n      <div class="gallery-upload-content">\n        <div class="gallery-upload-header">\n          <h3><i class="fas fa-upload"></i> Carica Foto</h3>\n          <button class="gallery-upload-close" onclick="profileGallery.closeUploadModal()" aria-label="Chiudi">\n            <i class="fas fa-times"></i>\n          </button>\n        </div>\n\n        <div class="gallery-dropzone" id="gallery-dropzone">\n          <i class="fas fa-cloud-upload-alt"></i>\n          <p>Trascina foto qui o clicca per selezionare</p>\n          <small>JPG, PNG o GIF - Max 5MB per foto - Fino a 20 foto</small>\n          <input type="file" id="gallery-file-input" accept="image/*" multiple style="display: none;">\n        </div>\n\n        <form class="gallery-upload-form" id="gallery-upload-form" style="display: none;">\n          <div class="gallery-form-group">\n            <label for="gallery-caption">Didascalia (opzionale)</label>\n            <textarea id="gallery-caption" placeholder="Descrivi questa foto..." maxlength="200"></textarea>\n          </div>\n\n          <div class="gallery-upload-actions">\n            <button type="button" class="btn-secondary" onclick="profileGallery.closeUploadModal()">\n              Annulla\n            </button>\n            <button type="submit" class="btn-primary">\n              <i class="fas fa-upload"></i>\n              Carica Foto\n            </button>\n          </div>\n        </form>\n      </div>\n    ';const t=e.querySelector("#gallery-dropzone"),o=e.querySelector("#gallery-file-input"),l=e.querySelector("#gallery-upload-form");return t.addEventListener("click",()=>o.click()),t.addEventListener("dragover",e=>{e.preventDefault(),t.classList.add("dragover")}),t.addEventListener("dragleave",()=>{t.classList.remove("dragover")}),t.addEventListener("drop",e=>{e.preventDefault(),t.classList.remove("dragover");const o=Array.from(e.dataTransfer.files).filter(e=>e.type.startsWith("image/"));o.length>0&&this.handleMultipleFiles(o)}),o.addEventListener("change",e=>{const t=Array.from(e.target.files);t.length>0&&this.handleMultipleFiles(t)}),l.addEventListener("submit",e=>{e.preventDefault(),this.uploadPhoto()}),e.addEventListener("click",t=>{t.target===e&&this.closeUploadModal()}),e}handleMultipleFiles(e){const t=this.maxPhotos-this.photos.length;if(e.length>t)return void this.showError(`Puoi caricare massimo ${t} foto (limite ${this.maxPhotos} raggiunto)`);const o=[];for(const t of e)t.type.startsWith("image/")?t.size>5242880?this.showError(`${t.name} è troppo grande (max 5MB)`):o.push(t):this.showError(`${t.name} non è un'immagine valida`);0!==o.length&&(this.selectedFiles=o,this.showFilesPreviews(o))}showFilesPreviews(e){const t=document.getElementById("gallery-dropzone"),o=document.getElementById("gallery-upload-form");t.style.display="none",o.style.display="flex";const l=e.map((e,t)=>{const o=new FileReader;return o.onload=e=>{const o=document.querySelector(`#preview-${t}`);o&&(o.src=e.target.result)},o.readAsDataURL(e),`\n        <div class="gallery-preview-item" id="preview-container-${t}">\n          <img id="preview-${t}" class="gallery-preview-img" alt="Preview ${t+1}">\n          <div class="gallery-preview-name">${e.name}</div>\n        </div>\n      `}).join("");t.innerHTML=`\n      <div class="gallery-previews-grid">\n        ${l}\n      </div>\n      <p class="gallery-upload-count">${e.length} foto selezionate</p>\n    `,t.style.display="block",t.style.border="none",t.style.padding="var(--space-4)"}handleFileSelect(e){this.handleMultipleFiles([e])}async uploadPhoto(){if(!this.selectedFiles||0===this.selectedFiles.length)return;const e=document.querySelector('#gallery-upload-form button[type="submit"]'),t=e.innerHTML;e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Caricamento...';try{const t=await window.supabaseClientManager.getClient();if(!t)throw new Error("Supabase client not available");const{data:{user:o}}=await t.auth.getUser();if(!o)throw new Error("Utente non autenticato");const l=document.getElementById("gallery-caption").value.trim(),a=[];let i=0,n=0;e.innerHTML=`<i class="fas fa-spinner fa-spin"></i> Caricamento 0/${this.selectedFiles.length}...`;for(let r=0;r<this.selectedFiles.length;r++){const s=this.selectedFiles[r];try{const n=s.name.split(".").pop(),c=`${o.id}/${Date.now()}_${r}.${n}`,{error:d}=await t.storage.from("profile-gallery").upload(c,s);if(d)throw d;const{data:h,error:p}=await t.from("profile_gallery").insert({user_id:o.id,photo_url:c,caption:1===this.selectedFiles.length&&l||null}).select().single();if(p)throw p;a.push(h),i++,e.innerHTML=`<i class="fas fa-spinner fa-spin"></i> Caricamento ${i}/${this.selectedFiles.length}...`}catch(e){console.error(`Error uploading ${s.name}:`,e),n++}}this.photos.unshift(...a),this.renderGallery(),this.closeUploadModal(),0===n?this.showSuccess(`${i} foto caricate con successo!`):this.showError(`${i} foto caricate, ${n} errori`)}catch(e){console.error("Error uploading photo:",e),this.showError("Errore nel caricamento della foto")}finally{e.disabled=!1,e.innerHTML=t}}closeUploadModal(){const e=document.getElementById("gallery-upload-modal");e&&(e.classList.remove("active"),document.body.style.overflow="",setTimeout(()=>{const e=document.getElementById("gallery-dropzone"),t=document.getElementById("gallery-upload-form"),o=document.getElementById("gallery-file-input");e&&(e.style.display="block",e.style.border="",e.style.padding="",e.innerHTML='\n            <i class="fas fa-cloud-upload-alt"></i>\n            <p>Trascina una foto qui o clicca per selezionare</p>\n            <small>JPG, PNG o GIF - Max 5MB</small>\n          '),t&&(t.style.display="none"),o&&(o.value=""),this.selectedFile=null},300))}async deletePhoto(e){if(confirm("Sei sicuro di voler eliminare questa foto?"))try{const t=await window.supabaseClientManager.getClient();if(!t)throw new Error("Supabase client not available");const o=this.photos.find(t=>t.id===e);if(!o)return;const{error:l}=await t.storage.from("profile-gallery").remove([o.photo_url]);l&&console.error("Storage delete error:",l);const{error:a}=await t.from("profile_gallery").delete().eq("id",e);if(a)throw a;this.photos=this.photos.filter(t=>t.id!==e),this.renderGallery(),this.showSuccess("Foto eliminata")}catch(e){console.error("Error deleting photo:",e),this.showError("Errore nell'eliminazione della foto")}}openLightbox(e){this.currentLightboxIndex=e;let t=document.getElementById("gallery-lightbox");t||(t=this.createLightbox(),document.body.appendChild(t)),this.updateLightbox(),t.classList.add("active"),document.body.style.overflow="hidden"}createLightbox(){const e=document.createElement("div");return e.id="gallery-lightbox",e.className="gallery-lightbox",e.innerHTML='\n      <div class="gallery-lightbox-content">\n        <button class="gallery-lightbox-close" onclick="profileGallery.closeLightbox()" aria-label="Chiudi">\n          <i class="fas fa-times"></i>\n        </button>\n        <button class="gallery-lightbox-nav prev" onclick="profileGallery.prevPhoto()" aria-label="Foto precedente">\n          <i class="fas fa-chevron-left"></i>\n        </button>\n        <img src="" alt="" class="gallery-lightbox-image" id="lightbox-image">\n        <button class="gallery-lightbox-nav next" onclick="profileGallery.nextPhoto()" aria-label="Foto successiva">\n          <i class="fas fa-chevron-right"></i>\n        </button>\n      </div>\n    ',e.addEventListener("click",t=>{t.target===e&&this.closeLightbox()}),document.addEventListener("keydown",t=>{e.classList.contains("active")&&("Escape"===t.key&&this.closeLightbox(),"ArrowLeft"===t.key&&this.prevPhoto(),"ArrowRight"===t.key&&this.nextPhoto())}),e}updateLightbox(){const e=this.photos[this.currentLightboxIndex];if(!e)return;const t=document.getElementById("lightbox-image");t&&(t.src=this.getPhotoUrl(e.photo_url),t.alt=e.caption||"Foto istituto")}prevPhoto(){this.currentLightboxIndex=(this.currentLightboxIndex-1+this.photos.length)%this.photos.length,this.updateLightbox()}nextPhoto(){this.currentLightboxIndex=(this.currentLightboxIndex+1)%this.photos.length,this.updateLightbox()}closeLightbox(){const e=document.getElementById("gallery-lightbox");e&&(e.classList.remove("active"),document.body.style.overflow="")}updateCounter(){const e=document.getElementById("gallery-upload-btn");if(!e)return;const t=e.querySelector(".gallery-counter");t&&t.remove();const o=document.createElement("span");o.className="gallery-counter",this.photos.length>=this.maxPhotos?o.classList.add("full"):this.photos.length>=this.maxPhotos-3&&o.classList.add("warning"),o.textContent=`${this.photos.length}/${this.maxPhotos}`,e.appendChild(o),this.photos.length>=this.maxPhotos?(e.disabled=!0,e.style.opacity="0.6",e.style.cursor="not-allowed"):(e.disabled=!1,e.style.opacity="1",e.style.cursor="pointer")}showSuccess(e){window.showNotification?window.showNotification(e,"success"):alert(e)}showError(e){window.showNotification?window.showNotification(e,"error"):alert(e)}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}}let profileGallery;document.addEventListener("DOMContentLoaded",()=>{profileGallery=new ProfileGallery}),window.profileGallery=profileGallery;