class ProfilePage{constructor(){this.currentUser=null,this.currentTab="about",this.supabase=null,this.profileUserType=null,this.init()}async init(){console.log("üîµ ProfilePage initializing..."),console.log("üìç Current URL:",window.location.href),console.log("üìç Search params:",window.location.search),await this.initSupabase(),await this.loadCurrentUserNavbar();const e=new URLSearchParams(window.location.search).get("id");console.log("üìç Profile ID from URL:",e),await this.loadUserProfile(e),window.avatarManager,this.setupEventListeners(),console.log("‚úÖ ProfilePage initialized")}async initSupabase(){if(window.supabaseClientManager){this.supabase=await window.supabaseClientManager.getClient();const{data:{user:e}}=await this.supabase.auth.getUser();this.currentUser=e}}setupEventListeners(){document.querySelectorAll(".tab-button").forEach(e=>{e.addEventListener("click",t=>{const o=e.getAttribute("aria-controls").replace("-tab","");this.switchTab(o)})});const e=document.getElementById("logout-btn");e&&e.addEventListener("click",()=>this.handleLogout());const t=document.getElementById("user-menu-btn"),o=t?.closest(".nav-item.dropdown");t&&o&&(t.addEventListener("click",e=>{e.stopPropagation(),document.querySelectorAll(".nav-item.dropdown.open").forEach(e=>{e!==o&&e.classList.remove("open")}),o.classList.toggle("open")}),document.addEventListener("click",()=>{o.classList.remove("open")})),[document.getElementById("notifications-btn"),document.getElementById("messages-btn")].forEach(e=>{if(e){const t=e.closest(".nav-item.dropdown");t&&e.addEventListener("click",e=>{e.stopPropagation(),document.querySelectorAll(".nav-item.dropdown.open").forEach(e=>{e!==t&&e.classList.remove("open")}),t.classList.toggle("open")})}})}async loadCurrentUserNavbar(){try{if(!this.currentUser||!this.supabase)return;const e=this.currentUser.id,{data:t}=await this.supabase.from("user_profiles").select("user_type").eq("id",e).maybeSingle();if(!t)return;let o="Utente",i="Utente";const{data:n}=await this.supabase.rpc("get_collaborator_profile");if(n?.is_collaborator){const e={admin:"Amministratore",editor:"Editor",viewer:"Visualizzatore"};o=`${n.first_name||""} ${n.last_name||""}`.trim()||"Collaboratore",i=`${e[n.role]||"Collaboratore"} - ${n.institute_name}`,this.collaboratorData=n,console.log("üë• Navbar: Collaboratore rilevato:",o)}else if("istituto"===t.user_type){const{data:t}=await this.supabase.from("school_institutes").select("institute_name, institute_type").eq("id",e).maybeSingle();t&&(o=t.institute_name||"Istituto",i=t.institute_type||"Istituto Scolastico")}else{const{data:t}=await this.supabase.from("private_users").select("first_name, last_name, profession").eq("id",e).maybeSingle();t?(o=`${t.first_name||""} ${t.last_name||""}`.trim()||"Utente",i=t.profession||"Utente Privato"):o="Utente"}const s=document.getElementById("user-name"),a=document.getElementById("user-full-name"),l=document.getElementById("user-type-display"),r=document.getElementById("mobile-user-name"),c=document.getElementById("mobile-user-type");s&&(s.textContent=o,s.classList.add("loaded")),a&&(a.textContent=o,a.classList.add("loaded")),l&&(l.textContent=i,l.classList.add("loaded")),r&&(r.textContent=o,r.classList.add("loaded")),c&&(c.textContent=i,c.classList.add("loaded")),console.log("‚úÖ Navbar updated for current user:",o)}catch(e){console.error("Error updating navbar:",e)}}async loadUserProfile(e=null){try{if(!this.supabase)return console.error("‚ùå Supabase not available"),void this.showEmptyProfile();const t=e||this.currentUser?.id;if(!t)return console.error("‚ùå No user ID available"),void this.showEmptyProfile();this.profileUserId=t,console.log("üîç Loading profile for user:",t);const o=this.currentUser&&t===this.currentUser.id;console.log("üë§ Is own profile:",o);const{data:i}=await this.supabase.from("user_privacy_settings").select("*").eq("user_id",t).maybeSingle();if(this.currentProfilePrivacy=i||{},!o&&i&&"private"===i.profile_visibility)return console.log("üîí Profilo privato, accesso negato"),void this.showPrivateProfile();const{data:n}=await this.supabase.from("user_profiles").select("user_type").eq("id",t).maybeSingle();if(!n)return console.error("‚ùå User profile not found in user_profiles"),void this.showEmptyProfile();if(console.log("‚úÖ User type:",n.user_type),"istituto"===n.user_type){const{data:e,error:n}=await this.supabase.from("school_institutes").select("*").eq("id",t).maybeSingle();if(n)throw console.error("‚ùå Error loading institute profile:",n),n;let s=e&&e.institute_name&&e.institute_type;if(e?.institute_code&&e.institute_code.length>=8&&/^[A-Z]{4}\d{5,6}[A-Z0-9]?$/i.test(e.institute_code))console.log("‚úÖ Istituto con codice MIUR valido:",e.institute_code),s=!0;else if(s&&e.institute_name){console.log("‚ÑπÔ∏è Nessun codice MIUR, verifico nome istituto...");const t=["liceo","istituto","scuola","comprensivo","tecnico","professionale","universit√†","politecnico","accademia","conservatorio","elementare","media","superiore","infanzia","primaria","secondaria","convitto","educandato","seminario","collegio","cfp","itis","ipsia","ipssar"],o=e.institute_name.toLowerCase();t.some(e=>o.includes(e))||e.institute_code||(["Scuola dell'Infanzia","Scuola Primaria","Scuola Secondaria","Scuola Secondaria di I Grado","Scuola Secondaria di II Grado","Liceo","Liceo Scientifico","Liceo Classico","Liceo Linguistico","Liceo Artistico","Istituto Tecnico","Istituto Professionale","Istituto Comprensivo","Istituto Superiore","ITS","Universit√†","Politecnico","Accademia","Conservatorio","Ente di Formazione","Altro"].some(t=>e.institute_type?.toLowerCase().includes(t.toLowerCase())||t.toLowerCase().includes(e.institute_type?.toLowerCase()))?(console.log("‚úÖ Tipo istituto valido, accetto come scuola:",e.institute_type),s=!0):(console.log("‚ÑπÔ∏è Tipo non in lista ma user_profiles dice istituto, accetto"),s=!0))}if(s){console.log("‚úÖ Institute profile loaded:",e),this.updateProfileUI(e,"istituto",i,o),await this.loadProfileStats(e.id),await this.loadProfileRating(e.id),window.instituteContactManager&&await window.instituteContactManager.init(e.id,e),this.updateProfileActions(o);const t=()=>{const t=document.getElementById("profile-avatar");if(t)if(e.logo_url){t.style.backgroundImage=`url(${e.logo_url})`,t.style.backgroundSize="cover",t.style.backgroundPosition="center";const o=t.querySelector("i");o&&(o.style.display="none"),console.log("üé® Forced institute avatar:",e.logo_url)}else{t.style.backgroundImage="none";const e=t.querySelector("i");e&&(e.style.display="block"),console.log("üé® No institute logo, showing placeholder")}};t(),setTimeout(t,500)}else{console.warn("‚ö†Ô∏è No valid institute profile found (missing name/type). Checking if private user...");let n=null;const{data:a}=await this.supabase.from("private_users").select("*").eq("id",t).maybeSingle();if(a)n=a;else if(o){const e=await this.supabase.auth.getUser(),o=e.data.user?.user_metadata;!o||"privato"!==o.user_type&&"privato"!==o.type||(console.log("‚úÖ Metadata confirm private user (Deadlock Breaker)"),n={id:t,first_name:o.first_name||o.name||"Utente",last_name:o.last_name||o.surname||""})}if(!n&&!s){console.warn("üî• FORZA TIPO PRIVATO: Dati istituto invalidi, assumo utente privato");let o="Utente",i="";if(e&&e.institute_name){const t=e.institute_name.split(" ");o=t[0]||"Utente",i=t.slice(1).join(" ")||""}n={id:t,first_name:o,last_name:i}}if(n)return console.log("‚úÖ Found as private user! Correcting type..."),o&&(this.supabase.from("user_profiles").update({user_type:"privato"}).eq("id",t).then(({error:e})=>{e?console.error("‚ùå Errore aggiornamento user_type:",e):console.log("‚úÖ user_type aggiornato a privato nel DB")}),a||this.supabase.from("private_users").upsert([{id:t,first_name:n.first_name,last_name:n.last_name,privacy_level:"pubblico"}],{onConflict:"id"}).then(({error:e})=>{e?console.error("‚ùå Errore creazione private_users:",e):console.log("‚úÖ Record private_users creato/aggiornato")}),e&&!e.institute_code?(console.log("üóëÔ∏è Rimozione record zombie (senza codice MIUR)"),this.supabase.from("school_institutes").delete().eq("id",t).then(({error:e})=>{e?console.error("‚ùå Errore rimozione school_institutes zombie:",e):console.log("‚úÖ Record school_institutes zombie rimosso")})):e?.institute_code&&console.log("‚ö†Ô∏è NON rimuovo school_institutes - ha codice MIUR:",e.institute_code)),this.updateProfileUI(n,"privato",i,o),await this.loadProfileStats(n.id),void this.updateProfileActions(o);console.warn("‚ö†Ô∏è No profile found in either table, showing empty profile"),this.showEmptyProfile("istituto")}}else if("privato"===n.user_type){const{data:e,error:n}=await this.supabase.from("private_users").select("*").eq("id",t).maybeSingle();if(n)throw console.error("‚ùå Error loading private profile:",n),n;if(e){console.log("‚úÖ Private profile loaded:",e),o&&this.currentUser?.email&&(e.email=this.currentUser.email),this.updateProfileUI(e,"privato",i,o),await this.loadProfileStats(e.id),this.updateProfileActions(o);const t=()=>{const t=document.getElementById("profile-avatar");if(t)if(e.avatar_url){t.style.backgroundImage=`url(${e.avatar_url})`,t.style.backgroundSize="cover",t.style.backgroundPosition="center";const o=t.querySelector("i");o&&(o.style.display="none"),console.log("üé® Forced private avatar:",e.avatar_url)}else{t.style.backgroundImage="none";const e=t.querySelector("i");e&&(e.style.display="block"),console.log("üé® No private avatar, showing placeholder")}};t(),setTimeout(t,500)}else console.warn("‚ö†Ô∏è No private profile found, showing empty profile"),this.showEmptyProfile("privato")}}catch(e){console.error("‚ùå Error loading profile:",e),this.showEmptyProfile()}}showPrivateProfile(){const e=document.querySelector("main.profile-main");e&&(e.innerHTML='\n      <div class="private-profile-container" style="text-align: center; padding: 4rem 1rem; max-width: 600px; margin: 0 auto;">\n        <div class="lock-icon" style="font-size: 4rem; color: #6b7280; margin-bottom: 1.5rem;">\n          <i class="fas fa-lock"></i>\n        </div>\n        <h2 style="font-size: 2rem; margin-bottom: 1rem; color: #111827;">Questo profilo √® privato</h2>\n        <p style="font-size: 1.1rem; color: #4b5563; margin-bottom: 2rem;">\n          L\'utente ha scelto di limitare la visibilit√† del proprio profilo.\n        </p>\n        <a href="../../homepage.html" class="btn-primary">\n          <i class="fas fa-arrow-left"></i> Torna alla Home\n        </a>\n      </div>\n    ')}showEmptyProfile(e="privato"){console.log("üìù Showing empty profile for type:",e);const t={first_name:"privato"===e?"Utente":null,last_name:"privato"===e?"":null,institute_name:"istituto"===e?"Istituto":null,institute_type:"istituto"===e?"Istituto Scolastico":null,bio:null,location:null,website:null,email:null,phone:null,address:null};this.updateProfileUI(t,e),this.loadDemoStats()}updateProfileUI(e,t="istituto",o=null,i=!1){console.log("üé® Updating profile UI with:",e,"Type:",t),this.removeSkeletonStates();const n=document.getElementById("profile-title");let s,a;document.getElementById("user-full-name"),"istituto"===t?(s=e.institute_name||"Nome Istituto",a=e.institute_type||"Istituto Scolastico",this.updateVerificationBadge(e.verification_status,e.verified)):(s=`${e.first_name||""} ${e.last_name||""}`.trim()||"Utente",a=e.profession||"Utente Privato",this.collaboratorData?.is_collaborator&&i&&(a=`${{admin:"Amministratore",editor:"Editor",viewer:"Visualizzatore"}[this.collaboratorData.role]||"Collaboratore"} - ${this.collaboratorData.institute_name}`,console.log("üë• Profilo collaboratore - tipo:",a))),n&&(n.textContent=s);const l=document.getElementById("profile-type");l&&(l.textContent=a);const r=document.getElementById("profile-bio");if(r){const t=e.bio||e.description;t?(r.textContent=t,r.parentElement?.classList.remove("hidden")):r.textContent="Nessuna descrizione"}const c=document.getElementById("profile-location");if(c){const t=e.location||e.city;t?(c.textContent=t,c.parentElement?.classList.remove("hidden")):c.textContent="Posizione non specificata"}const d=document.getElementById("profile-website");if(d)if(e.website){const t=e.website.startsWith("http")?e.website:`https://${e.website}`;d.href=t,d.textContent=e.website.replace(/^https?:\/\//,""),d.target="_blank",d.rel="noopener noreferrer",d.parentElement?.classList.remove("hidden")}else d.parentElement?.classList.add("hidden");const u=document.getElementById("profile-join-date");if(u&&e.created_at){const t=new Date(e.created_at);u.textContent=t.toLocaleDateString("it-IT",{month:"long",year:"numeric"})}const p=document.getElementById("cover-image");if(p){const t=e.cover_image||e.cover_image_url;if(t){console.log("Loading cover image:",t),p.style.backgroundImage=`url(${t})`,p.style.backgroundSize="cover",p.style.backgroundPosition="center top",p.style.backgroundRepeat="no-repeat";const e=p.querySelector(".cover-placeholder");e&&(e.style.display="none",e.style.visibility="hidden",e.style.opacity="0",e.style.width="0",e.style.height="0",e.style.position="absolute")}else{console.log("No cover image found in profile");const e=p.querySelector(".cover-placeholder");e&&(e.style.display="block",e.style.visibility="visible",e.style.opacity="1")}}const m=document.getElementById("profile-avatar");if(m){const t=e.avatar_image||e.logo_url||e.avatar_url;if(t){console.log("Loading avatar image:",t),m.style.backgroundImage=`url(${t})`,m.style.backgroundSize="cover",m.style.backgroundPosition="center",m.style.backgroundRepeat="no-repeat";const e=m.querySelector("i");e&&(e.style.display="none")}else console.log("No avatar image found in profile")}this.updateAboutTab(e,o,i,t),this.updateTabsVisibility(t)}updateTabsVisibility(e){this.profileUserType=e;const t=document.getElementById("posts-tab-btn"),o=document.getElementById("projects-tab-btn"),i=document.getElementById("posts-tab"),n=document.getElementById("projects-tab"),s=document.getElementById("about-tab-btn"),a=document.getElementById("about-tab"),l=document.getElementById("gallery-tab-btn"),r=document.getElementById("gallery-tab"),c=document.getElementById("reviews-tab-btn"),d=document.getElementById("reviews-tab"),u=document.getElementById("posts-stat-card"),p=document.getElementById("projects-stat-card"),m=document.getElementById("followers-stat-card"),g=document.getElementById("following-stat-card"),y=document.getElementById("profile-stats-section"),f=document.getElementById("location-meta-item"),h=document.getElementById("website-meta-item");"privato"===e?(t&&(t.style.display="none"),o&&(o.style.display="none"),i&&(i.style.display="none"),n&&(n.style.display="none"),l&&(l.style.display="none"),r&&(r.style.display="none"),c&&(c.style.display="none"),d&&(d.style.display="none"),u&&(u.style.display="none"),p&&(p.style.display="none"),m&&(m.style.display="none"),y&&(y.style.justifyContent="center"),g&&(g.style.minWidth="200px"),f&&(f.style.display="none"),h&&(h.style.display="none"),s&&(s.classList.add("active"),s.setAttribute("aria-selected","true")),a&&(a.classList.add("active"),a.style.display=""),this.currentTab="about",console.log("üîí Profilo privato: solo tab Info visibile")):(t&&(t.style.display=""),o&&(o.style.display=""),i&&(i.style.display=""),n&&(n.style.display=""),l&&(l.style.display=""),r&&(r.style.display=""),c&&(c.style.display=""),d&&(d.style.display=""),u&&(u.style.display=""),p&&(p.style.display=""),m&&(m.style.display=""),y&&(y.style.justifyContent=""),g&&(g.style.minWidth=""),f&&(f.style.display=""),h&&(h.style.display=""),s&&(s.classList.remove("active"),s.setAttribute("aria-selected","false")),a&&a.classList.remove("active"),t&&(t.classList.add("active"),t.setAttribute("aria-selected","true")),i&&i.classList.add("active"),this.currentTab="posts",this.loadTabContent("posts"),console.log("‚úÖ Profilo istituto: tutti i tab visibili, Posts attivo"))}updateAboutTab(e,t,o,i=null){console.log("üìã Updating About tab with privacy checks:",e,"userType:",i);const n=i||(e.institute_type?"istituto":"privato"),s=o||!!t&&t.show_email,a=document.querySelectorAll(".institute-about-section"),l=document.querySelectorAll(".private-about-section");if("privato"===n){a.forEach(e=>e.style.display="none"),l.forEach(e=>e.style.display="");const t=document.getElementById("about-private-bio");t&&(t.textContent=e.bio||e.description||"Nessuna presentazione");const o=document.getElementById("private-email-container"),i=document.getElementById("about-private-email");if(i&&o)if(e.email&&s)i.textContent=e.email,o.style.display="",this.initEmailActions(e.email,"private");else{o.style.display="none";const e=document.getElementById("private-email-actions");e&&(e.style.display="none")}return void console.log("üìã About tab configurato per UTENTE PRIVATO")}a.forEach(e=>e.style.display=""),l.forEach(e=>e.style.display="none");const r=document.getElementById("about-institute-type");r&&(e.institute_type?(r.textContent=e.institute_type,r.parentElement?.classList.remove("hidden")):r.parentElement?.classList.add("hidden"));const c=document.getElementById("about-email");if(c)if(e.email&&s)c.textContent=e.email,c.parentElement?.classList.remove("hidden"),this.initEmailActions(e.email,"institute");else{s?c.textContent="-":(c.textContent="Non visibile (Privacy)",c.parentElement?.classList.add("hidden"));const e=document.getElementById("email-actions");e&&(e.style.display="none")}const d=document.getElementById("about-phone");d&&(e.phone?(d.textContent=e.phone,d.parentElement?.classList.remove("hidden")):d.textContent="-");const u=document.getElementById("about-address");if(u){const t=[];e.address&&t.push(e.address),e.city&&t.push(e.city),e.province&&t.push(`(${e.province})`);const o=t.join(", ");u.textContent=o||"-",o&&u.parentElement?.classList.remove("hidden")}const p=document.getElementById("about-website");if(p&&e.website){const t=e.website.startsWith("http")?e.website:`https://${e.website}`;p.href=t,p.textContent=e.website,p.target="_blank",p.rel="noopener noreferrer",p.parentElement?.classList.remove("hidden")}else p&&(p.textContent="-",p.removeAttribute("href"));const m=document.getElementById("about-methodologies");m&&e.methodologies&&e.methodologies.length>0&&(m.innerHTML=e.methodologies.map(e=>`<span class="tag">${e}</span>`).join(""));const g=document.getElementById("about-interests");g&&e.interests&&e.interests.length>0&&(g.innerHTML=e.interests.map(e=>`<span class="tag">${e}</span>`).join(""));const y=document.getElementById("about-classroom-count");y&&(y.textContent=e.classroom_count?`${e.classroom_count} aule`:"-");const f=document.getElementById("about-internal-area");f&&(f.textContent=e.internal_area_sqm?`${e.internal_area_sqm} mq`:"-");const h=document.getElementById("about-external-spaces");h&&(h.textContent=e.external_spaces||"-");const v=document.getElementById("structure-section");if(v){const t=e.classroom_count||e.internal_area_sqm||e.external_spaces;v.style.display=t?"":"none"}const b=document.getElementById("about-opening-hours");if(b&&e.opening_hours&&"object"==typeof e.opening_hours){const t={lunedi:"Luned√¨",martedi:"Marted√¨",mercoledi:"Mercoled√¨",giovedi:"Gioved√¨",venerdi:"Venerd√¨",sabato:"Sabato",domenica:"Domenica"},o=Object.entries(e.opening_hours);o.length>0?b.innerHTML=`\n          <div class="hours-grid">\n            ${o.map(([e,o])=>`\n              <div class="hours-item">\n                <span class="day-name">${t[e]||e}</span>\n                <span class="day-hours">${o}</span>\n              </div>\n            `).join("")}\n          </div>\n        `:b.innerHTML='<p class="no-hours">Orari non specificati</p>'}const w=document.getElementById("hours-section");if(w){const t=e.opening_hours&&Object.keys(e.opening_hours).length>0;w.style.display=t?"":"none"}const E=document.getElementById("about-regulations");E&&(e.internal_regulations_url?E.innerHTML=`\n          <a href="${e.internal_regulations_url}" target="_blank" rel="noopener noreferrer" class="regulations-link">\n            <i class="fas fa-file-pdf"></i>\n            Visualizza Regolamento Interno\n            <i class="fas fa-external-link-alt"></i>\n          </a>\n        `:e.internal_regulations_text?E.innerHTML=`\n          <div class="regulations-text">\n            <p>${e.internal_regulations_text.substring(0,500)}${e.internal_regulations_text.length>500?"...":""}</p>\n            ${e.internal_regulations_text.length>500?`\n              <button class="btn-link show-more-regulations" onclick="this.parentElement.querySelector('p').textContent = '${e.internal_regulations_text.replace(/'/g,"\\'")}'; this.style.display='none';">\n                Mostra tutto\n              </button>\n            `:""}\n          </div>\n        `:E.innerHTML='<p class="no-regulations">Regolamento non disponibile</p>');const _=document.getElementById("regulations-section");if(_){const t=e.internal_regulations_url||e.internal_regulations_text;_.style.display=t?"":"none"}}initEmailActions(e,t="institute"){const o="private"===t?"private-email-actions":"email-actions",i="private"===t?"copy-private-email-btn":"copy-email-btn",n="private"===t?"private-mailto-btn":"mailto-btn",s=document.getElementById(o),a=document.getElementById(i),l=document.getElementById(n);if(s&&e){if(s.style.display="flex",l&&(l.href=`mailto:${e}`,l.title=`Invia email a ${e}`),a){const t=a.cloneNode(!0);a.parentNode.replaceChild(t,a),t.addEventListener("click",async o=>{o.preventDefault(),o.stopPropagation();try{await navigator.clipboard.writeText(e);const o=t.querySelector("i"),i=o?.className||"fas fa-copy";o&&(o.className="fas fa-check",t.classList.add("copied"),t.title="Copiato!"),console.log("‚úÖ Email copiata:",e),setTimeout(()=>{o&&(o.className=i,t.classList.remove("copied"),t.title="Copia email")},2e3)}catch(o){console.error("‚ùå Errore copia email:",o);const i=document.createElement("textarea");i.value=e,i.style.position="fixed",i.style.left="-9999px",document.body.appendChild(i),i.select();try{document.execCommand("copy"),console.log("‚úÖ Email copiata (fallback):",e);const o=t.querySelector("i");if(o){const e=o.className;o.className="fas fa-check",t.classList.add("copied"),setTimeout(()=>{o.className=e,t.classList.remove("copied")},2e3)}}catch(e){console.error("‚ùå Fallback copia fallito:",e)}document.body.removeChild(i)}})}console.log(`üìß Email actions inizializzate per ${t}:`,e)}else s&&(s.style.display="none")}async loadProfileStats(e){try{const{count:t}=await this.supabase.from("institute_posts").select("*",{count:"exact",head:!0}).eq("institute_id",e),{count:o}=await this.supabase.from("institute_posts").select("*",{count:"exact",head:!0}).eq("institute_id",e).eq("post_type","progetto"),i=document.getElementById("posts-count"),n=document.getElementById("projects-count");i&&(i.textContent=t||0),n&&(n.textContent=o||0);const s=document.getElementById("followers-count"),a=document.getElementById("following-count");s&&(s.textContent="0"),a&&(a.textContent="0")}catch(e){console.error("Error loading stats:",e),this.loadDemoStats()}}loadDemoStats(){const e=document.getElementById("posts-count"),t=document.getElementById("projects-count"),o=document.getElementById("followers-count"),i=document.getElementById("following-count");e&&(e.textContent="0"),t&&(t.textContent="0"),o&&(o.textContent="0"),i&&(i.textContent="0")}switchTab(e){document.querySelectorAll(".tab-button").forEach(e=>{e.classList.remove("active"),e.setAttribute("aria-selected","false")});const t=document.getElementById(`${e}-tab-btn`);t&&(t.classList.add("active"),t.setAttribute("aria-selected","true")),document.querySelectorAll(".tab-panel").forEach(e=>{e.classList.remove("active")});const o=document.getElementById(`${e}-tab`);o&&o.classList.add("active"),this.currentTab=e,this.loadTabContent(e)}async loadTabContent(e){switch(console.log("Loading tab content:",e),e){case"posts":await this.loadPosts();break;case"projects":await this.loadProjects();break;case"about":case"gallery":break;case"reviews":await this.loadReviews()}}async loadPosts(){const e=document.getElementById("profile-posts");if(e)try{if(console.log("üìù Loading posts for profile:",this.profileUserId),!this.supabase||!this.profileUserId)return console.warn("‚ö†Ô∏è Missing supabase or profileUserId"),void(e.innerHTML=this.getEmptyState("posts"));let t="public";if(this.currentProfilePrivacy&&this.currentProfilePrivacy.posts_visibility&&(t=this.currentProfilePrivacy.posts_visibility),this.currentUser&&this.profileUserId!==this.currentUser.id&&"private"===t)return console.log("üîí Posts are private"),void(e.innerHTML='\n                 <div class="empty-state">\n                   <i class="fas fa-lock" aria-hidden="true"></i>\n                   <h3>Post Privati</h3>\n                   <p>I post di questo utente non sono visibili pubblicamente.</p>\n                 </div>');const{data:o,error:i}=await this.supabase.from("institute_posts").select("*").eq("institute_id",this.profileUserId).eq("published",!0).order("created_at",{ascending:!1}).limit(20);if(i)throw console.error("‚ùå Error loading posts:",i),i;if(console.log("üìä Posts loaded:",o?.length||0,"posts"),console.log("üìä Posts data:",o),!o||0===o.length)return console.log("‚ÑπÔ∏è No posts found, showing empty state"),void(e.innerHTML=this.getEmptyState("posts"));console.log("üé® Rendering",o.length,"posts...");const n=o.map(e=>this.createPostCard(e)).join("");console.log("‚úÖ Cards HTML generated, length:",n.length),e.innerHTML=n,console.log("‚úÖ Posts rendered successfully")}catch(t){console.error("üí• Error loading posts:",t),e.innerHTML=this.getEmptyState("posts")}else console.error("‚ùå Posts container not found!")}async loadProjects(){const e=document.getElementById("profile-projects");if(e)try{if(!this.supabase||!this.profileUserId)return void(e.innerHTML=this.getEmptyState("projects"));const{data:t,error:o}=await this.supabase.from("institute_posts").select("*").eq("institute_id",this.profileUserId).eq("post_type","progetto").eq("published",!0).order("created_at",{ascending:!1}).limit(20);if(o)throw o;if(!t||0===t.length)return void(e.innerHTML=this.getEmptyState("projects"));e.innerHTML=t.map(e=>this.createPostCard(e)).join("")}catch(t){console.error("Error loading projects:",t),e.innerHTML=this.getEmptyState("projects")}}async loadReviews(){console.log("Loading reviews...");const e=new URLSearchParams(window.location.search).get("id")||this.currentUser?.id;if(e)try{const{data:t}=await this.supabase.from("user_profiles").select("user_type").eq("id",e).single();if("istituto"!==t?.user_type)return void(document.getElementById("reviews-tab").innerHTML='\n          <div class="reviews-container">\n            <div class="empty-state">\n              <i class="fas fa-star" aria-hidden="true"></i>\n              <h3>Recensioni non disponibili</h3>\n              <p>Le recensioni sono disponibili solo per gli istituti</p>\n            </div>\n          </div>\n        ');if(console.log("üîµ Initializing reviews for institute:",e),window.eduNetReviewManager?(await window.eduNetReviewManager.init(e),console.log("‚úÖ Reviews system initialized via EduNetReviewManager")):window.reviewsManager?await window.reviewsManager.init(e):"undefined"!=typeof InstituteReviewsManager?(window.reviewsManager=new InstituteReviewsManager,await window.reviewsManager.init(e)):(console.error("‚ùå No review manager available, creating new EduNetReviewManager"),"undefined"!=typeof EduNetReviewManager?(window.eduNetReviewManager=new EduNetReviewManager,await window.eduNetReviewManager.init(e),console.log("‚úÖ Created and initialized fallback EduNetReviewManager")):console.error("‚ùå EduNetReviewManager class not found")),this.currentUser&&this.currentUser.id===e){console.log("üë§ Own profile detected - initializing moderation panel");const t=document.getElementById("review-moderation-panel");if(console.log("üìã Moderation panel element:",t),t){t.style.display="block",console.log("‚úÖ Moderation panel visible");try{window.moderationPanel?(console.log("‚úÖ Using existing moderationPanel"),await window.moderationPanel.init(e)):"undefined"!=typeof ReviewModerationPanel?(console.log("‚úÖ Creating new ReviewModerationPanel"),window.moderationPanel=new ReviewModerationPanel,console.log("üîß Calling init on moderationPanel..."),await window.moderationPanel.init(e),console.log("‚úÖ Moderation panel init completed")):console.error("‚ùå ReviewModerationPanel class not found")}catch(e){console.error("‚ùå Error initializing moderation panel:",e),console.error("Stack trace:",e.stack)}}else console.error("‚ùå review-moderation-panel element not found in DOM")}else console.log("‚ÑπÔ∏è Not own profile - skipping moderation panel");await this.updateReviewsCount(e)}catch(e){console.error("Error loading reviews:",e),document.getElementById("reviews-tab").innerHTML='\n        <div class="reviews-container">\n          <div class="empty-state">\n            <i class="fas fa-exclamation-circle" aria-hidden="true"></i>\n            <h3>Errore caricamento recensioni</h3>\n            <p>Si √® verificato un errore. Riprova pi√π tardi.</p>\n          </div>\n        </div>\n      '}else console.error("No profile ID")}async updateReviewsCount(e){try{const{count:t,error:o}=await this.supabase.from("institute_reviews").select("*",{count:"exact",head:!0}).eq("reviewed_institute_id",e).eq("status","approved");if(o)throw o;const i=document.getElementById("reviews-count-badge");i&&(i.textContent=t||0,i.style.display=t&&t>0?"inline-block":"none")}catch(e){console.error("Error updating reviews count:",e)}}async loadProfileRating(e){try{const{data:t,error:o}=await this.supabase.from("institute_reviews").select("rating").eq("reviewed_institute_id",e).eq("status","approved");if(o)return void console.error("Error loading profile rating:",o);const i=document.getElementById("profile-rating"),n=document.getElementById("profile-rating-stars"),s=document.getElementById("profile-rating-value"),a=document.getElementById("profile-rating-count");if(!i)return;const l=t?t.length:0;let r=0;if(l>0&&(r=t.reduce((e,t)=>e+(t.rating||0),0)/l),l>0){const e=Math.floor(r),t=r%1>=.5,o=5-e-(t?1:0);let c="‚òÖ".repeat(e);t&&(c+="‚Ø®"),c+="‚òÜ".repeat(Math.max(0,o)),n&&(n.textContent=c),s&&(s.textContent=r.toFixed(1)),a&&(a.textContent=`(${l} ${1===l?"recensione":"recensioni"})`),i.style.display="flex",console.log("‚≠ê Rating loaded (real-time):",r,"from",l,"approved reviews")}else i.style.display="none"}catch(e){console.error("Error loading profile rating:",e)}}updateProfileActions(e){const t=document.getElementById("edit-profile-btn"),o=document.getElementById("settings-btn");e?(t&&(t.style.display="inline-flex"),o&&(o.style.display="inline-flex"),console.log("üîì Showing edit buttons - own profile")):(t&&(t.style.display="none"),o&&(o.style.display="none"),console.log("üîí Hiding edit buttons - viewing other profile"))}createPostCard(e){const t=new Date(e.created_at).toLocaleDateString("it-IT",{day:"numeric",month:"long",year:"numeric"}),o=e.image_urls&&e.image_urls.length>0?e.image_urls[0]:null;return`\n      <article class="profile-post-card" onclick="window.location.href='${window.AppConfig&&"function"==typeof window.AppConfig.getPageUrl?window.AppConfig.getPageUrl(`homepage.html#post-${e.id}`):`../../homepage.html#post-${e.id}`}'" style="cursor: pointer;">\n        ${o?`\n          <div class="profile-post-image">\n            <img src="${o}" alt="${e.title||"Post image"}" loading="lazy">\n            <div class="profile-post-overlay"></div>\n          </div>\n        `:""}\n        <div class="profile-post-content">\n          <div class="profile-post-header">\n            <span class="profile-post-type">${this.getPostTypeInfo(e.post_type).icon} ${this.getPostTypeInfo(e.post_type).label}</span>\n            <time class="profile-post-date">\n              <i class="fas fa-clock"></i>\n              ${t}\n            </time>\n          </div>\n          <h3 class="profile-post-title">${e.title||"Senza titolo"}</h3>\n          <p class="profile-post-excerpt">${e.content?this.stripHtml(e.content).substring(0,120)+"...":"Nessuna descrizione disponibile"}</p>\n          <div class="profile-post-footer">\n            <div class="profile-post-stats">\n              ${e.likes_count?`<span><i class="fas fa-heart"></i> ${e.likes_count}</span>`:""}\n              ${e.comments_count?`<span><i class="fas fa-comment"></i> ${e.comments_count}</span>`:""}\n            </div>\n            <span class="profile-post-link">\n              Visualizza <i class="fas fa-arrow-right"></i>\n            </span>\n          </div>\n        </div>\n      </article>\n    `}getPostTypeInfo(e){return{project:{label:"Progetto",icon:"üìä",color:"#0f62fe"},methodology:{label:"Metodologia",icon:"üéì",color:"#4589ff"},event:{label:"Evento",icon:"üìÖ",color:"#78a9ff"},news:{label:"Notizia",icon:"üì∞",color:"#0f62fe"},gallery:{label:"Galleria",icon:"üñºÔ∏è",color:"#4589ff"},collaboration:{label:"Collaborazione",icon:"ü§ù",color:"#78a9ff"},educational_experience:{label:"Esperienza Educativa",icon:"‚ú®",color:"#0f62fe"},progetto:{label:"Progetto",icon:"üìä",color:"#0f62fe"},metodologia:{label:"Metodologia",icon:"üéì",color:"#4589ff"},evento:{label:"Evento",icon:"üìÖ",color:"#78a9ff"},notizia:{label:"Notizia",icon:"üì∞",color:"#0f62fe"}}[e]||{label:"Post",icon:"üìù",color:"#0f62fe"}}stripHtml(e){const t=document.createElement("div");return t.innerHTML=e,t.textContent||t.innerText||""}static navigateToPost(e){sessionStorage.setItem("scrollToPost",e),window.location.href=window.AppConfig.getPageUrl("homepage.html")}getEmptyState(e){const t={posts:{icon:"fa-file-alt",title:"Nessun post",text:"Non hai ancora pubblicato contenuti",btnText:"Crea il tuo primo post"},projects:{icon:"fa-project-diagram",title:"Nessun progetto",text:"Non hai ancora condiviso progetti didattici",btnText:"Condividi un progetto"}}[e];return`\n      <div class="empty-state">\n        <i class="fas ${t.icon}" aria-hidden="true"></i>\n        <h3>${t.title}</h3>\n        <p>${t.text}</p>\n        <a href="homepage.html" class="btn-primary">${t.btnText}</a>\n      </div>\n    `}async handleLogout(){if(confirm("Sei sicuro di voler uscire?"))try{this.supabase&&await this.supabase.auth.signOut(),window.location.href=window.AppConfig.getPageUrl("index.html")}catch(e){console.error("Error during logout:",e),window.location.href=window.AppConfig.getPageUrl("index.html")}}removeSkeletonStates(){console.log("üîÑ Removing skeleton states..."),document.querySelectorAll(".skeleton-text, .skeleton-text-sm, .skeleton-text-inline").forEach(e=>{e.classList.add("loaded")}),document.querySelectorAll(".skeleton-hidden").forEach(e=>{e.classList.add("loaded")});const e=document.getElementById("profile-avatar");e&&e.classList.remove("skeleton-loading"),console.log("‚úÖ Skeleton states removed")}updateVerificationBadge(e,t){const o=document.getElementById("verification-badge"),i=document.getElementById("badge-verified"),n=document.getElementById("badge-pending"),s=document.getElementById("badge-unverified");if(!o)return;i&&(i.style.display="none"),n&&(n.style.display="none"),s&&(s.style.display="none");const a=e||(t?"verified":"pending_verification");switch(a){case"verified":i&&(i.style.display="inline-flex"),console.log("‚úÖ Istituto verificato");break;case"verification_sent":case"pending_verification":n&&(n.style.display="inline-flex"),console.log("‚è≥ Istituto in attesa di verifica");break;case"rejected":s&&(s.style.display="inline-flex"),console.log("‚ùå Verifica istituto rifiutata");break;default:s&&(s.style.display="inline-flex"),console.log("‚ö†Ô∏è Stato verifica sconosciuto:",a)}o.style.display="flex"}}function setupMobileMenu(){const e=document.getElementById("mobile-menu-toggle"),t=document.getElementById("mobile-menu-overlay"),o=document.getElementById("mobile-menu-close"),i=document.getElementById("mobile-logout");e&&t&&e.addEventListener("click",()=>{t.classList.toggle("show"),document.body.style.overflow=t.classList.contains("show")?"hidden":""}),o&&o.addEventListener("click",()=>{t.classList.remove("show"),document.body.style.overflow=""}),t&&t.addEventListener("click",e=>{e.target===t&&(t.classList.remove("show"),document.body.style.overflow="")}),i&&i.addEventListener("click",async()=>{if(confirm("Sei sicuro di voler uscire?"))try{if(window.supabaseClientManager){const e=await window.supabaseClientManager.getClient();await e.auth.signOut()}window.location.href=window.AppConfig.getPageUrl("index.html")}catch(e){console.error("Logout error:",e),window.location.href=window.AppConfig.getPageUrl("index.html")}})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.profilePage=new ProfilePage,setupMobileMenu()}):(window.profilePage=new ProfilePage,setupMobileMenu());