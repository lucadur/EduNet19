class SettingsPage{constructor(){this.currentUser=null,this.supabase=null,this.currentSection="account",this.settings={},this.init()}async init(){console.log("‚öôÔ∏è SettingsPage initializing..."),await this.initSupabase(),await this.loadSettings(),window.avatarManager&&await window.avatarManager.loadCurrentUserAvatar(),await this.updateStorageUsage(),this.registerCurrentSession(),this.setupEventListeners(),await this.check2FAStatus(),console.log("‚úÖ SettingsPage initialized")}async initSupabase(){if(window.supabaseClientManager){this.supabase=await window.supabaseClientManager.getClient();const{data:{user:e}}=await this.supabase.auth.getUser();this.currentUser=e}}setupEventListeners(){const e=document.getElementById("mobileSettingsToggle"),t=document.getElementById("mobileSettingsMenu");e&&t&&e.addEventListener("click",()=>{e.classList.toggle("open"),t.classList.toggle("open")});const s=document.querySelectorAll(".settings-nav-item, .settings-grid-item");s.forEach(s=>{s.addEventListener("click",()=>{const i=s.dataset.section;this.switchSection(i),t&&e&&(t.classList.remove("open"),e.classList.remove("open"));const o=s.querySelector(".settings-label, span")?.textContent,a=s.querySelector(".settings-icon i, i")?.className,n=document.getElementById("currentSectionName");n&&o&&(n.textContent=o);const r=e?.querySelector("i:first-child");r&&a&&(r.className=a),document.querySelectorAll(".settings-nav-item, .settings-grid-item").forEach(e=>{e.classList.remove("active")}),document.querySelectorAll(`[data-section="${i}"]`).forEach(e=>{e.classList.add("active")})})});const i=document.querySelectorAll(".toggle-switch input");i.forEach(e=>{e.addEventListener("change",e=>{this.handleToggleChange(e.target.id,e.target.checked)})});const o=document.querySelectorAll(".setting-select");o.forEach(e=>{e.addEventListener("change",e=>{this.handleSelectChange(e.target.id,e.target.value)})}),this.setupActionButtons();const a=document.getElementById("logout-btn");a&&a.addEventListener("click",()=>this.handleLogout());const n=document.getElementById("user-menu-btn"),r=n?.closest(".nav-item.dropdown");n&&r&&(n.addEventListener("click",e=>{e.stopPropagation(),document.querySelectorAll(".nav-item.dropdown.open").forEach(e=>{e!==r&&e.classList.remove("open")}),r.classList.toggle("open")}),document.addEventListener("click",()=>{r.classList.remove("open")}));const c=document.getElementById("notifications-btn"),l=document.getElementById("messages-btn");[c,l].forEach(e=>{if(e){const t=e.closest(".nav-item.dropdown");t&&e.addEventListener("click",e=>{e.stopPropagation(),document.querySelectorAll(".nav-item.dropdown.open").forEach(e=>{e!==t&&e.classList.remove("open")}),t.classList.toggle("open")})}})}setupActionButtons(){const e=document.getElementById("change-email-btn");e&&e.addEventListener("click",()=>this.changeEmail());const t=document.getElementById("change-password-btn");t&&t.addEventListener("click",()=>this.changePassword());const s=document.getElementById("manage-sessions-btn");s&&s.addEventListener("click",()=>this.manageSessions());const i=document.getElementById("download-data-btn");i&&i.addEventListener("click",()=>this.downloadData());const o=document.getElementById("clear-cache-btn");o&&o.addEventListener("click",()=>this.clearCache());const a=document.getElementById("deactivate-account-btn");a&&a.addEventListener("click",()=>this.deactivateAccount());const n=document.getElementById("delete-account-btn");n&&n.addEventListener("click",()=>this.deleteAccount());const r=document.getElementById("setup-2fa-btn");r&&r.addEventListener("click",()=>this.setup2FA());const c=document.getElementById("disable-2fa-btn");c&&c.addEventListener("click",()=>this.showDisable2FAModal());const l=document.getElementById("close-2fa-modal");l&&l.addEventListener("click",()=>this.close2FAModal());const d=document.getElementById("close-disable-2fa-modal");d&&d.addEventListener("click",()=>this.closeDisable2FAModal());const u=document.getElementById("close-sessions-modal");u&&u.addEventListener("click",()=>this.closeSessionsModal());const m=document.getElementById("sign-out-all-btn");m&&m.addEventListener("click",()=>this.signOutAllOtherSessions());const h=document.getElementById("sessions-modal");h&&h.addEventListener("click",e=>{e.target===h&&this.closeSessionsModal()});const g=document.getElementById("verify-2fa-code-btn");g&&g.addEventListener("click",()=>this.verify2FACode());const p=document.getElementById("verification-code-input");p&&(p.addEventListener("keypress",e=>{"Enter"===e.key&&this.verify2FACode()}),p.addEventListener("input",e=>{e.target.value=e.target.value.replace(/[^0-9]/g,"")}));const f=document.getElementById("download-backup-codes-btn");f&&f.addEventListener("click",()=>this.downloadBackupCodes());const y=document.getElementById("finish-2fa-setup-btn");y&&y.addEventListener("click",()=>this.finish2FASetup());const v=document.getElementById("cancel-disable-2fa-btn");v&&v.addEventListener("click",()=>this.closeDisable2FAModal());const w=document.getElementById("confirm-disable-2fa-btn");w&&w.addEventListener("click",()=>this.disable2FA())}async loadSettings(){try{this.loadSettingsFromStorage(),this.supabase&&this.currentUser&&await this.syncSettingsWithDatabase(),this.updateUIWithSettings();const e=document.getElementById("current-email");e&&this.currentUser&&this.currentUser.email&&(e.textContent=this.currentUser.email),await this.loadUserProfile()}catch(e){console.error("Error loading settings:",e),this.loadDefaultSettings()}}async syncSettingsWithDatabase(){try{const{data:e,error:t}=await this.supabase.from("user_privacy_settings").select("*").eq("user_id",this.currentUser.id).single();if(t&&"PGRST116"!==t.code&&console.warn("Error fetching privacy settings:",t),e){console.log("üì• Impostazioni scaricate dal cloud:",e);const t=this.mapDbToSettings(e);this.settings={...this.settings,...t},localStorage.setItem("edunet_settings",JSON.stringify(this.settings)),this.applySettings()}else console.log("üì§ Creazione impostazioni default sul cloud"),await this.saveSettingsToDatabase()}catch(e){console.warn("Sync settings warning:",e)}}async saveSettingsToDatabase(){if(this.supabase&&this.currentUser)try{const e=this.mapSettingsToDb(this.settings);e.user_id=this.currentUser.id,e.updated_at=(new Date).toISOString();const{error:t}=await this.supabase.from("user_privacy_settings").upsert(e).select();if(t)throw t;console.log("‚úÖ Impostazioni salvate nel cloud")}catch(e){console.error("Errore salvataggio impostazioni cloud:",e)}}mapDbToSettings(e){const t={profile_visibility:"publicProfile",show_email:"showEmail",searchable_by_email:"searchableEmail",posts_visibility:"postsVisibility",comments_permission:"commentsPermission",email_new_posts:"emailNewPosts",email_followers:"emailFollowers",email_comments:"emailComments",email_matches:"emailMatches",push_enabled:"pushEnabled",notification_sounds:"notificationSounds",theme:"theme",font_size:"fontSize",autoplay_videos:"autoplayVideos",data_saver_mode:"dataSaver",language:"language",social_login_enabled:"socialLogin"},s={};return Object.keys(t).forEach(i=>{if(void 0!==e[i]){const o=t[i];s[o]="profile_visibility"===i?"public"===e[i]:e[i]}}),s}mapSettingsToDb(e){const t={publicProfile:"profile_visibility",showEmail:"show_email",searchableEmail:"searchable_by_email",postsVisibility:"posts_visibility",commentsPermission:"comments_permission",emailNewPosts:"email_new_posts",emailFollowers:"email_followers",emailComments:"email_comments",emailMatches:"email_matches",pushEnabled:"push_enabled",notificationSounds:"notification_sounds",theme:"theme",fontSize:"font_size",autoplayVideos:"autoplay_videos",dataSaver:"data_saver_mode",language:"language",socialLogin:"social_login_enabled"},s={};return Object.keys(t).forEach(i=>{if(void 0!==e[i]){const o=t[i];s[o]="publicProfile"===i?e[i]?"public":"private":e[i]}}),s}loadDefaultSettings(){this.settings={publicProfile:!0,showEmail:!1,searchableEmail:!0,postsVisibility:"public",commentsPermission:"everyone",emailNewPosts:!0,emailFollowers:!0,emailComments:!0,emailMatches:!0,pushEnabled:!1,notificationSounds:!0,twoFactorAuth:!1,socialLogin:!1,theme:"dark",fontSize:"medium",autoplayVideos:!0,dataSaver:!1,language:"it"},this.applySettings()}loadSettingsFromStorage(){const e=localStorage.getItem("edunet_settings");if(e)try{this.settings=JSON.parse(e),this.applySettings()}catch(e){console.error("Error parsing saved settings:",e),this.loadDefaultSettings()}else this.loadDefaultSettings()}updateUIWithSettings(){Object.keys(this.settings).forEach(e=>{let t=this.kebabCase(e),s=document.getElementById(t);s||(s=document.getElementById(`${t}-select`)),s&&("checkbox"===s.type?s.checked=this.settings[e]:"SELECT"===s.tagName&&(s.value=this.settings[e]))})}applySettings(){window.EduNetPrefs?(this.settings.theme&&window.EduNetPrefs.applyTheme(this.settings.theme),this.settings.fontSize&&window.EduNetPrefs.applyFontSize(this.settings.fontSize),void 0!==this.settings.dataSaver&&window.EduNetPrefs.applyDataSaver(this.settings.dataSaver)):(this.settings.theme&&this.applyTheme(this.settings.theme),this.settings.fontSize&&this.applyFontSize(this.settings.fontSize),void 0!==this.settings.dataSaver&&this.applyDataSaver(this.settings.dataSaver)),void 0!==this.settings.autoplayVideos&&this.applyAutoplay(this.settings.autoplayVideos),this.updateUIWithSettings()}kebabCase(e){return e.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()}switchSection(e){document.querySelectorAll(".settings-nav-item").forEach(e=>{e.classList.remove("active")});const t=document.querySelector(`[data-section="${e}"]`);t&&t.classList.add("active"),document.querySelectorAll(".settings-section").forEach(e=>{e.classList.remove("active")});const s=document.getElementById(`${e}-section`);s&&s.classList.add("active"),this.currentSection=e}handleToggleChange(e,t){console.log(`Setting ${e} changed to:`,t);const s=e.replace(/-([a-z])/g,e=>e[1].toUpperCase());this.settings[s]=t,this.saveSettings(),this.showNotification("Impostazione aggiornata","success"),"autoplay-videos"===e?this.applyAutoplay(t):"data-saver"===e&&this.applyDataSaver(t)}handleSelectChange(e,t){console.log(`Setting ${e} changed to:`,t);const s=e.replace(/-select$/,"").replace(/-([a-z])/g,e=>e[1].toUpperCase());this.settings[s]=t,this.saveSettings(),this.showNotification("Impostazione aggiornata","success"),"theme-select"===e?this.applyTheme(t):"font-size-select"===e&&this.applyFontSize(t)}async saveSettings(){try{localStorage.setItem("edunet_settings",JSON.stringify(this.settings)),console.log("Settings saved to LocalStorage"),this.supabase&&this.currentUser&&await this.saveSettingsToDatabase()}catch(e){console.error("Error saving settings:",e)}}applyTheme(e){if("dark"===e)document.body.classList.add("dark-theme"),this.showNotification("üåô Tema scuro attivato","info");else if("light"===e)document.body.classList.remove("dark-theme"),this.showNotification("‚òÄÔ∏è Tema chiaro attivato","info");else if("auto"===e){const e=window.matchMedia("(prefers-color-scheme: dark)").matches;document.body.classList.toggle("dark-theme",e),this.showNotification("üîÑ Tema automatico attivato","info")}}applyFontSize(e){document.documentElement.setAttribute("data-font-size",e),console.log(`Font size set to: ${e}`)}applyAutoplay(e){document.documentElement.setAttribute("data-autoplay",e);const t=document.querySelectorAll("video");t.forEach(t=>{t.autoplay=e,e||t.paused?e&&t.paused&&t.checkVisibility&&t.checkVisibility()&&t.play().catch(e=>console.warn("Autoplay blocked:",e)):t.pause()}),console.log(`Autoplay set to: ${e}`)}applyDataSaver(e){document.documentElement.setAttribute("data-saver",e),e?document.body.classList.add("data-saver-mode"):document.body.classList.remove("data-saver-mode"),console.log(`Data saver set to: ${e}`)}async changeEmail(){const e=prompt("Inserisci il nuovo indirizzo email:");if(e)if(this.validateEmail(e))if(e!==this.currentUser.email)try{this.showLoading("Aggiornamento email...");const{error:t}=await this.supabase.auth.updateUser({email:e});if(this.hideLoading(),t)throw t;alert("‚úÖ Richiesta inviata! Controlla ORA entrambe le caselle email:\n\n1. La tua vecchia email ("+this.currentUser.email+")\n2. La tua nuova email ("+e+")\n\nDevi cliccare sui link di conferma in ENTRAMBE le email per completare il cambio.")}catch(e){this.hideLoading(),console.error("Error changing email:",e),alert("Errore durante il cambio email: "+(e.message||"Errore sconosciuto"))}else alert("La nuova email deve essere diversa da quella attuale.");else alert("Indirizzo email non valido.")}async changePassword(){const e=confirm("Vuoi cambiare la password? Riceverai un'email con un link sicuro per impostare la nuova password.");if(e)try{if(this.showLoading("Invio email reset..."),this.supabase&&this.currentUser){const{error:e}=await this.supabase.auth.resetPasswordForEmail(this.currentUser.email,{redirectTo:window.AppConfig.getPageUrl("pages/auth/reset-password.html")});if(this.hideLoading(),e)throw e;alert("‚úÖ Email inviata con successo!\n\nControlla la tua casella di posta (anche nello spam) e clicca sul link per creare una nuova password.")}}catch(e){this.hideLoading(),console.error("Error sending reset email:",e),alert("‚ùå Errore durante l'invio dell'email: "+e.message)}}manageSessions(){const e=document.getElementById("sessions-modal");e&&(e.classList.add("active"),this.loadActiveSessions())}closeSessionsModal(){const e=document.getElementById("sessions-modal");e&&e.classList.remove("active")}async registerCurrentSession(){if(this.currentUser&&this.supabase)try{let e=localStorage.getItem("edunet_device_id");e||(e=crypto.randomUUID(),localStorage.setItem("edunet_device_id",e));const t=navigator.userAgent;let s="Sconosciuto",i="Sconosciuto",o="desktop";t.includes("Firefox")&&!t.includes("Seamonkey")?s="Firefox":t.includes("Seamonkey")?s="Seamonkey":t.includes("Chrome")&&!t.includes("Chromium")?s="Chrome":t.includes("Chromium")?s="Chromium":t.includes("Safari")&&!t.includes("Chrome")?s="Safari":t.includes("OPR")||t.includes("Opera")?s="Opera":t.includes("Edg")&&(s="Edge"),t.includes("Win")?i="Windows":t.includes("Mac")?i="MacOS":t.includes("Linux")?i="Linux":t.includes("Android")?(i="Android",o="mobile"):(t.includes("iPhone")||t.includes("iPad"))&&(i="iOS",o="mobile");const a=`${s} su ${i}`;let n="N/A";try{const e=await fetch("https://api.ipify.org?format=json"),t=await e.json();n=t.ip}catch(e){console.warn("Could not fetch IP:",e)}try{const{error:t}=await this.supabase.from("user_active_sessions").select("id").limit(1);if(t&&"42P01"===t.code)return void console.warn("Table user_active_sessions does not exist yet.");const{error:r}=await this.supabase.from("user_active_sessions").upsert({user_id:this.currentUser.id,device_id:e,device_type:o,device_name:a,browser:s,os:i,ip_address:n,last_active:(new Date).toISOString()},{onConflict:"user_id, device_id"});r?console.warn("Session registration warning:",r.message):console.log("‚úÖ Session registered successfully")}catch(e){console.warn("Session upsert exception:",e)}}catch(e){console.error("Session registration error:",e)}}async loadActiveSessions(){try{const e=document.getElementById("sessions-list");if(!e)return;e.innerHTML='<div class="empty-sessions"><i class="fas fa-spinner fa-spin"></i> Caricamento sessioni...</div>';const t=localStorage.getItem("edunet_device_id"),{data:s,error:i}=await this.supabase.from("user_active_sessions").select("*").order("last_active",{ascending:!1});if(i)return console.warn("Error loading sessions table:",i),void(e.innerHTML='<div class="empty-sessions">Funzionalit√† sessioni non ancora disponibile.</div>');if(!s||0===s.length)return void(e.innerHTML='<div class="empty-sessions">Nessuna sessione attiva trovata.</div>');console.log(" Rendering",s.length,"sessions to DOM"),e.innerHTML="",s.forEach(s=>{const i=s.device_id===t;console.log(" Rendering session:",s.device_name,"Current:",i);const o=new Date(s.last_active).toLocaleString("it-IT",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"});let a="fa-desktop";"mobile"===s.device_type&&(a="fa-mobile-alt"),"tablet"===s.device_type&&(a="fa-tablet-alt");const n=`\n          <div class="session-card ${i?"current":""}" style="display: flex; align-items: center; padding: 1rem; background: #f8f9fa; border-radius: 0.5rem; margin-bottom: 0.5rem; border: 1px solid #e5e7eb;">\n            <div class="session-icon" style="font-size: 1.5rem; color: #6b7280; margin-right: 1rem; width: 40px; text-align: center;">\n              <i class="fas ${a}"></i>\n            </div>\n            <div class="session-info" style="flex: 1;">\n              <div class="session-name" style="font-weight: 600; color: #111827; margin-bottom: 0.25rem;">\n                ${s.device_name}\n                ${i?'<span class="current-badge" style="display: inline-block; background: #dbeafe; color: #2563eb; font-size: 0.75rem; padding: 0.125rem 0.5rem; border-radius: 9999px; margin-left: 0.5rem;">Attuale</span>':""}\n              </div>\n              <div class="session-details" style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">\n                ${"N/A"!==s.ip_address?s.ip_address+" ‚Ä¢ ":""} ${s.location||"Posizione sconosciuta"}\n              </div>\n              <div class="session-meta" style="font-size: 0.75rem; color: #9ca3af;">\n                <i class="far fa-clock"></i> Attivo: ${o}\n              </div>\n            </div>\n            ${i?"":`\n              <div class="session-actions">\n                <button class="revoke-btn" onclick="window.settingsPage.revokeSession('${s.device_id}')" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 0.5rem; font-size: 0.875rem;">\n                  <i class="fas fa-times-circle"></i> Termina\n                </button>\n              </div>\n            `}\n          </div>\n        `;e.insertAdjacentHTML("beforeend",n)}),console.log(" Session list innerHTML length:",e.innerHTML.length)}catch(e){console.error("Error loading sessions:",e);const t=document.getElementById("sessions-list");t&&(t.innerHTML='<div class="empty-sessions" style="color: #ef4444;">Errore caricamento sessioni.</div>')}}async revokeSession(e){if(confirm("Vuoi terminare questa sessione? Il dispositivo verr√† disconnesso."))try{this.showLoading("Terminazione sessione...");const{error:t}=await this.supabase.from("user_active_sessions").delete().match({user_id:this.currentUser.id,device_id:e});if(t)throw t;this.hideLoading(),this.showNotification("Sessione terminata con successo","success"),this.loadActiveSessions()}catch(e){this.hideLoading(),console.error("Error revoking session:",e),this.showNotification("Errore durante la terminazione","error")}}async signOutAllOtherSessions(){if(confirm("Sei sicuro? Tutti gli altri dispositivi verranno disconnessi immediatamente."))try{this.showLoading("Disconnessione dispositivi...");const{error:e}=await this.supabase.auth.signOut({scope:"others"});if(e)throw e;const t=localStorage.getItem("edunet_device_id");t&&await this.supabase.from("user_active_sessions").delete().neq("device_id",t).eq("user_id",this.currentUser.id),this.hideLoading(),this.showNotification("Tutti gli altri dispositivi sono stati disconnessi","success"),this.loadActiveSessions()}catch(e){this.hideLoading(),console.error("Error signing out others:",e),this.showNotification("Errore durante la disconnessione globale","error")}}async downloadData(){const e=confirm("Vuoi scaricare tutti i tuoi dati? Riceverai un file JSON con tutte le informazioni del tuo account.");if(e)try{if(this.showLoading("Preparazione archivio dati..."),!this.currentUser||!this.supabase)throw new Error("Utente non autenticato");const e=this.currentUser.id,t={export_date:(new Date).toISOString(),user_id:e,email:this.currentUser.email,metadata:{version:"1.0",platform:"EduNet19"}};console.log("üì¶ Inizio export dati per:",e);const{data:s,error:i}=await this.supabase.from("user_profiles").select("*").eq("id",e).single();if(i)throw i;t.profile=s;const o="istituto"===s.user_type?"school_institutes":"private_users",{data:a,error:n}=await this.supabase.from(o).select("*").eq("id",e).single();n?(console.warn("Dettagli profilo non trovati o errore:",n),t.details=null):t.details=a,console.log("üîÑ Recupero dati correlati...");const[r,c,l,d,u,m,h,g]=await Promise.all(["istituto"===s.user_type?this.supabase.from("institute_posts").select("*").eq("institute_id",e):{data:[],error:null},this.supabase.from("post_comments").select("*").eq("user_id",e),this.supabase.from("profile_gallery").select("*").eq("user_id",e),this.supabase.from("user_follows").select("*").eq("following_id",e),this.supabase.from("user_follows").select("*").eq("follower_id",e),this.supabase.from("post_likes").select("*").eq("user_id",e),this.supabase.from("saved_posts").select("*").eq("user_id",e),this.supabase.from("user_notifications").select("*").eq("user_id",e)]);r.error&&console.warn("Errore export posts:",r.error),t.content={posts:r.data||[],comments:c.data||[],gallery:l.data||[]},t.social={followers:d.data||[],following:u.data||[],likes:m.data||[],saved_posts:h.data||[]},t.notifications=g.data||[],console.log("‚úÖ Dati recuperati, generazione file...");const p=`edunet_data_${this.currentUser.email.split("@")[0]}_${(new Date).toISOString().split("T")[0]}.json`,f=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),y=window.URL.createObjectURL(f),v=document.createElement("a");v.style.display="none",v.href=y,v.download=p,document.body.appendChild(v),v.click(),window.URL.revokeObjectURL(y),setTimeout(()=>document.body.removeChild(v),100),this.hideLoading(),this.showNotification("‚úÖ Dati scaricati con successo!","success")}catch(e){console.error("Export error:",e),this.hideLoading(),alert("Errore durante il download dei dati: "+(e.message||"Errore sconosciuto"))}}async clearCache(){const e=confirm("Vuoi cancellare la cache? Questo eliminer√† i dati temporanei salvati nel browser per migliorare le prestazioni.\n\nNon perderai nessun dato salvato sul server.");if(e)try{this.showLoading("Pulizia cache in corso...");const e=["edunet_settings","supabase.auth.token","sb-access-token","sb-refresh-token"],t=[];for(let s=0;s<localStorage.length;s++){const i=localStorage.key(s);e.some(e=>i.includes(e))||t.push(i)}if(t.forEach(e=>localStorage.removeItem(e)),console.log(`üßπ Rimossi ${t.length} elementi da LocalStorage`),sessionStorage.clear(),console.log("üßπ SessionStorage svuotato"),"caches"in window){const e=await caches.keys();await Promise.all(e.map(e=>caches.delete(e))),console.log(`üßπ Rimossi ${e.length} cache service worker`)}await this.check2FAStatus(),await this.updateStorageUsage(),this.hideLoading(),alert("‚úÖ Cache cancellata con successo! La pagina verr√† ricaricata."),window.location.reload()}catch(e){console.error("Cache clear error:",e),this.hideLoading(),this.showNotification("Errore durante la pulizia della cache","error")}}async updateStorageUsage(){try{if(!this.currentUser)return void console.log("Storage usage: no user logged in");const e=document.querySelector(".storage-text");e&&(e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Calcolo spazio utilizzato...'),console.log("üìä Calcolo spazio utilizzato per:",this.currentUser.id);let t=null,s=null;const{data:i,error:o}=await this.supabase.rpc("get_user_storage_usage",{user_uuid:this.currentUser.id});if(o){const{data:e,error:i}=await this.supabase.rpc("get_user_storage_usage",{target_user_id:this.currentUser.id});i?s=i:t=e}else t=i;if(s||!t)return void await this.estimateStorageLocally();console.log("‚úÖ Storage usage received:",t),this.renderStorageUsage(t)}catch(e){console.error("‚ùå Error updating storage usage:",e),await this.estimateStorageLocally()}}async estimateStorageLocally(){console.log("‚ö†Ô∏è Using local storage estimation (fallback)");const e={total_bytes:0,limit_bytes:1073741824};this.renderStorageUsage(e)}renderStorageUsage(e){const t=e.total_bytes||0,s=e.limit_bytes||1073741824,i=Math.min(t/s*100,100).toFixed(1),o=this.formatBytes(t),a=this.formatBytes(s),n=document.querySelector(".storage-used"),r=document.querySelector(".storage-text");n&&(n.style.width=`${i}%`,n.style.backgroundColor=i>90?"#ef4444":i>70?"#f59e0b":"#2563eb"),r&&(r.innerHTML=`<strong>${o}</strong> di ${a} utilizzati (${i}%)`)}formatBytes(e,t=2){if(0===e)return"0 Bytes";const s=1024,i=t<0?0:t,o=["Bytes","KB","MB","GB","TB"],a=Math.floor(Math.log(e)/Math.log(s));return parseFloat((e/Math.pow(s,a)).toFixed(i))+" "+o[a]}async deactivateAccount(){const e=confirm("‚ö†Ô∏è ATTENZIONE\n\nSei sicuro di voler disattivare il tuo account?\n\nIl tuo profilo non sar√† pi√π visibile agli altri utenti, ma i tuoi dati non verranno eliminati. Potrai riattivare l'account effettuando nuovamente il login.");if(!e)return;const t=confirm("Confermi la disattivazione dell'account?");if(t)try{this.showLoading("Disattivazione account in corso...");const{error:e}=await this.supabase.auth.updateUser({data:{status:"deactivated",deactivated_at:(new Date).toISOString()}});if(e)throw e;await this.supabase.from("user_profiles").update({profile_completed:!1}).eq("id",this.currentUser.id),this.hideLoading(),alert("Account disattivato con successo. Verrai disconnesso."),await this.supabase.auth.signOut(),window.location.href=window.AppConfig.getPageUrl("index.html")}catch(e){this.hideLoading(),console.error("Error deactivating account:",e),alert("Errore durante la disattivazione: "+e.message)}}async deleteAccount(){const e=confirm("üö® PERICOLO\n\nSei sicuro di voler ELIMINARE PERMANENTEMENTE il tuo account?\n\nQuesta azione √® IRREVERSIBILE!\n\n‚Ä¢ Tutti i tuoi post verranno eliminati\n‚Ä¢ Tutti i tuoi progetti verranno eliminati\n‚Ä¢ Tutti i tuoi dati verranno cancellati\n‚Ä¢ Tutte le tue immagini verranno eliminate\n\nNon sar√† possibile recuperare l'account.");if(!e)return;const t=prompt("Per confermare, inserisci la tua password:");if(!t)return;const s=confirm("ULTIMA CONFERMA: Eliminare definitivamente l'account?\n\nDigita OK per procedere.");if(s)try{this.showLoading("Eliminazione account in corso...");const{data:{user:e},error:s}=await this.supabase.auth.getUser();if(s||!e)throw new Error("Utente non autenticato");const i=e.email,{error:o}=await this.supabase.auth.signInWithPassword({email:i,password:t});if(o)throw new Error("Password errata");console.log("‚úÖ Password verificata"),console.log("üóëÔ∏è Eliminazione dati database...");const{error:a}=await this.supabase.from("institute_posts").delete().eq("institute_id",e.id);a&&console.warn("Errore eliminazione post:",a);const{data:n}=await this.supabase.from("user_profiles").select("user_type").eq("id",e.id).single();n&&("istituto"===n.user_type?await this.supabase.from("school_institutes").delete().eq("id",e.id):await this.supabase.from("private_users").delete().eq("id",e.id)),await this.supabase.from("user_profiles").delete().eq("id",e.id),console.log("‚úÖ Dati database eliminati"),console.log("üóëÔ∏è Eliminazione immagini...");try{await this.supabase.storage.from("avatars").remove([`${e.id}/`]),await this.supabase.storage.from("profile-images").remove([`${e.id}/`]),await this.supabase.storage.from("profile-gallery").remove([`${e.id}/`])}catch(e){console.warn("Errore eliminazione storage:",e)}console.log("‚úÖ Immagini eliminate"),console.log("üóëÔ∏è Eliminazione account Auth..."),await this.supabase.auth.signOut(),this.hideLoading(),alert("‚úÖ Account eliminato con successo!\n\nTutti i tuoi dati sono stati cancellati.\n\nSarai reindirizzato alla pagina di login."),window.location.href=window.AppConfig.getPageUrl("index.html")}catch(e){this.hideLoading(),console.error("‚ùå Errore eliminazione account:",e),alert(`Errore durante l'eliminazione dell'account:\n\n${e.message}\n\nRiprova o contatta il supporto.`)}}validateEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}showLoading(e="Caricamento..."){const t=document.createElement("div");t.id="loading-overlay",t.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: rgba(0, 0, 0, 0.7);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      z-index: 99999;\n    ";const s=document.createElement("div");s.style.cssText="\n      background: white;\n      padding: 2rem 3rem;\n      border-radius: 1rem;\n      text-align: center;\n      box-shadow: 0 8px 32px rgba(0,0,0,0.3);\n    ";const i=document.createElement("div");i.style.cssText="\n      width: 50px;\n      height: 50px;\n      border: 4px solid #f3f3f3;\n      border-top: 4px solid #2563eb;\n      border-radius: 50%;\n      animation: spin 1s linear infinite;\n      margin: 0 auto 1rem;\n    ";const o=document.createElement("p");if(o.textContent=e,o.style.cssText="\n      margin: 0;\n      color: #333;\n      font-size: 1rem;\n      font-weight: 500;\n    ",s.appendChild(i),s.appendChild(o),t.appendChild(s),document.body.appendChild(t),!document.getElementById("spinner-style")){const e=document.createElement("style");e.id="spinner-style",e.textContent="\n        @keyframes spin {\n          0% { transform: rotate(0deg); }\n          100% { transform: rotate(360deg); }\n        }\n      ",document.head.appendChild(e)}}hideLoading(){const e=document.getElementById("loading-overlay");e&&e.remove()}showNotification(e,t="info"){const s=document.createElement("div");s.className=`notification notification-${t}`,s.textContent=e,s.style.cssText="\n      position: fixed;\n      top: calc(var(--top-nav-height) + 1rem);\n      right: 1rem;\n      background: var(--color-white);\n      padding: 1rem 1.5rem;\n      border-radius: 0.5rem;\n      box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n      z-index: 10000;\n      animation: slideIn 0.3s ease;\n    ",document.body.appendChild(s),setTimeout(()=>{s.style.animation="slideOut 0.3s ease",setTimeout(()=>s.remove(),300)},3e3)}async handleLogout(){if(confirm("Sei sicuro di voler uscire?"))try{this.supabase&&await this.supabase.auth.signOut(),window.location.href=window.AppConfig.getPageUrl("index.html")}catch(e){console.error("Error during logout:",e),window.location.href=window.AppConfig.getPageUrl("index.html")}}async loadUserProfile(){try{if(!this.supabase||!this.currentUser)return;const{data:e,error:t}=await this.supabase.from("school_institutes").select("institute_name, institute_type").eq("id",this.currentUser.id).maybeSingle();if(t)throw t;if(e){const t=document.getElementById("user-name"),s=document.getElementById("user-full-name"),i=document.getElementById("user-type-display");t&&(t.textContent=e.institute_name||"Utente"),s&&(s.textContent=e.institute_name||"Utente"),i&&(i.textContent=e.institute_type||"Istituto Scolastico")}}catch(e){console.error("Error loading profile:",e)}}async check2FAStatus(){try{if(!window.twoFactorAuth)return void console.warn("2FA library not loaded");const e=await window.twoFactorAuth.is2FAEnabled(),t=document.getElementById("setup-2fa-btn"),s=document.getElementById("disable-2fa-btn"),i=document.getElementById("2fa-status-text");e?(t&&(t.style.display="none"),s&&(s.style.display="inline-flex"),i&&(i.textContent="‚úÖ Autenticazione a due fattori attiva")):(t&&(t.style.display="inline-flex"),s&&(s.style.display="none"),i&&(i.textContent="Aggiungi un livello extra di sicurezza al tuo account"))}catch(e){console.error("Error checking 2FA status:",e)}}async setup2FA(){try{if(this.showLoading("Generazione codice 2FA..."),!window.twoFactorAuth)throw new Error("Libreria 2FA non disponibile");const{secret:e,qrCodeUrl:t,backupCodes:s}=await window.twoFactorAuth.generateSecret();this.hideLoading(),this.tempBackupCodes=s;const i=document.getElementById("2fa-setup-modal");if(i){i.style.display="flex",document.getElementById("2fa-step-1").style.display="block",document.getElementById("2fa-step-2").style.display="none",document.getElementById("2fa-step-3").style.display="none",document.getElementById("qr-code-loading").style.display="none";const s=document.getElementById("qr-code-image"),o=`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(t)}`;s.src=o,s.style.display="block";const a=document.getElementById("secret-code");a&&window.twoFactorAuth.formatSecret?a.textContent=window.twoFactorAuth.formatSecret(e):a.textContent=e,setTimeout(()=>{const e=document.createElement("button");e.className="btn-primary",e.style.width="100%",e.style.marginTop="1rem",e.innerHTML='<i class="fas fa-arrow-right"></i> Continua',e.onclick=()=>this.goTo2FAStep(2);const t=document.getElementById("2fa-step-1");t&&!t.querySelector(".btn-primary")&&t.appendChild(e)},100)}}catch(e){this.hideLoading(),console.error("Error setting up 2FA:",e),this.showNotification("Errore durante la configurazione del 2FA","error")}}goTo2FAStep(e){if(document.getElementById("2fa-step-1").style.display=1===e?"block":"none",document.getElementById("2fa-step-2").style.display=2===e?"block":"none",document.getElementById("2fa-step-3").style.display=3===e?"block":"none",2===e){const e=document.getElementById("verification-code-input");e&&(e.value="",e.focus());const t=document.getElementById("verification-error");t&&(t.style.display="none")}}async verify2FACode(){try{const e=document.getElementById("verification-code-input"),t=e?.value;if(!t||6!==t.length)return void this.show2FAError("Inserisci un codice a 6 cifre");this.showLoading("Verifica in corso...");const s=await window.twoFactorAuth.verifyCode(t);if(!s)return this.hideLoading(),void this.show2FAError("Codice non valido. Riprova.");await window.twoFactorAuth.enable2FA(t),this.hideLoading(),this.goTo2FAStep(3),this.displayBackupCodes()}catch(e){this.hideLoading(),console.error("Error verifying 2FA code:",e),this.show2FAError("Errore durante la verifica. Riprova.")}}show2FAError(e){const t=document.getElementById("verification-error");t&&(t.textContent=e,t.style.display="block")}displayBackupCodes(){const e=document.getElementById("backup-codes-container");e&&this.tempBackupCodes&&(e.innerHTML=this.tempBackupCodes.map((e,t)=>`<div style="padding: 0.5rem 0;">${t+1}. <strong>${e}</strong></div>`).join(""))}downloadBackupCodes(){this.tempBackupCodes&&window.twoFactorAuth&&(window.twoFactorAuth.downloadBackupCodes(this.tempBackupCodes),this.showNotification("Codici di backup scaricati","success"))}finish2FASetup(){this.close2FAModal(),this.tempBackupCodes=null,this.showNotification("‚úÖ Autenticazione a due fattori attivata con successo!","success"),this.check2FAStatus()}close2FAModal(){const e=document.getElementById("2fa-setup-modal");e&&(e.style.display="none"),this.goTo2FAStep(1),this.tempBackupCodes=null}showDisable2FAModal(){const e=document.getElementById("2fa-disable-modal");if(e){e.style.display="flex";const t=document.getElementById("disable-2fa-password");t&&(t.value="",t.focus());const s=document.getElementById("disable-2fa-error");s&&(s.style.display="none")}}closeDisable2FAModal(){const e=document.getElementById("2fa-disable-modal");e&&(e.style.display="none")}async disable2FA(){try{const e=document.getElementById("disable-2fa-password"),t=e?.value;if(!t)return void this.showDisable2FAError("Inserisci la tua password");this.showLoading("Disattivazione 2FA..."),await window.twoFactorAuth.disable2FA(t),this.hideLoading(),this.closeDisable2FAModal(),this.showNotification("Autenticazione a due fattori disattivata","info"),this.check2FAStatus()}catch(e){this.hideLoading(),console.error("Error disabling 2FA:",e),this.showDisable2FAError(e.message||"Errore durante la disattivazione")}}showDisable2FAError(e){const t=document.getElementById("disable-2fa-error");t&&(t.textContent=e,t.style.display="block")}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.settingsPage=new SettingsPage}):window.settingsPage=new SettingsPage;