!function(){"use strict";let e=null,t=null;async function n(){console.log("ðŸ”„ MIUR Update - Initializing..."),await i(),e&&e.institute_code&&(a(),o()),console.log("âœ… MIUR Update - Initialized")}async function i(){let t=0;const n=50;for(;t<n;){if(window.editProfilePage&&window.editProfilePage.currentProfile)return e=window.editProfilePage.currentProfile,void console.log("âœ… Profilo caricato per MIUR update:",e.institute_name);await new Promise(e=>setTimeout(e,100)),t++}console.warn("âš ï¸ Timeout waiting for profile data")}function a(){const t=document.getElementById("miurUpdateSection"),n=document.getElementById("currentMiurCode"),i=document.getElementById("lastMiurUpdate");if(t){if(n&&(n.textContent=e.institute_code),i&&e.miur_data&&e.miur_data.data_import){const t=new Date(e.miur_data.data_import);i.textContent=t.toLocaleDateString("it-IT",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}else i&&(i.textContent="Mai aggiornato");t.style.display="block"}}function o(){const e=document.getElementById("updateFromMiurBtn");e&&e.addEventListener("click",r)}async function r(){const n=document.getElementById("updateFromMiurBtn");if(e&&e.institute_code){n.disabled=!0,n.classList.add("loading"),n.querySelector("span").textContent="Caricamento...";try{if(console.log("ðŸ” Aggiornamento dati MIUR per codice:",e.institute_code),t=await window.miurAutocomplete.findSchoolByCode(e.institute_code),!t)return void alert("Codice non trovato nel database MIUR. Potrebbe essere stato modificato.");const n=window.miurAutocomplete.validateData(t);if(!n.isValid)return void alert("Dati MIUR non validi: "+n.errors.join(", "));const i=s(e,t);if(0===i.length)return void alert("I dati sono giÃ  aggiornati. Nessuna modifica necessaria.");l(i)}catch(e){console.error("âŒ Errore aggiornamento MIUR:",e),alert("Errore durante l'aggiornamento. Riprova piÃ¹ tardi.")}finally{n.disabled=!1,n.classList.remove("loading"),n.querySelector("span").textContent="Aggiorna da MIUR"}}else alert("Codice MIUR non trovato nel profilo")}function s(e,t){const n=[],i=[{key:"institute_name",label:"Nome Istituto",currentKey:"institute_name",miurKey:"institute_name"},{key:"institute_type",label:"Tipo Istituto",currentKey:"institute_type",miurKey:"institute_type"},{key:"email",label:"Email",currentKey:"email",miurKey:"email"},{key:"website",label:"Sito Web",currentKey:"website",miurKey:"website"},{key:"address",label:"Indirizzo",currentKey:"address",miurKey:"address"},{key:"city",label:"CittÃ ",currentKey:"city",miurKey:"city"},{key:"province",label:"Provincia",currentKey:"province",miurKey:"province"},{key:"cap",label:"CAP",currentKey:"cap",miurKey:"cap"}];return i.forEach(i=>{const a=e[i.currentKey]||"",o=t[i.miurKey]||"";a!==o&&n.push({key:i.key,label:i.label,oldValue:a,newValue:o})}),n}function l(e){const t=document.createElement("div");t.className="miur-update-modal",t.innerHTML=`\n      <div class="miur-update-modal-content">\n        <div class="miur-update-modal-header">\n          <i class="fas fa-sync-alt"></i>\n          <h3>Aggiorna Dati da MIUR</h3>\n        </div>\n        \n        <p>Sono stati trovati <strong>${e.length} aggiornamenti</strong> dal database MIUR:</p>\n        \n        <div class="miur-changes-preview">\n          ${e.map(e=>`\n            <div class="miur-change-item">\n              <span class="miur-change-label">${e.label}:</span>\n              <div class="miur-change-values">\n                ${e.oldValue?`<span class="miur-old-value">${e.oldValue}</span>`:""}\n                <span class="miur-new-value">${e.newValue||"Non disponibile"}</span>\n              </div>\n            </div>\n          `).join("")}\n        </div>\n        \n        <p><strong>Vuoi applicare questi aggiornamenti?</strong></p>\n        <p class="text-muted">I dati verranno sovrascritti con quelli del database MIUR.</p>\n        \n        <div class="miur-update-modal-actions">\n          <button type="button" class="btn-cancel" onclick="closeMiurModal()">Annulla</button>\n          <button type="button" class="btn-confirm" onclick="applyMiurUpdates()">Applica Aggiornamenti</button>\n        </div>\n      </div>\n    `,document.body.appendChild(t),setTimeout(()=>t.classList.add("show"),10),document.addEventListener("keydown",function e(t){"Escape"===t.key&&(closeMiurModal(),document.removeEventListener("keydown",e))})}function d(e){const t={"institute-name":e.institute_name,"institute-type":e.institute_type,email:e.email,website:e.website,address:e.address,city:e.city,province:e.province};Object.entries(t).forEach(([e,t])=>{const n=document.getElementById(e);n&&t&&(n.value=t,n.dispatchEvent(new Event("change",{bubbles:!0})))}),console.log("âœ… Campi form aggiornati con dati MIUR")}function c(){const e=document.createElement("div");e.style.cssText="\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);\n      color: white;\n      padding: 1rem 1.5rem;\n      border-radius: 8px;\n      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);\n      z-index: 1001;\n      display: flex;\n      align-items: center;\n      gap: 0.5rem;\n      font-weight: 600;\n      animation: slideInRight 0.3s ease;\n    ",e.innerHTML='\n      <i class="fas fa-check-circle"></i>\n      <span>Dati aggiornati da MIUR!</span>\n    ',document.body.appendChild(e),setTimeout(()=>{e.style.animation="slideOutRight 0.3s ease",setTimeout(()=>e.remove(),300)},3e3)}document.addEventListener("DOMContentLoaded",function(){n()}),window.closeMiurModal=function(){const e=document.querySelector(".miur-update-modal");e&&(e.classList.remove("show"),setTimeout(()=>e.remove(),300))},window.applyMiurUpdates=function(){t&&(d(t),window.closeMiurModal(),c())},console.log("âœ… MIUR Update - Script loaded")}();const style=document.createElement("style");style.textContent="\n  @keyframes slideInRight {\n    from {\n      opacity: 0;\n      transform: translateX(100px);\n    }\n    to {\n      opacity: 1;\n      transform: translateX(0);\n    }\n  }\n  \n  @keyframes slideOutRight {\n    from {\n      opacity: 1;\n      transform: translateX(0);\n    }\n    to {\n      opacity: 0;\n      transform: translateX(100px);\n    }\n  }\n  \n  .text-muted {\n    color: #6c757d;\n    font-size: 0.9rem;\n  }\n",document.head.appendChild(style);