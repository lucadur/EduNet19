class EditProfilePage{constructor(){this.currentUser=null,this.supabase=null,this.userType=null,this.methodologies=[],this.interests=[],this.coverImage=null,this.avatarImage=null,this.init()}async init(){console.log("‚úèÔ∏è EditProfilePage initializing..."),await this.initSupabase(),await this.loadProfileData(),window.avatarManager&&await window.avatarManager.loadCurrentUserAvatar(),this.setupEventListeners(),await this.initCollaborators(),console.log("‚úÖ EditProfilePage initialized")}async initCollaborators(){console.log("üë• initCollaborators - userType:",this.userType,"collaboratorData:",this.collaboratorData);let e="istituto"===this.userType,t=this.currentUser?.id;if(!e&&this.collaboratorData?.is_collaborator&&"admin"===this.collaboratorData.role&&(e=!0,t=this.collaboratorData.institute_id,console.log("üë• Collaboratore admin pu√≤ gestire collaboratori per istituto:",this.collaboratorData.institute_name)),!e){const e=document.getElementById("collaborators-section");return void(e&&(e.style.display="none",console.log("üë• Sezione collaboratori nascosta (non autorizzato)")))}const o=document.getElementById("collaborators-section");o&&(o.style.display="",console.log("üë• Sezione collaboratori visibile")),window.CollaboratorsManager&&t?(console.log("üë• Inizializzazione CollaboratorsManager per istituto:",t),this.collaboratorsManager=new window.CollaboratorsManager,await this.collaboratorsManager.init(t)):console.warn("üë• CollaboratorsManager non disponibile:",{hasManager:!!window.CollaboratorsManager,hasInstituteId:!!t})}async initSupabase(){if(window.supabaseClientManager){this.supabase=await window.supabaseClientManager.getClient();const{data:{user:e}}=await this.supabase.auth.getUser();this.currentUser=e}}setupEventListeners(){const e=document.getElementById("edit-profile-form");e&&e.addEventListener("submit",e=>this.handleSubmit(e)),this.setupImageUploads(),this.setupTagsInput("methodologies"),this.setupTagsInput("interests");const t=document.getElementById("bio");t&&t.addEventListener("input",e=>{const t=document.getElementById("bio-count");t&&(t.textContent=e.target.value.length)});const o=document.getElementById("private-bio");o&&o.addEventListener("input",e=>{const t=document.getElementById("private-bio-count");t&&(t.textContent=e.target.value.length)});const a=document.getElementById("regulations-text");a&&a.addEventListener("input",e=>{const t=document.getElementById("regulations-count");t&&(t.textContent=e.target.value.length)});const n=document.getElementById("logout-btn");n&&n.addEventListener("click",()=>this.handleLogout());const i=document.getElementById("user-menu-btn"),s=i?.closest(".nav-item.dropdown");i&&s&&(i.addEventListener("click",e=>{e.stopPropagation(),document.querySelectorAll(".nav-item.dropdown.open").forEach(e=>{e!==s&&e.classList.remove("open")}),s.classList.toggle("open")}),document.addEventListener("click",()=>{s.classList.remove("open")}));const r=document.getElementById("notifications-btn"),l=document.getElementById("messages-btn");[r,l].forEach(e=>{if(e){const t=e.closest(".nav-item.dropdown");t&&e.addEventListener("click",e=>{e.stopPropagation(),document.querySelectorAll(".nav-item.dropdown.open").forEach(e=>{e!==t&&e.classList.remove("open")}),t.classList.toggle("open")})}})}setupImageUploads(){const e=document.getElementById("cover-upload"),t=document.getElementById("cover-preview"),o=document.getElementById("remove-cover");t&&e&&(t.addEventListener("click",()=>e.click()),e.addEventListener("change",e=>this.handleImageUpload(e,"cover"))),o&&o.addEventListener("click",()=>{this.coverImage=null,t.innerHTML='<i class="fas fa-image" aria-hidden="true"></i><p>Clicca per caricare</p>',o.style.display="none"});const a=document.getElementById("avatar-upload"),n=document.getElementById("avatar-preview"),i=document.getElementById("remove-avatar");n&&a&&(n.addEventListener("click",()=>a.click()),a.addEventListener("change",e=>this.handleImageUpload(e,"avatar"))),i&&i.addEventListener("click",()=>{this.avatarImage=null,n.innerHTML='<i class="fas fa-user" aria-hidden="true"></i>',i.style.display="none"})}handleImageUpload(e,t){const o=e.target.files[0];if(!o)return;if(!o.type.startsWith("image/"))return void alert("Per favore seleziona un file immagine valido");if(o.size>5242880)return void alert("L'immagine deve essere inferiore a 5MB");"cover"===t?this.coverImage=o:"avatar"===t&&(this.avatarImage=o);const a=new FileReader;a.onload=e=>{if("cover"===t){const t=document.getElementById("cover-preview");t.style.backgroundImage=`url(${e.target.result})`,t.style.backgroundSize="cover",t.style.backgroundPosition="center top",t.innerHTML="",document.getElementById("remove-cover").style.display="block"}else if("avatar"===t){const t=document.getElementById("avatar-preview");t.style.backgroundImage=`url(${e.target.result})`,t.style.backgroundSize="cover",t.style.backgroundPosition="center",t.innerHTML="",document.getElementById("remove-avatar").style.display="block"}},a.readAsDataURL(o)}setupTagsInput(e){const t=document.getElementById(`${e}-input`),o=document.getElementById(`${e}-display`);t&&o&&t.addEventListener("keydown",o=>{if("Enter"===o.key){o.preventDefault();const a=t.value.trim();a&&(this.addTag(e,a),t.value="")}})}addTag(e,t){const o="methodologies"===e?this.methodologies:this.interests;o.includes(t)||(o.push(t),this.renderTags(e))}removeTag(e,t){"methodologies"===e?this.methodologies=this.methodologies.filter(e=>e!==t):this.interests=this.interests.filter(e=>e!==t),this.renderTags(e)}renderTags(e){const t=document.getElementById(`${e}-display`),o="methodologies"===e?this.methodologies:this.interests;t&&(t.innerHTML=o.map(t=>`\n      <span class="tag">\n        ${t}\n        <button type="button" class="remove-tag" onclick="window.editProfilePage.removeTag('${e}', '${t}')" aria-label="Rimuovi ${t}">\n          <i class="fas fa-times" aria-hidden="true"></i>\n        </button>\n      </span>\n    `).join(""))}async loadProfileData(){try{if(!this.supabase||!this.currentUser)return void console.log("No user logged in");console.log("Loading profile data...");const{data:e,error:t}=await this.supabase.from("user_profiles").select("user_type").eq("id",this.currentUser.id).single();if(t)return void console.error("Error loading user profile:",t);if(!e)return void console.error("User profile not found");let o=e.user_type;console.log("User type:",o),this.userType=o;const{data:a}=await this.supabase.rpc("get_collaborator_profile");a?.is_collaborator&&(console.log("üë• Utente √® un collaboratore:",a),this.collaboratorData=a,this.updateNavbarForCollaborator(a)),"istituto"===o?await this.loadInstituteProfile():await this.loadPrivateUserProfile(),this.adjustFormForUserType(o)}catch(e){console.error("Error loading profile:",e)}}async loadInstituteProfile(){try{const{data:e,error:t}=await this.supabase.from("school_institutes").select("*").eq("id",this.currentUser.id).single();if(t)throw t;e&&this.populateInstituteForm(e)}catch(e){console.error("Error loading institute profile:",e)}}async loadPrivateUserProfile(){try{const{data:e,error:t}=await this.supabase.from("private_users").select("*").eq("id",this.currentUser.id).single();if(t)throw t;e&&this.populatePrivateUserForm(e)}catch(e){console.error("Error loading private user profile:",e)}}populateInstituteForm(e){if(this.setValue("institute-name",e.institute_name),this.setValue("institute-type",e.institute_type),this.setValue("bio",e.bio),e.bio){const t=document.getElementById("bio-count");t&&(t.textContent=e.bio.length)}if(this.setValue("email",e.email),this.setValue("phone",e.phone),this.setValue("website",e.website),this.setValue("address",e.address),this.setValue("city",e.city),this.setValue("province",e.province),this.setValue("classroom-count",e.classroom_count),this.setValue("internal-area",e.internal_area_sqm),this.setValue("external-spaces",e.external_spaces),e.opening_hours&&"object"==typeof e.opening_hours){const t={lunedi:"monday",martedi:"tuesday",mercoledi:"wednesday",giovedi:"thursday",venerdi:"friday",sabato:"saturday"};Object.entries(e.opening_hours).forEach(([e,o])=>{const a=t[e];a&&this.setValue(`hours-${a}`,o)})}if(this.setValue("regulations-url",e.internal_regulations_url),this.setValue("regulations-text",e.internal_regulations_text),e.internal_regulations_text){const t=document.getElementById("regulations-count");t&&(t.textContent=e.internal_regulations_text.length)}if(this.setValue("specializations",e.specializations),this.setValue("facebook",e.facebook),this.setValue("twitter",e.twitter),this.setValue("instagram",e.instagram),this.setValue("linkedin",e.linkedin),e.cover_image){const t=document.getElementById("cover-preview");if(t){t.style.backgroundImage=`url(${e.cover_image})`,t.style.backgroundSize="cover",t.style.backgroundPosition="center top",t.innerHTML="";const o=document.getElementById("remove-cover");o&&(o.style.display="block")}}if(e.logo_url&&!e.logo_url.includes("Glutatione")&&!e.logo_url.includes("cover")){const t=document.getElementById("avatar-preview");if(t){t.style.backgroundImage=`url(${e.logo_url})`,t.style.backgroundSize="cover",t.style.backgroundPosition="center",t.innerHTML="";const o=document.getElementById("remove-avatar");o&&(o.style.display="block")}}e.methodologies&&Array.isArray(e.methodologies)&&(this.methodologies=e.methodologies,this.renderTags("methodologies")),e.interests&&Array.isArray(e.interests)&&(this.interests=e.interests,this.renderTags("interests"));const t=document.getElementById("user-name"),o=document.getElementById("user-full-name"),a=document.getElementById("user-type-display");t&&(t.textContent=e.institute_name||"Utente"),o&&(o.textContent=e.institute_name||"Utente"),a&&(a.textContent=e.institute_type||"Istituto Scolastico")}populatePrivateUserForm(e){if(this.setValue("first-name",e.first_name),this.setValue("last-name",e.last_name),this.setValue("private-bio",e.bio),e.bio){const t=document.getElementById("private-bio-count");t&&(t.textContent=e.bio.length)}if(e.avatar_url){const t=document.getElementById("avatar-preview");if(t){t.style.backgroundImage=`url(${e.avatar_url})`,t.style.backgroundSize="cover",t.style.backgroundPosition="center",t.innerHTML="";const o=document.getElementById("remove-avatar");o&&(o.style.display="block")}}if(e.cover_image_url){const t=document.getElementById("cover-preview");if(t){t.style.backgroundImage=`url(${e.cover_image_url})`,t.style.backgroundSize="cover",t.style.backgroundPosition="center top",t.innerHTML="";const o=document.getElementById("remove-cover");o&&(o.style.display="block")}}const t=document.getElementById("user-name"),o=document.getElementById("user-full-name"),a=document.getElementById("user-type-display"),n=`${e.first_name||""} ${e.last_name||""}`.trim();t&&(t.textContent=e.first_name||"Utente"),o&&(o.textContent=n||"Utente"),this.collaboratorData?this.updateNavbarForCollaborator(this.collaboratorData):a&&(a.textContent="Utente Privato")}updateNavbarForCollaborator(e){const t={admin:"Amministratore",editor:"Editor",viewer:"Visualizzatore"},o=`${e.first_name||""} ${e.last_name||""}`.trim()||"Collaboratore",a=`${t[e.role]||"Collaboratore"} - ${e.institute_name}`,n=document.getElementById("user-name"),i=document.getElementById("user-full-name"),s=document.getElementById("user-type-display");n&&(n.textContent=o),i&&(i.textContent=o),s&&(s.textContent=a);const r=document.getElementById("mobile-user-name"),l=document.getElementById("mobile-user-type");r&&(r.textContent=o),l&&(l.textContent=a),console.log("üë• Navbar aggiornata per collaboratore:",o)}adjustFormForUserType(e){console.log("üîß Adjusting form for user type:",e);const t=document.getElementById("user-type");t&&(t.value=e,t.disabled=!0,t.style.opacity="0.6",t.style.cursor="not-allowed",t.title="Il tipo di utente non pu√≤ essere modificato");const o=document.querySelectorAll(".institute-only"),a=document.querySelectorAll(".private-only"),n=document.querySelector(".page-header .header-content h1"),i=document.querySelector(".page-header .header-content p");"istituto"===e?(o.forEach(e=>e.style.display=""),a.forEach(e=>e.style.display="none"),n&&(n.innerHTML='<i class="fas fa-edit" aria-hidden="true"></i> Modifica Profilo Istituto'),i&&(i.textContent="Aggiorna le informazioni del tuo istituto scolastico"),console.log("‚úÖ Form configurato per ISTITUTO")):(o.forEach(e=>e.style.display="none"),a.forEach(e=>e.style.display=""),n&&(n.innerHTML='<i class="fas fa-user-edit" aria-hidden="true"></i> Modifica Profilo'),i&&(i.textContent="Aggiorna le tue informazioni personali"),console.log("‚úÖ Form configurato per UTENTE PRIVATO"))}setValue(e,t){const o=document.getElementById(e);if(o&&t)if("SELECT"===o.tagName){const a=Array.from(o.options),n=a.find(e=>e.value===t);if(n)o.value=t;else{const n=t.toLowerCase(),i=a.find(e=>e.value.toLowerCase()===n||e.value.toLowerCase().includes(n)||n.includes(e.value.toLowerCase()));i?(o.value=i.value,console.log(`üìã Select "${e}": matched "${t}" ‚Üí "${i.value}"`)):console.warn(`‚ö†Ô∏è Select "${e}": no match for "${t}"`)}}else o.value=t}async handleSubmit(e){e.preventDefault();const t=document.getElementById("save-profile-btn");t&&(t.disabled=!0,t.innerHTML='<i class="fas fa-spinner fa-spin" aria-hidden="true"></i> Salvataggio...');try{if(!this.supabase||!this.currentUser)throw new Error("User not authenticated");if(!this.userType){const{data:e}=await this.supabase.from("user_profiles").select("user_type").eq("id",this.currentUser.id).single();this.userType=e?.user_type}"istituto"===this.userType?await this.saveInstituteProfile():await this.savePrivateUserProfile(),this.showNotification("Profilo aggiornato con successo!","success"),setTimeout(()=>{window.location.href=window.AppConfig.getPageUrl("pages/profile/profile.html")},1500)}catch(e){console.error("Error saving profile:",e),this.showNotification("Errore durante il salvataggio: "+e.message,"error")}finally{t&&(t.disabled=!1,t.innerHTML='<i class="fas fa-save" aria-hidden="true"></i> Salva Modifiche')}}async saveInstituteProfile(){const e=this.getFormData();if(this.coverImage&&this.coverImage instanceof File){const t=await this.uploadImage(this.coverImage,"cover");t&&(e.cover_image=t)}if(this.avatarImage&&this.avatarImage instanceof File){console.log("üì§ Uploading avatar...",this.avatarImage.name);const t=await this.uploadImage(this.avatarImage,"avatar");console.log("üì• Avatar upload result:",t),t&&(e.logo_url=t,console.log("‚úÖ Avatar URL set in formData:",t))}console.log("Saving institute profile data:",e);const{error:t}=await this.supabase.from("school_institutes").upsert({id:this.currentUser.id,...e,updated_at:(new Date).toISOString()});if(t)throw t}async savePrivateUserProfile(){const e={},t=document.getElementById("first-name")?.value?.trim();t&&(e.first_name=t);const o=document.getElementById("last-name")?.value?.trim();o&&(e.last_name=o);const a=document.getElementById("private-bio")?.value?.trim();if(void 0!==a&&(e.bio=a||""),this.coverImage&&this.coverImage instanceof File){const t=await this.uploadImage(this.coverImage,"cover");t&&(e.cover_image_url=t)}if(this.avatarImage&&this.avatarImage instanceof File){console.log("üì§ Uploading avatar...",this.avatarImage.name);const t=await this.uploadImage(this.avatarImage,"avatar");console.log("üì• Avatar upload result:",t),t&&(e.avatar_url=t,console.log("‚úÖ Avatar URL set in formData:",t))}console.log("üíæ Saving private user profile data:",JSON.stringify(e,null,2)),console.log("üîë User ID:",this.currentUser.id);const{data:n,error:i}=await this.supabase.from("private_users").select("id").eq("id",this.currentUser.id).maybeSingle();if(i)throw console.error("‚ùå Error checking record:",i),i;if(!n)throw console.error("‚ùå Record not found in private_users!"),console.error("‚ö†Ô∏è Esegui lo script SQL per creare il record"),new Error("Record utente non trovato. Contatta l'amministratore.");console.log("‚úÖ Record exists, proceeding with update...");const{data:s,error:r}=await this.supabase.from("private_users").update({...e,updated_at:(new Date).toISOString()}).eq("id",this.currentUser.id).select();if(r)throw console.error("‚ùå Error details:",JSON.stringify(r,null,2)),r;console.log("‚úÖ Profile saved successfully:",s)}async uploadImage(e,t){try{console.log(`üì§ Starting upload for ${t}:`,e.name);const o=e.name.split(".").pop(),a=`${t}_${Date.now()}.${o}`,n="avatar"===t?"avatars":"profile-images",i=`${this.currentUser.id}/${a}`;console.log(`üì¶ Uploading to bucket: ${n}, path: ${i}`);const{data:s,error:r}=await this.supabase.storage.from(n).upload(i,e,{cacheControl:"3600",upsert:!0});if(r)return console.error("‚ùå Error uploading image:",r),this.showNotification(`Errore upload ${t}: ${r.message}`,"error"),null;console.log("‚úÖ Upload successful:",s);const{data:{publicUrl:l}}=this.supabase.storage.from(n).getPublicUrl(i);return console.log("üîó Public URL:",l),l}catch(e){return console.error("‚ùå Error in uploadImage:",e),this.showNotification(`Errore upload: ${e.message}`,"error"),null}}getFormData(){const e={},t=document.getElementById("institute-name")?.value;e.institute_name=t||"";const o=document.getElementById("institute-type")?.value;e.institute_type=o||"Altro";const a=document.getElementById("bio")?.value;null!=a&&(e.bio=a);const n=document.getElementById("email")?.value;n&&(e.email=n);const i=document.getElementById("phone")?.value;i&&(e.phone=i);const s=document.getElementById("website")?.value;s&&(e.website=s);const r=document.getElementById("address")?.value;r&&(e.address=r);const l=document.getElementById("city")?.value;l&&(e.city=l);const c=document.getElementById("province")?.value;c&&(e.province=c);const d=document.getElementById("specializations")?.value;d&&(e.specializations=d);const u=document.getElementById("classroom-count")?.value;u&&(e.classroom_count=parseInt(u));const m=document.getElementById("internal-area")?.value;m&&(e.internal_area_sqm=parseFloat(m));const g=document.getElementById("external-spaces")?.value;g&&(e.external_spaces=g);const h={},p=["monday","tuesday","wednesday","thursday","friday","saturday"],v=["lunedi","martedi","mercoledi","giovedi","venerdi","sabato"];p.forEach((e,t)=>{const o=document.getElementById(`hours-${e}`)?.value;o&&(h[v[t]]=o)}),Object.keys(h).length>0&&(e.opening_hours=h);const y=document.getElementById("regulations-url")?.value;y&&(e.internal_regulations_url=y);const f=document.getElementById("regulations-text")?.value;f&&(e.internal_regulations_text=f),this.methodologies&&this.methodologies.length>0&&(e.methodologies=this.methodologies),this.interests&&this.interests.length>0&&(e.interests=this.interests);const b=document.getElementById("facebook")?.value;b&&(e.facebook=b);const E=document.getElementById("twitter")?.value;E&&(e.twitter=E);const I=document.getElementById("instagram")?.value;I&&(e.instagram=I);const w=document.getElementById("linkedin")?.value;return w&&(e.linkedin=w),e}async handleLogout(){if(confirm("Sei sicuro di voler uscire? Le modifiche non salvate andranno perse."))try{this.supabase&&await this.supabase.auth.signOut(),window.location.href=window.AppConfig.getPageUrl("index.html")}catch(e){console.error("Error during logout:",e),window.location.href=window.AppConfig.getPageUrl("index.html")}}showNotification(e,t="info"){const o=document.createElement("div");o.className=`notification notification-${t}`,o.style.cssText=`\n      position: fixed;\n      top: calc(var(--top-nav-height) + var(--space-4));\n      right: var(--space-4);\n      background: ${"success"===t?"#10b981":"error"===t?"#ef4444":"#3b82f6"};\n      color: white;\n      padding: var(--space-4) var(--space-6);\n      border-radius: var(--radius-lg);\n      box-shadow: var(--shadow-lg);\n      z-index: 9999;\n      display: flex;\n      align-items: center;\n      gap: var(--space-3);\n      animation: slideInRight 0.3s ease-out;\n      max-width: 400px;\n    `,o.innerHTML=`\n      <i class="fas fa-${"success"===t?"check-circle":"error"===t?"exclamation-circle":"info-circle"}"></i>\n      <span>${e}</span>\n    `,document.body.appendChild(o),setTimeout(()=>{o.style.animation="slideOutRight 0.3s ease-in",setTimeout(()=>o.remove(),300)},3e3)}}function setupMobileMenu(){const e=document.getElementById("mobile-menu-toggle"),t=document.getElementById("mobile-menu-overlay"),o=document.getElementById("mobile-menu-close"),a=document.getElementById("mobile-logout");e&&t&&e.addEventListener("click",()=>{t.classList.toggle("show"),document.body.style.overflow=t.classList.contains("show")?"hidden":""}),o&&o.addEventListener("click",()=>{t.classList.remove("show"),document.body.style.overflow=""}),t&&t.addEventListener("click",e=>{e.target===t&&(t.classList.remove("show"),document.body.style.overflow="")}),a&&a.addEventListener("click",async()=>{if(confirm("Sei sicuro di voler uscire?"))try{if(window.supabaseClientManager){const e=await window.supabaseClientManager.getClient();await e.auth.signOut()}window.location.href=window.AppConfig.getPageUrl("index.html")}catch(e){console.error("Logout error:",e),window.location.href=window.AppConfig.getPageUrl("index.html")}})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.editProfilePage=new EditProfilePage}):window.editProfilePage=new EditProfilePage,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",setupMobileMenu):setupMobileMenu();