class EduNetProfileManager{constructor(){this.supabase=null,this.currentUser=null,this.currentProfile=null,this.profileType=null,this.init()}async init(){this.supabase=await window.supabaseClientManager.getClient(),this.supabase||console.warn("âš ï¸ Client Supabase non disponibile per ProfileManager")}async loadCurrentUserProfile(){try{if(!this.supabase)throw new Error("Supabase non inizializzato");const{data:{user:e},error:t}=await this.supabase.auth.getUser();if(t)throw t;if(!e)return null;this.currentUser=e;const{data:r,error:i}=await this.supabase.from("user_profiles").select("*").eq("user_id",e.id).single();if(i)throw i;return this.currentProfile=r,this.profileType=r.user_type,"institute"===r.user_type?await this.loadInstituteProfile():"private"===r.user_type&&await this.loadPrivateUserProfile(),this.currentProfile}catch(e){throw console.error("Errore nel caricamento profilo:",e),e}}async loadInstituteProfile(){try{const{data:e,error:t}=await this.supabase.from("school_institutes").select("*").eq("user_id",this.currentUser.id).single();if(t)throw t;return this.currentProfile.instituteData=e,e}catch(e){throw console.error("Errore nel caricamento dati istituto:",e),e}}async loadPrivateUserProfile(){try{const{data:e,error:t}=await this.supabase.from("private_users").select("*").eq("user_id",this.currentUser.id).single();if(t)throw t;return this.currentProfile.privateData=e,e}catch(e){throw console.error("Errore nel caricamento dati utente privato:",e),e}}async updateBaseProfile(e){try{if(!this.currentUser)throw new Error("Nessun utente autenticato");const{data:t,error:r}=await this.supabase.from("user_profiles").update({display_name:e.displayName,bio:e.bio,avatar_url:e.avatarUrl,location:e.location,website:e.website,updated_at:(new Date).toISOString()}).eq("user_id",this.currentUser.id).select().single();if(r)throw r;return Object.assign(this.currentProfile,t),t}catch(e){throw console.error("Errore nell'aggiornamento profilo base:",e),e}}async updateInstituteProfile(e){try{if(!this.currentUser||"institute"!==this.profileType)throw new Error("Utente non autorizzato per questa operazione");const{data:t,error:r}=await this.supabase.from("school_institutes").update({institute_name:e.instituteName,institute_type:e.instituteType,description:e.description,address:e.address,phone:e.phone,website:e.website,pec_email:e.pecEmail,principal_name:e.principalName,student_count:e.studentCount,teacher_count:e.teacherCount,updated_at:(new Date).toISOString()}).eq("user_id",this.currentUser.id).select().single();if(r)throw r;return this.currentProfile.instituteData=t,t}catch(e){throw console.error("Errore nell'aggiornamento profilo istituto:",e),e}}async updatePrivateUserProfile(e){try{if(!this.currentUser||"private"!==this.profileType)throw new Error("Utente non autorizzato per questa operazione");const{data:t,error:r}=await this.supabase.from("private_users").update({first_name:e.firstName,last_name:e.lastName,date_of_birth:e.dateOfBirth,phone:e.phone,education_level:e.educationLevel,interests:e.interests,profession:e.profession,updated_at:(new Date).toISOString()}).eq("user_id",this.currentUser.id).select().single();if(r)throw r;return this.currentProfile.privateData=t,t}catch(e){throw console.error("Errore nell'aggiornamento profilo utente privato:",e),e}}async loadUserFollows(){try{if(!this.currentUser)throw new Error("Nessun utente autenticato");const{data:e,error:t}=await this.supabase.from("user_follows").select("\n                    *,\n                    followed_profile:user_profiles!user_follows_followed_user_id_fkey(\n                        *,\n                        school_institutes(*),\n                        private_users(*)\n                    )\n                ").eq("follower_user_id",this.currentUser.id);if(t)throw t;return e}catch(e){throw console.error("Errore nel caricamento seguiti:",e),e}}async followUser(e){try{if(!this.currentUser)throw new Error("Nessun utente autenticato");if(e===this.currentUser.id)throw new Error("Non puoi seguire te stesso");const{data:t,error:r}=await this.supabase.from("user_follows").insert({follower_user_id:this.currentUser.id,followed_user_id:e}).select().single();if(r)throw r;return t}catch(e){throw console.error("Errore nel seguire utente:",e),e}}async unfollowUser(e){try{if(!this.currentUser)throw new Error("Nessun utente autenticato");const{error:t}=await this.supabase.from("user_follows").delete().eq("follower_user_id",this.currentUser.id).eq("followed_user_id",e);if(t)throw t;return!0}catch(e){throw console.error("Errore nel smettere di seguire utente:",e),e}}async isFollowing(e){try{if(!this.currentUser)return!1;const{data:t,error:r}=await this.supabase.from("user_follows").select("id").eq("follower_user_id",this.currentUser.id).eq("followed_user_id",e).single();return!r&&t}catch(e){return!1}}async loadProfileStats(){try{if(!this.currentUser)throw new Error("Nessun utente autenticato");const{count:e,error:t}=await this.supabase.from("user_follows").select("*",{count:"exact",head:!0}).eq("followed_user_id",this.currentUser.id);if(t)throw t;const{count:r,error:i}=await this.supabase.from("user_follows").select("*",{count:"exact",head:!0}).eq("follower_user_id",this.currentUser.id);if(i)throw i;let s=0;if("institute"===this.profileType){const{count:e,error:t}=await this.supabase.from("institute_posts").select("*",{count:"exact",head:!0}).eq("institute_user_id",this.currentUser.id);t||(s=e)}return{followers:e||0,following:r||0,posts:s}}catch(e){throw console.error("Errore nel caricamento statistiche profilo:",e),e}}async searchProfiles(e,t=null){try{let r=[];if(!t||"istituto"===t)try{const{data:t}=await this.supabase.from("school_institutes").select("id, institute_name, institute_type, city, institute_code").ilike("institute_name",`%${e}%`).limit(20);if(t){const e=["liceo","istituto","scuola","comprensivo","tecnico","professionale","universitÃ ","politecnico","accademia","conservatorio","ic ","i.c.","its","ipsia","itis","itc","ipseoa"],i=t.filter(t=>{const r=(t.institute_name||"").toLowerCase();if(t.institute_code)return!0;if(e.some(e=>r.includes(e)))return!0;const i=["Scuola Primaria","Scuola Secondaria","Liceo","UniversitÃ "];return!!i.some(e=>t.institute_type?.includes(e))||(console.log("ðŸ”’ Istituto escluso dalla ricerca (nome sospetto):",r),!1)});r=i.slice(0,10).map(e=>({id:e.id,user_type:"istituto",school_institutes:{institute_name:e.institute_name,city:e.city}}))}}catch(e){console.warn("Error searching institutes:",e)}let i=[];const s=[...r,...i];return s.slice(0,20)}catch(e){return console.error("Errore nella ricerca profili:",e),[]}}getCurrentUser(){return this.currentUser}getCurrentProfile(){return this.currentProfile}getProfileType(){return this.profileType}isInstitute(){return"institute"===this.profileType}isPrivateUser(){return"private"===this.profileType}}window.eduNetProfileManager=new EduNetProfileManager,"undefined"!=typeof module&&module.exports&&(module.exports=EduNetProfileManager);